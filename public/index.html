<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1">
<meta http-equiv="Content-Security-Policy" content="default-src 'self' https: data: blob:; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://unpkg.com; img-src 'self' https: data: blob:; connect-src 'self' https://overpass-api.de https://overpass.kumi.systems https://lz4.overpass-api.de https://nominatim.openstreetmap.org https://commons.wikimedia.org https://*.wikipedia.org https://www.wikidata.org https://*.tile.openstreetmap.org https://*.basemaps.cartocdn.com https://server.arcgisonline.com; object-src 'none'; base-uri 'self'; frame-ancestors 'self';">
<title>KÄ±ble DedektÃ¶rÃ¼</title>
<style>
:root {
  --bg:#0a0a0f; --surface:#111118; --panel:#16161f; --border:#2a2a3a;
  --gold:#c9a84c; --gold-light:#e8c97a; --green:#4ade80; --red:#f87171;
  --amber:#fbbf24; --text:#e8e4d8; --muted:#6b6b7a;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace,sans-serif;height:100vh;display:flex;flex-direction:column;overflow:hidden;}
body.outdoor-mode{
  --bg:#fffef8; --surface:#ffffff; --panel:#ffffff; --border:#101010;
  --gold:#111111; --gold-light:#000000; --green:#056b00; --red:#b00020;
  --amber:#9a6800; --text:#050505; --muted:#222222;
}

/* â”€â”€ HEADER */
header{display:flex;align-items:center;gap:14px;padding:11px 18px;background:var(--surface);border-bottom:1px solid var(--border);z-index:1000;flex-shrink:0;}
.brand-home{display:flex;align-items:center;gap:10px;cursor:pointer;border-radius:8px;padding:2px 4px;transition:background .15s;}
.brand-home:hover{background:rgba(201,168,76,.08);}
.brand-home:focus-visible{outline:1px solid rgba(201,168,76,.55);}
.logo-arabic{font-size:21px;color:var(--gold);}
.logo-title{font-size:16px;font-weight:700;}
.logo-sub{font-size:9px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase;}
.divider{width:1px;height:34px;background:var(--border);}
.search-box{display:flex;gap:7px;flex:1;max-width:360px;position:relative;}
.search-box input{background:var(--panel);border:1px solid var(--border);color:var(--text);font-family:inherit;font-size:13px;padding:7px 13px;border-radius:6px;flex:1;outline:none;}
.search-box input:focus{border-color:var(--gold);}
.search-box input::placeholder{color:var(--muted);}
.city-smart-dd{
  position:absolute;top:calc(100% + 6px);left:0;right:0;background:var(--panel);
  border:1px solid var(--border);border-radius:8px;z-index:1300;max-height:290px;overflow-y:auto;
  box-shadow:0 10px 26px rgba(0,0,0,.55);display:none;
}
.city-smart-dd.show{display:block;}
.btn{background:var(--gold);color:#0a0a0f;border:none;font-family:inherit;font-size:12px;font-weight:600;padding:7px 14px;border-radius:6px;cursor:pointer;white-space:nowrap;}
.btn:hover{background:var(--gold-light);}
.btn-sm{background:transparent;color:var(--muted);border:1px solid var(--border);font-size:11px;padding:6px 11px;border-radius:6px;cursor:pointer;font-family:inherit;white-space:nowrap;}
.btn-sm:hover{color:var(--text);}
.btn-sm.active{background:rgba(201,168,76,.15);color:var(--gold);border-color:rgba(201,168,76,.4);}

/* â”€â”€ SCORE CARD */
.score-card{
  position:absolute;top:12px;right:12px;z-index:801;
  background:rgba(13,13,20,.95);border:1px solid var(--border);
  border-radius:10px;padding:16px;width:220px;
  backdrop-filter:blur(8px);box-shadow:0 12px 40px rgba(0,0,0,.6);
  opacity:0;pointer-events:none;transition:opacity .25s,transform .25s;
  transform:translateY(-6px);
}
.score-card.show{opacity:1;pointer-events:all;transform:translateY(0);}
.sc-close{position:absolute;top:10px;right:12px;cursor:pointer;color:var(--muted);font-size:13px;line-height:1;}
.sc-close:hover{color:var(--text);}
.sc-city{font-size:13px;font-weight:700;color:var(--text);margin-bottom:14px;padding-right:20px;letter-spacing:.02em;}
/* donut */
.sc-score-wrap{position:relative;width:110px;height:110px;margin:0 auto 10px;}
#sc-donut{display:block;}
.sc-score-center{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;}
.sc-pct{font-size:24px;font-weight:700;color:var(--text);line-height:1;}
.sc-pct-lbl{font-size:9px;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;margin-top:2px;}
/* grade badge */
.sc-grade{text-align:center;font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;padding:3px 10px;border-radius:20px;display:inline-block;margin:0 auto 12px;width:fit-content;display:block;}
.sc-grade.A{background:rgba(74,222,128,.15);color:#4ade80;border:1px solid rgba(74,222,128,.3);}
.sc-grade.B{background:rgba(251,191,36,.15);color:#fbbf24;border:1px solid rgba(251,191,36,.3);}
.sc-grade.C{background:rgba(251,146,60,.15);color:#fb923c;border:1px solid rgba(251,146,60,.3);}
.sc-grade.D{background:rgba(248,113,113,.15);color:#f87171;border:1px solid rgba(248,113,113,.3);}
/* stats */
.sc-stats{display:flex;flex-direction:column;gap:4px;margin-bottom:10px;}
.sc-stat-row{display:flex;align-items:center;gap:7px;font-size:10px;}
.sc-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.sc-stat-lbl{flex:1;color:var(--muted);}
.sc-stat-val{color:var(--text);font-weight:600;min-width:30px;text-align:right;}
/* best/worst */
.sc-best-worst{background:rgba(255,255,255,.03);border-radius:6px;padding:8px 10px;margin-bottom:8px;font-size:10px;}
.sc-bw-label{color:var(--muted);font-size:9px;letter-spacing:.08em;text-transform:uppercase;}
.sc-bw-name{color:var(--green);font-weight:600;margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sc-tolerance{font-size:9px;color:var(--border);text-align:center;}
.map-switch{display:flex;gap:1px;background:var(--border);border-radius:6px;overflow:hidden;}
.map-switch button{background:var(--panel);color:var(--muted);border:none;font-family:inherit;font-size:11px;padding:6px 11px;cursor:pointer;transition:all .15s;}
.map-switch button.active{background:var(--gold);color:#0a0a0f;font-weight:600;}
.map-switch button:hover:not(.active){color:var(--text);}
.lang-switch{display:flex;gap:4px;align-items:center;}
.header-actions{display:flex;flex-direction:column;gap:7px;margin-left:auto;align-items:flex-end;min-width:0;}
.header-row{display:flex;gap:7px;align-items:center;justify-content:flex-end;flex-wrap:wrap;}

/* â”€â”€ STATS BAR */
.stats-bar{display:flex;background:var(--surface);border-bottom:1px solid var(--border);flex-shrink:0;align-items:center;}
.stat{display:flex;align-items:center;gap:7px;padding:8px 15px;border-right:1px solid var(--border);font-size:11px;}
.dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.dot.gold{background:var(--gold);}
.dot.green{background:var(--green);box-shadow:0 0 5px var(--green);}
.dot.red{background:var(--red);box-shadow:0 0 5px var(--red);}
.dot.amber{background:var(--amber);}
.stat-num{font-size:15px;font-weight:600;color:var(--text);min-width:24px;}
.stat-lbl{color:var(--muted);letter-spacing:.05em;text-transform:uppercase;}

/* viewport loading indicator */
.vp-status{display:flex;align-items:center;gap:7px;padding:0 14px;font-size:10px;color:var(--muted);}
.vp-dot{width:6px;height:6px;border-radius:50%;background:var(--border);transition:background .3s,box-shadow .3s;}
.vp-dot.loading{background:var(--amber);box-shadow:0 0 6px var(--amber);animation:pulse .8s infinite;}
.vp-dot.done{background:var(--green);box-shadow:0 0 5px var(--green);}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.4;}}

/* cache stats */
.cache-info{font-size:10px;color:var(--border);padding:0 10px;border-left:1px solid var(--border);}
.cache-info span{color:var(--muted);}

.tol{display:flex;align-items:center;gap:7px;margin-left:auto;padding:0 15px;font-size:11px;color:var(--muted);}
.tol input[type=range]{-webkit-appearance:none;width:75px;height:3px;background:var(--border);border-radius:2px;outline:none;cursor:pointer;}
.tol input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:11px;height:11px;border-radius:50%;background:var(--gold);cursor:pointer;}
#tol-val{color:var(--gold);min-width:26px;}

/* â”€â”€ MAIN */
.main{display:flex;flex:1;overflow:hidden;}
#map{flex:1;position:relative;}

/* â”€â”€ SIDEBAR */
.sidebar{width:290px;background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;flex-shrink:0;}
.sb-head{padding:11px 13px;border-bottom:1px solid var(--border);font-size:10px;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);display:flex;align-items:center;justify-content:space-between;}
.sb-count{color:var(--gold);font-weight:600;}
.mosque-list{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.m-item{padding:8px 13px;border-bottom:1px solid rgba(42,42,58,.5);cursor:pointer;display:flex;gap:8px;align-items:flex-start;transition:background .12s;}
.m-item:hover{background:var(--panel);}
.m-item.active{background:rgba(201,168,76,.08);}
.m-dot{width:6px;height:6px;border-radius:50%;margin-top:4px;flex-shrink:0;}
.m-info{flex:1;min-width:0;}
.m-name{font-size:11px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.m-sub{font-size:10px;color:var(--muted);margin-top:2px;}
.m-diff{font-size:10px;font-weight:600;flex-shrink:0;}
/* â”€â”€ MOSQUE SEARCH */
.ms-wrap{position:relative;border-bottom:1px solid var(--border);flex-shrink:0;}
.ms-box{display:flex;align-items:center;gap:7px;padding:8px 12px;background:var(--panel);}
.ms-icon{font-size:13px;flex-shrink:0;opacity:.5;}
.ms-box input{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:inherit;font-size:12px;}
.ms-box input::placeholder{color:var(--muted);}
.ms-box input.has-value{color:var(--gold);}
#ms-clear{background:none;border:none;color:var(--muted);cursor:pointer;font-size:12px;padding:0 2px;display:none;line-height:1;}
#ms-clear:hover{color:var(--red);}
#ms-clear.show{display:block;}
.ms-scope{
  display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:6px 12px;background:#111118;border-top:1px solid rgba(42,42,58,.45);
}
.ms-scope-lbl{font-size:10px;color:var(--muted);}
.ms-scope-lbl b{color:var(--text);font-weight:600;}
.ms-switch{position:relative;display:inline-flex;align-items:center;cursor:pointer;}
.ms-switch input{position:absolute;opacity:0;pointer-events:none;}
.ms-switch-track{
  width:34px;height:18px;border-radius:20px;background:#2a2a3a;border:1px solid #3a3a4a;
  position:relative;transition:all .15s;
}
.ms-switch-track::after{
  content:'';position:absolute;top:1px;left:1px;width:14px;height:14px;border-radius:50%;
  background:#d1d5db;transition:left .15s;
}
.ms-switch input:checked + .ms-switch-track{
  background:rgba(201,168,76,.25);border-color:rgba(201,168,76,.6);
}
.ms-switch input:checked + .ms-switch-track::after{
  left:17px;background:#c9a84c;
}
/* dropdown */
.ms-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--panel);border:1px solid var(--border);border-top:none;border-radius:0 0 8px 8px;z-index:900;max-height:220px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--border) transparent;box-shadow:0 8px 24px rgba(0,0,0,.5);display:none;}
.ms-dropdown.show{display:block;}
.ms-item{padding:8px 13px;cursor:pointer;display:flex;gap:8px;align-items:flex-start;border-bottom:1px solid rgba(42,42,58,.4);transition:background .1s;}
.ms-item:last-child{border-bottom:none;}
.ms-item:hover,.ms-item.focused{background:rgba(201,168,76,.07);}
.ms-item-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.ms-item-info{flex:1;min-width:0;}
.ms-item-name{font-size:11px;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ms-item-name mark{background:transparent;color:var(--gold);font-weight:700;}
.ms-item-sub{font-size:10px;color:var(--muted);margin-top:1px;}
.ms-item-sub.meta{opacity:.9;}
.ms-badges{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;}
.ms-badge{font-size:9px;padding:1px 6px;border-radius:10px;border:1px solid #2a2a3a;color:#9ca3af;background:#111118;}
.ms-badge.pop{color:#c9a84c;border-color:rgba(201,168,76,.38);background:rgba(201,168,76,.1);}
.ms-badge.near{color:#60a5fa;border-color:rgba(96,165,250,.35);background:rgba(96,165,250,.1);}
.ms-badge.view{color:#4ade80;border-color:rgba(74,222,128,.35);background:rgba(74,222,128,.1);}
.ms-item-diff{font-size:10px;font-weight:600;flex-shrink:0;margin-top:2px;white-space:nowrap;}
.ms-no-result{padding:12px 13px;font-size:11px;color:var(--muted);text-align:center;}
.ms-suggest-btn{
  margin-top:7px;background:#111118;border:1px solid #2a2a3a;color:#c9a84c;
  font-family:'DM Mono',monospace;font-size:10px;padding:5px 8px;border-radius:6px;cursor:pointer;
}
.ms-suggest-btn:hover{border-color:rgba(201,168,76,.45);background:rgba(201,168,76,.08);}
/* Active filter banner */
.ms-filter-banner{display:none;padding:5px 12px;background:rgba(201,168,76,.08);border-bottom:1px solid rgba(201,168,76,.2);font-size:10px;color:var(--gold);align-items:center;justify-content:space-between;}
.ms-filter-banner.show{display:flex;}
.ms-filter-banner button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:11px;padding:0;}
.ms-filter-banner button:hover{color:var(--red);}

.legend{padding:10px 13px;border-top:1px solid var(--border);font-size:10px;color:var(--muted);display:flex;flex-direction:column;gap:5px;}
.leg-row{display:flex;align-items:center;gap:7px;}
.leg-line{width:22px;height:2px;border-radius:1px;}
.pull-refresh{display:none;text-align:center;padding:0 10px;line-height:0;overflow:hidden;transition:line-height .18s ease,padding .18s ease;background:rgba(201,168,76,.08);color:var(--gold);border-bottom:1px solid rgba(201,168,76,.22);font-size:10px;letter-spacing:.08em;text-transform:uppercase;}
.pull-refresh.show{display:block;}
.pull-refresh.visible{line-height:22px;padding:6px 10px;}

/* â”€â”€ LOADING OVERLAY */
.overlay{position:fixed;inset:0;background:rgba(10,10,15,.88);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;backdrop-filter:blur(4px);}
.spinner{width:42px;height:42px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.ov-text{margin-top:13px;font-size:12px;color:var(--muted);letter-spacing:.1em;}
.ov-sub{font-size:10px;color:var(--border);margin-top:4px;}

/* â”€â”€ MINI LOADER (non-blocking, bottom-left of map) */
.mini-loader{position:absolute;bottom:12px;left:12px;z-index:800;background:rgba(17,17,24,.9);border:1px solid var(--border);border-radius:7px;padding:7px 12px;font-size:11px;color:var(--muted);display:flex;align-items:center;gap:8px;pointer-events:none;opacity:0;transition:opacity .25s;backdrop-filter:blur(4px);}
.mini-loader.show{opacity:1;}
.mini-spin{width:12px;height:12px;border:1.5px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin .6s linear infinite;flex-shrink:0;}

/* â”€â”€ KIBLE ANIMATION PANEL */
.qibla-panel{position:absolute;top:12px;left:12px;z-index:800;background:rgba(17,17,24,.92);border:1px solid var(--border);border-radius:8px;padding:10px 14px;font-size:11px;color:var(--muted);min-width:200px;pointer-events:none;opacity:0;transition:opacity .3s;backdrop-filter:blur(6px);}
.qibla-panel.show{opacity:1;}
.qp-name{color:var(--gold);font-size:12px;font-weight:700;margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px;}
.qp-row{display:flex;justify-content:space-between;gap:16px;margin-bottom:3px;}
.qp-k{color:var(--muted);}
.qp-v{color:var(--text);}
.qp-anim{font-size:9px;color:var(--gold);margin-top:6px;letter-spacing:.1em;text-transform:uppercase;}

.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:5px;color:var(--muted);font-size:11px;padding:18px;text-align:center;min-height:180px;}
.empty-icon{font-size:28px;opacity:.35;margin-bottom:5px;}
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:var(--panel);border:1px solid var(--border);padding:9px 16px;border-radius:8px;font-size:12px;z-index:9999;opacity:0;transition:opacity .3s;pointer-events:none;white-space:nowrap;}
.toast.show{opacity:1;}

/* Leaflet popup */
.leaflet-popup-content-wrapper{background:var(--panel) !important;color:var(--text) !important;border:1px solid var(--border) !important;border-radius:8px !important;box-shadow:0 8px 32px rgba(0,0,0,.6) !important;}
.leaflet-popup-tip{background:var(--panel) !important;}
.leaflet-popup-content{font-family:'DM Mono',monospace;font-size:12px;margin:10px 14px !important;}
.p-name{font-size:13px;color:var(--gold);font-weight:700;margin-bottom:7px;}
.p-row{display:flex;justify-content:space-between;gap:14px;margin-bottom:3px;}
.p-k{color:var(--muted);}.p-v{color:var(--text);}
.p-method{font-size:9px;color:var(--border);margin-top:6px;letter-spacing:.08em;}
.p-anim-btn{margin-top:8px;background:rgba(201,168,76,.15);border:1px solid rgba(201,168,76,.3);color:var(--gold);font-family:inherit;font-size:10px;padding:5px 10px;border-radius:5px;cursor:pointer;width:100%;pointer-events:all;}
.p-anim-btn:hover{background:rgba(201,168,76,.25);}

/* â•â• TOOLTIPS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
[data-tip]{position:relative;}
[data-tip]::after{content:attr(data-tip);position:absolute;bottom:calc(100% + 7px);left:50%;transform:translateX(-50%);background:#1a1a26;border:1px solid #3a3a4a;color:#e8e4d8;font-size:10px;font-family:'DM Mono',monospace;padding:4px 9px;border-radius:5px;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .15s;z-index:9000;letter-spacing:.03em;}
[data-tip]:hover::after{opacity:1;}

/* â•â• KEYBOARD SHORTCUT OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ks-overlay{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:9800;display:none;align-items:center;justify-content:center;backdrop-filter:blur(8px);}
.ks-overlay.show{display:flex;}
.ks-modal{background:#0e0e16;border:1px solid #2a2a3a;border-radius:14px;padding:28px 32px;width:min(560px,94vw);box-shadow:0 24px 80px rgba(0,0,0,.9);}
.ks-title{font-size:14px;font-weight:700;color:#e8e4d8;margin-bottom:18px;display:flex;justify-content:space-between;align-items:center;}
.ks-close-btn{background:none;border:none;color:#6b6b7a;cursor:pointer;font-size:15px;padding:2px 6px;border-radius:4px;}
.ks-close-btn:hover{color:#e8e4d8;}
.ks-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px 24px;}
.ks-row{display:flex;align-items:center;gap:10px;padding:5px 0;border-bottom:1px solid rgba(42,42,58,.4);}
.ks-row:last-child{border-bottom:none;}
.ks-key{background:#1a1a26;border:1px solid #3a3a4a;border-radius:5px;padding:2px 7px;font-size:10px;color:#c9a84c;font-family:'DM Mono',monospace;min-width:28px;text-align:center;font-weight:700;flex-shrink:0;}
.ks-desc{font-size:11px;color:#9ca3af;}
.ks-footer{margin-top:14px;font-size:10px;color:#4a4a5a;text-align:center;}

/* â•â• STAT COUNTER ANIMATION â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stat-num{transition:color .3s;}
.stat-num.updated{animation:statpop .4s ease;}
@keyframes statpop{0%{transform:scale(1.3);}100%{transform:scale(1);}}

/* â•â• SIDEBAR LIST STAGGER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.m-item{animation:fadeSlide .2s ease both;}
@keyframes fadeSlide{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:none;}}

/* â•â• SKELETON LOADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sk-item{padding:8px 13px;border-bottom:1px solid rgba(42,42,58,.5);display:flex;gap:8px;align-items:center;}
.sk-dot{width:6px;height:6px;border-radius:50%;background:#1e1e2e;flex-shrink:0;}
.sk-line{height:9px;border-radius:4px;background:linear-gradient(90deg,#1a1a26 25%,#252534 50%,#1a1a26 75%);background-size:200% 100%;animation:shimmer 1.2s infinite;}
@keyframes shimmer{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
.sk-name{flex:1;}
.sk-diff{width:34px;}

/* â•â• MOBILE RESPONSIVE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.mob-menu-btn{display:none;background:transparent;border:1px solid var(--border);color:var(--muted);font-size:16px;padding:5px 9px;border-radius:6px;cursor:pointer;line-height:1;}
.mob-menu-btn:hover{color:var(--text);}

/* Mobile menu drawer */
.mob-drawer{position:fixed;top:0;left:0;bottom:0;width:280px;background:#0e0e16;border-right:1px solid #2a2a3a;z-index:8000;transform:translateX(-100%);transition:transform .28s cubic-bezier(.4,0,.2,1);overflow-y:auto;padding:16px;}
.mob-drawer.open{transform:translateX(0);}
.mob-drawer-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:7999;display:none;}
.mob-drawer-backdrop.show{display:block;}
.mob-drawer-title{font-size:11px;color:#6b6b7a;letter-spacing:.12em;text-transform:uppercase;padding:4px 0 10px;border-bottom:1px solid #2a2a3a;margin-bottom:12px;}
.mob-drawer-section{margin-bottom:16px;}
.mob-drawer-section-lbl{font-size:9px;color:#4a4a5a;letter-spacing:.1em;text-transform:uppercase;margin-bottom:6px;}
.mob-drawer-btn{display:flex;align-items:center;gap:9px;width:100%;background:transparent;border:1px solid #2a2a3a;color:#9ca3af;font-family:'DM Mono',monospace;font-size:12px;padding:9px 12px;border-radius:7px;cursor:pointer;margin-bottom:5px;transition:all .13s;text-align:left;}
.mob-drawer-btn:hover{color:#e8e4d8;border-color:#3a3a4a;background:#111118;}
.mob-drawer-btn.active{background:rgba(201,168,76,.1);color:#c9a84c;border-color:rgba(201,168,76,.35);}
.mob-search-row{display:flex;gap:7px;margin-bottom:12px;}
.mob-search-row input{flex:1;background:#16161f;border:1px solid #2a2a3a;color:#e8e4d8;font-family:'DM Mono',monospace;font-size:13px;padding:8px 12px;border-radius:6px;outline:none;}
.mob-search-row input:focus{border-color:#c9a84c;}
.mob-search-row button{background:#c9a84c;color:#0a0a0f;border:none;padding:8px 14px;border-radius:6px;font-weight:700;cursor:pointer;}
.mob-bottom-bar{display:none;}
.mob-layer-stack{display:none;}
.compass-fab{display:none;}

.sb-snap-panels{display:none;}

@media (max-width: 1460px) and (min-width: 769px) {
  header{
    flex-wrap:wrap;
    row-gap:8px;
    align-items:flex-start;
  }
  .divider{display:none;}
  .search-box{
    order:30;
    flex:1 1 100%;
    max-width:none;
  }
  .header-actions{
    order:20;
    margin-left:0;
    width:100%;
    align-items:stretch;
  }
  .header-row{
    justify-content:flex-start;
  }
  .btn-sm{padding:6px 9px;font-size:10px;}
}

@media (max-width: 768px) {
  html,body{
    width:100%;
    height:100%;
    overflow:hidden;
    overscroll-behavior:none;
    -webkit-text-size-adjust:100%;
  }

  /* Header collapses */
  header{padding:10px 14px;gap:10px;flex-wrap:nowrap;}
  .header-actions{display:none !important;}
  .logo-sub,.divider,.map-switch,.btn-sm:not(#mob-menu-show){display:none !important;}
  .lang-switch{display:none !important;}
  .search-box{display:none !important;}
  .mob-menu-btn{display:block;}
  .brand-home{margin-right:auto;}

  .mob-bottom-bar{
    display:flex;
    position:fixed;
    left:10px;
    right:10px;
    bottom:calc(10px + env(safe-area-inset-bottom, 0px));
    z-index:1200;
    background:linear-gradient(180deg,rgba(18,18,28,.98),rgba(12,12,20,.96));
    border:1px solid rgba(201,168,76,.45);
    border-radius:14px;
    padding:10px;
    gap:8px;
    backdrop-filter:blur(8px);
    box-shadow:0 12px 34px rgba(0,0,0,.55);
  }
  .mob-bottom-bar input{
    flex:1;
    min-width:0;
    background:#16161f;
    border:1px solid #3a3a4a;
    color:#e8e4d8;
    font-family:'DM Mono',monospace;
    font-size:16px;
    border-radius:8px;
    padding:11px 12px;
    outline:none;
  }
  .mob-bottom-bar button{
    border:1px solid #3a3a4a;
    background:#111118;
    color:#e8e4d8;
    font-family:'DM Mono',monospace;
    font-size:14px;
    border-radius:8px;
    padding:10px 12px;
    cursor:pointer;
  }
  .mob-bottom-bar button.primary{
    background:#c9a84c;
    color:#0a0a0f;
    border-color:#c9a84c;
    font-weight:700;
  }
  .mob-bottom-bar button:active{transform:translateY(1px);}
  .mob-bottom-bar button:last-child{min-width:44px;}
  .mob-search-row input{font-size:16px;}
  .dp-int-form input,.dp-int-form select{font-size:16px;}
  .ms-box input{font-size:16px;}
  header,.stats-bar,.mob-bottom-bar{touch-action:manipulation;}

  .mob-layer-stack{
    display:flex;
    flex-direction:column;
    gap:6px;
    position:absolute;
    top:10px;
    right:10px;
    z-index:1450;
  }
  .mob-layer-btn{
    border:1px solid #3a3a4a;
    background:rgba(14,14,22,.94);
    color:#d1d5db;
    font-family:'DM Mono',monospace;
    font-size:12px;
    border-radius:8px;
    padding:8px 10px;
    cursor:pointer;
    box-shadow:0 8px 20px rgba(0,0,0,.35);
  }
  .mob-layer-btn.active{
    background:#c9a84c;
    color:#0a0a0f;
    border-color:#c9a84c;
    font-weight:700;
  }

  .compass-fab{
    display:flex;
    position:absolute;
    right:10px;
    bottom:86px;
    z-index:1450;
    align-items:center;
    justify-content:center;
    width:46px;
    height:46px;
    border-radius:50%;
    border:1px solid #3a3a4a;
    background:rgba(14,14,22,.94);
    color:#d1d5db;
    font-family:'DM Mono',monospace;
    font-size:20px;
    cursor:pointer;
    box-shadow:0 8px 20px rgba(0,0,0,.35);
  }
  .compass-fab.active{
    background:#c9a84c;
    color:#0a0a0f;
    border-color:#c9a84c;
  }

  /* Stats bar scrollable */
  .stats-bar{overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;flex-wrap:nowrap;scrollbar-width:none;}
  .stats-bar::-webkit-scrollbar{display:none;}
  .stat{flex-shrink:0;}
  .tol{flex-shrink:0;}
  .cache-info{display:none;}

  /* Sidebar becomes bottom sheet */
  .main{position:relative;}
  .sidebar{
    position:fixed;bottom:0;left:0;right:0;
    width:100% !important;
    height:95vh;
    --sheet-snap:20;
    border-left:none;border-top:1px solid #2a2a3a;
    border-radius:14px 14px 0 0;
    transform:translateY(calc(100% - (var(--sheet-snap) * 1vh)));
    transition:transform .3s cubic-bezier(.4,0,.2,1);
    z-index:700;
    box-shadow:0 -8px 40px rgba(0,0,0,.6);
    padding-bottom:70px;
  }
  .sidebar.mob-open{--sheet-snap:95;}
  .sb-head{cursor:pointer;justify-content:center;padding:10px;position:sticky;top:0;background:#111118;z-index:2;}
  .sb-head::before{content:'';display:block;width:36px;height:4px;background:#3a3a4a;border-radius:2px;position:absolute;top:6px;left:50%;transform:translateX(-50%);}

  .sb-snap-panels{display:block;border-bottom:1px solid #2a2a3a;background:#101019;}
  .sb-mini-panel,.sb-half-panel{display:none;padding:10px 12px;}
  .sb-mini-title{font-size:9px;letter-spacing:.12em;text-transform:uppercase;color:#6b6b7a;margin-bottom:4px;}
  .sb-mini-city{font-size:12px;color:#e8e4d8;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .sb-mini-score{font-size:24px;font-weight:700;color:#c9a84c;line-height:1;margin-top:4px;}
  .sb-mini-sub{font-size:10px;color:#6b6b7a;}
  .sb-half-grid{display:grid;grid-template-columns:1fr 110px;gap:10px;align-items:center;}
  .sb-half-metrics{display:flex;flex-direction:column;gap:6px;}
  .sb-half-row{display:flex;justify-content:space-between;font-size:10px;color:#9ca3af;border-bottom:1px solid rgba(42,42,58,.45);padding-bottom:4px;}
  .sb-half-row b{color:#e8e4d8;}
  #sb-radar{width:108px;height:108px;border-radius:50%;border:1px solid #2a2a3a;background:#0f0f18;}

  .sidebar[data-snap="min"] .sb-mini-panel{display:block;}
  .sidebar[data-snap="half"] .sb-half-panel{display:block;}
  .sidebar[data-snap="full"] .ms-wrap,
  .sidebar[data-snap="full"] .ms-filter-banner,
  .sidebar[data-snap="full"] .mosque-list,
  .sidebar[data-snap="full"] .legend{display:block;}
  .sidebar[data-snap="min"] .ms-wrap,
  .sidebar[data-snap="min"] .ms-filter-banner,
  .sidebar[data-snap="min"] .mosque-list,
  .sidebar[data-snap="min"] .legend,
  .sidebar[data-snap="min"] #sb-pull-indicator{display:none !important;}
  .sidebar[data-snap="half"] .ms-wrap,
  .sidebar[data-snap="half"] .ms-filter-banner,
  .sidebar[data-snap="half"] .mosque-list,
  .sidebar[data-snap="half"] .legend,
  .sidebar[data-snap="half"] #sb-pull-indicator{display:none !important;}
  .sidebar[data-snap="full"] .sb-mini-panel,
  .sidebar[data-snap="full"] .sb-half-panel{display:none;}

  /* Detail panel full-screen on mobile */
  .dp-panel{width:100% !important;border-left:none;border-top:1px solid #2a2a3a;}
  .dp-int-gallery{grid-template-columns:repeat(2,1fr);}
  .dp-int-form{grid-template-columns:1fr;}
  .dp-name{font-size:21px;}
  .dp-name-ar{font-size:17px;}
  .dp-coords{font-size:11px;}
  .dp-ribbon-lbl{font-size:10px;}
  .dp-ribbon-val{font-size:18px;}
  .dp-status-badge{font-size:15px;}
  .dp-section-title{font-size:11px;}
  .dp-int-meta{font-size:13px;}
  .dp-int-form label{font-size:13px;}
  .dp-int-form input,.dp-int-form select{font-size:16px;padding:9px 10px;}
  .dp-int-axis-val{font-size:15px;}
  .dp-qs-row{font-size:14px;}
  .dp-wiki-body{font-size:14px;}
  .dp-tag-row{grid-template-columns:130px 1fr;font-size:13px;}
  .dp-action-btn{font-size:14px;padding:10px 12px;}
  .m-item{font-size:13px;}

  /* Score card repositioned */
  .score-card{right:8px;top:8px;width:200px;}

  /* Qibla panel smaller */
  .qibla-panel{max-width:160px;font-size:10px;}
  .qp-name{max-width:140px;}

  /* Modals full-screen */
  .hist-modal,.cmp-modal,.lb-modal{width:100% !important;max-height:100vh;border-radius:0;margin:0;}
  .lab-modal{width:100% !important;max-height:100vh;border-radius:0;margin:0;}
  .cmps-modal{width:100% !important;max-height:100vh;border-radius:0;margin:0;}
  .m3d-modal{width:100% !important;max-height:100vh;border-radius:0;margin:0;}
  .biz-modal{width:100% !important;max-height:100vh;border-radius:0;margin:0;}
  .hist-overlay,.cmp-overlay,.lb-overlay{align-items:flex-end;}
  .lab-overlay{align-items:flex-end;}
  .cmps-overlay,.m3d-overlay{align-items:flex-end;}
  .biz-overlay{align-items:flex-end;}
  .biz-grid{grid-template-columns:1fr;}
  .biz-form{grid-template-columns:1fr;}
  .lab-grid{grid-template-columns:1fr;}
  .m3d-wrap{grid-template-columns:1fr;}
  .m3d-side{border-left:none;border-top:1px solid #2a2a3a;}

  /* Mobile: live loading badge near stats + hide bottom mosque sheet */
  .stats-bar{
    position:relative;
    padding-right:128px;
  }
  .vp-status{
    position:absolute;
    right:8px;
    top:50%;
    transform:translateY(-50%);
    border:1px solid #2a2a3a;
    border-radius:999px;
    padding:5px 9px;
    background:rgba(10,10,18,.92);
    gap:6px;
    color:#9ca3af;
    z-index:5;
  }
  .vp-status.loading{
    border-color:rgba(251,191,36,.6);
    color:#fbbf24;
  }
  .vp-status.done{
    border-color:rgba(74,222,128,.6);
    color:#4ade80;
    background:rgba(15,40,25,.9);
  }
  #vp-label{
    font-size:10px;
    white-space:nowrap;
    letter-spacing:.02em;
  }
  .sidebar{display:none !important;}
}

@media (max-width: 480px) {
  .logo-title{font-size:14px;}
  .search-box input{font-size:12px;}
  .mob-bottom-bar{
    left:8px;
    right:8px;
    bottom:calc(8px + env(safe-area-inset-bottom, 0px));
  }
}

@media (max-width: 900px) and (pointer: coarse) {
  .mob-bottom-bar{display:flex;}
}
</style>
<link rel="stylesheet" href="./vendor/leaflet/leaflet.css"/>
</head>
<body>

<header>
  <div class="brand-home" role="button" tabindex="0" onclick="resetToHome()" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();resetToHome();}">
    <div><div class="logo-arabic">Ù‚ÙØ¨Ù’Ù„ÙØ©</div></div>
    <div>
      <div class="logo-title">KÄ±ble DedektÃ¶rÃ¼</div>
      <div class="logo-sub">Bina YÃ¶nÃ¼ Analizi</div>
    </div>
  </div>
  <div class="divider"></div>
  <div class="search-box">
    <input id="city-input" list="city-suggest-list" type="text" placeholder="Åehir adÄ±..." value=""/>
    <datalist id="city-suggest-list"></datalist>
    <button class="btn" id="search-btn" data-tip="Åehir ara [Enter]">Ara</button>
    <div class="city-smart-dd" id="city-smart-dd"></div>
  </div>
  <div class="header-actions">
    <div class="header-row">
      <div class="map-switch">
        <button id="btn-dark" class="active" onclick="switchLayer('dark')" data-tip="Koyu harita">ğŸŒ‘ Koyu</button>
        <button id="btn-sat" onclick="switchLayer('satellite')" data-tip="Uydu gÃ¶rÃ¼nÃ¼mÃ¼">ğŸ›° Uydu</button>
        <button id="btn-osm" onclick="switchLayer('osm')" data-tip="Standart harita">ğŸ—º Harita</button>
      </div>
      <button id="btn-heat"    class="btn btn-sm" onclick="toggleHeatmap()"     data-tip="IsÄ± haritasÄ± [H]">ğŸŒ¡ IsÄ±</button>
      <button id="btn-score"   class="btn btn-sm" onclick="toggleScoreCard()"   data-tip="Skor kartÄ± [S]">ğŸ“Š Skor</button>
      <button id="btn-compare" class="btn btn-sm" onclick="openCompare()"       data-tip="Åehir karÅŸÄ±laÅŸtÄ±r [C]">âš–ï¸ KarÅŸÄ±laÅŸtÄ±r</button>
      <button id="btn-history" class="btn btn-sm" onclick="toggleHistoryMode()" data-tip="Tarihsel analiz [T]">ğŸ“… Tarih</button>
      <button id="btn-lb"      class="btn btn-sm" onclick="openLeaderboard()"   data-tip="KÃ¼resel sÄ±ralama [L]">ğŸŒ SÄ±ralama</button>
      <button class="btn btn-sm" id="loc-btn" data-tip="Konumuma git [G]">ğŸ“ Konum</button>
      <button class="btn btn-sm" id="btn-export" onclick="openExport()" data-tip="Export & PaylaÅŸ">ğŸ“¤ Export</button>
    </div>
    <div class="header-row">
      <button class="btn btn-sm" id="btn-biz" onclick="openBiz()" data-tip="Gelir & iÅŸ modeli [P]">ğŸ’¼ Gelir</button>
      <button class="btn btn-sm" id="btn-lab" onclick="openLab()" data-tip="QA & iÃ§gÃ¶rÃ¼">ğŸ§ª Lab</button>
      <button class="btn btn-sm" id="btn-compass" onclick="openCompass()" data-tip="CanlÄ± pusula">ğŸ§­ Pusula</button>
      <button class="btn btn-sm" id="btn-follow" onclick="toggleFollowLock()" data-tip="Konum takip kilidi">ğŸ“ Takip</button>
      <button class="btn btn-sm" id="btn-nearby" onclick="loadNearbyCitySuggestions()" data-tip="YakÄ±nÄ±mdaki ÅŸehir Ã¶nerileri">ğŸ§­ YakÄ±n</button>
      <button class="btn btn-sm" id="btn-outdoor" onclick="toggleOutdoorMode()" data-tip="YÃ¼ksek kontrast dÄ±ÅŸ mekan">â˜€ï¸ Outdoor</button>
      <div class="lang-switch">
        <button class="btn-sm active" id="lang-tr" onclick="setLang('tr')">TR</button>
        <button class="btn-sm" id="lang-en" onclick="setLang('en')">EN</button>
      </div>
      <button class="btn btn-sm" onclick="openShortcuts()" data-tip="Klavye kÄ±sayollarÄ± [?]" style="border-color:transparent;padding:6px 8px">âŒ¨ï¸</button>
    </div>
  </div>
  <button class="mob-menu-btn" id="mob-menu-show" onclick="openMobDrawer()">â˜°</button>
</header>
<div class="mob-bottom-bar" id="mob-bottom-bar">
  <input id="mob-quick-city" type="text" placeholder="Åehir ara..." autocomplete="off"/>
  <button class="primary" onclick="mobQuickSearch()">Ara</button>
  <button onclick="useMyLocation()">ğŸ“</button>
</div>

<!-- Mobile drawer -->
<div class="mob-drawer-backdrop" id="mob-backdrop" onclick="closeMobDrawer()"></div>
<div class="mob-drawer" id="mob-drawer">
  <div class="mob-drawer-title">KÄ±ble DedektÃ¶rÃ¼</div>
  <div class="mob-search-row">
    <input id="mob-city-input" type="text" placeholder="Åehir ara..."/>
    <button onclick="mobSearch()">Ara</button>
  </div>
  <div class="mob-drawer-section">
    <div class="mob-drawer-section-lbl">Harita</div>
    <button class="mob-drawer-btn active" id="mob-btn-dark"  onclick="switchLayer('dark');closeMobDrawer()">ğŸŒ‘ Koyu Harita</button>
    <button class="mob-drawer-btn"        id="mob-btn-sat"   onclick="switchLayer('satellite');closeMobDrawer()">ğŸ›° Uydu</button>
    <button class="mob-drawer-btn"        id="mob-btn-osm"   onclick="switchLayer('osm');closeMobDrawer()">ğŸ—º Standart</button>
  </div>
  <div class="mob-drawer-section">
    <div class="mob-drawer-section-lbl">AraÃ§lar</div>
    <button class="mob-drawer-btn" onclick="toggleHeatmap();closeMobDrawer()">ğŸŒ¡ IsÄ± HaritasÄ±</button>
    <button class="mob-drawer-btn" onclick="toggleScoreCard();closeMobDrawer()">ğŸ“Š Skor KartÄ±</button>
    <button class="mob-drawer-btn" onclick="openCompare();closeMobDrawer()">âš–ï¸ KarÅŸÄ±laÅŸtÄ±r</button>
    <button class="mob-drawer-btn" onclick="toggleHistoryMode();closeMobDrawer()">ğŸ“… Tarihsel Analiz</button>
    <button class="mob-drawer-btn" onclick="openLeaderboard();closeMobDrawer()">ğŸŒ KÃ¼resel SÄ±ralama</button>
    <button class="mob-drawer-btn" onclick="useMyLocation();closeMobDrawer()">ğŸ“ Konumum</button>
    <button class="mob-drawer-btn" onclick="openExport();closeMobDrawer()">ğŸ“¤ Export & PaylaÅŸ</button>
    <button class="mob-drawer-btn" onclick="openBiz();closeMobDrawer()">ğŸ’¼ Gelir & Paketler</button>
    <button class="mob-drawer-btn" onclick="openLab();closeMobDrawer()">ğŸ§ª QA & Lab</button>
    <button class="mob-drawer-btn" onclick="openCompass();closeMobDrawer()">ğŸ§­ CanlÄ± Pusula</button>
    <button class="mob-drawer-btn" id="mob-btn-follow" onclick="toggleFollowLock();closeMobDrawer()">ğŸ“ Beni Takip Et</button>
    <button class="mob-drawer-btn" onclick="loadNearbyCitySuggestions();closeMobDrawer()">ğŸ§­ YakÄ±nÄ±mdaki Åehirler</button>
    <button class="mob-drawer-btn" id="mob-btn-outdoor" onclick="toggleOutdoorMode();closeMobDrawer()">â˜€ï¸ Outdoor Mod</button>
    <div class="mob-search-row">
      <button onclick="setLang('tr')">TR</button>
      <button onclick="setLang('en')">EN</button>
    </div>
  </div>
</div>

<!-- â•â• EXPORT MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="exp-overlay" id="exp-overlay" onclick="expOverlayClick(event)">
  <div class="exp-modal">

    <div class="exp-header">
      <div class="exp-title">ğŸ“¤ Export & PaylaÅŸÄ±m</div>
      <button class="exp-close" onclick="closeExport()">âœ•</button>
    </div>

    <!-- Share URL -->
    <div class="exp-section">
      <div class="exp-section-title">ğŸ”— PaylaÅŸÄ±labilir URL</div>
      <div class="exp-url-row">
        <input class="exp-url-input" id="exp-url-input" type="text" readonly/>
        <button class="exp-copy-btn" id="exp-copy-url" onclick="copyShareUrl()">Kopyala</button>
      </div>
      <div class="exp-url-hint">URL'de ÅŸehir adÄ±, harita merkezi ve zoom seviyesi kaydedilir. PaylaÅŸÄ±lan kiÅŸi aynÄ± gÃ¶rÃ¼nÃ¼me gider.</div>
    </div>

    <!-- Summary -->
    <div class="exp-section">
      <div class="exp-section-title">ğŸ“Š Mevcut Veri Ã–zeti</div>
      <div class="exp-summary" id="exp-summary"></div>
    </div>

    <!-- Download buttons -->
    <div class="exp-section">
      <div class="exp-section-title">ğŸ’¾ Ä°ndir</div>
      <div class="exp-dl-grid">
        <button class="exp-dl-btn" onclick="exportJSON()">
          <span class="exp-dl-icon">{ }</span>
          <span class="exp-dl-label">JSON</span>
          <span class="exp-dl-desc">TÃ¼m cami verisi</span>
        </button>
        <button class="exp-dl-btn" onclick="exportCSV()">
          <span class="exp-dl-icon">âŠ</span>
          <span class="exp-dl-label">CSV</span>
          <span class="exp-dl-desc">Excel uyumlu</span>
        </button>
        <button class="exp-dl-btn" onclick="exportGeoJSON()">
          <span class="exp-dl-icon">ğŸ—º</span>
          <span class="exp-dl-label">GeoJSON</span>
          <span class="exp-dl-desc">QGIS / Mapbox</span>
        </button>
        <button class="exp-dl-btn" onclick="exportReport()">
          <span class="exp-dl-icon">ğŸ“‹</span>
          <span class="exp-dl-label">HTML Rapor</span>
          <span class="exp-dl-desc">Yeni sekmede aÃ§</span>
        </button>
        <button class="exp-dl-btn" onclick="shareScoreCard()">
          <span class="exp-dl-icon">ğŸ–¼</span>
          <span class="exp-dl-label">Skor KartÄ±</span>
          <span class="exp-dl-desc">GÃ¶rsel Ã¼ret & paylaÅŸ</span>
        </button>
      </div>
    </div>

    <div class="exp-footer">
      Veri kaynaÄŸÄ±: OpenStreetMap katkÄ±cÄ±larÄ± Â· ODbL lisansÄ±
    </div>
  </div>
</div>

<!-- â•â• BUSINESS / MONETIZATION MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="biz-overlay" id="biz-overlay" onclick="bizOverlayClick(event)">
  <div class="biz-modal">
    <div class="biz-header">
      <div class="biz-title">ğŸ’¼ Gelir KanallarÄ± (Ãœyeliksiz)</div>
      <button class="biz-close" onclick="closeBiz()">âœ•</button>
    </div>

    <div class="biz-section">
      <div class="biz-section-title">Sponsor AlanlarÄ± (AylÄ±k)</div>
      <div class="biz-grid">
        <div class="biz-card">
          <div class="biz-card-name">Bronz Sponsor</div>
          <div class="biz-card-price">7.500 TL / ay</div>
          <div class="biz-card-desc">Footer + modal iÃ§inde gÃ¶rÃ¼nÃ¼rlÃ¼k</div>
        </div>
        <div class="biz-card">
          <div class="biz-card-name">GÃ¼mÃ¼ÅŸ Sponsor</div>
          <div class="biz-card-price">15.000 TL / ay</div>
          <div class="biz-card-desc">Sidebar + ÅŸehir raporu ekranÄ±nda gÃ¶rÃ¼nÃ¼rlÃ¼k</div>
        </div>
        <div class="biz-card">
          <div class="biz-card-name">AltÄ±n Sponsor</div>
          <div class="biz-card-price">30.000 TL / ay</div>
          <div class="biz-card-desc">Header rozeti + rapor sayfasÄ± sponsor etiketi</div>
        </div>
      </div>
      <div class="biz-cta-row">
        <a class="biz-cta" href="mailto:sales@qibla-checker.app?subject=Sponsorluk%20Teklifi">Sponsorluk Talebi</a>
      </div>
    </div>

    <div class="biz-section">
      <div class="biz-section-title">Tek Seferlik SatÄ±ÅŸ</div>
      <div class="biz-inline">
        <span>Kurumsal PDF Rapor</span>
        <strong>2.500 TL</strong>
      </div>
      <div class="biz-inline">
        <span>Toplu Åehir Analizi (10 ÅŸehir)</span>
        <strong>12.000 TL</strong>
      </div>
      <div class="biz-cta-row">
        <a class="biz-cta primary" href="https://example.com/odeme-linki" target="_blank" rel="noopener">Ã–deme Linki (Demo)</a>
        <button class="biz-cta" onclick="openExport();closeBiz()">Ã–nce Ã–rnek Rapor GÃ¶r</button>
      </div>
    </div>

    <div class="biz-section">
      <div class="biz-section-title">B2B / White-Label Talebi</div>
      <div class="biz-form">
        <input id="biz-name" type="text" placeholder="Ad Soyad"/>
        <input id="biz-company" type="text" placeholder="Kurum / Åirket"/>
        <input id="biz-email" type="email" placeholder="E-posta"/>
        <textarea id="biz-msg" placeholder="Ä°htiyaÃ§: white-label, API, toplu analiz..."></textarea>
        <button class="biz-cta primary" onclick="bizSendLead()">Teklif Maili OluÅŸtur</button>
      </div>
      <div class="biz-hint">Not: Bu sÃ¼rÃ¼m backend iÃ§ermez. Buton varsayÄ±lan e-posta uygulamasÄ± ile taslak aÃ§ar.</div>
    </div>
  </div>
</div>

<!-- â•â• QA / INSIGHTS LAB â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="lab-overlay" id="lab-overlay" onclick="labOverlayClick(event)">
  <div class="lab-modal">
    <div class="lab-header">
      <div class="lab-title">ğŸ§ª QA & Ä°Ã§gÃ¶rÃ¼ LaboratuvarÄ±</div>
      <button class="lab-close" onclick="closeLab()">âœ•</button>
    </div>
    <div class="lab-grid">
      <div class="lab-card">
        <div class="lab-card-title">Åehir Ä°Ã§gÃ¶rÃ¼sÃ¼</div>
        <div id="lab-insights"></div>
      </div>
      <div class="lab-card">
        <div class="lab-card-title">Kalite KuyruÄŸu</div>
        <div id="lab-queue"></div>
      </div>
      <div class="lab-card">
        <div class="lab-card-title">SÃ¼rÃ¼m GeÃ§miÅŸi</div>
        <div id="lab-snapshots"></div>
      </div>
    </div>
  </div>
</div>

<!-- â•â• LIVE COMPASS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="cmps-overlay" id="cmps-overlay" onclick="compassOverlayClick(event)">
  <div class="cmps-modal">
    <div class="cmps-header">
      <div class="cmps-title">ğŸ§­ CanlÄ± Pusula</div>
      <button class="cmps-close" onclick="closeCompass()">âœ•</button>
    </div>
    <div class="cmps-body">
      <canvas id="cmps-canvas" width="260" height="260"></canvas>
      <div class="cmps-rows" id="cmps-rows"></div>
      <div class="cmps-actions">
        <button class="btn btn-sm" onclick="requestCompassPermission()">SensÃ¶r Ä°zni</button>
        <button class="btn btn-sm" onclick="refreshCompassLocation()">Konumu Yenile</button>
        <button class="btn btn-sm" id="btn-map-sync" onclick="toggleMapCompassSync()">HaritayÄ± DÃ¶ndÃ¼r</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â• 3D ANALYSIS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="m3d-overlay" id="m3d-overlay" onclick="m3dOverlayClick(event)">
  <div class="m3d-modal">
    <div class="m3d-header">
      <div class="m3d-title">ğŸ— 3D YÃ¶n Analizi (Deneysel)</div>
      <button class="m3d-close" onclick="close3D()">âœ•</button>
    </div>
    <div class="m3d-wrap">
      <canvas id="m3d-canvas"></canvas>
      <div class="m3d-side" id="m3d-side"></div>
    </div>
  </div>
</div>

<!-- â•â• KEYBOARD SHORTCUTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="ks-overlay" id="ks-overlay" onclick="ksOverlayClick(event)">
  <div class="ks-modal">
    <div class="ks-title">
      âŒ¨ï¸ Klavye KÄ±sayollarÄ±
      <button class="ks-close-btn" onclick="closeShortcuts()">âœ•</button>
    </div>
    <div class="ks-grid">
      <div class="ks-row"><span class="ks-key">/</span><span class="ks-desc">Åehir arama</span></div>
      <div class="ks-row"><span class="ks-key">Enter</span><span class="ks-desc">Ara / Onayla</span></div>
      <div class="ks-row"><span class="ks-key">Esc</span><span class="ks-desc">Panel / Modal kapat</span></div>
      <div class="ks-row"><span class="ks-key">?</span><span class="ks-desc">Bu yardÄ±m ekranÄ±</span></div>
      <div class="ks-row"><span class="ks-key">H</span><span class="ks-desc">IsÄ± haritasÄ±</span></div>
      <div class="ks-row"><span class="ks-key">S</span><span class="ks-desc">Skor kartÄ±</span></div>
      <div class="ks-row"><span class="ks-key">T</span><span class="ks-desc">Tarihsel analiz</span></div>
      <div class="ks-row"><span class="ks-key">L</span><span class="ks-desc">SÄ±ralama tablosu</span></div>
      <div class="ks-row"><span class="ks-key">Q</span><span class="ks-desc">QA & lab paneli</span></div>
      <div class="ks-row"><span class="ks-key">O</span><span class="ks-desc">CanlÄ± pusula</span></div>
      <div class="ks-row"><span class="ks-key">P</span><span class="ks-desc">Gelir / paket modalÄ±</span></div>
      <div class="ks-row"><span class="ks-key">G</span><span class="ks-desc">Konumuma git</span></div>
      <div class="ks-row"><span class="ks-key">â†</span><span class="ks-desc">Ã–nceki cami</span></div>
      <div class="ks-row"><span class="ks-key">â†’</span><span class="ks-desc">Sonraki cami</span></div>
      <div class="ks-row"><span class="ks-key">+/-</span><span class="ks-desc">Tolerans artÄ±r/azalt</span></div>
      <div class="ks-row"><span class="ks-key">D</span><span class="ks-desc">Detay paneli kapat</span></div>
    </div>
    <div class="ks-footer">TÃ¼m kÄ±sayollar â€” metin giriÅŸi aktifken devre dÄ±ÅŸÄ±</div>
  </div>
</div>

<div class="stats-bar">
  <div class="stat"><div class="dot gold"></div><div class="stat-num" id="s-total">â€”</div><div class="stat-lbl">Cami</div></div>
  <div class="stat"><div class="dot green"></div><div class="stat-num" id="s-ok">â€”</div><div class="stat-lbl">DoÄŸru</div></div>
  <div class="stat"><div class="dot red"></div><div class="stat-num" id="s-bad">â€”</div><div class="stat-lbl">Sapma</div></div>
  <div class="stat"><div class="dot amber"></div><div class="stat-num" id="s-unk">â€”</div><div class="stat-lbl">Veri Yok</div></div>
  <div class="vp-status">
    <div class="vp-dot" id="vp-dot"></div>
    <span id="vp-label">HazÄ±r</span>
  </div>
  <div class="map-switch" id="axis-switch">
    <button id="axis-final" class="active" onclick="setAxisMode('final')">Final</button>
    <button id="axis-raw" onclick="setAxisMode('raw')">Raw</button>
    <button id="axis-interior" onclick="setAxisMode('interior')">Inside</button>
  </div>
  <div class="cache-info">Cache: <span id="cache-count">0</span> tile</div>
  <div class="tol">Tolerans:<input type="range" id="tol" min="5" max="45" value="15"><span id="tol-val">15Â°</span></div>
</div>

<div class="main">
  <div id="map">
    <div class="mob-layer-stack" id="mob-layer-stack">
      <button class="mob-layer-btn active" id="mob-fab-dark" onclick="switchLayer('dark')" aria-label="Koyu harita">ğŸŒ‘ Koyu</button>
      <button class="mob-layer-btn" id="mob-fab-sat" onclick="switchLayer('satellite')" aria-label="Uydu harita">ğŸ›° Uydu</button>
      <button class="mob-layer-btn" id="mob-fab-osm" onclick="switchLayer('osm')" aria-label="Standart harita">ğŸ—º Harita</button>
    </div>
    <button class="compass-fab" id="compass-fab" onclick="toggleLiveMapCompass()" aria-label="CanlÄ± pusula modu">ğŸ§­</button>
    <!-- Mini non-blocking loader -->
    <div class="mini-loader" id="mini-loader">
      <div class="mini-spin"></div>
      <span id="mini-text">YÃ¼kleniyor...</span>
    </div>
    <!-- KÄ±ble animation info panel -->
    <div class="qibla-panel" id="qibla-panel">
      <div class="qp-name" id="qp-name">â€”</div>
      <div class="qp-row"><span class="qp-k" style="color:#c9a84c">â”€â”€</span><span class="qp-v" id="qp-angle" style="font-size:10px">â€”</span></div>
      <div class="qp-row"><span class="qp-k" style="color:#7c6ad8">â”€â”€</span><span class="qp-v" id="qp-diff" style="font-size:10px">â€”</span></div>
      <div class="qp-row"><span class="qp-k">Kabe</span><span class="qp-v" id="qp-dist">â€”</span></div>
      <div class="qp-anim" id="qp-anim-status">â— KÄ±ble Ã§izgisi Ã§iziliyor...</div>
    </div>

    <!-- Score Card Panel -->
    <div class="score-card" id="score-card">
      <div class="sc-close" onclick="toggleScoreCard()">âœ•</div>
      <div class="sc-city" id="sc-city">â€”</div>
      <div class="sc-score-wrap">
        <canvas id="sc-donut" width="110" height="110"></canvas>
        <div class="sc-score-center">
          <div class="sc-pct" id="sc-pct">â€”</div>
          <div class="sc-pct-lbl">doÄŸruluk</div>
        </div>
      </div>
      <div class="sc-grade" id="sc-grade"></div>
      <div class="sc-stats">
        <div class="sc-stat-row">
          <span class="sc-dot" style="background:#4ade80"></span>
          <span class="sc-stat-lbl">DoÄŸru yÃ¶n</span>
          <span class="sc-stat-val" id="sc-ok">â€”</span>
        </div>
        <div class="sc-stat-row">
          <span class="sc-dot" style="background:#f87171"></span>
          <span class="sc-stat-lbl">Sapma var</span>
          <span class="sc-stat-val" id="sc-bad">â€”</span>
        </div>
        <div class="sc-stat-row">
          <span class="sc-dot" style="background:#fbbf24"></span>
          <span class="sc-stat-lbl">Veri yok</span>
          <span class="sc-stat-val" id="sc-unk">â€”</span>
        </div>
        <div class="sc-stat-row" style="border-top:1px solid var(--border);margin-top:6px;padding-top:6px;">
          <span class="sc-stat-lbl" style="color:var(--muted)">Ort. sapma</span>
          <span class="sc-stat-val" id="sc-avg">â€”</span>
        </div>
        <div class="sc-stat-row">
          <span class="sc-stat-lbl" style="color:var(--muted)">Maks. sapma</span>
          <span class="sc-stat-val" id="sc-max">â€”</span>
        </div>
        <div class="sc-stat-row">
          <span class="sc-stat-lbl" style="color:var(--muted)">Min. sapma</span>
          <span class="sc-stat-val" id="sc-min">â€”</span>
        </div>
      </div>
      <div class="sc-best-worst">
        <div class="sc-bw-label">En Ä°yi â†‘</div>
        <div class="sc-bw-name" id="sc-best">â€”</div>
        <div class="sc-bw-label" style="margin-top:6px">En KÃ¶tÃ¼ â†“</div>
        <div class="sc-bw-name" id="sc-worst" style="color:var(--red)">â€”</div>
      </div>
      <div class="sc-tolerance">Tolerans: <span id="sc-tol-val">15Â°</span> ile hesaplandÄ±</div>
    </div>
  </div>
  <div class="sidebar">
    <div class="sb-head" id="sb-head-handle">
      <span>Cami Listesi</span>
      <span class="sb-count" id="sb-count"></span>
    </div>
    <div class="sb-snap-panels">
      <div class="sb-mini-panel" id="sb-mini-panel">
        <div class="sb-mini-title">Genel Skor</div>
        <div class="sb-mini-city" id="sb-mini-city">â€”</div>
        <div class="sb-mini-score" id="sb-mini-score">â€”</div>
        <div class="sb-mini-sub" id="sb-mini-sub">Veri bekleniyor</div>
      </div>
      <div class="sb-half-panel" id="sb-half-panel">
        <div class="sb-mini-title">Ä°statistik & Radar</div>
        <div class="sb-half-grid">
          <div class="sb-half-metrics">
            <div class="sb-half-row"><span>Toplam</span><b id="sb-m-total">â€”</b></div>
            <div class="sb-half-row"><span>DoÄŸruluk</span><b id="sb-m-pct">â€”</b></div>
            <div class="sb-half-row"><span>Ort. Sapma</span><b id="sb-m-avg">â€”</b></div>
            <div class="sb-half-row"><span>Maks Sapma</span><b id="sb-m-max">â€”</b></div>
          </div>
          <canvas id="sb-radar" width="108" height="108"></canvas>
        </div>
      </div>
    </div>
    <div class="ms-wrap" id="ms-wrap">
      <div class="ms-box">
        <span class="ms-icon">ğŸ”</span>
        <input id="mosque-search" type="text" placeholder="Cami adÄ± ara..." autocomplete="off" spellcheck="false"/>
        <button id="ms-clear" onclick="clearMosqueSearch()">âœ•</button>
      </div>
      <div class="ms-scope">
        <span class="ms-scope-lbl"><b>Bu alanda ara</b> (harita gÃ¶rÃ¼nÃ¼mÃ¼)</span>
        <label class="ms-switch" for="ms-scope-only">
          <input id="ms-scope-only" type="checkbox" checked/>
          <span class="ms-switch-track"></span>
        </label>
      </div>
      <div class="ms-dropdown" id="ms-dropdown"></div>
    </div>
    <div class="ms-filter-banner" id="ms-banner">
      <span id="ms-banner-text"></span>
      <button onclick="clearMosqueSearch()">âœ• Filtreyi KaldÄ±r</button>
    </div>
    <div class="pull-refresh" id="sb-pull-indicator">BÄ±rakÄ±nca yenilenecek</div>
    <div class="mosque-list" id="mosque-list">
      <div class="empty"><div class="empty-icon">ğŸ•Œ</div><div>Bir ÅŸehir arayÄ±n</div></div>
    </div>
    <div class="legend">
      <div style="font-size:9px;letter-spacing:.1em;text-transform:uppercase;margin-bottom:3px;">AÃ§Ä±klama</div>
      <div class="leg-row"><div class="leg-line" style="background:#4ade80"></div><span>KÄ±ble yÃ¶nÃ¼nde</span></div>
      <div class="leg-row"><div class="leg-line" style="background:#f87171"></div><span>Sapma var</span></div>
      <div class="leg-row"><div class="leg-line" style="background:transparent;border-top:1px dashed #c9a84c;height:0;width:22px"></div><span>GerÃ§ek kÄ±ble yÃ¶nÃ¼</span></div>
      <div class="leg-row"><div class="leg-line" style="background:rgba(201,168,76,.6)"></div><span>Bina kÄ±ble duvarÄ±</span></div>
      <div class="leg-row"><div class="leg-line" style="background:#7c6ad8"></div><span>BinanÄ±n gerÃ§ek baktÄ±ÄŸÄ± yÃ¶n</span></div>
      <div class="leg-row"><div class="leg-line" style="background:transparent;border-top:2px dashed #c9a84c;height:0;width:22px"></div><span>Kabe'ye bÃ¼yÃ¼k daire (doÄŸru)</span></div>
    </div>
  </div>
</div>

<div class="overlay" id="overlay">
  <div class="spinner"></div>
  <div class="ov-text" id="ov-text">YÃ¼kleniyor...</div>
  <div class="ov-sub" id="ov-sub"></div>
</div>
<div class="toast" id="toast"></div>
<script src="./vendor/leaflet/leaflet.js"></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const KAABA = { lat: 21.4225, lng: 39.8262 };

// â”€â”€ Tile cache: stores loaded bbox cells to avoid duplicate queries
// Key: "lat_lng_zoom" grid cell (0.05Â° grid), Value: true
const tileCache = new Set();
// All processed mosque data (keyed by OSM id)
const mosqueDB = new Map();

let tol = 15;
let map = null;
let tileLayer = null;
let renderLayers = [];
let animLayers = [];
let vpDebounceTimer = null;
let vpNeedsReload = false;
let isVpLoading = false;
let heatLayer = null;
let heatVisible = false;
let scoreCardVisible = false;
let currentCity = '';
let denseModeNotified = false;
const wikidataLabelCache = new Map();
const NAME_ENRICH_KEY = 'qibla-name-enrich-v1';
const INTERIOR_KEY = 'qibla-interior-v1';
const SNAPSHOT_KEY = 'qibla-snapshots-v1';
const LANG_KEY = 'qibla-lang-v1';
const MANUAL_AXIS_KEY = 'qibla-manual-axis-v1';
const OUTDOOR_KEY = 'qibla-outdoor-v1';
const GEO_PROMPT_KEY = 'qibla-geo-prompt-v1';
const nameEnrichCache = new Map();
const nameEnrichQueue = [];
const nameEnrichQueued = new Set();
let nameEnrichRunning = false;
let interiorDB = {};
let analysisLayerMode = 'final'; // final | raw | interior
let snapshots = [];
let currentLang = 'tr';
let manualAxisDB = {};
let manualCapture = { active:false, markers:[], line:null, points:[] };
let compassState = { running:false, heading:null, qibla:null, loc:null, watchId:null };
let followState = { enabled:false, watchId:null, lastFixAt:0 };
let userGeoState = { lat:null, lng:null, enabled:false, ts:0 };
let uiState = { mapSyncWithCompass:false, outdoor:false, pullRefreshing:false, sheetSnap:20, liveMapCompass:false };
let m3dState = { renderer:null, scene:null, camera:null, raf:0, obj:null };
const API_RATE = {
  nominatim: { nextAt:0, cooldown:0, minInterval:1100 },
  overpass: { nextAt:0, cooldown:0, minInterval:500 }
};

function haptic(ms = 10) {
  try {
    if (navigator.vibrate) navigator.vibrate(Math.max(5, Math.min(50, ms|0)));
  } catch {}
}

function setUserGeoState(lat, lng, enabled = true) {
  if (!Number.isFinite(lat) || !Number.isFinite(lng)) return;
  userGeoState.lat = lat;
  userGeoState.lng = lng;
  userGeoState.enabled = !!enabled;
  userGeoState.ts = Date.now();
}

function safeStorageGet(key, fallback = null) {
  try {
    const raw = localStorage.getItem(key);
    return raw == null ? fallback : raw;
  } catch {
    return fallback;
  }
}

function trimObjectByCount(obj, max = 300) {
  if (!obj || typeof obj !== 'object') return obj;
  const entries = Object.entries(obj);
  if (entries.length <= max) return obj;
  entries.sort((a,b) => (b[1]?.at || b[1]?.ts || b[1]?.time || 0) - (a[1]?.at || a[1]?.ts || a[1]?.time || 0));
  return Object.fromEntries(entries.slice(0, max));
}

function storageCleanup() {
  try {
    const rawSnaps = safeStorageGet(SNAPSHOT_KEY, '[]');
    let snaps = [];
    try { snaps = JSON.parse(rawSnaps) || []; } catch {}
    if (Array.isArray(snaps) && snaps.length > 80) localStorage.setItem(SNAPSHOT_KEY, JSON.stringify(snaps.slice(-80)));

    const rawName = safeStorageGet(NAME_ENRICH_KEY, '{}');
    let nameObj = {};
    try { nameObj = JSON.parse(rawName) || {}; } catch {}
    localStorage.setItem(NAME_ENRICH_KEY, JSON.stringify(trimObjectByCount(nameObj, 600)));

    const rawInt = safeStorageGet(INTERIOR_KEY, '{}');
    let intObj = {};
    try { intObj = JSON.parse(rawInt) || {}; } catch {}
    localStorage.setItem(INTERIOR_KEY, JSON.stringify(trimObjectByCount(intObj, 220)));

    const rawManual = safeStorageGet(MANUAL_AXIS_KEY, '{}');
    let manObj = {};
    try { manObj = JSON.parse(rawManual) || {}; } catch {}
    localStorage.setItem(MANUAL_AXIS_KEY, JSON.stringify(trimObjectByCount(manObj, 380)));

    const lbKey = 'qibla-leaderboard-v2';
    const rawLb = safeStorageGet(lbKey, '[]');
    let lb = [];
    try { lb = JSON.parse(rawLb) || []; } catch {}
    if (Array.isArray(lb) && lb.length > 320) localStorage.setItem(lbKey, JSON.stringify(lb.slice(0, 320)));
  } catch {}
}

function safeStorageSet(key, value) {
  try {
    localStorage.setItem(key, value);
    return true;
  } catch {
    storageCleanup();
    try {
      localStorage.setItem(key, value);
      return true;
    } catch {
      return false;
    }
  }
}

async function limitedFetch(url, opts = {}, policy = {}) {
  const hostKey = policy.hostKey || (String(url).includes('nominatim') ? 'nominatim' : 'overpass');
  const st = API_RATE[hostKey] || { nextAt:0, cooldown:0, minInterval:650 };
  const retries = Number.isFinite(policy.retries) ? policy.retries : 2;
  const timeoutMs = Number.isFinite(policy.timeoutMs) ? policy.timeoutMs : 30000;
  const baseBackoff = Number.isFinite(policy.backoffMs) ? policy.backoffMs : 900;
  st.minInterval = Math.max(st.minInterval || 0, policy.minInterval || st.minInterval || 450);
  API_RATE[hostKey] = st;

  for (let i = 0; i <= retries; i++) {
    const wait = Math.max(0, (st.nextAt || 0) - Date.now());
    if (wait > 0) await new Promise(r => setTimeout(r, wait));
    const ctrl = new AbortController();
    const timer = setTimeout(() => ctrl.abort(), timeoutMs);
    try {
      const r = await fetch(url, { ...opts, signal: ctrl.signal });
      clearTimeout(timer);
      if (r.status === 429 || r.status === 503) {
        st.cooldown = Math.min(12000, Math.max(1100, st.cooldown ? st.cooldown * 1.65 : 1200));
        st.nextAt = Date.now() + st.cooldown + Math.round(Math.random() * 350);
        if (i < retries) continue;
      } else {
        st.cooldown = Math.max(0, Math.floor((st.cooldown || 0) * 0.55));
        st.nextAt = Date.now() + st.minInterval;
      }
      return r;
    } catch (e) {
      clearTimeout(timer);
      if (i >= retries) throw e;
      const pause = baseBackoff * Math.pow(1.6, i) + Math.round(Math.random()*220);
      st.nextAt = Date.now() + pause;
      await new Promise(r => setTimeout(r, pause));
    }
  }
  throw new Error('AÄŸ isteÄŸi sÄ±nÄ±r nedeniyle baÅŸarÄ±sÄ±z');
}

async function nominatimFetchJson(url, headers = {}) {
  const r = await limitedFetch(url, { headers:{'User-Agent':'QiblaChecker/1.0', ...headers} }, { hostKey:'nominatim', minInterval:1100, retries:2, timeoutMs:22000, backoffMs:1100 });
  if (!r.ok) throw new Error(`Nominatim HTTP ${r.status}`);
  return r.json();
}

const TILES = {
  dark:      { url:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',         opts:{ attribution:'Â©OSM Â©CartoDB', subdomains:'abcd', maxZoom:19 } },
  satellite: { url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', opts:{ attribution:'Â©Esri Â©OSM', maxZoom:19 } },
  osm:       { url:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',                   opts:{ attribution:'Â©OSM', subdomains:'abc', maxZoom:19 } }
};
let currentLayer = 'dark';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BOOTSTRAP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadScript(src) {
  return new Promise((res,rej) => {
    const s = document.createElement('script');
    s.src = src;
    s.async = true;
    const timer = setTimeout(() => {
      try { s.remove(); } catch {}
      rej(new Error('timeout ' + src));
    }, 9000);
    s.onload = () => { clearTimeout(timer); res(); };
    s.onerror = () => { clearTimeout(timer); rej(new Error('load failed ' + src)); };
    document.head.appendChild(s);
  });
}

async function bootstrap() {
  loadNameEnrichCache();
  loadInteriorDB();
  loadManualAxisDB();
  loadSnapshots();
  const langSaved = safeStorageGet(LANG_KEY, 'tr') || 'tr';
  const outdoorSaved = safeStorageGet(OUTDOOR_KEY, '0');
  if (String(outdoorSaved) === '1') {
    uiState.outdoor = true;
    document.body.classList.add('outdoor-mode');
  }
  document.getElementById('btn-outdoor')?.classList.toggle('active', uiState.outdoor);
  document.getElementById('mob-btn-outdoor')?.classList.toggle('active', uiState.outdoor);
  setLang(langSaved, true);
  setOv(true,'Harita yÃ¼kleniyor...','Leaflet.js baÅŸlatÄ±lÄ±yor');
  if (!window.L || !window.L.map) {
    setOv(false);
    toast('âŒ Harita kÃ¼tÃ¼phanesi bulunamadÄ± (lokal dosya eksik)', 9000);
    return;
  }
  try {
    initMap();
  } catch (e) {
    setOv(false);
    toast('âŒ BaÅŸlatma hatasÄ±: ' + (e?.message || 'bilinmeyen'), 9000);
    console.error(e);
  }
}

function initMap() {
  map = L.map('map', { center:[41.015,28.979], zoom:13 });
  tileLayer = L.tileLayer(TILES.dark.url, TILES.dark.opts).addTo(map);

  // Kaaba marker (permanent)
  L.circleMarker([KAABA.lat,KAABA.lng],{ radius:9,fillColor:'#c9a84c',color:'#e8c97a',weight:2,fillOpacity:1 })
    .addTo(map).bindPopup('<div style="font-family:monospace;color:#c9a84c;font-weight:700">ğŸ•‹ KÃ¢be<br><small style="color:#888">21.4225Â°N 39.8262Â°E</small></div>');

  // â”€â”€ VIEWPORT EVENTS â€” debounced auto-load
  map.on('moveend zoomend', () => {
    clearTimeout(vpDebounceTimer);
    // Zoom < 11 â†’ too wide, skip auto-load
    if (map.getZoom() < 11) { setVpStatus('idle'); return; }
    // Repaint immediately for already-cached data in current view.
    if (mosqueDB.size) renderAll();
    vpDebounceTimer = setTimeout(loadViewport, 3000);
  });
  map.on('moveend zoomend', updateHashFromMap);
  map.on('dragstart', () => {
    if (followState.enabled) {
      stopFollowLock(true);
      toast('Takip kilidi manuel kaydÄ±rma ile kapatÄ±ldÄ±', 2200);
    }
  });

  // Wire buttons
  document.getElementById('search-btn').onclick = doSearch;
  document.getElementById('loc-btn').onclick    = useMyLocation;
  document.getElementById('city-input').onkeydown = e => {
    if (e.key !== 'Enter') return;
    const dd = document.getElementById('city-smart-dd');
    if (dd?.classList.contains('show') && cityDropdownIdx >= 0) return;
    doSearch();
  };
  document.getElementById('tol').oninput = e => { tol=+e.target.value; document.getElementById('tol-val').textContent=tol+'Â°'; recompute(); };
  const mq = document.getElementById('mob-quick-city');
  if (mq) mq.value = document.getElementById('city-input').value || '';

  // Init mosque search
  initMosqueSearch();
  initTopSmartSearch();
  initSidebarPullToRefresh();
  initSidebarSnapSheet();

  // Close qibla panel on map click (not on marker)
  map.on('click', hideQiblaPanel);

  // Always start from clean home state on refresh/load (no hash restore, empty search).
  _hashUpdating = true;
  history.replaceState(null, '', location.pathname);
  _hashUpdating = false;
  currentCity = '';
  document.getElementById('city-input').value = '';
  if (mq) mq.value = '';
  setOv(false);
  if (map.getZoom() >= 11) {
    vpDebounceTimer = setTimeout(loadViewport, 3000);
  }
}

async function autoLocateOnStartup() {
  if (!navigator.geolocation) return false;
  const pref = safeStorageGet(GEO_PROMPT_KEY, '');
  if (pref === 'denied') return false;
  try {
    if (!navigator.permissions?.query) {
      const ok = await useMyLocation({ showToast:false, source:'auto' });
      safeStorageSet(GEO_PROMPT_KEY, ok ? 'granted' : 'denied');
      return ok;
    }
    const perm = await navigator.permissions.query({ name:'geolocation' });
    if (perm.state === 'granted') {
      const ok = await useMyLocation({ showToast:false, source:'auto' });
      safeStorageSet(GEO_PROMPT_KEY, ok ? 'granted' : 'denied');
      return ok;
    }
    if (perm.state === 'prompt') {
      const ok = await useMyLocation({ showToast:false, source:'auto' });
      safeStorageSet(GEO_PROMPT_KEY, ok ? 'granted' : 'denied');
      return ok;
    }
    safeStorageSet(GEO_PROMPT_KEY, 'denied');
    return false;
  } catch {
    return false;
  }
}

function switchLayer(type) {
  if (!map||type===currentLayer) return;
  currentLayer=type;
  if(tileLayer) map.removeLayer(tileLayer);
  tileLayer = L.tileLayer(TILES[type].url,TILES[type].opts).addTo(map);
  tileLayer.bringToBack();
  setLayerButtonActive(type);
}

function setLayerButtonActive(type) {
  const normalized = type === 'satellite' ? 'sat' : type;
  const ids = ['btn-'+normalized, 'mob-btn-'+normalized, 'mob-fab-'+normalized];
  ['dark','sat','osm'].forEach(key => {
    const targets = ['btn-'+key, 'mob-btn-'+key, 'mob-fab-'+key];
    targets.forEach(id => document.getElementById(id)?.classList.remove('active'));
  });
  ids.forEach(id => document.getElementById(id)?.classList.add('active'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TILE CACHE SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Divide world into 0.08Â° grid cells. Track which cells are loaded.
const GRID = 0.08;

function boundsToGridCells(bounds) {
  const cells = [];
  const s = Math.floor(bounds.getSouth()/GRID)*GRID;
  const n = Math.ceil(bounds.getNorth()/GRID)*GRID;
  const w = Math.floor(bounds.getWest()/GRID)*GRID;
  const e = Math.ceil(bounds.getEast()/GRID)*GRID;
  for (let la=s; la<n; la+=GRID)
    for (let ln=w; ln<e; ln+=GRID)
      cells.push({ key:`${la.toFixed(3)}_${ln.toFixed(3)}`, lat:la+GRID/2, lng:ln+GRID/2 });
  return cells;
}

function getUncachedCells(bounds) {
  return boundsToGridCells(bounds).filter(c => !tileCache.has(c.key));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VIEWPORT AUTO-LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadViewport(opts = {}) {
  if (isVpLoading) {
    vpNeedsReload = true;
    return;
  }
  if (map.getZoom() < 11) {
    setVpStatus('idle');
    return;
  }
  const bounds = map.getBounds();
  const center = bounds.getCenter();
  const newCells = getUncachedCells(bounds).sort((a, b) => {
    const da = Math.pow(a.lat - center.lat, 2) + Math.pow(a.lng - center.lng, 2);
    const db = Math.pow(b.lat - center.lat, 2) + Math.pow(b.lng - center.lng, 2);
    return da - db;
  });
  if (!newCells.length) {
    // No new fetch needed, but viewport may have changed.
    if (mosqueDB.size) renderAll();
    setVpStatus('done');
    return;
  }

  isVpLoading = true;
  setVpStatus('loading');
  const batchSize = Number.isFinite(opts.batchSize) ? Math.max(1, opts.batchSize | 0) : 10;
  const concurrency = Number.isFinite(opts.concurrency) ? Math.max(1, opts.concurrency | 0) : 2;
  const batch = newCells.slice(0, batchSize);
  showMini(`${batch.length}/${newCells.length} alan yÃ¼kleniyor...`);
  showSkeletonList();

  try {
    // Fetch per-grid-cell so moving around always loads local area deterministically.
    let cursor = 0;
    const workers = Array.from({ length: Math.min(concurrency, batch.length) }, async () => {
      while (cursor < batch.length) {
        const c = batch[cursor++];
        const half = GRID / 2;
        const pad = GRID * 0.05;
        const s = c.lat - half - pad;
        const n = c.lat + half + pad;
        const w = c.lng - half - pad;
        const e = c.lng + half + pad;
        try {
          const elements = await fetchBbox(s, w, n, e, opts.fetchPolicy || { retries:1, timeoutMs:22000, backoffMs:700, minInterval:340 });
          processElements(elements);
          tileCache.add(c.key);
        } catch (err) {
          // Keep cell uncached so it can retry on next viewport load.
          console.warn('cell fetch failed', c.key, err?.message || err);
        }
      }
    });
    await Promise.all(workers);
    updateCacheUI();
    renderAll();
    setVpStatus('done');
    if (newCells.length > batch.length) {
      clearTimeout(vpDebounceTimer);
      vpDebounceTimer = setTimeout(loadViewport, 120);
    }
  } catch(err) {
    setVpStatus('idle');
    toast('Veri yÃ¼klenirken hata: '+err.message, 5000);
    console.error(err);
  }

  hideMini();
  isVpLoading = false;
  if (vpNeedsReload) {
    vpNeedsReload = false;
    clearTimeout(vpDebounceTimer);
    vpDebounceTimer = setTimeout(loadViewport, 120);
  }
}

function showSkeletonList() {
  const el = document.getElementById('mosque-list');
  el.innerHTML = Array(6).fill(0).map((_,i) => `
    <div class="sk-item" style="animation-delay:${i*60}ms">
      <div class="sk-dot"></div>
      <div class="sk-line sk-name" style="width:${55+Math.random()*30|0}%"></div>
      <div class="sk-line sk-diff"></div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  OSM API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const OVERPASS_ENDPOINTS = [
  'https://overpass-api.de/api/interpreter',
  'https://overpass.kumi.systems/api/interpreter',
  'https://lz4.overpass-api.de/api/interpreter'
];

function buildMosqueQuery(s,w,n,e) {
  return `[out:json][timeout:60];
(
  way["amenity"="place_of_worship"]["religion"~"muslim|islam",i](${s},${w},${n},${e});
  node["amenity"="place_of_worship"]["religion"~"muslim|islam",i](${s},${w},${n},${e});
  relation["amenity"="place_of_worship"]["religion"~"muslim|islam",i](${s},${w},${n},${e});
  way["amenity"="place_of_worship"]["denomination"~"sunni|shia|ibadi",i](${s},${w},${n},${e});
  node["amenity"="place_of_worship"]["denomination"~"sunni|shia|ibadi",i](${s},${w},${n},${e});
  relation["amenity"="place_of_worship"]["denomination"~"sunni|shia|ibadi",i](${s},${w},${n},${e});
  way["amenity"="mosque"](${s},${w},${n},${e});
  node["amenity"="mosque"](${s},${w},${n},${e});
  relation["amenity"="mosque"](${s},${w},${n},${e});
  way["building"="mosque"](${s},${w},${n},${e});
  node["building"="mosque"](${s},${w},${n},${e});
  relation["building"="mosque"](${s},${w},${n},${e});
  way["place_of_worship"="mosque"](${s},${w},${n},${e});
  node["place_of_worship"="mosque"](${s},${w},${n},${e});
  relation["place_of_worship"="mosque"](${s},${w},${n},${e});
  way["mosque"](${s},${w},${n},${e});
  node["mosque"](${s},${w},${n},${e});
  relation["mosque"](${s},${w},${n},${e});
);
out body geom qt 3000;`;
}

async function fetchOverpassQuery(query, policy = {}) {
  let lastErr = null;
  for (const endpoint of OVERPASS_ENDPOINTS) {
    try {
      const r = await limitedFetch(endpoint, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:'data='+encodeURIComponent(query)
      }, {
        hostKey:'overpass',
        minInterval: Number.isFinite(policy.minInterval) ? policy.minInterval : 500,
        retries: Number.isFinite(policy.retries) ? policy.retries : 2,
        timeoutMs: Number.isFinite(policy.timeoutMs) ? policy.timeoutMs : 46000,
        backoffMs: Number.isFinite(policy.backoffMs) ? policy.backoffMs : 900
      });
      if(!r.ok) throw new Error(`HTTP ${r.status} @ ${endpoint}`);
      const d = await r.json();
      return d.elements || [];
    } catch (e) {
      lastErr = e;
    }
  }
  throw new Error(lastErr?.message || 'Overpass yanÄ±t vermedi');
}

async function fetchBbox(s,w,n,e,policy={}) {
  return fetchOverpassQuery(buildMosqueQuery(s,w,n,e), policy);
}

function pickBestGeocodeResult(items, name) {
  if (!items?.length) return null;
  const q = trLower(name || '').trim();
  const mosqueMode = isLikelyMosqueQuery(name);
  const ranked = items.map(it => {
    const disp = trLower(it.display_name || '');
    const type = trLower(it.type || '');
    const cls  = trLower(it.class || '');
    let score = Number(it.importance || 0) * 100;
    if (disp.startsWith(q + ',')) score += 80;
    if (disp.includes(',' + q + ',')) score += 35;
    if (disp.includes(q)) score += 18;
    if (['city','town','village','municipality','county','state','province'].includes(type)) score += mosqueMode ? 4 : 22;
    if (cls === 'place' || cls === 'boundary') score += 12;
    if (mosqueMode) {
      if (cls === 'amenity' && (type === 'place_of_worship' || type === 'mosque')) score += 60;
      if (disp.includes('cami') || disp.includes('mosque') || disp.includes('mescid') || disp.includes('mescit') || disp.includes('masjid')) score += 30;
    }
    return { it, score };
  }).sort((a,b) => b.score - a.score);
  return ranked[0]?.it || items[0];
}

async function geocode(name) {
  const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(name)}&format=json&limit=8&addressdetails=1`;
  const headerVariants = [
    {'Accept-Language':'tr,en','User-Agent':'QiblaChecker/1.0'},
    {'Accept-Language':'en','User-Agent':'QiblaChecker/1.0'},
    {'User-Agent':'QiblaChecker/1.0'}
  ];

  let lastErr = null;
  for (const headers of headerVariants) {
    try {
      const d = await nominatimFetchJson(url, headers);
      const best = pickBestGeocodeResult(d, name);
      if (!best) continue;
      return {
        lat:+best.lat,
        lng:+best.lon,
        bbox: Array.isArray(best.boundingbox) ? best.boundingbox.map(Number) : null,
        osmClass: best.class || '',
        osmType: best.type || '',
        displayName: best.display_name || ''
      };
    } catch (e) {
      lastErr = e;
    }
  }
  throw new Error('Åehir bulunamadÄ±: ' + name + (lastErr ? ` (${lastErr.message})` : ''));
}

async function fetchCityFallback(lat, lng) {
  // Kademeli arama: kÃ¼Ã§Ã¼k ÅŸehir merkezinden baÅŸlayÄ±p daha geniÅŸ kutuya Ã§Ä±kar.
  const radii = [0.06, 0.12, 0.22, 0.35]; // ~6km, 13km, 24km, 39km (enleme gÃ¶re deÄŸiÅŸir)
  const unique = new Map();

  for (const r of radii) {
    const elements = await fetchBbox(lat-r, lng-r, lat+r, lng+r);
    for (const el of elements) {
      unique.set(`${el.type}:${el.id}`, el);
    }
    if (unique.size >= 40) break;
  }
  return [...unique.values()];
}

function parseDirectMosqueQuery(q) {
  const t = (q || '').trim();
  const osm = t.match(/^(node|way|relation)\s*[:#]?\s*(\d+)$/i);
  if (osm) return { type:'osm', osmType:osm[1].toLowerCase(), id:osm[2] };
  const qid = t.match(/^Q\d+$/i);
  if (qid) return { type:'wikidata', qid:qid[0].toUpperCase() };
  return null;
}

async function fetchByOsmId(osmType, id) {
  const q = `[out:json][timeout:35];${osmType}(${id});out body geom tags center;`;
  return fetchOverpassQuery(q);
}

async function fetchByWikidataQid(qid) {
  const q = `[out:json][timeout:40];
(
  node["wikidata"="${qid}"];
  way["wikidata"="${qid}"];
  relation["wikidata"="${qid}"];
);out body geom tags center;`;
  return fetchOverpassQuery(q);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DATA PROCESSING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function processElements(elements) {
  let added = 0;
  for (const el of elements) {

    let lat0,lng0,polyCoords=null;
    if (el.type==='node') { lat0=el.lat; lng0=el.lon; }
    else if (el.type==='way'&&el.geometry) {
      const pts=el.geometry;
      lat0=pts.reduce((s,p)=>s+p.lat,0)/pts.length;
      lng0=pts.reduce((s,p)=>s+p.lon,0)/pts.length;
      polyCoords=pts.map(p=>[p.lat,p.lon]);
    } else if (el.type==='relation' && el.geometry && el.geometry.length) {
      const pts=el.geometry;
      lat0=pts.reduce((s,p)=>s+p.lat,0)/pts.length;
      lng0=pts.reduce((s,p)=>s+p.lon,0)/pts.length;
      polyCoords=pts.map(p=>[p.lat,p.lon]);
    } else if (el.type==='relation' && el.center) {
      lat0 = el.center.lat; lng0 = el.center.lon;
    } else continue;

    const qibla = qiblaAngle(lat0,lng0);
    let axis=null, method='none';

    const dt = el.tags?.direction||el.tags?.['building:direction']||el.tags?.['roof:direction'];
    if(dt&&!isNaN(+dt)) { axis=+dt%180; method='osm-tag'; }
    else if(polyCoords&&polyCoords.length>=4) {
      const res = buildingQiblaEdge(polyCoords,qibla);
      if(res){ axis=res.angle; method='edge-analysis'; }
    }

    const fallbackName = pickNameFromTags(el.tags) || buildTagsAddressFallbackName(el.tags || {}, el.id);
    const rec = {
      id:el.id,
      osmType: el.type,
      name:fallbackName,
      nameAr: el.tags?.['name:ar']||null,
      nameTr: el.tags?.['name:tr']||null,
      lat:lat0,lng:lng0,qibla,
      baseAxis: axis,
      baseMethod: method,
      axis:null,diff:null,status:'unknown',polyCoords,method,
      startDate: el.tags?.start_date||el.tags?.['building:start_date']||null,
      tags: el.tags||{},
      geomComplexity: computeGeometryComplexity(polyCoords)
    };
    buildSearchIndexForMosque(rec);
    applyAxisFusion(rec);
    const existing = mosqueDB.get(el.id);
    if (existing) {
      const recScore =
        (rec.axis != null ? 120 : 0) +
        (Array.isArray(rec.polyCoords) && rec.polyCoords.length >= 4 ? 30 : 0) +
        (rec.osmType === 'way' || rec.osmType === 'relation' ? 12 : 0) +
        (rec.baseMethod === 'edge-analysis' ? 8 : 0);
      const existingScore =
        (existing.axis != null ? 120 : 0) +
        (Array.isArray(existing.polyCoords) && existing.polyCoords.length >= 4 ? 30 : 0) +
        (existing.osmType === 'way' || existing.osmType === 'relation' ? 12 : 0) +
        (existing.baseMethod === 'edge-analysis' ? 8 : 0);
      if (recScore <= existingScore) continue;
    } else {
      added++;
    }
    mosqueDB.set(el.id, rec);
    if (rec && (isPlaceholderMosqueName(rec.name) || isGenericMosqueName(rec.name))) enqueueMosqueNameEnrichment(rec);
  }
  return added;
}

function findBestMosqueByName(query) {
  const q = (query || '').trim();
  if (!q || !mosqueDB.size) return null;
  const qLow  = trLower(q);
  const qNorm = normalize(qLow);
  const words = qLow.split(/\s+/).filter(Boolean);
  let best = null;
  let bestScore = -1;
  for (const m of mosqueDB.values()) {
    const s = msMosqueScore(m, qLow, qNorm, words);
    if (s > bestScore) { bestScore = s; best = m; }
  }
  return bestScore >= 30 ? best : null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER (only visible mosques for performance)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderAll() {
  // Remove old visual layers
  renderLayers.forEach(l=>{ try{map.removeLayer(l);}catch{} });
  renderLayers=[];

  const bounds = map.getBounds().pad(0.1);
  const visible = [...mosqueDB.values()].filter(m=>bounds.contains([m.lat,m.lng]));
  const denseMode = visible.length > 700;
  if (denseMode && !denseModeNotified) {
    toast('Performans modu: yoÄŸun bÃ¶lgede sade Ã§izim kullanÄ±lÄ±yor', 3200);
    denseModeNotified = true;
  } else if (!denseMode) {
    denseModeNotified = false;
  }

  for (const m of visible) {
    const col = m.status==='correct'?'#4ade80':m.status==='wrong'?'#f87171':'#fbbf24';
    const dispAxis = getDisplayAxis(m);

    if(!denseMode && m.polyCoords){
      const poly=L.polygon(m.polyCoords,{color:col,weight:1.5,fillColor:col,fillOpacity:.07,opacity:.45}).addTo(map);
      poly.on('click',()=>handleMosqueClick(m));
      renderLayers.push(poly);
    }

    // KÄ±ble direction line (dashed gold)
    if (!denseMode) {
      const qEnd=destination(m.lat,m.lng,m.qibla,200);
      renderLayers.push(L.polyline([[m.lat,m.lng],[qEnd.lat,qEnd.lng]],{color:'#c9a84c',weight:1.5,opacity:.7,dashArray:'6 5'}).addTo(map));
    }

    // Building axis arrow
    if(!denseMode && dispAxis!==null){
      const fd=closestDirection(dispAxis,m.qibla);
      const e1=destination(m.lat,m.lng,fd,90);
      const e2=destination(m.lat,m.lng,(fd+180)%360,90);
      const axl=L.polyline([[e2.lat,e2.lng],[e1.lat,e1.lng]],{color:col,weight:2.5,opacity:.9}).addTo(map);
      axl.on('click',()=>handleMosqueClick(m)); renderLayers.push(axl);
      const tip=destination(m.lat,m.lng,fd,95);
      const aL=destination(tip.lat,tip.lng,(fd+145)%360,17);
      const aR=destination(tip.lat,tip.lng,(fd+215)%360,17);
      renderLayers.push(L.polygon([[tip.lat,tip.lng],[aL.lat,aL.lng],[aR.lat,aR.lng]],{color:col,fillColor:col,weight:0,fillOpacity:.9}).addTo(map));
    }

    const mk=L.circleMarker([m.lat,m.lng],{radius:5,fillColor:col,color:'#0a0a0f',weight:1.5,fillOpacity:.95}).addTo(map);
    mk.mosque = m;
    mk.bindPopup(makePopup(m));
    mk.on('click',()=>handleMosqueClick(m));
    renderLayers.push(mk);
  }

  updateStats();
  // Respect active mosque filter when updating list
  if (mosqueFilter) {
    applyMosqueFilter(mosqueFilter);
  } else {
    updateList(visible);
  }
  // Refresh overlays if active
  if(heatVisible) refreshHeatmap();
  if(scoreCardVisible) updateScoreCard();
  // Refresh history mode colors & modal if active
  if(typeof historyModeActive !== 'undefined' && historyModeActive) {
    enrichWithPeriod();
    applyPeriodColors();
    renderHistoryModal();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  KIBLE GREAT-CIRCLE ANIMATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Animation state â€” single source of truth for cancellation
let _animHandle = null;   // rAF handle
let _animTimer  = null;   // setTimeout handle (phase transition)

function cancelAnimation() {
  if (_animHandle) { cancelAnimationFrame(_animHandle); _animHandle = null; }
  if (_animTimer)  { clearTimeout(_animTimer);          _animTimer  = null; }
}

function animateQibla(m) {
  // â”€â”€ Cancel any running animation immediately
  cancelAnimation();
  animLayers.forEach(l=>{ try{map.removeLayer(l);}catch{} });
  animLayers = [];

  const dist   = Math.round(greatCircleKm(m.lat, m.lng, KAABA.lat, KAABA.lng));
  const hasAxis = m.axis !== null;

  // â”€â”€ Info panel
  document.getElementById('qp-name').textContent       = m.name;
  document.getElementById('qp-angle').textContent      = m.qibla.toFixed(2)+'Â°  (gerÃ§ek kÄ±ble)';
  document.getElementById('qp-diff').textContent       = m.diff!==null ? m.diff.toFixed(1)+'Â° sapma' : 'â€”';
  document.getElementById('qp-dist').textContent       = dist+' km uzakta';
  document.getElementById('qp-anim-status').textContent = 'â— Ã‡iziliyor...';
  document.getElementById('qibla-panel').classList.add('show');

  // â”€â”€ Pre-compute points
  const qiblaPts  = greatCirclePoints(m.lat, m.lng, KAABA.lat, KAABA.lng, 120);
  let   buildPts  = [];
  if (hasAxis) {
    const faceDir  = closestDirection(m.axis, m.qibla);
    // greatCircleKm ismine karÅŸÄ±n metre dÃ¶ndÃ¼rÃ¼r (R=6371000)
    const kabeDistM = greatCircleM(m.lat, m.lng, KAABA.lat, KAABA.lng);
    // faceDir yÃ¶nÃ¼nde aynÄ± mesafede hedef nokta â†’ bÃ¼yÃ¼k daire Ã§iz
    const buildTarget = destination(m.lat, m.lng, faceDir, kabeDistM);
    buildPts = greatCirclePoints(m.lat, m.lng, buildTarget.lat, buildTarget.lng, 120);
  }

  // â”€â”€ Create Leaflet layers upfront
  const qibleLine = L.polyline([], { color:'#c9a84c', weight:2.5, opacity:.9, dashArray:'8 5' }).addTo(map);
  animLayers.push(qibleLine);

  let buildLine = null;
  if (hasAxis) {
    buildLine = L.polyline([], { color:'#7c6ad8', weight:3, opacity:.95 }).addTo(map);
    animLayers.push(buildLine);
  }

  const center = L.circleMarker([m.lat,m.lng],{
    radius:9, fillColor:'#ffffff', color:'#c9a84c', weight:2, fillOpacity:.9
  }).addTo(map);
  animLayers.push(center);

  // â”€â”€ rAF-based sequential animator
  // animatePoints(pts, layer, speed, onDone)
  // speed = points per second
  function animatePoints(pts, layer, speed, onDone) {
    let idx      = 0;
    let lastTime = null;
    let accum    = 0;

    function frame(ts) {
      if (lastTime === null) lastTime = ts;
      const dt = ts - lastTime;
      lastTime = ts;
      accum += dt * speed / 1000; // how many points to advance

      const steps = Math.floor(accum);
      accum -= steps;

      for (let s = 0; s < steps && idx < pts.length; s++, idx++) {
        layer.addLatLng(pts[idx]);
      }

      if (idx < pts.length) {
        _animHandle = requestAnimationFrame(frame);
      } else {
        _animHandle = null;
        onDone();
      }
    }
    _animHandle = requestAnimationFrame(frame);
  }

  // â”€â”€ Phase 1: draw building axis (purple)
  function phase1() {
    if (!hasAxis) { phase2(); return; }

    animatePoints(buildPts, buildLine, 180, () => {
      // Arrowhead at tip
      const last = buildPts[buildPts.length-1];
      const prev = buildPts[Math.max(0, buildPts.length-4)];
      const bear = bearing(prev[0],prev[1],last[0],last[1]);
      const aL   = destination(last[0],last[1],(bear+150)%360, 60);
      const aR   = destination(last[0],last[1],(bear+210)%360, 60);
      animLayers.push(
        L.polygon([[last[0],last[1]],[aL.lat,aL.lng],[aR.lat,aR.lng]],
          {color:'#7c6ad8',fillColor:'#7c6ad8',weight:0,fillOpacity:.95}).addTo(map)
      );
      document.getElementById('qp-anim-status').textContent = 'ğŸŸ£ GerÃ§ek yÃ¶n â€” ÅŸimdi kÄ±ble...';
      _animTimer = setTimeout(phase2, 250);
    });
  }

  // â”€â”€ Phase 2: draw great circle to Kaaba (gold)
  function phase2() {
    // Variable speed: fast at start, slower as it approaches
    animatePoints(qiblaPts, qibleLine, 160, () => {
      // Arrowhead at Kaaba
      const last = qiblaPts[qiblaPts.length-1];
      const prev = qiblaPts[Math.max(0, qiblaPts.length-4)];
      const bear = bearing(prev[0],prev[1],last[0],last[1]);
      const aL   = destination(last[0],last[1],(bear+150)%360, 25000);
      const aR   = destination(last[0],last[1],(bear+210)%360, 25000);
      animLayers.push(
        L.polygon([[last[0],last[1]],[aL.lat,aL.lng],[aR.lat,aR.lng]],
          {color:'#c9a84c',fillColor:'#c9a84c',weight:0,fillOpacity:.95}).addTo(map)
      );
      const diffStr = m.diff!==null ? `${m.diff.toFixed(1)}Â° sapma` : 'veri yok';
      document.getElementById('qp-anim-status').textContent = `âœ“ TamamlandÄ± â€” ${diffStr}`;
      if (hasAxis) drawDiffArc(m);
    });
  }

  phase1();
}

// DÃ¼z Ã§izgi boyunca ara noktalar (bina yÃ¶nÃ¼ iÃ§in)
function linearPoints(lat1,lng1,lat2,lng2,n=60){
  const pts=[];
  for(let i=0;i<=n;i++){
    const t=i/n;
    pts.push([lat1+(lat2-lat1)*t, lng1+(lng2-lng1)*t]);
  }
  return pts;
}

// AÃ§Ä± farkÄ±nÄ± gÃ¶rsel yay olarak Ã§iz
function drawDiffArc(m){
  if(m.diff===null||m.axis===null) return;
  const faceDir = closestDirection(m.axis, m.qibla);
  const r = 300; // metre
  const steps = 24;
  // Arc from faceDir to qibla (shortest path)
  let start = faceDir, end = m.qibla;
  // Go the short way
  let delta = ((end - start) + 360) % 360;
  if (delta > 180) delta -= 360;
  const arcPts = [];
  for(let i=0;i<=steps;i++){
    const ang = start + (delta * i/steps);
    const p = destination(m.lat, m.lng, ang, r);
    arcPts.push([p.lat, p.lng]);
  }
  const col = m.diff <= tol ? 'rgba(74,222,128,0.6)' : 'rgba(248,113,113,0.6)';
  animLayers.push(L.polyline(arcPts,{color:col,weight:3,opacity:.8}).addTo(map));
  // AÃ§Ä± etiketi ortasÄ±nda
  const midAng = start + delta/2;
  const midPt = destination(m.lat, m.lng, midAng, r*1.35);
  animLayers.push(L.marker([midPt.lat,midPt.lng],{
    icon: L.divIcon({
      className:'',
      html:`<div style="background:rgba(10,10,15,.85);border:1px solid ${m.diff<=tol?'#4ade80':'#f87171'};color:${m.diff<=tol?'#4ade80':'#f87171'};font-family:monospace;font-size:11px;font-weight:700;padding:2px 7px;border-radius:4px;white-space:nowrap">${m.diff.toFixed(1)}Â°</div>`,
      iconAnchor:[20,10]
    })
  }).addTo(map));
  animLayers.push(...animLayers.slice(-1));
}

function hideQiblaPanel() {
  document.getElementById('qibla-panel').classList.remove('show');
  cancelAnimation();
  animLayers.forEach(l=>{ try{map.removeLayer(l);}catch{} });
  animLayers=[];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MATH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const toRad=d=>d*Math.PI/180, toDeg=r=>r*180/Math.PI;
const escHtml = s => String(s ?? '')
  .replace(/&/g,'&amp;')
  .replace(/</g,'&lt;')
  .replace(/>/g,'&gt;')
  .replace(/"/g,'&quot;')
  .replace(/'/g,'&#39;');

function isLikelyMosqueQuery(q) {
  const t = trLower(q || '');
  return /\b(cami|camii|mescid|mescit|mosque|masjid)\b/.test(t);
}

function pickNameFromTags(tags = {}) {
  const nameKeys = [
    'name:tr','name:bs','name:hr','name:sr','name:sr-Latn','name:sr-Cyrl',
    'name','official_name','short_name','name:en','name:ar',
    'loc_name','alt_name','old_name','int_name'
  ];
  for (const k of nameKeys) {
    const v = tags[k];
    if (typeof v === 'string' && v.trim()) return v.trim();
  }
  if (typeof tags.wikipedia === 'string' && tags.wikipedia.includes(':')) {
    const title = tags.wikipedia.split(':').slice(1).join(':').replace(/_/g, ' ').trim();
    if (title) return title;
  }
  const area = tags['addr:suburb'] || tags['addr:neighbourhood'] || tags['addr:quarter'] || tags['addr:village'] || tags['addr:hamlet'];
  if (typeof area === 'string' && area.trim()) return `${area.trim()} Camii`;
  return null;
}

function pickBestNamedetailName(namedetails = {}) {
  const order = ['name:bs','name:hr','name:sr','name:sr-Latn','name:tr','name:en','name'];
  for (const k of order) {
    const v = namedetails[k];
    if (typeof v === 'string' && v.trim()) return v.trim();
  }
  for (const [k,v] of Object.entries(namedetails || {})) {
    if (/^name(:|$)/i.test(k) && typeof v === 'string' && v.trim()) return v.trim();
  }
  return null;
}

function buildAddressBasedMosqueName(addr = {}) {
  const place = addr.suburb || addr.neighbourhood || addr.quarter || addr.village || addr.hamlet || addr.city_district || addr.town || addr.city;
  if (!place || typeof place !== 'string') return null;
  const base = place.trim();
  if (!base) return null;
  const country = trLower(addr.country || '');
  if (/(bosnia|bosna|hersek|hercegovina)/.test(country)) return `${base} Dzamija`;
  return `${base} Camii`;
}

function buildTagsAddressFallbackName(tags = {}, osmId = '') {
  const addr = {
    suburb: tags['addr:suburb'],
    neighbourhood: tags['addr:neighbourhood'],
    quarter: tags['addr:quarter'],
    village: tags['addr:village'],
    hamlet: tags['addr:hamlet'],
    city_district: tags['addr:city_district'] || tags['addr:district'],
    town: tags['addr:town'],
    city: tags['addr:city'],
    country: tags['addr:country']
  };
  const byAddr = buildAddressBasedMosqueName(addr);
  if (byAddr) return byAddr;
  const area = tags['addr:place'] || tags['addr:street'] || tags['addr:county'] || tags['addr:state'];
  if (typeof area === 'string' && area.trim()) return `${area.trim()} Camii`;
  return `OSM Cami #${osmId}`;
}

async function fetchWikidataLabel(qid) {
  if (!/^Q\d+$/i.test(String(qid || '').trim())) return null;
  const key = String(qid).toUpperCase();
  if (wikidataLabelCache.has(key)) return wikidataLabelCache.get(key);
  try {
    const api = `https://www.wikidata.org/w/api.php?action=wbgetentities&ids=${encodeURIComponent(key)}&props=labels&languages=tr|en&format=json&origin=*`;
    const r = await fetch(api);
    const d = await r.json();
    const ent = d?.entities?.[key];
    const label = ent?.labels?.tr?.value || ent?.labels?.en?.value || null;
    wikidataLabelCache.set(key, label);
    return label;
  } catch {
    wikidataLabelCache.set(key, null);
    return null;
  }
}

function isPlaceholderMosqueName(name) {
  const t = trLower(name || '').trim();
  return !t || t === 'isimsiz cami' || t.startsWith('isimsiz cami (#') || t.startsWith('osm cami #');
}

function isGenericMosqueName(name) {
  const t = trLower(String(name || '').trim());
  return /^(cami|camii|mosque|masjid|mescit|mescid|cuma camii|dzamija|dÅ¾amija)$/.test(t);
}

function loadNameEnrichCache() {
  try {
    const raw = safeStorageGet(NAME_ENRICH_KEY, null);
    if (!raw) return;
    const parsed = JSON.parse(raw);
    if (!parsed || typeof parsed !== 'object') return;
    Object.entries(parsed).forEach(([k,v]) => {
      if (v && typeof v.name === 'string') nameEnrichCache.set(k, v);
    });
  } catch {}
}

function saveNameEnrichCache() {
  try {
    const obj = {};
    nameEnrichCache.forEach((v,k) => { obj[k] = v; });
    safeStorageSet(NAME_ENRICH_KEY, JSON.stringify(obj));
  } catch {}
}

function enrichCacheKey(m) {
  return `${m.osmType || 'way'}:${m.id}`;
}

async function fetchOverpassNearbyNameCandidates(m, radiusM = 120) {
  const q = `[out:json][timeout:30];
(
  node(around:${radiusM},${m.lat},${m.lng})["amenity"="place_of_worship"]["~"^name(:.*)?$"~"."] ;
  way(around:${radiusM},${m.lat},${m.lng})["amenity"="place_of_worship"]["~"^name(:.*)?$"~"."] ;
  relation(around:${radiusM},${m.lat},${m.lng})["amenity"="place_of_worship"]["~"^name(:.*)?$"~"."] ;
  node(around:${radiusM},${m.lat},${m.lng})["amenity"="mosque"]["~"^name(:.*)?$"~"."] ;
  way(around:${radiusM},${m.lat},${m.lng})["amenity"="mosque"]["~"^name(:.*)?$"~"."] ;
  relation(around:${radiusM},${m.lat},${m.lng})["amenity"="mosque"]["~"^name(:.*)?$"~"."] ;
  node(around:${radiusM},${m.lat},${m.lng})["building"="mosque"]["~"^name(:.*)?$"~"."] ;
  way(around:${radiusM},${m.lat},${m.lng})["building"="mosque"]["~"^name(:.*)?$"~"."] ;
  relation(around:${radiusM},${m.lat},${m.lng})["building"="mosque"]["~"^name(:.*)?$"~"."] ;
);
out center tags 120;`;
  const els = await fetchOverpassQuery(q);
  const out = [];
  for (const el of els) {
    const tags = el.tags || {};
    const nm = pickNameFromTags(tags);
    if (!nm || isGenericMosqueName(nm)) continue;
    const lat = el.type === 'node' ? el.lat : el.center?.lat;
    const lng = el.type === 'node' ? el.lon : el.center?.lon;
    if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;
    const d = greatCircleM(m.lat, m.lng, lat, lng);
    const same = (String(el.id) === String(m.id));
    out.push({ name:nm, source:'overpass-near', dist:d, sameId:same });
  }
  return out;
}

async function fetchNominatimReverseCandidate(m) {
  const url = `https://nominatim.openstreetmap.org/reverse?lat=${m.lat}&lon=${m.lng}&format=jsonv2&zoom=18&addressdetails=1&namedetails=1`;
  try {
    const d = await nominatimFetchJson(url, {'Accept-Language':'bs,hr,sr,en,tr'});
    const cls = trLower(d.class || '');
    const type = trLower(d.type || '');
    const nm = pickBestNamedetailName(d.namedetails || {}) || String(d.name || d.display_name || '').split(',')[0].trim();
    if (!nm || isGenericMosqueName(nm)) return null;
    return { name:nm, source:'nominatim-reverse', cls, type, address:d.address || {} };
  } catch {
    return null;
  }
}

async function fetchNominatimNearbyCandidates(m) {
  const span = 0.003; // ~300m
  const left = (m.lng - span).toFixed(6);
  const right = (m.lng + span).toFixed(6);
  const top = (m.lat + span).toFixed(6);
  const bottom = (m.lat - span).toFixed(6);
  const terms = ['mosque','masjid','dÅ¾amija','dzamija','cami'];
  const out = [];
  const seen = new Set();
  try {
    for (const term of terms) {
      const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(term)}&limit=8&bounded=1&viewbox=${left},${top},${right},${bottom}&addressdetails=1&namedetails=1`;
      const d = await nominatimFetchJson(url, {'Accept-Language':'bs,hr,sr,en,tr'});
      for (const it of (d || [])) {
        const nm = pickBestNamedetailName(it.namedetails || {}) || String(it.name || it.display_name || '').split(',')[0].trim();
        if (!nm || isGenericMosqueName(nm)) continue;
        const lat = +it.lat, lng = +it.lon;
        if (!Number.isFinite(lat) || !Number.isFinite(lng)) continue;
        const k = `${nm}|${lat.toFixed(5)}|${lng.toFixed(5)}`;
        if (seen.has(k)) continue;
        seen.add(k);
        out.push({ name:nm, source:'nominatim-near', dist:greatCircleM(m.lat,m.lng,lat,lng), cls:trLower(it.class||''), type:trLower(it.type||'') });
      }
    }
    return out;
  } catch {
    return [];
  }
}

function scoreNameCandidate(c) {
  let s = 0;
  if (c.source === 'wikidata') s += 72;
  if (c.source === 'address-synth') s += 30;
  if (c.source === 'overpass-near') {
    if (c.sameId) s += 140;
    else if (c.dist <= 20) s += 95;
    else if (c.dist <= 45) s += 78;
    else if (c.dist <= 90) s += 60;
    else s += 45;
  }
  if (c.source === 'nominatim-reverse') {
    s += 42;
    if (c.cls === 'amenity' && (c.type === 'place_of_worship' || c.type === 'mosque')) s += 35;
  }
  if (c.source === 'nominatim-near') {
    s += c.dist <= 25 ? 45 : c.dist <= 60 ? 35 : 20;
    if (c.cls === 'amenity' && (c.type === 'place_of_worship' || c.type === 'mosque')) s += 20;
  }
  if (isGenericMosqueName(c.name)) s -= 55;
  if (c.name.length < 4) s -= 18;
  return s;
}

async function resolveMosqueNameFromSources(m) {
  const candidates = [];
  const wd = m.tags?.wikidata ? await fetchWikidataLabel(m.tags.wikidata) : null;
  if (wd) candidates.push({ name:wd, source:'wikidata' });
  const rev = await fetchNominatimReverseCandidate(m);
  if (rev) candidates.push(rev);
  const nearNom = await fetchNominatimNearbyCandidates(m);
  nearNom.forEach(x => candidates.push(x));
  for (const r of [60, 140, 260]) {
    const nearOv = await fetchOverpassNearbyNameCandidates(m, r);
    nearOv.forEach(x => candidates.push(x));
    if (candidates.some(c => c.source === 'overpass-near' && c.sameId)) break;
  }
  if (rev?.address) {
    const synth = buildAddressBasedMosqueName(rev.address);
    if (synth) candidates.push({ name:synth, source:'address-synth', cls:'synthetic', type:'synthetic' });
  }
  if (!candidates.length) return null;

  const best = candidates
    .map(c => ({...c, score:scoreNameCandidate(c)}))
    .sort((a,b) => b.score - a.score)[0];
  if (!best || (best.source === 'address-synth' ? best.score < 28 : best.score < 45)) return null;
  return { name: best.name.trim(), source: best.source, score: best.score };
}

function applyResolvedNameToMosque(m, resolved) {
  if (!m || !resolved?.name) return false;
  const newName = resolved.name.trim();
  if (!newName || isGenericMosqueName(newName)) return false;
  const changed = m.name !== newName;
  m.name = newName;
  if (!m.tags) m.tags = {};
  m.tags.name = m.tags.name || newName;
  m.tags['name:source'] = resolved.source;
  buildSearchIndexForMosque(m);
  if (changed) {
    const key = enrichCacheKey(m);
    nameEnrichCache.set(key, { name:newName, source:resolved.source, at:Date.now() });
    saveNameEnrichCache();
  }
  return changed;
}

async function enrichMosqueName(m, opts = {}) {
  if (!m) return null;
  const force = !!opts.force;
  const key = enrichCacheKey(m);
  const cached = nameEnrichCache.get(key);
  if (cached && cached.name && !force) {
    applyResolvedNameToMosque(m, { name:cached.name, source:cached.source || 'cache' });
    return m.name;
  }
  if (!force && !isPlaceholderMosqueName(m.name) && !isGenericMosqueName(m.name)) return m.name;
  const resolved = await resolveMosqueNameFromSources(m);
  if (!resolved) return null;
  applyResolvedNameToMosque(m, resolved);
  return m.name;
}

function enqueueMosqueNameEnrichment(m) {
  if (!m || (!isPlaceholderMosqueName(m.name) && !isGenericMosqueName(m.name))) return;
  const key = enrichCacheKey(m);
  if (nameEnrichQueued.has(key)) return;
  nameEnrichQueued.add(key);
  nameEnrichQueue.push(m);
  runMosqueNameEnrichmentQueue();
}

async function runMosqueNameEnrichmentQueue() {
  if (nameEnrichRunning) return;
  nameEnrichRunning = true;
  while (nameEnrichQueue.length) {
    const m = nameEnrichQueue.shift();
    const key = enrichCacheKey(m);
    try {
      const before = m.name;
      await enrichMosqueName(m);
      if (m.name !== before && map && mosqueDB.size) {
        const bounds = map.getBounds().pad(0.1);
        const visible = [...mosqueDB.values()].filter(x => bounds.contains([x.lat, x.lng]));
        if (mosqueFilter) applyMosqueFilter(mosqueFilter);
        else updateList(visible);
      }
    } catch {}
    nameEnrichQueued.delete(key);
    await new Promise(r => setTimeout(r, 250));
  }
  nameEnrichRunning = false;
}

function boostNameEnrichment(maxItems = 90) {
  const targets = [...mosqueDB.values()]
    .filter(m => isPlaceholderMosqueName(m.name) || isGenericMosqueName(m.name))
    .sort((a,b) => {
      const da = greatCircleM(a.lat, a.lng, map.getCenter().lat, map.getCenter().lng);
      const db = greatCircleM(b.lat, b.lng, map.getCenter().lat, map.getCenter().lng);
      return da - db;
    })
    .slice(0, maxItems);
  targets.forEach(m => enqueueMosqueNameEnrichment(m));
}

function countUnresolvedMosqueNames() {
  let unresolved = 0;
  for (const m of mosqueDB.values()) {
    if (isPlaceholderMosqueName(m.name) || isGenericMosqueName(m.name)) unresolved++;
  }
  return unresolved;
}

function triggerAggressiveNameEnrichment() {
  if (!mosqueDB.size) return;
  const unresolved = countUnresolvedMosqueNames();
  if (unresolved < 6) return;
  const maxItems = unresolved > 320 ? 240 : unresolved > 160 ? 170 : unresolved > 80 ? 120 : 80;
  const queuedBefore = nameEnrichQueue.length;
  boostNameEnrichment(maxItems);
  const queuedAfter = nameEnrichQueue.length;
  if (queuedAfter > queuedBefore) {
    toast(`Ä°sim zenginleÅŸtirme aktif: ${unresolved} kayÄ±t iÃ§in arka planda isim aranÄ±yor`, 4200);
  }
}

function loadInteriorDB() {
  try {
    const raw = safeStorageGet(INTERIOR_KEY, null);
    interiorDB = raw ? JSON.parse(raw) : {};
    if (!interiorDB || typeof interiorDB !== 'object') interiorDB = {};
  } catch { interiorDB = {}; }
}

function loadSnapshots() {
  try {
    const raw = safeStorageGet(SNAPSHOT_KEY, null);
    snapshots = raw ? JSON.parse(raw) : [];
    if (!Array.isArray(snapshots)) snapshots = [];
  } catch { snapshots = []; }
}

function saveSnapshot() {
  const all = [...mosqueDB.values()];
  const withData = all.filter(m => m.diff != null);
  const correct = withData.filter(m => m.diff <= tol).length;
  const lowConf = all.filter(m => (m.confidence || 0) < 55).length;
  const snap = {
    city: currentCity,
    ts: Date.now(),
    total: all.length,
    withData: withData.length,
    pct: withData.length ? Math.round(correct / withData.length * 100) : null,
    lowConf
  };
  snapshots.push(snap);
  snapshots = snapshots.slice(-50);
  try { safeStorageSet(SNAPSHOT_KEY, JSON.stringify(snapshots)); } catch {}
}

function saveInteriorDB() {
  try { safeStorageSet(INTERIOR_KEY, JSON.stringify(interiorDB)); } catch {}
}

function loadManualAxisDB() {
  try {
    const raw = safeStorageGet(MANUAL_AXIS_KEY, null);
    manualAxisDB = raw ? JSON.parse(raw) : {};
    if (!manualAxisDB || typeof manualAxisDB !== 'object') manualAxisDB = {};
  } catch { manualAxisDB = {}; }
}

function saveManualAxisDB() {
  try { safeStorageSet(MANUAL_AXIS_KEY, JSON.stringify(manualAxisDB)); } catch {}
}

function getManualAxisRecord(m) {
  return manualAxisDB[getMosqueKey(m)] || null;
}

function aiModerateManualAxis(m, axis180) {
  const reasons = [];
  let score = 0.5;
  if (!Number.isFinite(axis180)) return { status:'rejected', score:0, reasons:['axis_nan'] };

  const base = m.baseAxis;
  const interiorAxis = getInteriorAxis(m);
  const diffQ = angDiff180(m.qibla % 180, axis180);
  const diffBase = base!=null ? angDiff180(base, axis180) : null;
  const diffInt = interiorAxis!=null ? angDiff180(interiorAxis, axis180) : null;

  if (diffQ <= 35) { score += 0.22; reasons.push('close_to_qibla'); }
  else if (diffQ <= 55) { score += 0.1; reasons.push('moderate_qibla_alignment'); }
  else { score -= 0.18; reasons.push('far_from_qibla'); }

  if (diffBase!=null) {
    if (diffBase <= 18) { score += 0.16; reasons.push('consistent_with_building'); }
    else if (diffBase > 70) { score -= 0.14; reasons.push('conflicts_building_axis'); }
  }
  if (diffInt!=null) {
    if (diffInt <= 14) { score += 0.26; reasons.push('consistent_with_interior'); }
    else if (diffInt > 65) { score -= 0.2; reasons.push('conflicts_interior_evidence'); }
  }

  if ((m.fusion?.interiorCount || 0) >= 2) score += 0.06;
  if (m.convertedFrom?.converted) score -= 0.04;

  score = Math.max(0, Math.min(1, score));
  let status = 'accepted';
  if (score < 0.42) status = 'rejected';
  else if (score < 0.57) status = 'pending';
  return { status, score, reasons };
}

function applyManualAxisSubmission(m, axis180, source = 'map-2point') {
  const moderation = aiModerateManualAxis(m, axis180);
  const key = getMosqueKey(m);
  manualAxisDB[key] = {
    axis: axis180,
    source,
    ts: Date.now(),
    moderation
  };
  saveManualAxisDB();
  applyAxisFusion(m);
  return moderation;
}

function setAxisMode(mode) {
  analysisLayerMode = mode;
  ['final','raw','interior'].forEach(k => {
    const el = document.getElementById('axis-'+k);
    if (el) el.classList.toggle('active', k===mode);
  });
  renderAll();
  if (window._lastClickedMosque) populateDetailPanel(window._lastClickedMosque);
}

const I18N = {
  tr: {
    title:'KÄ±ble DedektÃ¶rÃ¼', searchPlaceholder:'Åehir adÄ±...', searchBtn:'Ara',
    toolsHeat:'ğŸŒ¡ IsÄ±', toolsScore:'ğŸ“Š Skor', toolsCompare:'âš–ï¸ KarÅŸÄ±laÅŸtÄ±r',
    toolsHistory:'ğŸ“… Tarih', toolsRank:'ğŸŒ SÄ±ralama', toolsLoc:'ğŸ“ Konum',
    toolsExport:'ğŸ“¤ Export', toolsBiz:'ğŸ’¼ Gelir', toolsLab:'ğŸ§ª Lab', toolsCompass:'ğŸ§­ Pusula',
    toolsFollow:'ğŸ“ Takip', toolsNearby:'ğŸ§­ YakÄ±n', toolsOutdoor:'â˜€ï¸ Outdoor'
  },
  en: {
    title:'Qibla Detector', searchPlaceholder:'City name...', searchBtn:'Search',
    toolsHeat:'ğŸŒ¡ Heat', toolsScore:'ğŸ“Š Score', toolsCompare:'âš–ï¸ Compare',
    toolsHistory:'ğŸ“… History', toolsRank:'ğŸŒ Ranking', toolsLoc:'ğŸ“ My Location',
    toolsExport:'ğŸ“¤ Export', toolsBiz:'ğŸ’¼ Revenue', toolsLab:'ğŸ§ª Lab', toolsCompass:'ğŸ§­ Compass',
    toolsFollow:'ğŸ“ Follow', toolsNearby:'ğŸ§­ Nearby', toolsOutdoor:'â˜€ï¸ Outdoor'
  }
};

function setLang(lang, silent=false) {
  currentLang = lang === 'en' ? 'en' : 'tr';
  safeStorageSet(LANG_KEY, currentLang);
  const t = I18N[currentLang];
  document.documentElement.lang = currentLang;
  const tt = (id, txt, prop='textContent') => { const el = document.getElementById(id); if (el) el[prop] = txt; };
  tt('search-btn', t.searchBtn);
  tt('btn-heat', t.toolsHeat);
  tt('btn-score', t.toolsScore);
  tt('btn-compare', t.toolsCompare);
  tt('btn-history', t.toolsHistory);
  tt('btn-lb', t.toolsRank);
  tt('loc-btn', t.toolsLoc);
  tt('btn-export', t.toolsExport);
  tt('btn-biz', t.toolsBiz);
  tt('btn-lab', t.toolsLab);
  tt('btn-compass', t.toolsCompass);
  tt('btn-follow', t.toolsFollow);
  tt('btn-nearby', t.toolsNearby);
  tt('btn-outdoor', t.toolsOutdoor);
  const cityInput = document.getElementById('city-input');
  if (cityInput) cityInput.placeholder = t.searchPlaceholder;
  const logo = document.querySelector('.logo-title');
  if (logo) logo.textContent = t.title;
  document.getElementById('lang-tr')?.classList.toggle('active', currentLang==='tr');
  document.getElementById('lang-en')?.classList.toggle('active', currentLang==='en');
  if (dpOpen && window._lastClickedMosque) populateDetailPanel(window._lastClickedMosque);
  if (!silent) toast(currentLang==='tr' ? 'Dil TÃ¼rkÃ§e' : 'Language set to English', 1400);
}

function getMosqueKey(m) {
  return `${m.osmType || 'way'}:${m.id}`;
}

function getInteriorEvidenceList(m) {
  const arr = interiorDB[getMosqueKey(m)];
  return Array.isArray(arr) ? arr : [];
}

function toAxis180(v) {
  const n = ((+v % 180) + 180) % 180;
  return Number.isFinite(n) ? n : null;
}

function weightedAxisMean180(items) {
  let x = 0, y = 0, wSum = 0;
  for (const it of items) {
    const a = toAxis180(it.axis);
    const w = Math.max(0, Number(it.weight) || 0);
    if (a === null || !w) continue;
    const r = toRad(a * 2);
    x += Math.cos(r) * w;
    y += Math.sin(r) * w;
    wSum += w;
  }
  if (!wSum) return { axis:null, reliability:0 };
  const ang = ((toDeg(Math.atan2(y, x)) / 2) + 180) % 180;
  const rel = Math.sqrt(x*x + y*y) / wSum;
  return { axis:ang, reliability:rel };
}

function parseDirectionalTag(tags = {}) {
  const keys = ['qibla:direction','prayer:direction','mihrab:direction','direction','building:direction','roof:direction'];
  for (const k of keys) {
    const v = tags[k];
    if (v == null) continue;
    const num = Number(v);
    if (Number.isFinite(num)) return toAxis180(num);
  }
  return null;
}

function detectConversionInfo(tags = {}) {
  const checks = [
    'building:former_use','was:building','was:amenity','old_religion','former_religion',
    'historic:religion','description','note','source'
  ];
  let raw = '';
  for (const k of checks) if (tags[k]) raw += ' ' + String(tags[k]);
  const hay = trLower(raw);
  const prev = tags['building:former_use'] || tags['was:building'] || tags['old_religion'] || tags['former_religion'] || '';
  const hit = /(church|kilise|synagogue|sinagog|temple|tapinak|tapÄ±nak|cathedral|chapel|monastery|manastir|manastÄ±r)/.test(hay);
  if (!hit && !prev) return null;
  return {
    converted: true,
    previous: String(prev || 'unknown'),
    evidence: raw.trim().slice(0,220)
  };
}

function computeConfidenceScore(m) {
  const manualRec = getManualAxisRecord(m);
  let score = 45;
  if (m.baseMethod === 'osm-tag') score += 20;
  else if (m.baseMethod === 'edge-analysis') score += 12;
  if (m.fusion?.mode === 'hybrid-interior') score += 16;
  if (m.fusion?.mode === 'interior-only') score += 12;
  score += Math.round((m.fusion?.reliability || 0) * 12);
  if ((m.fusion?.interiorCount || 0) >= 2) score += 8;
  if (m.name && !isPlaceholderMosqueName(m.name) && !isGenericMosqueName(m.name)) score += 6;
  if (m.diff == null) score -= 18;
  if (m.convertedFrom?.converted) score -= 6;
  if ((m.geomComplexity || 0) > 0.62) score -= 8;
  else if ((m.geomComplexity || 0) > 0.46) score -= 4;
  if (manualRec?.moderation?.status === 'accepted') score += 6;
  if (manualRec?.moderation?.status === 'rejected') score -= 8;
  score = Math.max(0, Math.min(100, score));
  m.confidence = score;
  m.confidenceBand = score >= 80 ? 'high' : score >= 55 ? 'medium' : 'low';
  m.qualityBadges = [
    m.confidenceBand === 'high' ? 'High Confidence' : m.confidenceBand === 'medium' ? 'Medium Confidence' : 'Low Confidence',
    m.fusion?.mode || 'none',
    m.convertedFrom?.converted ? 'Converted Structure' : 'Native Mosque',
    (m.geomComplexity || 0) > 0.62 ? 'Complex Geometry' : (m.geomComplexity || 0) > 0.46 ? 'Irregular Geometry' : 'Simple Geometry',
    isPlaceholderMosqueName(m.name) ? 'Name Missing' : 'Name OK',
    manualRec?.moderation?.status ? `Manual:${manualRec.moderation.status}` : 'Manual:none'
  ];
  return score;
}

function getInteriorAxis(m) {
  const interior = getInteriorEvidenceList(m);
  if (!interior.length) return null;
  const local = weightedAxisMean180(interior.map(ev => ({ axis:ev.axis, weight:Math.max(0.2, Number(ev.confidence)||0.6) })));
  return local.axis;
}

function applyAxisFusion(m) {
  const candidates = [];
  const manualRec = getManualAxisRecord(m);
  const tagAxis = parseDirectionalTag(m.tags || {});
  if (tagAxis !== null) candidates.push({ axis:tagAxis, weight:0.95, label:'osm-direction' });
  if (m.baseAxis !== null && m.baseAxis !== undefined) {
    const w = m.baseMethod === 'osm-tag' ? 0.85 : 0.62;
    candidates.push({ axis:m.baseAxis, weight:w, label:m.baseMethod || 'building' });
  }
  const interior = getInteriorEvidenceList(m);
  if (interior.length) {
    const local = weightedAxisMean180(interior.map(ev => ({ axis:ev.axis, weight:Math.max(0.2, Number(ev.confidence)||0.6) })));
    if (local.axis !== null) candidates.push({ axis:local.axis, weight:0.55 + 0.45*local.reliability, label:'interior' });
  }
  if (manualRec?.axis != null && manualRec?.moderation?.status === 'accepted') {
    const mw = 0.9 + 0.1 * (manualRec.moderation.score || 0.5);
    candidates.push({ axis:manualRec.axis, weight:mw, label:'manual-accepted' });
  }

  const fused = weightedAxisMean180(candidates);
  if (fused.axis === null) {
    m.axis = null;
    m.diff = null;
    m.status = 'unknown';
    m.method = m.baseMethod || 'none';
    m.fusion = { mode:'none', reliability:0, candidates:0 };
    m.convertedFrom = detectConversionInfo(m.tags || {});
    computeConfidenceScore(m);
    return m;
  }

  m.axis = fused.axis;
  m.diff = angDiff180(m.qibla % 180, m.axis);
  m.status = m.diff <= tol ? 'correct' : 'wrong';
  const hasInterior = interior.length > 0;
  const hasBase = m.baseAxis !== null && m.baseAxis !== undefined;
  m.method = hasInterior && hasBase ? 'hybrid-interior' : hasInterior ? 'interior-only' : (m.baseMethod || 'fused');
  m.fusion = {
    mode: m.method,
    reliability: fused.reliability,
    candidates: candidates.length,
    interiorCount: interior.length,
    manualStatus: manualRec?.moderation?.status || 'none'
  };
  m.convertedFrom = detectConversionInfo(m.tags || {});
  computeConfidenceScore(m);
  return m;
}

function getDisplayAxis(m) {
  if (analysisLayerMode === 'raw') return m.baseAxis ?? null;
  if (analysisLayerMode === 'interior') return getInteriorAxis(m);
  return m.axis;
}

const interiorPhotoCache = new Map();
function looksInteriorText(t) {
  return /(interior|inside|prayer|hall|mihrab|musalla|mushalla|iÃ§|ic mekan|salah|namaz)/i.test(String(t || ''));
}

async function fetchCommonsInteriorByCategory(catName) {
  if (!catName) return [];
  const clean = String(catName).replace(/^Category:/i,'').trim();
  const api = `https://commons.wikimedia.org/w/api.php?action=query&list=categorymembers&cmtitle=Category:${encodeURIComponent(clean)}&cmnamespace=6&cmlimit=40&format=json&origin=*`;
  const r = await fetch(api);
  const d = await r.json();
  const files = (d?.query?.categorymembers || []).filter(x => looksInteriorText(x.title));
  if (!files.length) return [];
  const titles = files.slice(0,8).map(x=>x.title).join('|');
  const api2 = `https://commons.wikimedia.org/w/api.php?action=query&titles=${encodeURIComponent(titles)}&prop=imageinfo&iiprop=url&format=json&origin=*`;
  const r2 = await fetch(api2); const d2 = await r2.json();
  const pages = d2?.query?.pages || {};
  return Object.values(pages).map(p => p?.imageinfo?.[0]?.url).filter(Boolean);
}

async function fetchCommonsInteriorBySearch(term) {
  const q = `${term} mosque interior`;
  const api = `https://commons.wikimedia.org/w/api.php?action=query&generator=search&gsrsearch=${encodeURIComponent(q)}&gsrnamespace=6&gsrlimit=10&prop=imageinfo&iiprop=url&format=json&origin=*`;
  const r = await fetch(api); const d = await r.json();
  const pages = d?.query?.pages || {};
  return Object.values(pages)
    .filter(p => looksInteriorText(p.title))
    .map(p => p?.imageinfo?.[0]?.url)
    .filter(Boolean);
}

async function resolveInteriorPhotos(m) {
  const key = getMosqueKey(m);
  if (interiorPhotoCache.has(key)) return interiorPhotoCache.get(key);
  const out = [];
  try {
    const wm = m.tags?.wikimedia_commons || '';
    if (/^Category:/i.test(wm)) {
      const a = await fetchCommonsInteriorByCategory(wm);
      a.forEach(url => out.push({ url, source:'commons-category' }));
    }
  } catch {}
  try {
    const b = await fetchCommonsInteriorBySearch(m.name || '');
    b.forEach(url => out.push({ url, source:'commons-search' }));
  } catch {}
  const uniq = [];
  const seen = new Set();
  for (const p of out) {
    if (!p?.url || seen.has(p.url)) continue;
    seen.add(p.url);
    uniq.push(p);
    if (uniq.length >= 8) break;
  }
  interiorPhotoCache.set(key, uniq);
  return uniq;
}

function qiblaAngle(lat,lng){
  const p1=toRad(lat),p2=toRad(KAABA.lat),dl=toRad(KAABA.lng-lng);
  return(toDeg(Math.atan2(Math.sin(dl)*Math.cos(p2),Math.cos(p1)*Math.sin(p2)-Math.sin(p1)*Math.cos(p2)*Math.cos(dl)))+360)%360;
}

function greatCircleM(lat1,lng1,lat2,lng2){
  const R=6371000;
  const p1=toRad(lat1),p2=toRad(lat2),dp=toRad(lat2-lat1),dl=toRad(lng2-lng1);
  const a=Math.sin(dp/2)**2+Math.cos(p1)*Math.cos(p2)*Math.sin(dl/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function greatCircleKm(lat1,lng1,lat2,lng2){ return greatCircleM(lat1,lng1,lat2,lng2)/1000; }

function greatCirclePoints(lat1,lng1,lat2,lng2,n=100){
  // Slerp-based great circle interpolation
  const p1=toRad(lat1),l1=toRad(lng1),p2=toRad(lat2),l2=toRad(lng2);
  // Convert to cartesian
  const cart=([p,l])=>[Math.cos(p)*Math.cos(l),Math.cos(p)*Math.sin(l),Math.sin(p)];
  const A=cart([p1,l1]),B=cart([p2,l2]);
  const dot=A[0]*B[0]+A[1]*B[1]+A[2]*B[2];
  const omega=Math.acos(Math.min(1,Math.max(-1,dot)));
  const pts=[];
  for(let i=0;i<=n;i++){
    const t=i/n;
    const s=Math.sin(omega)>1e-10 ? 1/Math.sin(omega) : 1;
    const sa=Math.sin((1-t)*omega)*s, sb=Math.sin(t*omega)*s;
    const x=sa*A[0]+sb*B[0], y=sa*A[1]+sb*B[1], z=sa*A[2]+sb*B[2];
    const lat=toDeg(Math.atan2(z,Math.sqrt(x*x+y*y)));
    const lng=toDeg(Math.atan2(y,x));
    pts.push([lat,lng]);
  }
  return pts;
}

function bearing(lat1,lng1,lat2,lng2){
  const p1=toRad(lat1),p2=toRad(lat2),dl=toRad(lng2-lng1);
  return(toDeg(Math.atan2(Math.sin(dl)*Math.cos(p2),Math.cos(p1)*Math.sin(p2)-Math.sin(p1)*Math.cos(p2)*Math.cos(dl)))+360)%360;
}

function buildingQiblaEdge(polyCoords,qibla){
  if(!polyCoords||polyCoords.length<4) return null;
  const edges=[];
  for(let i=0;i<polyCoords.length-1;i++){
    const[lat1,lng1]=polyCoords[i],[lat2,lng2]=polyCoords[i+1];
    const dx=(lng2-lng1)*Math.cos(toRad((lat1+lat2)/2))*111320;
    const dy=(lat2-lat1)*111320;
    const len=Math.sqrt(dx*dx+dy*dy);
    if(len<0.5) continue;
    const angle=(toDeg(Math.atan2(dx,dy))+360)%180;
    edges.push({angle,len});
  }
  if(!edges.length) return null;
  const bins=new Array(36).fill(0);
  for(const{angle,len}of edges){
    const b=Math.floor(angle/5)%36;
    bins[b]+=len; bins[(b+1)%36]+=len*.3; bins[(b+35)%36]+=len*.3;
  }
  let maxBin=0;
  for(let i=1;i<36;i++) if(bins[i]>bins[maxBin]) maxBin=i;
  const dir1=maxBin*5;
  let secondBin=0;
  for(let i=0;i<36;i++){
    const d=Math.min(Math.abs(i-maxBin),36-Math.abs(i-maxBin));
    if(d>=3&&bins[i]>bins[secondBin]) secondBin=i;
  }
  const dir2=secondBin*5;
  const qU=qibla%180;
  const d1=angDiff180(dir1,qU),d2=angDiff180(dir2,qU);
  return{angle:d1<=d2?dir1:dir2,diff:Math.min(d1,d2)};
}

function angDiff180(a,b){ const d=Math.abs(((a-b)%180+180)%180); return Math.min(d,180-d); }

function computeGeometryComplexity(polyCoords) {
  if (!Array.isArray(polyCoords) || polyCoords.length < 4) return 0;
  const pts = polyCoords;
  const edges = [];
  for (let i = 0; i < pts.length - 1; i++) {
    const a = pts[i], b = pts[i+1];
    const dx = (b[1]-a[1]) * Math.cos(toRad((a[0]+b[0])/2)) * 111320;
    const dy = (b[0]-a[0]) * 111320;
    const len = Math.sqrt(dx*dx + dy*dy);
    if (len < 0.7) continue;
    const ang = (toDeg(Math.atan2(dx,dy)) + 360) % 180;
    edges.push({len, ang});
  }
  if (edges.length < 3) return 0;
  const total = edges.reduce((s,e) => s + e.len, 0) || 1;
  const bins = new Array(18).fill(0);
  edges.forEach(e => { bins[Math.floor(e.ang / 10) % 18] += e.len; });
  const entropy = -bins.reduce((s,v) => {
    if (!v) return s;
    const p = v / total;
    return s + p * Math.log2(p);
  }, 0) / Math.log2(18);
  const vertexPenalty = Math.min(1, Math.max(0, (pts.length - 6) / 18));
  return Math.max(0, Math.min(1, entropy * 0.72 + vertexPenalty * 0.28));
}

function destination(lat,lng,bearing,distM){
  const R=6371000,d=distM/R,t=toRad(bearing),p1=toRad(lat),l1=toRad(lng);
  const sp2=Math.sin(p1)*Math.cos(d)+Math.cos(p1)*Math.sin(d)*Math.cos(t);
  const p2=Math.asin(sp2);
  return{lat:toDeg(p2),lng:toDeg(l1+Math.atan2(Math.sin(t)*Math.sin(d)*Math.cos(p1),Math.cos(d)-Math.sin(p1)*sp2))};
}

function closestDirection(axisDeg,targetBearing){
  const d1=axisDeg,d2=(axisDeg+180)%360;
  const a1=Math.min(Math.abs(((d1-targetBearing)+360)%360),Math.abs(((d1-targetBearing)-360)%360));
  const a2=Math.min(Math.abs(((d2-targetBearing)+360)%360),Math.abs(((d2-targetBearing)-360)%360));
  return a1<=a2?d1:d2;
}

function isArabicText(s) {
  return /[\u0600-\u06FF]/.test(String(s || ''));
}

function uniqNonEmpty(vals) {
  const out = [];
  const seen = new Set();
  for (const v of vals || []) {
    const t = String(v || '').trim();
    if (!t) continue;
    const k = trLower(t);
    if (seen.has(k)) continue;
    seen.add(k);
    out.push(t);
  }
  return out;
}

function pickLocalizedMosqueNames(m, tags = {}) {
  const trCands = uniqNonEmpty([m?.nameTr, tags['name:tr'], tags['official_name:tr'], tags['alt_name:tr']]);
  const enCands = uniqNonEmpty([tags['name:en'], tags['official_name:en'], tags['alt_name:en']]);
  const arCands = uniqNonEmpty([m?.nameAr, tags['name:ar']]);
  const generic = uniqNonEmpty([m?.name, tags.name, tags.official_name, tags.int_name, tags.alt_name]);
  const latinGeneric = generic.filter(x => !isArabicText(x));

  const primaryPool = currentLang === 'en'
    ? [...enCands, ...latinGeneric, ...trCands, ...generic, ...arCands]
    : [...trCands, ...latinGeneric, ...enCands, ...generic, ...arCands];
  const primary = primaryPool[0] || m?.name || `OSM Cami #${m?.id ?? '?'}`;

  const arName = arCands.find(x => trLower(x) !== trLower(primary)) || '';
  return { primary, arName };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function makePopup(m){
  const tags = m.tags || {};
  const names = pickLocalizedMosqueNames(m, tags);
  const s=m.status==='correct'?'<span style="color:#4ade80">âœ… DoÄŸru yÃ¶n</span>':
          m.status==='wrong'?'<span style="color:#f87171">âŒ Sapma var</span>':
          '<span style="color:#fbbf24">âš ï¸ Veri yok</span>';
  const meth=
    m.method==='edge-analysis'?'Kenar analizi':
    m.method==='osm-tag'?'OSM etiketi':
    m.method==='hybrid-interior'?'Hibrit (iÃ§ mekan+bina)':
    m.method==='interior-only'?'Ä°Ã§ mekan kanÄ±tÄ±':
    m.method==='fused'?'BirleÅŸik':
    'â€”';
  const dist=greatCircleKm(m.lat,m.lng,KAABA.lat,KAABA.lng).toFixed(0);
  // Store mosque in global registry so popup button can find it by id
  window._popupRegistry = window._popupRegistry || {};
  window._popupRegistry[m.id] = m;
  return`<div class="p-name">${escHtml(names.primary)}</div>
    <div class="p-row"><span class="p-k">Durum</span><span class="p-v">${s}</span></div>
    <div class="p-row"><span class="p-k">GÃ¼ven</span><span class="p-v">${m.confidence ?? 'â€”'}/100</span></div>
    <div class="p-row"><span class="p-k">KÄ±ble aÃ§Ä±sÄ±</span><span class="p-v">${m.qibla.toFixed(1)}Â°</span></div>
    ${m.axis!==null?`<div class="p-row"><span class="p-k">Bina yÃ¶nÃ¼</span><span class="p-v">${m.axis.toFixed(1)}Â°</span></div>`:''}
    <div class="p-row"><span class="p-k">Sapma</span><span class="p-v">${m.diff!==null?m.diff.toFixed(1)+'Â°':'â€”'}</span></div>
    ${m.convertedFrom?.converted?`<div class="p-row"><span class="p-k">YapÄ± geÃ§miÅŸi</span><span class="p-v" style="color:#fbbf24">DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ olabilir</span></div>`:''}
    <div class="p-row"><span class="p-k">Kabe mesafesi</span><span class="p-v">${dist} km</span></div>
    <div class="p-method">YÃ¶ntem: ${meth}</div>
    <button class="p-anim-btn" onclick="animateFromPopup(${m.id})">ğŸŒ BÃ¼yÃ¼k Daire Animasyonu</button>`;
}

// Store last clicked for popup button
let _lastClickedMosque = null;

// Called by popup button â€” looks up mosque by id from registry or mosqueDB
function animateFromPopup(id) {
  // OSM ids are numbers; try both numeric and string lookup
  const numId = typeof id === 'string' ? parseInt(id) : id;
  const m = mosqueDB.get(numId) || mosqueDB.get(String(numId))
         || [...mosqueDB.values()].find(x => x.id == id);
  if (!m) { console.warn('animateFromPopup: mosque not found', id); return; }
  map.closePopup();
  // Small delay to let popup close before animating
  setTimeout(() => handleMosqueClick(m), 80);
}

function handleMosqueClick(m) {
  window._lastClickedMosque = m;
  document.querySelectorAll('.m-item').forEach(el=>el.classList.remove('active'));
  const el=document.getElementById('mi-'+m.id);
  if(el){el.classList.add('active');el.scrollIntoView({block:'nearest',behavior:'smooth'});}
  if (m.status === 'wrong') haptic(20);
  animateQibla(m);
  openDetailPanel(m);
}

function animateCounter(el, target) {
  const start = parseInt(el.textContent) || 0;
  if (start === target) return;
  const dur = 400, step = 16;
  const steps = dur / step;
  let cur = 0;
  el.classList.add('updated');
  setTimeout(()=>el.classList.remove('updated'), 400);
  const id = setInterval(() => {
    cur++;
    el.textContent = Math.round(start + (target - start) * (cur/steps));
    if (cur >= steps) { el.textContent = target; clearInterval(id); }
  }, step);
}

function updateStats(){
  const all=[...mosqueDB.values()];
  const bounds=map.getBounds().pad(0.1);
  const vis=all.filter(m=>bounds.contains([m.lat,m.lng]));
  if (vis.length) {
    animateCounter(document.getElementById('s-total'), vis.length);
    animateCounter(document.getElementById('s-ok'),    vis.filter(m=>m.status==='correct').length);
    animateCounter(document.getElementById('s-bad'),   vis.filter(m=>m.status==='wrong').length);
    animateCounter(document.getElementById('s-unk'),   vis.filter(m=>m.status==='unknown').length);
  } else {
    ['s-total','s-ok','s-bad','s-unk'].forEach(id=>document.getElementById(id).textContent='â€”');
  }
  updateSidebarSnapPanels();
}

function getLoadedStats() {
  const all = [...mosqueDB.values()];
  const withData = all.filter(m => m.diff !== null);
  const ok = withData.filter(m => m.diff <= tol);
  const pct = withData.length ? Math.round((ok.length / withData.length) * 100) : null;
  const avg = withData.length ? withData.reduce((s,m)=>s+m.diff,0)/withData.length : null;
  const max = withData.length ? Math.max(...withData.map(m=>m.diff)) : null;
  return { total: all.length, withData: withData.length, pct, avg, max };
}

function drawSidebarRadar(stats) {
  const cv = document.getElementById('sb-radar');
  if (!cv) return;
  const ctx = cv.getContext('2d');
  const W = cv.width, H = cv.height, cx = W/2, cy = H/2, r = 42;
  ctx.clearRect(0,0,W,H);
  for (let ring=1; ring<=3; ring++) {
    ctx.beginPath();
    for (let i=0; i<3; i++) {
      const a = (i/3)*Math.PI*2 - Math.PI/2;
      const x = cx + Math.cos(a)*r*(ring/3);
      const y = cy + Math.sin(a)*r*(ring/3);
      i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.strokeStyle = '#2a2a3a';
    ctx.lineWidth = 1;
    ctx.stroke();
  }
  const acc = (stats.pct ?? 0) / 100;
  const cov = stats.total ? (stats.withData / stats.total) : 0;
  const dev = stats.avg != null ? Math.max(0, Math.min(1, (90 - stats.avg) / 90)) : 0;
  const vals = [acc, cov, dev];
  ctx.beginPath();
  for (let i=0; i<3; i++) {
    const a = (i/3)*Math.PI*2 - Math.PI/2;
    const x = cx + Math.cos(a)*r*vals[i];
    const y = cy + Math.sin(a)*r*vals[i];
    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  }
  ctx.closePath();
  ctx.fillStyle = 'rgba(201,168,76,.18)';
  ctx.fill();
  ctx.strokeStyle = '#c9a84c';
  ctx.lineWidth = 2;
  ctx.stroke();
}

function updateSidebarSnapPanels() {
  if (window.innerWidth > 768) return;
  const stats = getLoadedStats();
  const city = currentCity || 'â€”';
  const miniCity = document.getElementById('sb-mini-city');
  const miniScore = document.getElementById('sb-mini-score');
  const miniSub = document.getElementById('sb-mini-sub');
  if (miniCity) miniCity.textContent = city;
  if (miniScore) miniScore.textContent = stats.pct != null ? `${stats.pct}%` : 'â€”';
  if (miniSub) miniSub.textContent = stats.total ? `${stats.total} cami Â· tolerans ${tol}Â°` : 'Veri bekleniyor';
  const st = (id,v) => { const el=document.getElementById(id); if (el) el.textContent = v; };
  st('sb-m-total', stats.total ? stats.total.toLocaleString() : 'â€”');
  st('sb-m-pct', stats.pct != null ? `${stats.pct}%` : 'â€”');
  st('sb-m-avg', stats.avg != null ? `${stats.avg.toFixed(1)}Â°` : 'â€”');
  st('sb-m-max', stats.max != null ? `${stats.max.toFixed(1)}Â°` : 'â€”');
  drawSidebarRadar(stats);
}

function updateList(visible){
  const el=document.getElementById('mosque-list');
  if(!visible.length){el.innerHTML='<div class="empty"><div class="empty-icon">ğŸ•Œ</div><div>Cami bulunamadÄ±</div></div>';document.getElementById('sb-count').textContent='';return;}
  document.getElementById('sb-count').textContent=visible.length;
  const sorted=[...visible].sort((a,b)=>({wrong:0,unknown:1,correct:2}[a.status]-{wrong:0,unknown:1,correct:2}[b.status]));
  const frag=document.createDocumentFragment();
  sorted.forEach((m,i)=>{
    const col=m.status==='correct'?'#4ade80':m.status==='wrong'?'#f87171':'#fbbf24';
    const div=document.createElement('div');
    div.className='m-item';div.id='mi-'+m.id;
    div.style.animationDelay = Math.min(i*18, 300)+'ms';
    const convMark = m.convertedFrom?.converted ? ' â›ªâ†’ğŸ•Œ' : '';
    div.innerHTML=`<div class="m-dot" style="background:${col};box-shadow:0 0 4px ${col}"></div>
      <div class="m-info"><div class="m-name">${escHtml(m.name)}${convMark}</div>
      <div class="m-sub">KÄ±ble:${m.qibla.toFixed(1)}Â°${m.axis!==null?' | Bina:'+m.axis.toFixed(1)+'Â°':''}</div></div>
      <div class="m-diff" style="color:${col}">${m.diff!==null?m.diff.toFixed(1)+'Â°':'â€”'}</div>`;
    div.onclick=()=>handleMosqueClick(m);
    frag.appendChild(div);
  });
  el.innerHTML='';el.appendChild(frag);
}

function recompute(){
  if(!mosqueDB.size) return;
  mosqueDB.forEach(m=>applyAxisFusion(m));
  renderAll();
  if(heatVisible) refreshHeatmap();
  if(scoreCardVisible) updateScoreCard();
  // Re-render comparison with updated tolerance
  const overlay = document.getElementById('cmp-overlay');
  if(overlay && overlay.classList.contains('show')) renderCompare();
  // History: reset period cache so next enrichWithPeriod re-runs (tol change affects correct/wrong)
  if(typeof historyModeActive !== 'undefined' && historyModeActive) {
    renderHistoryModal();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HEATMAP (AdÄ±m 2)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadLeafletHeat() {
  if(window.L && L.heatLayer) return; // already loaded
  return new Promise((res,rej)=>{
    const s=document.createElement('script');
    s.src='https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js';
    s.onload=res; s.onerror=rej;
    document.head.appendChild(s);
  });
}

async function toggleHeatmap() {
  const btn = document.getElementById('btn-heat');
  if(heatVisible){
    // Turn off
    if(heatLayer){ try{map.removeLayer(heatLayer);}catch{} heatLayer=null; }
    heatVisible=false;
    btn.classList.remove('active');
    return;
  }
  // Turn on
  try {
    await loadLeafletHeat();
  } catch {
    toast('IsÄ± haritasÄ± yÃ¼klenemedi',4000); return;
  }
  heatVisible=true;
  btn.classList.add('active');
  refreshHeatmap();
}

function refreshHeatmap(){
  if(!heatVisible || !window.L || !L.heatLayer) return;
  if(heatLayer){ try{map.removeLayer(heatLayer);}catch{} heatLayer=null; }

  const bounds = map.getBounds().pad(0.15);
  const points = [];

  [...mosqueDB.values()]
    .filter(m=>bounds.contains([m.lat,m.lng]) && m.diff!==null)
    .forEach(m=>{
      // Intensity: normalize diff to 0-1 range (0Â°=cool, 90Â°=hot)
      // We want to show WHERE sapma is concentrated â€” high diff = hot
      const intensity = Math.min(m.diff / 45, 1.0);
      points.push([m.lat, m.lng, intensity]);
    });

  if(!points.length) return;

  heatLayer = L.heatLayer(points, {
    radius: 35,
    blur: 25,
    maxZoom: 17,
    max: 1.0,
    gradient: {
      0.0: '#1a3a2a',   // very dark green (perfect)
      0.2: '#4ade80',   // green (good)
      0.4: '#fbbf24',   // amber (marginal)
      0.7: '#f87171',   // red (bad)
      1.0: '#dc2626'    // deep red (very bad)
    }
  }).addTo(map);
  heatLayer.bringToFront();
}

// Auto-refresh heatmap when map moves
// (wired into loadViewport â†’ renderAll)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCORE CARD (AdÄ±m 2)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleScoreCard() {
  scoreCardVisible = !scoreCardVisible;
  const card = document.getElementById('score-card');
  const btn = document.getElementById('btn-score');
  card.classList.toggle('show', scoreCardVisible);
  btn.classList.toggle('active', scoreCardVisible);
  if(scoreCardVisible) updateScoreCard();
}

function updateScoreCard(){
  const bounds = map.getBounds().pad(0.1);
  const visible = [...mosqueDB.values()].filter(m=>bounds.contains([m.lat,m.lng]));
  const withData = visible.filter(m=>m.diff!==null);
  const correct = visible.filter(m=>m.status==='correct');
  const wrong   = visible.filter(m=>m.status==='wrong');
  const unknown = visible.filter(m=>m.status==='unknown');

  const total = withData.length;
  const pct = total > 0 ? Math.round((correct.length / total) * 100) : null;

  // City name
  document.getElementById('sc-city').textContent = currentCity;
  document.getElementById('sc-tol-val').textContent = tol+'Â°';

  // Percentage
  document.getElementById('sc-pct').textContent = pct !== null ? pct+'%' : 'â€”';

  // Grade
  const gradeEl = document.getElementById('sc-grade');
  let grade='â€”', gradeClass='';
  if(pct!==null){
    if(pct>=85){grade='A â€” MÃ¼kemmel';gradeClass='A';}
    else if(pct>=65){grade='B â€” Ä°yi';gradeClass='B';}
    else if(pct>=45){grade='C â€” Orta';gradeClass='C';}
    else{grade='D â€” ZayÄ±f';gradeClass='D';}
  }
  gradeEl.textContent=grade;
  gradeEl.className='sc-grade'+(gradeClass?' '+gradeClass:'');

  // Stats
  document.getElementById('sc-ok').textContent  = correct.length;
  document.getElementById('sc-bad').textContent = wrong.length;
  document.getElementById('sc-unk').textContent = unknown.length;

  if(withData.length){
    const diffs = withData.map(m=>m.diff);
    const avg = diffs.reduce((a,b)=>a+b,0)/diffs.length;
    const maxD = Math.max(...diffs);
    const minD = Math.min(...diffs);
    document.getElementById('sc-avg').textContent = avg.toFixed(1)+'Â°';
    document.getElementById('sc-max').textContent = maxD.toFixed(1)+'Â°';
    document.getElementById('sc-min').textContent = minD.toFixed(1)+'Â°';

    // Best (smallest diff) and worst (largest diff) with data
    const sorted = [...withData].sort((a,b)=>a.diff-b.diff);
    document.getElementById('sc-best').textContent  = sorted[0].name+' ('+sorted[0].diff.toFixed(1)+'Â°)';
    document.getElementById('sc-worst').textContent = sorted[sorted.length-1].name+' ('+sorted[sorted.length-1].diff.toFixed(1)+'Â°)';
  } else {
    ['sc-avg','sc-max','sc-min','sc-best','sc-worst'].forEach(id=>document.getElementById(id).textContent='â€”');
  }

  // Donut chart (canvas)
  drawDonut(correct.length, wrong.length, unknown.length, pct);
}

function drawDonut(ok, bad, unk, pct){
  const canvas = document.getElementById('sc-donut');
  const ctx = canvas.getContext('2d');
  const cx=55, cy=55, r=44, inner=30;
  ctx.clearRect(0,0,110,110);

  const total = ok+bad+unk;
  if(!total){ 
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); 
    ctx.strokeStyle='#2a2a3a'; ctx.lineWidth=14; ctx.stroke(); 
    return; 
  }

  const slices = [
    { val:ok,  color:'#4ade80' },
    { val:bad, color:'#f87171' },
    { val:unk, color:'#fbbf24' }
  ].filter(s=>s.val>0);

  let angle = -Math.PI/2;
  for(const s of slices){
    const sweep = (s.val/total) * Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,r,angle,angle+sweep);
    ctx.closePath();
    ctx.fillStyle = s.color+'33'; // very subtle fill
    ctx.fill();
    // Arc stroke (thick ring)
    ctx.beginPath();
    ctx.arc(cx,cy,r-7, angle, angle+sweep);
    ctx.strokeStyle = s.color;
    ctx.lineWidth = 13;
    ctx.lineCap = 'butt';
    ctx.stroke();
    angle += sweep;
  }

  // Gap lines between slices
  ctx.strokeStyle='#0a0a0f';
  ctx.lineWidth=2;
  angle=-Math.PI/2;
  for(const s of slices){
    const sweep=(s.val/total)*Math.PI*2;
    ctx.beginPath();
    ctx.moveTo(cx+Math.cos(angle)*(r-14), cy+Math.sin(angle)*(r-14));
    ctx.lineTo(cx+Math.cos(angle)*r, cy+Math.sin(angle)*r);
    ctx.stroke();
    angle+=sweep;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOSQUE SEARCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let mosqueFilter = '';        // active filter query
let msDropdownIdx = -1;       // keyboard navigation index
let cityDropdownIdx = -1;
let msGeoProbePending = false;
let msGeoProbeAt = 0;
let msScopeViewportOnly = true;
let msRemoteLookupPending = false;
let msRemoteLookupKey = '';
const msRemoteLookupMissAt = new Map();
const LANDMARK_ALIAS_GROUPS = [
  { key:'sultanahmet', aliases:['sultanahmet camii','sultan ahmet camii','sultan ahmed mosque','blue mosque','the blue mosque','sultanahmet mosque'] },
  { key:'ayasofya', aliases:['ayasofya','ayasofya camii','hagia sophia','aya sofya'] },
  { key:'fatih', aliases:['fatih camii','fatih mosque','fatih mosque istanbul'] },
  { key:'suleymaniye', aliases:['suleymaniye camii','sÃ¼leymaniye camii','suleymaniye mosque'] },
  { key:'eyup_sultan', aliases:['eyup sultan camii','eyÃ¼p sultan camii','eyup sultan mosque'] },
  { key:'selimiye_edirne', aliases:['selimiye camii edirne','selimiye mosque edirne','edirne selimiye'] },
  { key:'ulu_cami_bursa', aliases:['bursa ulu camii','ulu cami bursa','grand mosque of bursa'] },
  { key:'kocatepe', aliases:['kocatepe camii','kocatepe mosque'] },
  { key:'camlica', aliases:['camlica camii','Ã§amlÄ±ca camii','buyuk camlica camii','bÃ¼yÃ¼k Ã§amlÄ±ca camii'] },
  { key:'nabawi', aliases:['mescid-i nebevi','masjid an nabawi','al-masjid an-nabawi','prophets mosque','prophet mosque medina'] },
  { key:'aqsa', aliases:['mescid-i aksa','masjid al aqsa','al-aqsa mosque','aqsa mosque'] },
  { key:'hassan_ii', aliases:['hassan ii mosque','hassan 2 mosque','cami hassan ii'] },
  { key:'sheikh_zayed', aliases:['sheikh zayed grand mosque','sheikh zayed mosque','zayed grand mosque'] },
  { key:'badshahi', aliases:['badshahi mosque','badshahi masjid'] },
  { key:'faisal_islamabad', aliases:['faisal mosque','faisal masjid islamabad'] },
  { key:'istiqlal_jakarta', aliases:['istiqlal mosque','masjid istiqlal'] },
  { key:'putra', aliases:['putra mosque','masjid putra'] },
  { key:'national_malaysia', aliases:['national mosque malaysia','masjid negara'] },
  { key:'baiturrahman', aliases:['baiturrahman grand mosque','masjid raya baiturrahman'] },
  { key:'blue_mosque_yerevan', aliases:['blue mosque yerevan','gok jami yerevan','gÃ¶k cami yerevan'] }
];
const LANDMARK_ALIAS_COMPILED = LANDMARK_ALIAS_GROUPS.map(g => ({
  key: g.key,
  aliasesNorm: [...new Set((g.aliases || []).map(a => normalize(trLower(a))).filter(Boolean))]
}));

function uniqueNameList(arr) {
  const out = [];
  const seen = new Set();
  for (const raw of arr || []) {
    const v = String(raw || '').trim();
    if (!v) continue;
    const key = trLower(v);
    if (seen.has(key)) continue;
    seen.add(key);
    out.push(v);
  }
  return out;
}

function findAliasGroupsForQuery(qNorm) {
  if (!qNorm) return [];
  const out = new Set();
  for (const g of LANDMARK_ALIAS_COMPILED) {
    for (const a of g.aliasesNorm) {
      if (a === qNorm || a.startsWith(qNorm) || qNorm.startsWith(a) || a.includes(` ${qNorm}`) || qNorm.includes(` ${a}`)) {
        out.add(g.key);
        break;
      }
    }
  }
  return [...out];
}

function gatherMosqueNameVariants(m) {
  const tags = m?.tags || {};
  const wikipediaTitle = (typeof tags.wikipedia === 'string' && tags.wikipedia.includes(':'))
    ? tags.wikipedia.split(':').slice(1).join(':').replace(/_/g, ' ').trim()
    : '';
  const wdLabel = tags.wikidata ? wikidataLabelCache.get(String(tags.wikidata).toUpperCase()) : null;
  return uniqueNameList([
    m?.name, m?.nameTr, m?.nameAr,
    tags['name'], tags['name:tr'], tags['name:en'], tags['name:ar'],
    tags['official_name'], tags['short_name'], tags['alt_name'], tags['old_name'],
    tags['loc_name'], tags['int_name'], tags['operator'], wikipediaTitle, wdLabel
  ]);
}

function buildSearchIndexForMosque(m) {
  if (!m) return;
  const variants = gatherMosqueNameVariants(m);
  const namesLow = variants.map(v => trLower(v));
  const namesNorm = namesLow.map(v => normalize(v));
  const tokenSet = new Set();
  for (const n of namesLow) {
    const toks = n.split(/[^a-z0-9Ä±ÄŸÃ¼ÅŸÃ¶Ã§Ã¢ÃªÃ®Ã»]+/i).filter(t => t.length > 1);
    for (const t of toks) {
      tokenSet.add(t);
      tokenSet.add(normalize(t));
    }
  }
  const aliasGroups = [];
  for (const g of LANDMARK_ALIAS_COMPILED) {
    const hit = g.aliasesNorm.some(alias =>
      namesNorm.some(n => n === alias || n.includes(alias) || (n.length >= 8 && alias.includes(n)))
    );
    if (hit) aliasGroups.push(g.key);
  }
  m.searchIndex = {
    variants,
    namesLow,
    namesNorm,
    tokens: [...tokenSet],
    aliasGroups
  };
}

function initMosqueSearch() {
  const input    = document.getElementById('mosque-search');
  const dropdown = document.getElementById('ms-dropdown');
  const clearBtn = document.getElementById('ms-clear');
  const scopeChk = document.getElementById('ms-scope-only');

  let debounceTimer = null;

  input.addEventListener('input', () => {
    const q = input.value; // don't trim yet â€” let user type spaces
    clearBtn.classList.toggle('show', q.length > 0);
    input.classList.toggle('has-value', q.length > 0);
    msDropdownIdx = -1;

    clearTimeout(debounceTimer);

    if (!q.trim()) {
      dropdown.classList.remove('show');
      if (mosqueFilter) { mosqueFilter = ''; applyMosqueFilter(''); }
      return;
    }

    // Debounce 80ms so rapid typing doesn't stutter
    debounceTimer = setTimeout(() => showMosqueDropdown(q.trim()), 80);
  });

  input.addEventListener('keydown', e => {
    if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
      e.preventDefault();
      e.stopPropagation();
      const items = dropdown.querySelectorAll('.ms-item');
      if (!items.length) return;
      if (e.key === 'ArrowDown') msDropdownIdx = Math.min(msDropdownIdx + 1, items.length - 1);
      else                        msDropdownIdx = Math.max(msDropdownIdx - 1, 0);
      items.forEach((el,i) => el.classList.toggle('focused', i === msDropdownIdx));
      if (items[msDropdownIdx]) items[msDropdownIdx].scrollIntoView({block:'nearest'});
    } else if (e.key === 'Enter') {
      e.preventDefault();
      e.stopPropagation();
      const items = dropdown.querySelectorAll('.ms-item');
      if (msDropdownIdx >= 0 && items[msDropdownIdx]) {
        items[msDropdownIdx].click();
      } else if (input.value.trim()) {
        applyMosqueFilter(input.value.trim());
        dropdown.classList.remove('show');
      }
    } else if (e.key === 'Escape') {
      e.stopPropagation();
      dropdown.classList.remove('show');
      input.blur();
    } else if (e.key === '/') {
      // Don't let global '/' shortcut steal focus when already in mosque-search
      e.stopPropagation();
    }
  });

  document.addEventListener('click', e => {
    if (!e.target.closest('#ms-wrap')) dropdown.classList.remove('show');
  });

  scopeChk?.addEventListener('change', () => {
    msScopeViewportOnly = !!scopeChk.checked;
    const q = input.value.trim();
    if (q) showMosqueDropdown(q);
    const cq = document.getElementById('city-input')?.value?.trim();
    if (cq) showCitySmartDropdown(cq);
  });
}

function initTopSmartSearch() {
  const input = document.getElementById('city-input');
  const dd = document.getElementById('city-smart-dd');
  if (!input || !dd) return;
  let t = null;
  input.addEventListener('input', () => {
    const q = input.value.trim();
    clearTimeout(t);
    if (!q) { closeCitySmartDropdown(); return; }
    t = setTimeout(() => showCitySmartDropdown(q), 90);
  });
  input.addEventListener('keydown', e => {
    if (!dd.classList.contains('show')) return;
    const items = dd.querySelectorAll('.ms-item');
    if (!items.length) return;
    if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
      e.preventDefault();
      if (e.key === 'ArrowDown') cityDropdownIdx = Math.min(cityDropdownIdx + 1, items.length - 1);
      else cityDropdownIdx = Math.max(cityDropdownIdx - 1, 0);
      items.forEach((el,i) => el.classList.toggle('focused', i === cityDropdownIdx));
      items[cityDropdownIdx]?.scrollIntoView({ block:'nearest' });
    } else if (e.key === 'Escape') {
      closeCitySmartDropdown();
    } else if (e.key === 'Enter' && cityDropdownIdx >= 0) {
      e.preventDefault();
      items[cityDropdownIdx]?.click();
    }
  });
  document.addEventListener('click', e => {
    if (!e.target.closest('.search-box')) closeCitySmartDropdown();
  });
}

// Scoring function for a single mosque against query
function msMosqueScore(m, qLow, qNorm, words) {
  if (!m.searchIndex) buildSearchIndexForMosque(m);
  const names = m.searchIndex?.namesLow || [trLower(m.name || '')];
  const namesNorm = m.searchIndex?.namesNorm || names.map(n => normalize(n));
  const tokenSet = new Set(m.searchIndex?.tokens || []);
  const mosqueAliasGroups = new Set(m.searchIndex?.aliasGroups || []);
  const queryAliasGroups = findAliasGroupsForQuery(qNorm);

  let best = 0;
  for (const n of names) {
    const nn = normalize(n);
    if      (n === qLow)                                       best = Math.max(best, 100);
    else if (n.startsWith(qLow))                               best = Math.max(best, 85);
    else if (n.split(/\s+/).some(w => w === qLow))             best = Math.max(best, 80);
    else if (n.split(/\s+/).some(w => w.startsWith(qLow)))     best = Math.max(best, 65);
    else if (n.includes(qLow))                                 best = Math.max(best, 50);
    else if (nn.includes(qNorm))                               best = Math.max(best, 35);
  }

  // Multi-word: all words must appear somewhere in any name
  if (best === 0 && words.length > 1) {
    const allMatch = words.every(w =>
      tokenSet.has(w) || tokenSet.has(normalize(w)) ||
      names.some(n => n.includes(w)) || namesNorm.some(n => n.includes(normalize(w)))
    );
    if (allMatch) best = 30;
    else {
      // Partial: at least one word matches
      const anyMatch = words.some(w =>
        tokenSet.has(w) || tokenSet.has(normalize(w)) ||
        names.some(n => n.includes(w)) || namesNorm.some(n => n.includes(normalize(w)))
      );
      if (anyMatch) best = 10;
    }
  }

  if (queryAliasGroups.length && mosqueAliasGroups.size) {
    const aliasHit = queryAliasGroups.some(g => mosqueAliasGroups.has(g));
    if (aliasHit) best = Math.max(best, 160);
  }
  if (best > 0 && mosqueAliasGroups.size) {
    best += Math.min(14, mosqueAliasGroups.size * 4);
  }

  return best;
}

function computeMosquePopularityScore(m) {
  const tags = m?.tags || {};
  let score = 0;
  const aliasCount = Array.isArray(m?.searchIndex?.aliasGroups) ? m.searchIndex.aliasGroups.length : 0;
  if (aliasCount) score += Math.min(20, aliasCount * 6);
  if (typeof tags.wikipedia === 'string' && tags.wikipedia.trim()) score += 10;
  if (typeof tags.wikidata === 'string' && tags.wikidata.trim()) score += 12;
  if (typeof tags.historic === 'string' && tags.historic.trim()) score += 8;
  if (typeof tags.heritage === 'string' && tags.heritage.trim()) score += 8;
  if (trLower(tags.tourism || '') === 'attraction') score += 6;
  if (trLower(tags.place || '') === 'landmark') score += 6;
  if (!isPlaceholderMosqueName(m?.name) && !isGenericMosqueName(m?.name)) score += 4;
  return Math.min(40, score);
}

function computeMosqueProximityScore(m) {
  if (!userGeoState.enabled || !Number.isFinite(userGeoState.lat) || !Number.isFinite(userGeoState.lng)) return 0;
  const km = greatCircleKm(userGeoState.lat, userGeoState.lng, m.lat, m.lng);
  if (!Number.isFinite(km)) return 0;
  if (km <= 0.25) return 18;
  if (km <= 1) return 14;
  if (km <= 3) return 10;
  if (km <= 8) return 6;
  if (km <= 20) return 3;
  return 0;
}

function msEditDistance(a, b) {
  const s = String(a || '');
  const t = String(b || '');
  if (!s) return t.length;
  if (!t) return s.length;
  const dp = Array.from({ length: s.length + 1 }, () => new Array(t.length + 1).fill(0));
  for (let i = 0; i <= s.length; i++) dp[i][0] = i;
  for (let j = 0; j <= t.length; j++) dp[0][j] = j;
  for (let i = 1; i <= s.length; i++) {
    for (let j = 1; j <= t.length; j++) {
      const c = s[i - 1] === t[j - 1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i - 1][j] + 1,
        dp[i][j - 1] + 1,
        dp[i - 1][j - 1] + c
      );
    }
  }
  return dp[s.length][t.length];
}

function suggestClosestMosqueQuery(qNorm) {
  if (!qNorm || qNorm.length < 3 || !mosqueDB.size) return null;
  let best = null;
  let bestDist = Infinity;
  for (const m of mosqueDB.values()) {
    if (!m.searchIndex) buildSearchIndexForMosque(m);
    const names = m.searchIndex?.namesNorm || [];
    for (const n of names) {
      if (!n || n.length < 3) continue;
      const d = msEditDistance(qNorm, n);
      if (d < bestDist) {
        bestDist = d;
        best = m.name || n;
      }
      if (bestDist === 1) break;
    }
    if (bestDist === 1) break;
  }
  if (!best) return null;
  const maxAllowed = Math.max(1, Math.floor(qNorm.length * 0.34));
  return bestDist <= maxAllowed ? best : null;
}

function applySuggestedMosqueQuery(text) {
  const input = document.getElementById('mosque-search');
  if (!input) return;
  input.value = text;
  input.classList.add('has-value');
  document.getElementById('ms-clear')?.classList.add('show');
  showMosqueDropdown(text);
}

function rankMosqueCandidates(q, limit = 15) {
  const qLow  = trLower(q);
  const qNorm = normalize(qLow);
  const words = qLow.split(/\s+/).filter(w => w.length > 0);
  const bounds = map?.getBounds?.()?.pad?.(0.08) || null;
  const scored = [];
  for (const m of mosqueDB.values()) {
    const textScore = msMosqueScore(m, qLow, qNorm, words);
    if (textScore <= 0) continue;
    const inView = bounds ? bounds.contains([m.lat, m.lng]) : false;
    const popScore = computeMosquePopularityScore(m);
    const proxScore = computeMosqueProximityScore(m);
    const viewportBonus = !bounds ? 0 : (inView ? (msScopeViewportOnly ? 45 : 18) : (msScopeViewportOnly ? -50 : 0));
    const rankScore = textScore + popScore + proxScore + viewportBonus;
    scored.push({ m, s:textScore, p:popScore, d:proxScore, inView, rank:rankScore });
  }
  const ranked = msScopeViewportOnly && bounds
    ? scored.filter(x => x.inView).sort((a,b) => b.rank - a.rank || b.s - a.s)
    : scored.sort((a,b) => b.rank - a.rank || (b.inView - a.inView) || (b.s - a.s));
  return { ranked: ranked.slice(0, limit), qLow, qNorm, words, bounds };
}

function toOsmType(v) {
  const t = trLower(String(v || '').trim());
  if (t === 'n' || t === 'node') return 'node';
  if (t === 'w' || t === 'way') return 'way';
  if (t === 'r' || t === 'relation') return 'relation';
  return null;
}

function isLikelyMosqueHit(it) {
  const cls = trLower(it?.class || '');
  const typ = trLower(it?.type || '');
  const disp = trLower(it?.display_name || '');
  if (cls === 'amenity' && (typ === 'place_of_worship' || typ === 'mosque')) return true;
  return /\b(cami|camii|mosque|masjid|mescid|mescit|dÅ¾amija|dzamija)\b/.test(disp);
}

function nominatimViewboxParams(bounds, bounded = true) {
  if (!bounds) return '';
  const left = bounds.getWest().toFixed(6);
  const top = bounds.getNorth().toFixed(6);
  const right = bounds.getEast().toFixed(6);
  const bottom = bounds.getSouth().toFixed(6);
  return `&viewbox=${left},${top},${right},${bottom}${bounded ? '&bounded=1' : ''}`;
}

async function fetchNominatimMosqueRefs(query, bounds, bounded = true, limit = 12) {
  const vb = nominatimViewboxParams(bounds, bounded);
  const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=${limit}&addressdetails=1&q=${encodeURIComponent(query)}${vb}`;
  const data = await nominatimFetchJson(url, {'Accept-Language':'tr,en'});
  const refs = [];
  for (const it of (data || [])) {
    if (!isLikelyMosqueHit(it)) continue;
    const osmType = toOsmType(it.osm_type);
    const id = String(it.osm_id || '').replace(/\D/g, '');
    if (!osmType || !id) continue;
    refs.push({ osmType, id });
  }
  return refs;
}

async function fetchByOsmRefs(refs) {
  const groups = { node:[], way:[], relation:[] };
  for (const r of refs || []) {
    if (!r?.osmType || !r?.id) continue;
    groups[r.osmType]?.push(String(r.id));
  }
  const uniq = t => [...new Set(groups[t])].slice(0, 40);
  const nodes = uniq('node');
  const ways = uniq('way');
  const rels = uniq('relation');
  if (!nodes.length && !ways.length && !rels.length) return [];
  const parts = [];
  if (nodes.length) parts.push(`node(id:${nodes.join(',')});`);
  if (ways.length) parts.push(`way(id:${ways.join(',')});`);
  if (rels.length) parts.push(`relation(id:${rels.join(',')});`);
  const q = `[out:json][timeout:45];(${parts.join('')});out body geom tags center;`;
  return fetchOverpassQuery(q);
}

async function triggerRemoteMosqueLookup(query, qNorm, bounds) {
  if (!query || !qNorm || qNorm.length < 3) return 0;
  if (msRemoteLookupPending && msRemoteLookupKey === qNorm) return 0;
  const missAt = msRemoteLookupMissAt.get(qNorm);
  if (missAt && Date.now() - missAt < 120000) return 0;
  msRemoteLookupPending = true;
  msRemoteLookupKey = qNorm;
  try {
    const refsMap = new Map();
    const boundedRefs = await fetchNominatimMosqueRefs(query, bounds, true, 16).catch(() => []);
    boundedRefs.forEach(r => refsMap.set(`${r.osmType}:${r.id}`, r));

    if (!refsMap.size || !msScopeViewportOnly) {
      const globalRefs = await fetchNominatimMosqueRefs(`${query} mosque`, null, false, 14).catch(() => []);
      globalRefs.forEach(r => refsMap.set(`${r.osmType}:${r.id}`, r));
    }

    if (!refsMap.size) {
      msRemoteLookupMissAt.set(qNorm, Date.now());
      return 0;
    }

    const elements = await fetchByOsmRefs([...refsMap.values()]);
    const added = processElements(elements);
    if (!added) msRemoteLookupMissAt.set(qNorm, Date.now());
    return added;
  } catch {
    return 0;
  } finally {
    msRemoteLookupPending = false;
    msRemoteLookupKey = '';
  }
}

function getMosqueHierarchyLine(m) {
  const t = m?.tags || {};
  const n1 = t['addr:suburb'] || t['addr:neighbourhood'] || t['addr:quarter'] || t['addr:hamlet'] || t['addr:village'] || t['addr:city_district'] || '';
  const n2 = t['addr:district'] || t['addr:township'] || t['addr:county'] || '';
  const n3 = t['addr:city'] || t['addr:town'] || t['addr:municipality'] || t['addr:state'] || t['is_in:city'] || t['is_in:state'] || '';
  const parts = [n1, n2, n3].map(x => String(x || '').trim()).filter(Boolean);
  if (parts.length) return parts.join(', ');
  return 'Mahalle / ilÃ§e / ÅŸehir bilgisi yok';
}

function getUserDistanceLabel(m) {
  if (!userGeoState.enabled || !Number.isFinite(userGeoState.lat) || !Number.isFinite(userGeoState.lng)) return '';
  const km = greatCircleKm(userGeoState.lat, userGeoState.lng, m.lat, m.lng);
  if (!Number.isFinite(km)) return '';
  if (km < 1) return `${Math.max(50, Math.round(km * 1000))} m`;
  return `${km.toFixed(km < 10 ? 1 : 0)} km`;
}

async function probeUserGeoForSearch(currentQuery) {
  if (msGeoProbePending) return;
  if (!navigator.geolocation) return;
  if (Date.now() - msGeoProbeAt < 45000) return;
  msGeoProbePending = true;
  try {
    if (navigator.permissions?.query) {
      const perm = await navigator.permissions.query({ name:'geolocation' });
      if (perm.state !== 'granted') return;
    } else if (!userGeoState.enabled) {
      return;
    }
    const pos = await getCurrentPositionAsync({ enableHighAccuracy:false, timeout:4500, maximumAge:300000 });
    setUserGeoState(pos.coords.latitude, pos.coords.longitude, true);
    const inputVal = document.getElementById('mosque-search')?.value?.trim();
    if (inputVal && inputVal === currentQuery) showMosqueDropdown(inputVal);
  } catch {
    // Silent fail: dropdown should continue without distance.
  } finally {
    msGeoProbeAt = Date.now();
    msGeoProbePending = false;
  }
}

function showMosqueDropdown(q) {
  const dropdown = document.getElementById('ms-dropdown');
  probeUserGeoForSearch(q);

  if (!mosqueDB || !mosqueDB.size) {
    dropdown.innerHTML = '<div class="ms-no-result">HenÃ¼z veri yÃ¼klenmedi â€” bir ÅŸehir arayÄ±n</div>';
    dropdown.classList.add('show');
    return;
  }

  const { ranked, qNorm, bounds } = rankMosqueCandidates(q, 15);
  const top = ranked;

  if (!top.length) {
    const scopeMsg = msScopeViewportOnly ? ' (mevcut harita alanÄ±nda)' : '';
    const alt = suggestClosestMosqueQuery(qNorm);
    dropdown.innerHTML = `<div class="ms-no-result">"${escHtml(q)}" iÃ§in sonuÃ§ bulunamadÄ±${scopeMsg}${
      alt ? `<br><button class="ms-suggest-btn" onclick="applySuggestedMosqueQuery('${escHtml(alt).replace(/'/g, '&#39;')}')">Bunu mu demek istediniz: ${escHtml(alt)}?</button>` : ''
    }<br><span style="opacity:.75">DÄ±ÅŸ kaynakta aranÄ±yor...</span></div>`;
    dropdown.classList.add('show');
    triggerRemoteMosqueLookup(q, qNorm, bounds).then(added => {
      const current = document.getElementById('mosque-search')?.value?.trim();
      if (current !== q) return;
      if (added > 0) {
        showMosqueDropdown(q);
        return;
      }
      const scopeMsg2 = msScopeViewportOnly ? ' (mevcut harita alanÄ±nda)' : '';
      const alt2 = suggestClosestMosqueQuery(qNorm);
      dropdown.innerHTML = `<div class="ms-no-result">"${escHtml(q)}" iÃ§in sonuÃ§ bulunamadÄ±${scopeMsg2}${
        alt2 ? `<br><button class="ms-suggest-btn" onclick="applySuggestedMosqueQuery('${escHtml(alt2).replace(/'/g, '&#39;')}')">Bunu mu demek istediniz: ${escHtml(alt2)}?</button>` : ''
      }</div>`;
      dropdown.classList.add('show');
    });
    return;
  }

  const frag = document.createDocumentFragment();
  top.forEach(({m, p, d, inView}) => {
    const col = m.status==='correct'?'#4ade80':m.status==='wrong'?'#f87171':'#fbbf24';
    const addressLine = getMosqueHierarchyLine(m);
    const userDistance = getUserDistanceLabel(m);
    const rightBadge = userDistance ? `${userDistance} uzaÄŸÄ±nÄ±zda` : (m.diff!==null ? m.diff.toFixed(1)+'Â°' : 'â€”');
    const badges = [];
    if (p >= 14) badges.push('<span class="ms-badge pop">PopÃ¼ler</span>');
    if (d >= 10) badges.push('<span class="ms-badge near">YakÄ±nda</span>');
    if (inView) badges.push('<span class="ms-badge view">Bu bÃ¶lgede</span>');
    const div = document.createElement('div');
    div.className = 'ms-item';
    div.innerHTML = `
      <div class="ms-item-dot" style="background:${col};box-shadow:0 0 4px ${col}"></div>
      <div class="ms-item-info">
        <div class="ms-item-name">${highlightMatch(m.name, q)}</div>
        <div class="ms-item-sub">${escHtml(addressLine)}</div>
        ${badges.length ? `<div class="ms-badges">${badges.join('')}</div>` : ''}
        <div class="ms-item-sub meta">KÄ±ble:${m.qibla.toFixed(1)}Â°${m.diff!==null?' | '+m.diff.toFixed(1)+'Â° sapma':''}</div>
      </div>
      <div class="ms-item-diff" style="color:${userDistance ? 'var(--gold)' : col}">${escHtml(rightBadge)}</div>`;
    div.onclick = () => selectMosque(m);
    frag.appendChild(div);
  });

  // "Filter all" footer
  const total = ranked.length;
  if (total > 0) {
    const footer = document.createElement('div');
    footer.style.cssText = 'padding:7px 12px;font-size:10px;color:var(--muted);cursor:pointer;border-top:1px solid var(--border);text-align:center;';
    footer.textContent = `"${q}" â€” ${total} sonuÃ§ â€” tÃ¼mÃ¼nÃ¼ listede filtrele â†’`;
    footer.onmouseenter = () => footer.style.color = 'var(--gold)';
    footer.onmouseleave = () => footer.style.color = 'var(--muted)';
    footer.onclick = () => { applyMosqueFilter(q); dropdown.classList.remove('show'); };
    frag.appendChild(footer);
  }

  dropdown.innerHTML = '';
  dropdown.appendChild(frag);
  dropdown.classList.add('show');
}

function closeCitySmartDropdown() {
  const dd = document.getElementById('city-smart-dd');
  if (!dd) return;
  dd.classList.remove('show');
  cityDropdownIdx = -1;
}

function showCitySmartDropdown(q) {
  const dd = document.getElementById('city-smart-dd');
  if (!dd) return;
  if (!q || q.length < 2 || !mosqueDB.size) { closeCitySmartDropdown(); return; }
  const { ranked, qNorm, bounds } = rankMosqueCandidates(q, 8);
  if (!ranked.length) {
    dd.innerHTML = `<div class="ms-no-result">"${escHtml(q)}" iÃ§in Ã¶neri yok</div>`;
    dd.classList.add('show');
    triggerRemoteMosqueLookup(q, qNorm, bounds).then(added => {
      const cur = document.getElementById('city-input')?.value?.trim();
      if (cur !== q || added <= 0) return;
      showCitySmartDropdown(q);
    });
    return;
  }
  const frag = document.createDocumentFragment();
  ranked.forEach(({m, p, d, inView}) => {
    const col = m.status==='correct'?'#4ade80':m.status==='wrong'?'#f87171':'#fbbf24';
    const addressLine = getMosqueHierarchyLine(m);
    const userDistance = getUserDistanceLabel(m);
    const rightBadge = userDistance ? `${userDistance} uzaÄŸÄ±nÄ±zda` : (m.diff!==null ? m.diff.toFixed(1)+'Â°' : 'â€”');
    const badges = [];
    if (p >= 14) badges.push('<span class="ms-badge pop">PopÃ¼ler</span>');
    if (d >= 10) badges.push('<span class="ms-badge near">YakÄ±nda</span>');
    if (inView) badges.push('<span class="ms-badge view">Bu bÃ¶lgede</span>');
    const div = document.createElement('div');
    div.className = 'ms-item';
    div.innerHTML = `
      <div class="ms-item-dot" style="background:${col};box-shadow:0 0 4px ${col}"></div>
      <div class="ms-item-info">
        <div class="ms-item-name">${highlightMatch(m.name, q)}</div>
        <div class="ms-item-sub">${escHtml(addressLine)}</div>
        ${badges.length ? `<div class="ms-badges">${badges.join('')}</div>` : ''}
      </div>
      <div class="ms-item-diff" style="color:${userDistance ? 'var(--gold)' : col}">${escHtml(rightBadge)}</div>`;
    div.onclick = () => {
      document.getElementById('city-input').value = m.name;
      closeCitySmartDropdown();
      selectMosque(m);
    };
    frag.appendChild(div);
  });
  dd.innerHTML = '';
  dd.appendChild(frag);
  dd.classList.add('show');
}

// Navigate to mosque on map + highlight
function selectMosque(m) {
  const dropdown = document.getElementById('ms-dropdown');
  dropdown.classList.remove('show');
  document.getElementById('city-input').value = m.name;
  closeCitySmartDropdown();
  map.setView([m.lat, m.lng], 17, {animate:true});
  // Small delay for map to settle before animating
  setTimeout(() => handleMosqueClick(m), 150);
  // Show mosque in sidebar (use full DB not just viewport for banner)
  mosqueFilter = m.name;
  document.getElementById('mosque-search').value = m.name;
  document.getElementById('mosque-search').classList.add('has-value');
  document.getElementById('ms-clear').classList.add('show');
  document.getElementById('ms-banner-text').textContent = `"${m.name}" â€” 1 sonuÃ§`;
  document.getElementById('ms-banner').classList.add('show');
  updateList([m]);
}

// Filter the sidebar list + show banner
function applyMosqueFilter(q) {
  mosqueFilter = q;
  const banner  = document.getElementById('ms-banner');
  const bounds  = map.getBounds().pad(0.1);
  const visible = [...mosqueDB.values()].filter(m => bounds.contains([m.lat,m.lng]));

  if (!q) {
    banner.classList.remove('show');
    updateList(visible);
    return;
  }

  const qLow  = trLower(q);
  const qNorm = normalize(qLow);
  const words = qLow.split(/\s+/).filter(w => w.length > 0);

  const filtered = visible.filter(m => msMosqueScore(m, qLow, qNorm, words) > 0);

  document.getElementById('ms-banner-text').textContent = `"${q}" â€” ${filtered.length} sonuÃ§`;
  banner.classList.add('show');
  updateList(filtered);
}

function clearMosqueSearch() {
  document.getElementById('mosque-search').value = '';
  document.getElementById('mosque-search').classList.remove('has-value');
  document.getElementById('ms-clear').classList.remove('show');
  document.getElementById('ms-dropdown').classList.remove('show');
  mosqueFilter = '';
  document.getElementById('ms-banner').classList.remove('show');
  // Restore full list
  if (mosqueDB.size && map) {
    const bounds = map.getBounds().pad(0.1);
    const visible = [...mosqueDB.values()].filter(m=>bounds.contains([m.lat,m.lng]));
    updateList(visible);
  }
}

// Highlight matching substrings (supports multi-word)
function highlightMatch(name, q) {
  if (!q || !name) return escHtml(name || '');
  const words = trLower(q).split(/\s+/).filter(w => w.length > 1);
  if (!words.length) return escHtml(name);

  // Build a char-level "highlight" map
  const lower = trLower(name);
  const marked = new Uint8Array(name.length); // 1 = highlighted

  for (const w of words) {
    let pos = 0;
    while (pos < lower.length) {
      const idx = lower.indexOf(w, pos);
      if (idx < 0) break;
      for (let i = idx; i < Math.min(idx + w.length, name.length); i++) marked[i] = 1;
      pos = idx + 1;
    }
    // Normalized fallback
    if (!marked.some(Boolean)) {
      const normName = normalize(lower);
      const normW    = normalize(w);
      let p = 0;
      while (p < normName.length) {
        const idx = normName.indexOf(normW, p);
        if (idx < 0) break;
        for (let i = idx; i < Math.min(idx + normW.length, name.length); i++) marked[i] = 1;
        p = idx + 1;
      }
    }
  }

  // Build output string from mark map
  let out = '', inMark = false;
  for (let i = 0; i < name.length; i++) {
    if (marked[i] && !inMark) { out += '<mark>'; inMark = true; }
    if (!marked[i] && inMark) { out += '</mark>'; inMark = false; }
    out += escHtml(name[i]);
  }
  if (inMark) out += '</mark>';
  return out || escHtml(name);
}

// Turkish-aware lowercase (fixes Ä°â†’i, Iâ†’Ä± issues)
function trLower(s) {
  return s.replace(/Ä°/g,'i').replace(/I/g,'Ä±')
          .replace(/Ä/g,'ÄŸ').replace(/Ãœ/g,'Ã¼')
          .replace(/Å/g,'ÅŸ').replace(/Ã–/g,'Ã¶')
          .replace(/Ã‡/g,'Ã§').toLowerCase();
}

// Normalize Turkish chars for fuzzy matching (Ä±â†’i, ÄŸâ†’g etc.)
function normalize(s) {
  return s.replace(/Ä±/g,'i').replace(/ÄŸ/g,'g').replace(/Ã¼/g,'u')
          .replace(/ÅŸ/g,'s').replace(/Ã¶/g,'o').replace(/Ã§/g,'c')
          .replace(/Ä°/g,'i').replace(/Ä/g,'g').replace(/Ãœ/g,'u')
          .replace(/Å/g,'s').replace(/Ã–/g,'o').replace(/Ã‡/g,'c');
}

// â”€â”€ Status indicators
function setVpStatus(s){
  const dot=document.getElementById('vp-dot'),lbl=document.getElementById('vp-label');
  const box=document.querySelector('.vp-status');
  dot.className='vp-dot'+(s==='loading'?' loading':s==='done'?' done':'');
  if (box) box.className='vp-status'+(s==='loading'?' loading':s==='done'?' done':'');
  lbl.textContent=s==='loading'?'CanlÄ± yÃ¼kleniyor':s==='done'?'CanlÄ± gÃ¼ncel':'CanlÄ± hazÄ±r';
}
function updateCacheUI(){ document.getElementById('cache-count').textContent=tileCache.size; }
function showMini(t){ document.getElementById('mini-text').textContent=t; document.getElementById('mini-loader').classList.add('show'); }
function hideMini(){ document.getElementById('mini-loader').classList.remove('show'); }

function setOv(show,text='',sub=''){
  document.getElementById('overlay').style.display=show?'flex':'none';
  if(show){document.getElementById('ov-text').textContent=text;document.getElementById('ov-sub').textContent=sub;}
}
function toast(msg,ms=5000){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.classList.add('show');
  if (/(hata|error|âŒ|baÅŸarÄ±sÄ±z|failed)/i.test(String(msg || ''))) haptic(10);
  setTimeout(()=>t.classList.remove('show'),ms);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SEARCH & LOAD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function doSearch(){
  if(!map) return;
  const v=document.getElementById('city-input').value.trim();
  if(!v) return;
  closeCitySmartDropdown();
  const mq = document.getElementById('mob-quick-city');
  if (mq) mq.value = v;
  const aliasHints = findAliasGroupsForQuery(normalize(trLower(v)));
  const smart = rankMosqueCandidates(v, 1).ranked[0] || null;
  if (smart && (isLikelyMosqueQuery(v) || aliasHints.length || smart.rank >= 118 || smart.s >= 90)) {
    selectMosque(smart.m);
    return;
  }
  const mosqueMode = isLikelyMosqueQuery(v);
  const direct = parseDirectMosqueQuery(v);
  try{
    if (direct) {
      setOv(true, `"${v}" aranÄ±yor...`, 'DoÄŸrudan kayÄ±t sorgusu');
      tileCache.clear(); updateCacheUI();
      mosqueDB.clear();
      renderLayers.forEach(l=>{ try{map.removeLayer(l);}catch{} }); renderLayers=[];
      const items = direct.type === 'osm'
        ? await fetchByOsmId(direct.osmType, direct.id)
        : await fetchByWikidataQid(direct.qid);
      processElements(items || []);
      if (mosqueDB.size) {
        const first = [...mosqueDB.values()][0];
        map.setView([first.lat, first.lng], 18);
        renderAll();
        triggerAggressiveNameEnrichment();
        setTimeout(() => handleMosqueClick(first), 120);
        toast(`${mosqueDB.size} kayÄ±t bulundu`, 2500);
      } else {
        toast('DoÄŸrudan sorguda kayÄ±t bulunamadÄ±', 3500);
      }
      setOv(false);
      return;
    }

    setOv(true,`"${v}" aranÄ±yor...`,'Koordinatlar alÄ±nÄ±yor');
    const loc=await geocode(v);
    currentCity = v;
    if (mosqueMode) {
      map.setView([loc.lat,loc.lng], 17);
    } else if (loc.bbox && loc.bbox.length === 4 && loc.bbox.every(Number.isFinite)) {
      const s = loc.bbox[0], n = loc.bbox[1], w = loc.bbox[2], e = loc.bbox[3];
      if (Math.abs(n-s) > 0.001 && Math.abs(e-w) > 0.001) map.fitBounds([[s,w],[n,e]]);
      else map.setView([loc.lat,loc.lng],14);
    } else {
      map.setView([loc.lat,loc.lng],14);
    }
    // Clear cache for fresh city load
    tileCache.clear(); updateCacheUI();
    mosqueDB.clear();
    renderLayers.forEach(l=>{ try{map.removeLayer(l);}catch{} }); renderLayers=[];
    if(heatLayer){ try{map.removeLayer(heatLayer);}catch{} heatLayer=null; }
    // Ä°lk viewport yÃ¼klemesi
    setOv(true,`"${v}" yÃ¼kleniyor...`,'Harita gÃ¶rÃ¼nÃ¼mÃ¼ndeki camiler alÄ±nÄ±yor');
    await loadViewport({
      batchSize: 12,
      concurrency: 3,
      fetchPolicy: { retries:1, timeoutMs:18000, backoffMs:650, minInterval:320 }
    });

    if (mosqueMode && !mosqueDB.size) {
      // Spesifik cami adÄ± aramasÄ±nda dar Ã§evrede yoÄŸun dene
      const near = await fetchCityFallback(loc.lat, loc.lng);
      if (near.length) {
        processElements(near);
        renderAll();
      }
    }

    // Fallback: gÃ¶rÃ¼nÃ¼mde hiÃ§ veri gelmezse ÅŸehir merkezi etrafÄ±nda geniÅŸleyerek dene.
    if (!mosqueDB.size) {
      setOv(true,`"${v}" iÃ§in geniÅŸ arama...`,'FarklÄ± etiketler ve daha geniÅŸ alan taranÄ±yor');
      const fallback = await fetchCityFallback(loc.lat, loc.lng);
      if (fallback.length) {
        processElements(fallback);
        renderAll();
      }
    }

    // Sorgu bir cami adÄ±ysa en iyi eÅŸleÅŸmeyi odakla
    if (mosqueMode && mosqueDB.size) {
      const best = findBestMosqueByName(v);
      if (best) {
        map.setView([best.lat, best.lng], Math.max(map.getZoom(), 17), {animate:true});
        setTimeout(() => handleMosqueClick(best), 140);
      }
    }
    if (mosqueDB.size) triggerAggressiveNameEnrichment();

    setOv(false);
    if (!mosqueDB.size) {
      toast('Bu ÅŸehir iÃ§in OSM Ã¼zerinde cami verisi bulunamadÄ±. YazÄ±mÄ±/Ã¼lke adÄ±nÄ± kontrol edin.', 7000);
    } else {
      haptic(20);
      toast(`${mosqueDB.size} cami kaydÄ± yÃ¼klendi`, 2800);
      saveSnapshot();
    }
    updateHashFromMap();
  } catch(e){
    setOv(false);
    toast('Hata: '+e.message,7000);
    console.error(e);
  }
}

function geoErrorMessage(err) {
  if (!err || typeof err.code !== 'number') return 'Konum alÄ±namadÄ±';
  if (err.code === 1) return 'Konum izni kapalÄ±. TarayÄ±cÄ±dan konum iznini aÃ§Ä±n.';
  if (err.code === 2) return 'Konum kaynaÄŸÄ± bulunamadÄ± (GPS/aÄŸ).';
  if (err.code === 3) return 'Konum isteÄŸi zaman aÅŸÄ±mÄ±na uÄŸradÄ±.';
  return 'Konum alÄ±namadÄ±';
}

function getCurrentPositionAsync(options) {
  return new Promise((resolve, reject) => {
    navigator.geolocation.getCurrentPosition(resolve, reject, options);
  });
}

function watchPositionFirstFixAsync(options = {}, hardTimeoutMs = 22000) {
  return new Promise((resolve, reject) => {
    let done = false;
    const finish = (fn, payload) => {
      if (done) return;
      done = true;
      try { navigator.geolocation.clearWatch(watchId); } catch {}
      clearTimeout(timer);
      fn(payload);
    };
    const watchId = navigator.geolocation.watchPosition(
      pos => finish(resolve, pos),
      err => {
        if (err?.code === 1) finish(reject, err);
      },
      options
    );
    const timer = setTimeout(() => finish(reject, { code:3, message:'watch timeout' }), hardTimeoutMs);
  });
}

async function useMyLocation(opts = {}){
  const showToast = opts.showToast !== false;
  const zoom = Number.isFinite(opts.zoom) ? opts.zoom : 14;
  const source = opts.source || 'manual';
  if(!navigator.geolocation){
    if (showToast) toast('Konum desteklenmiyor');
    return false;
  }
  try {
    let pos = null;
    try {
      pos = await getCurrentPositionAsync({ enableHighAccuracy:true, timeout:12000, maximumAge:120000 });
    } catch (e1) {
      // Fallback: lower accuracy but wider timeout works better on some mobile networks.
      if (e1?.code === 2 || e1?.code === 3) {
        try {
          pos = await getCurrentPositionAsync({ enableHighAccuracy:false, timeout:22000, maximumAge:600000 });
        } catch {
          // Last fallback: wait for first watchPosition fix.
          pos = await watchPositionFirstFixAsync({ enableHighAccuracy:false, maximumAge:0, timeout:15000 }, 24000);
        }
      } else {
        throw e1;
      }
    }
    if(!map) return false;
    setUserGeoState(pos.coords.latitude, pos.coords.longitude, true);
    map.setView([pos.coords.latitude,pos.coords.longitude],zoom);
    tileCache.clear(); mosqueDB.clear();
    renderLayers.forEach(l=>{ try{map.removeLayer(l);}catch{} }); renderLayers=[];
    updateCacheUI();
    await loadViewport();
    if (showToast && source === 'manual') toast('Konum tespit edildi', 1800);
    return true;
  } catch (err) {
    if (source === 'auto' && err?.code === 1) safeStorageSet(GEO_PROMPT_KEY, 'denied');
    if (showToast) toast(geoErrorMessage(err), 3600);
    return false;
  }
}

async function resetToHome() {
  if (!map) return;
  try {
    if (followState.enabled) stopFollowLock(true);
    if (dpOpen) closeDetailPanel();
    closeMobDrawer?.();
    clearMosqueSearch?.();
    hideQiblaPanel?.();
    map.closePopup();
    document.getElementById('city-input').value = '';
    const mq = document.getElementById('mob-quick-city');
    if (mq) mq.value = '';
    currentCity = '';
    tileCache.clear();
    mosqueDB.clear();
    renderLayers.forEach(l=>{ try{map.removeLayer(l);}catch{} });
    renderLayers = [];
    if(heatLayer){ try{map.removeLayer(heatLayer);}catch{} heatLayer=null; }
    updateCacheUI();
    _hashUpdating = true;
    history.replaceState(null, '', location.pathname);
    map.setView([41.015, 28.979], 13, { animate:true });
    _hashUpdating = false;
    clearTimeout(vpDebounceTimer);
    vpDebounceTimer = setTimeout(loadViewport, 3000);
    toast('Ana sayfa sÄ±fÄ±rlandÄ±', 1800);
  } catch {}
}

function toggleOutdoorMode() {
  uiState.outdoor = !uiState.outdoor;
  document.body.classList.toggle('outdoor-mode', uiState.outdoor);
  document.getElementById('btn-outdoor')?.classList.toggle('active', uiState.outdoor);
  document.getElementById('mob-btn-outdoor')?.classList.toggle('active', uiState.outdoor);
  safeStorageSet(OUTDOOR_KEY, uiState.outdoor ? '1' : '0');
  toast(uiState.outdoor ? 'Outdoor mod aktif' : 'Outdoor mod kapatÄ±ldÄ±', 1800);
}

function updateFollowUi() {
  document.getElementById('btn-follow')?.classList.toggle('active', followState.enabled);
  document.getElementById('mob-btn-follow')?.classList.toggle('active', followState.enabled);
}

function stopFollowLock(silent = false) {
  if (followState.watchId != null && navigator.geolocation) {
    navigator.geolocation.clearWatch(followState.watchId);
  }
  followState.watchId = null;
  followState.enabled = false;
  updateFollowUi();
  if (!silent) toast('Takip kilidi kapatÄ±ldÄ±', 1800);
}

function startFollowLock() {
  if (!navigator.geolocation) { toast('Konum desteÄŸi yok', 2200); return; }
  if (followState.enabled) return;
  followState.enabled = true;
  updateFollowUi();
  followState.watchId = navigator.geolocation.watchPosition(pos => {
    if (!map) return;
    followState.lastFixAt = Date.now();
    const lat = pos.coords.latitude;
    const lng = pos.coords.longitude;
    setUserGeoState(lat, lng, true);
    const z = Math.max(16, map.getZoom() || 16);
    map.setView([lat, lng], z, { animate:false });
  }, () => {
    stopFollowLock(true);
    toast('Takip iÃ§in konum alÄ±namadÄ±', 2600);
  }, { enableHighAccuracy:true, maximumAge:5000, timeout:12000 });
  toast('Takip kilidi aktif: manuel kaydÄ±rÄ±nca kapanÄ±r', 2200);
}

function toggleFollowLock() {
  if (followState.enabled) stopFollowLock();
  else startFollowLock();
}

function toggleMapCompassSync() {
  uiState.mapSyncWithCompass = !uiState.mapSyncWithCompass;
  if (!uiState.mapSyncWithCompass && uiState.liveMapCompass) uiState.liveMapCompass = false;
  document.getElementById('btn-map-sync')?.classList.toggle('active', uiState.mapSyncWithCompass);
  if (!uiState.mapSyncWithCompass) applyMapHeadingRotation(null);
  toast(uiState.mapSyncWithCompass ? 'Pusula-harita senkronu aktif' : 'Pusula-harita senkronu kapalÄ±', 1800);
  updateCompassFabUi();
}

function applyMapHeadingRotation(heading) {
  if (!map) return;
  const paneNames = ['tilePane', 'overlayPane', 'shadowPane', 'markerPane', 'popupPane'];
  paneNames.forEach(name => {
    const pane = map[name] || map['_' + name];
    if (!pane || !pane.style) return;
    const raw = pane.style.transform || '';
    const base = raw.replace(/\s?rotate\([^)]*\)/g, '');
    if (!uiState.mapSyncWithCompass || heading == null) {
      pane.style.transform = base;
      return;
    }
    pane.style.transform = `${base} rotate(${-heading.toFixed(1)}deg)`;
  });
}

function isCompassModalOpen() {
  return document.getElementById('cmps-overlay')?.classList.contains('show');
}

function updateCompassFabUi() {
  document.getElementById('compass-fab')?.classList.toggle('active', !!uiState.liveMapCompass);
}

async function toggleLiveMapCompass() {
  if (uiState.liveMapCompass) {
    uiState.liveMapCompass = false;
    uiState.mapSyncWithCompass = false;
    document.getElementById('btn-map-sync')?.classList.remove('active');
    applyMapHeadingRotation(null);
    if (!isCompassModalOpen()) stopCompass();
    updateCompassFabUi();
    toast('CanlÄ± pusula modu kapatÄ±ldÄ±', 1600);
    return;
  }
  const granted = await requestCompassPermission();
  if (!granted) {
    uiState.liveMapCompass = false;
    uiState.mapSyncWithCompass = false;
    updateCompassFabUi();
    return;
  }
  uiState.liveMapCompass = true;
  uiState.mapSyncWithCompass = true;
  document.getElementById('btn-map-sync')?.classList.add('active');
  updateCompassFabUi();
  toast('CanlÄ± pusula modu aktif', 1600);
}

async function loadNearbyCitySuggestions(showToastMsg = true) {
  const list = document.getElementById('city-suggest-list');
  if (!list) return;
  if (!navigator.geolocation) {
    if (showToastMsg) toast('YakÄ±n ÅŸehir Ã¶nerileri iÃ§in konum desteÄŸi yok', 2600);
    return;
  }
  try {
    const pos = await new Promise((res, rej) => navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy:false, timeout:9000, maximumAge:150000 }));
    const lat = pos.coords.latitude, lng = pos.coords.longitude;
    const probes = [
      [lat, lng], [lat + 0.28, lng], [lat - 0.28, lng], [lat, lng + 0.35], [lat, lng - 0.35]
    ];
    const out = [];
    const seen = new Set();
    for (const [la, ln] of probes) {
      const url = `https://nominatim.openstreetmap.org/reverse?lat=${la}&lon=${ln}&format=jsonv2&zoom=10&addressdetails=1`;
      let d = null;
      try { d = await nominatimFetchJson(url, {'Accept-Language':'tr,en'}); } catch {}
      const a = d?.address || {};
      const cands = [a.city, a.town, a.county, a.state, a.village].filter(Boolean);
      for (const c of cands) {
        const k = trLower(String(c));
        if (seen.has(k)) continue;
        seen.add(k);
        out.push(String(c));
      }
    }
    list.innerHTML = out.slice(0, 10).map(x => `<option value="${escHtml(x)}"></option>`).join('');
    if (showToastMsg) toast(out.length ? `YakÄ±n ÅŸehir Ã¶nerileri gÃ¼ncellendi (${out.length})` : 'YakÄ±n ÅŸehir Ã¶nerisi bulunamadÄ±', 2300);
  } catch {
    if (showToastMsg) toast('YakÄ±n ÅŸehir Ã¶nerisi alÄ±namadÄ±', 2200);
  }
}

async function refreshCurrentViewport() {
  if (!map || !mosqueDB.size) return;
  if (uiState.pullRefreshing) return;
  uiState.pullRefreshing = true;
  const ind = document.getElementById('sb-pull-indicator');
  if (ind) { ind.textContent = 'Yenileniyor...'; ind.classList.add('show','visible'); }
  tileCache.clear();
  updateCacheUI();
  await loadViewport();
  recompute();
  if (ind) {
    setTimeout(() => {
      ind.classList.remove('visible');
      setTimeout(() => ind.classList.remove('show'), 180);
      ind.textContent = 'BÄ±rakÄ±nca yenilenecek';
    }, 380);
  }
  uiState.pullRefreshing = false;
  toast('Veriler gÃ¼ncellendi', 1600);
}

function initSidebarPullToRefresh() {
  const listEl = document.getElementById('mosque-list');
  const ind = document.getElementById('sb-pull-indicator');
  if (!listEl || !ind) return;
  let sy = 0, pulling = false;
  listEl.addEventListener('touchstart', e => {
    if (window.innerWidth > 768) return;
    if (listEl.scrollTop > 0) return;
    sy = e.touches[0].clientY;
    pulling = true;
  }, {passive:true});
  listEl.addEventListener('touchmove', e => {
    if (!pulling) return;
    const dy = e.touches[0].clientY - sy;
    if (dy > 8) {
      ind.classList.add('show');
      ind.classList.toggle('visible', dy > 34);
      ind.textContent = dy > 76 ? 'BÄ±rakÄ±nca yenilenecek' : 'AÅŸaÄŸÄ± Ã§ek...';
    }
  }, {passive:true});
  listEl.addEventListener('touchend', async e => {
    if (!pulling) return;
    const dy = e.changedTouches[0].clientY - sy;
    pulling = false;
    if (dy > 76) await refreshCurrentViewport();
    else {
      ind.classList.remove('visible');
      setTimeout(() => ind.classList.remove('show'), 160);
      ind.textContent = 'BÄ±rakÄ±nca yenilenecek';
    }
  }, {passive:true});
}

function setSidebarSnap(vh) {
  const sb = document.querySelector('.sidebar');
  if (!sb || window.innerWidth > 768) return;
  uiState.sheetSnap = Math.max(20, Math.min(95, vh));
  sb.style.setProperty('--sheet-snap', uiState.sheetSnap);
  const snapState = uiState.sheetSnap <= 30 ? 'min' : uiState.sheetSnap <= 72 ? 'half' : 'full';
  sb.setAttribute('data-snap', snapState);
  updateSidebarSnapPanels();
}

function initSidebarSnapSheet() {
  const sb = document.querySelector('.sidebar');
  const head = document.getElementById('sb-head-handle');
  if (!sb || !head) return;
  const snaps = [20, 50, 95];
  let idx = 1;
  setSidebarSnap(snaps[idx]);
  head.onclick = () => {
    if (window.innerWidth > 768) return;
    idx = (idx + 1) % snaps.length;
    setSidebarSnap(snaps[idx]);
  };
  let sy = 0;
  sb.addEventListener('touchstart', e => { sy = e.touches[0].clientY; }, {passive:true});
  sb.addEventListener('touchend', e => {
    if (window.innerWidth > 768) return;
    const dy = e.changedTouches[0].clientY - sy;
    if (dy < -38) idx = Math.min(snaps.length - 1, idx + 1);
    if (dy > 38) idx = Math.max(0, idx - 1);
    setSidebarSnap(snaps[idx]);
  }, {passive:true});
}

window.addEventListener('DOMContentLoaded', bootstrap);
</script>

<!-- â•â• DETAIL PANEL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="dp-backdrop" id="dp-backdrop" onclick="closeDetailPanel()"></div>
<div class="dp-panel" id="dp-panel">

  <!-- Header -->
  <div class="dp-head">
    <div class="dp-head-left">
      <div class="dp-name" id="dp-name">â€”</div>
      <div class="dp-name-ar" id="dp-name-ar"></div>
      <div class="dp-place" id="dp-place"></div>
      <div class="dp-coords" id="dp-coords"></div>
    </div>
    <button class="dp-close" onclick="closeDetailPanel()">âœ•</button>
  </div>

  <!-- Status ribbon -->
  <div class="dp-ribbon" id="dp-ribbon">
    <div class="dp-ribbon-item" id="dp-status-badge"></div>
    <div class="dp-ribbon-item">
      <span class="dp-ribbon-lbl">KÄ±ble</span>
      <span class="dp-ribbon-val" id="dp-qibla-val">â€”</span>
    </div>
    <div class="dp-ribbon-item">
      <span class="dp-ribbon-lbl">Bina YÃ¶nÃ¼</span>
      <span class="dp-ribbon-val" id="dp-axis-val">â€”</span>
    </div>
    <div class="dp-ribbon-item">
      <span class="dp-ribbon-lbl">Sapma</span>
      <span class="dp-ribbon-val" id="dp-diff-val">â€”</span>
    </div>
    <div class="dp-ribbon-item">
      <span class="dp-ribbon-lbl">Kabe</span>
      <span class="dp-ribbon-val" id="dp-dist-val">â€”</span>
    </div>
  </div>

  <!-- Photo -->
  <div class="dp-photo-wrap" id="dp-photo-wrap" style="display:none">
    <img class="dp-photo" id="dp-photo" alt="Cami fotoÄŸrafÄ±"/>
    <div class="dp-photo-credit" id="dp-photo-credit"></div>
  </div>

  <!-- Interior evidence -->
  <div class="dp-section" id="dp-interior-section">
    <div class="dp-section-title">Ä°Ã§ Mekan KanÄ±tÄ±</div>
    <div class="dp-int-gallery" id="dp-int-gallery"></div>
    <div class="dp-int-meta" id="dp-int-meta"></div>
    <div class="dp-int-form">
      <label for="dp-int-axis">Namaz saf/mihrab yÃ¶nÃ¼ (0â€“179Â°)</label>
      <input id="dp-int-axis" type="range" min="0" max="179" value="90" oninput="document.getElementById('dp-int-axis-val').textContent=this.value+'Â°'"/>
      <div class="dp-int-axis-val" id="dp-int-axis-val">90Â°</div>
      <select id="dp-int-conf">
        <option value="0.55">DÃ¼ÅŸÃ¼k gÃ¼ven</option>
        <option value="0.75" selected>Orta gÃ¼ven</option>
        <option value="0.9">YÃ¼ksek gÃ¼ven</option>
      </select>
      <input id="dp-int-url" type="text" placeholder="Kaynak URL (opsiyonel)"/>
      <input id="dp-int-note" type="text" placeholder="Not (Ã¶rn: mihrab aÃ§Ä±kÃ§a gÃ¶rÃ¼nÃ¼yor)"/>
      <button class="dp-action-btn" onclick="saveInteriorEvidence()">Ä°Ã§ Mekan YÃ¶nÃ¼nÃ¼ Kaydet</button>
    </div>
    <div class="dp-int-form">
      <label>Manuel Aks DÃ¼zeltme (Harita Ãœzerinde 2 Nokta)</label>
      <button class="dp-action-btn" id="dp-manual-start" onclick="startManualAxisCapture()">Haritada Aks Ã‡iz</button>
      <button class="dp-action-btn" onclick="cancelManualAxisCapture()">Ä°ptal</button>
      <div class="dp-int-meta" id="dp-manual-status">HazÄ±r</div>
    </div>
    <div class="dp-int-ev-list" id="dp-int-ev-list"></div>
  </div>

  <!-- Qibla mini diagram -->
  <div class="dp-section">
    <div class="dp-section-title">KÄ±ble Analizi</div>
    <div class="dp-qibla-row">
      <canvas id="dp-compass" width="120" height="120"></canvas>
      <div class="dp-qibla-stats" id="dp-qibla-stats"></div>
    </div>
  </div>

  <div class="dp-section">
    <div class="dp-section-title">AÃ§Ä±klanabilirlik</div>
    <div class="dp-tags" id="dp-explain"></div>
  </div>

  <!-- Wikipedia summary -->
  <div class="dp-section" id="dp-wiki-section" style="display:none">
    <div class="dp-section-title">Wikipedia</div>
    <div class="dp-wiki-body" id="dp-wiki-body"></div>
    <a class="dp-wiki-link" id="dp-wiki-link" target="_blank" rel="noopener">Wikipedia'da oku â†’</a>
  </div>

  <!-- OSM Tags -->
  <div class="dp-section">
    <div class="dp-section-title" id="dp-tags-title">OSM Etiketleri</div>
    <div class="dp-tags" id="dp-tags"></div>
  </div>

  <!-- Action buttons -->
  <div class="dp-actions" id="dp-actions"></div>

</div>

<!-- â•â• LEADERBOARD MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="lb-overlay" id="lb-overlay" onclick="lbOverlayClick(event)">
  <div class="lb-modal" id="lb-modal">

    <div class="lb-header">
      <div class="lb-title">ğŸŒ KÃ¼resel KÄ±ble SÄ±ralamasÄ±</div>
      <div class="lb-header-right">
        <span class="lb-updated" id="lb-updated"></span>
        <button class="lb-close" onclick="closeLeaderboard()">âœ•</button>
      </div>
    </div>

    <!-- Controls bar -->
    <div class="lb-controls">
      <div class="lb-add-wrap">
        <input id="lb-city-input" type="text" placeholder="Åehir ekle... (Ã¶rn: Konya, Cairo, Lahore)" autocomplete="off"/>
        <button id="lb-add-btn" onclick="lbAddCity()">+ Analiz Et</button>
      </div>
      <div class="lb-mode-row">
        <span class="lb-sort-label">Mod:</span>
        <button class="lb-mode active" data-mode="qibla" onclick="lbSetDataset('qibla')">ğŸ§­ Åehir Analizi</button>
        <button class="lb-mode" data-mode="admin" onclick="lbSetDataset('admin')">ğŸ“Š Ä°l/State SayÄ±mÄ±</button>
      </div>
      <div class="lb-progress-wrap" id="lb-progress-wrap" style="display:none">
        <div class="lb-progress-bar" id="lb-progress-bar"></div>
        <span class="lb-progress-label" id="lb-progress-label">Analiz ediliyor...</span>
      </div>
      <div class="lb-filters">
        <button class="lb-filter active" data-region="all"   onclick="lbSetRegion('all')">ğŸŒ TÃ¼mÃ¼</button>
        <button class="lb-filter"        data-region="turkey" onclick="lbSetRegion('turkey')">ğŸ‡¹ğŸ‡· TÃ¼rkiye</button>
        <button class="lb-filter"        data-region="mideast" onclick="lbSetRegion('mideast')">ğŸŒ™ Orta DoÄŸu</button>
        <button class="lb-filter"        data-region="asia"    onclick="lbSetRegion('asia')">ğŸŒ GÃ¼ney Asya</button>
        <button class="lb-filter"        data-region="africa"  onclick="lbSetRegion('africa')">ğŸŒ Afrika</button>
        <button class="lb-filter"        data-region="europe"  onclick="lbSetRegion('europe')">ğŸ‡ªğŸ‡º Avrupa</button>
        <button class="lb-filter"        data-region="other"   onclick="lbSetRegion('other')">ğŸ—º DiÄŸer</button>
      </div>
      <div class="lb-sort-row">
        <span class="lb-sort-label">SÄ±rala:</span>
        <button class="lb-sort active" data-sort="pct"   onclick="lbSetSort('pct')">DoÄŸruluk %</button>
        <button class="lb-sort"        data-sort="count" onclick="lbSetSort('count')">Cami SayÄ±sÄ±</button>
        <button class="lb-sort"        data-sort="avg"   onclick="lbSetSort('avg')">Ort. Sapma</button>
        <button class="lb-sort"        data-sort="name"  onclick="lbSetSort('name')">Åehir AdÄ±</button>
      </div>
    </div>

    <!-- Summary strip -->
    <div class="lb-summary" id="lb-summary"></div>

    <!-- Table -->
    <div class="lb-table-wrap">
      <div class="lb-table-head">
        <span class="lbt-rank">#</span>
        <span class="lbt-city" id="lb-h-city">Åehir</span>
        <span class="lbt-bar" id="lb-h-bar">DoÄŸruluk</span>
        <span class="lbt-pct" id="lb-h-pct">%</span>
        <span class="lbt-not" id="lb-h-note">Not</span>
        <span class="lbt-count" id="lb-h-count">Cami</span>
        <span class="lbt-avg" id="lb-h-avg">Ort.Sap.</span>
        <span class="lbt-date">Analiz</span>
        <span class="lbt-act"></span>
      </div>
      <div id="lb-rows"></div>
    </div>

    <div class="lb-footer">
      Veriler <strong>OpenStreetMap</strong> Â· Åehir merkezi 8km yarÄ±Ã§apÄ± Â· localStorage'da saklanÄ±r
      <button class="lb-clear-btn" onclick="lbClearAll()">ğŸ—‘ TÃ¼mÃ¼nÃ¼ Temizle</button>
    </div>
  </div>
</div>

<!-- â•â• HISTORY MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="hist-overlay" id="hist-overlay" onclick="histOverlayClick(event)">
  <div class="hist-modal" id="hist-modal">
    <div class="hist-header">
      <div class="hist-title">ğŸ“… Tarihsel DÃ¶nem Analizi</div>
      <button class="hist-close" onclick="closeHistoryMode()">âœ•</button>
    </div>

    <!-- Period filter chips -->
    <div class="hist-chips" id="hist-chips">
      <button class="hist-chip all active" onclick="filterPeriod('all')" data-period="all">TÃ¼mÃ¼</button>
      <button class="hist-chip ottoman" onclick="filterPeriod('ottoman')" data-period="ottoman">ğŸ•Œ OsmanlÄ± <span class="hist-chip-sub">â€”1922</span></button>
      <button class="hist-chip early" onclick="filterPeriod('early')" data-period="early">ğŸ‡¹ğŸ‡· Erken Cum. <span class="hist-chip-sub">1923â€“50</span></button>
      <button class="hist-chip mid" onclick="filterPeriod('mid')" data-period="mid">ğŸ— Orta <span class="hist-chip-sub">1951â€“2000</span></button>
      <button class="hist-chip modern" onclick="filterPeriod('modern')" data-period="modern">ğŸ™ Modern <span class="hist-chip-sub">2001+</span></button>
      <button class="hist-chip unknown" onclick="filterPeriod('unknown')" data-period="unknown">â“ Tarihi Bilinmiyor</button>
    </div>

    <!-- Summary cards row -->
    <div class="hist-cards" id="hist-cards"></div>

    <!-- Bar chart canvas -->
    <div class="hist-chart-wrap">
      <div class="hist-section-label">DÃ¶neme GÃ¶re DoÄŸruluk KarÅŸÄ±laÅŸtÄ±rmasÄ±</div>
      <canvas id="hist-chart" height="140"></canvas>
    </div>

    <!-- Scatter: inÅŸaat yÄ±lÄ± vs sapma -->
    <div class="hist-scatter-wrap">
      <div class="hist-section-label">Ä°nÅŸaat YÄ±lÄ± Ã— KÄ±ble SapmasÄ± <span style="color:#6b6b7a;font-size:9px">(veri olan camiler)</span></div>
      <canvas id="hist-scatter" height="160"></canvas>
      <div class="hist-scatter-legend">
        <span class="hsl-dot ottoman"></span>OsmanlÄ± &nbsp;
        <span class="hsl-dot early"></span>Erken Cum. &nbsp;
        <span class="hsl-dot mid"></span>Orta &nbsp;
        <span class="hsl-dot modern"></span>Modern
      </div>
    </div>

    <!-- Detail table -->
    <div class="hist-table-wrap">
      <div class="hist-section-label">DÃ¶nem Detay Tablosu</div>
      <div id="hist-table"></div>
    </div>

    <!-- Filtered list -->
    <div class="hist-list-wrap">
      <div class="hist-section-label" id="hist-list-label">SeÃ§ili dÃ¶nemdeki camiler</div>
      <div class="hist-list" id="hist-list"></div>
    </div>

    <div class="hist-footer">
      OSM <code>start_date</code> / <code>building:start_date</code> tag verisi Â· Tarihi olmayan camiler "bilinmiyor" kategorisinde
    </div>
  </div>
</div>

<!-- â•â• COMPARISON MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="cmp-overlay" id="cmp-overlay" onclick="cmpOverlayClick(event)">
  <div class="cmp-modal" id="cmp-modal">
    <div class="cmp-header">
      <div class="cmp-title">âš–ï¸ Åehir KarÅŸÄ±laÅŸtÄ±rmasÄ±</div>
      <button class="cmp-close" onclick="closeCompare()">âœ•</button>
    </div>
    <div class="cmp-inputs">
      <div class="cmp-city-col">
        <div class="cmp-city-label" style="color:#60a5fa">Åehir A</div>
        <div class="cmp-search-row">
          <input id="cmp-a-input" type="text" placeholder="Åehir/ilÃ§e adÄ± girin..." autocomplete="off"/>
          <select id="cmp-a-level">
            <option value="city">Åehir</option>
            <option value="district">Ä°lÃ§e</option>
          </select>
        </div>
        <div class="cmp-search-row">
          <button class="btn" id="cmp-a-fetch-btn" onclick="fetchCompareSide('a')">YÃ¼kle</button>
          <button class="btn btn-sm" id="cmp-a-clear-btn" onclick="clearCompareSide('a')">KaldÄ±r</button>
        </div>
        <div class="cmp-city-current" id="cmp-a-name">â€”</div>
        <div class="cmp-city-status" id="cmp-a-status"></div>
      </div>
      <div class="cmp-vs">VS</div>
      <div class="cmp-city-col">
        <div class="cmp-city-label" style="color:#f472b6">Åehir B</div>
        <div class="cmp-search-row">
          <input id="cmp-b-input" type="text" placeholder="Åehir/ilÃ§e adÄ± girin..." autocomplete="off"/>
          <select id="cmp-b-level">
            <option value="city">Åehir</option>
            <option value="district">Ä°lÃ§e</option>
          </select>
        </div>
        <div class="cmp-search-row">
          <button class="btn" id="cmp-b-fetch-btn" onclick="fetchCompareSide('b')">YÃ¼kle</button>
          <button class="btn btn-sm" id="cmp-b-clear-btn" onclick="clearCompareSide('b')">KaldÄ±r</button>
        </div>
        <div class="cmp-city-current" id="cmp-b-name">â€”</div>
        <div class="cmp-city-status" id="cmp-b-status"></div>
      </div>
    </div>
    <div class="cmp-progress-wrap" id="cmp-progress-wrap" style="display:none">
      <div class="cmp-progress-bar" id="cmp-progress-bar"></div>
      <div class="cmp-progress-label" id="cmp-progress-label">YÃ¼kleniyor...</div>
    </div>
    <div class="cmp-results" id="cmp-results" style="display:none">
      <div class="cmp-score-row">
        <div class="cmp-score-block cmp-a-bg">
          <div class="cmp-score-pct" id="cmp-a-pct">â€”</div>
          <canvas id="cmp-a-donut" width="80" height="80"></canvas>
          <div class="cmp-score-grade" id="cmp-a-grade"></div>
          <div class="cmp-score-city" id="cmp-a-label">â€”</div>
        </div>
        <div class="cmp-winner-col">
          <div class="cmp-winner-badge" id="cmp-winner-badge"></div>
          <canvas id="cmp-radar" width="200" height="200"></canvas>
          <div class="cmp-radar-legend">
            <span class="cmp-leg-a">â– </span> A &nbsp;
            <span class="cmp-leg-b">â– </span> B
          </div>
        </div>
        <div class="cmp-score-block cmp-b-bg">
          <div class="cmp-score-pct" id="cmp-b-pct">â€”</div>
          <canvas id="cmp-b-donut" width="80" height="80"></canvas>
          <div class="cmp-score-grade" id="cmp-b-grade"></div>
          <div class="cmp-score-city" id="cmp-b-label">â€”</div>
        </div>
      </div>
      <div class="cmp-bars-section">
        <div class="cmp-section-label">Metrik KarÅŸÄ±laÅŸtÄ±rmasÄ±</div>
        <div id="cmp-bars"></div>
      </div>
      <div class="cmp-table-section">
        <div class="cmp-section-label">Ã–zet Tablo</div>
        <div id="cmp-table"></div>
      </div>
    </div>
    <div class="cmp-footer">Tolerans: <span id="cmp-tol">15Â°</span> Â· OSM verisi</div>
  </div>
</div>

<style>
/* â•â• COMPARISON MODAL CSS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cmp-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:5000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.cmp-overlay.show{display:flex;}
.cmp-modal{background:#0e0e16;border:1px solid #2a2a3a;border-radius:14px;width:min(820px,96vw);max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,.8);display:flex;flex-direction:column;scrollbar-width:thin;scrollbar-color:#2a2a3a transparent;}
.cmp-header{display:flex;align-items:center;justify-content:space-between;padding:18px 22px 14px;border-bottom:1px solid #2a2a3a;flex-shrink:0;}
.cmp-title{font-size:15px;font-weight:700;color:#e8e4d8;letter-spacing:.02em;}
.cmp-close{background:none;border:none;color:#6b6b7a;cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;}
.cmp-close:hover{color:#e8e4d8;background:#2a2a3a;}

/* inputs */
.cmp-inputs{display:grid;grid-template-columns:1fr 60px 1fr;gap:0;padding:18px 22px;border-bottom:1px solid #2a2a3a;align-items:center;}
.cmp-city-label{font-size:10px;letter-spacing:.12em;text-transform:uppercase;font-weight:700;margin-bottom:6px;}
.cmp-city-current{font-size:15px;font-weight:700;color:#e8e4d8;margin-bottom:3px;}
.cmp-city-hint{font-size:10px;color:#6b6b7a;}
.cmp-vs{text-align:center;font-size:18px;font-weight:700;color:#2a2a3a;}
.cmp-search-row{display:flex;gap:7px;margin-bottom:5px;}
.cmp-search-row input{flex:1;background:#16161f;border:1px solid #2a2a3a;color:#e8e4d8;font-family:'DM Mono',monospace;font-size:12px;padding:7px 12px;border-radius:6px;outline:none;}
.cmp-search-row input:focus{border-color:#c9a84c;}
.cmp-search-row input::placeholder{color:#6b6b7a;}
.cmp-search-row select{background:#16161f;border:1px solid #2a2a3a;color:#e8e4d8;font-family:'DM Mono',monospace;font-size:11px;padding:7px 9px;border-radius:6px;outline:none;min-width:84px;}
.cmp-search-row select:focus{border-color:#c9a84c;}
.cmp-search-row .btn-sm{padding:7px 10px;font-size:11px;}
.cmp-city-status{font-size:10px;color:#6b6b7a;min-height:14px;}

/* progress */
.cmp-progress-wrap{padding:12px 22px;border-bottom:1px solid #2a2a3a;}
.cmp-progress-bar{height:3px;background:linear-gradient(90deg,#c9a84c,#e8c97a);border-radius:2px;width:0%;transition:width .4s ease;margin-bottom:6px;}
.cmp-progress-label{font-size:10px;color:#6b6b7a;letter-spacing:.08em;}

/* results */
.cmp-results{padding:20px 22px;display:flex;flex-direction:column;gap:20px;}

/* score row */
.cmp-score-row{display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:start;}
.cmp-score-block{border-radius:10px;padding:16px 12px;display:flex;flex-direction:column;align-items:center;gap:6px;}
.cmp-a-bg{background:rgba(96,165,250,.06);border:1px solid rgba(96,165,250,.2);}
.cmp-b-bg{background:rgba(244,114,182,.06);border:1px solid rgba(244,114,182,.2);}
.cmp-score-pct{font-size:28px;font-weight:700;color:#e8e4d8;line-height:1;}
.cmp-score-grade{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:2px 8px;border-radius:12px;}
.cmp-score-grade.A{background:rgba(74,222,128,.15);color:#4ade80;}
.cmp-score-grade.B{background:rgba(251,191,36,.15);color:#fbbf24;}
.cmp-score-grade.C{background:rgba(251,146,60,.15);color:#fb923c;}
.cmp-score-grade.D{background:rgba(248,113,113,.15);color:#f87171;}
.cmp-score-city{font-size:11px;font-weight:700;color:#e8e4d8;text-align:center;max-width:120px;word-break:break-word;}

/* winner middle column */
.cmp-winner-col{display:flex;flex-direction:column;align-items:center;gap:8px;}
.cmp-winner-badge{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:4px 12px;border-radius:20px;text-align:center;}
.cmp-winner-badge.a{background:rgba(96,165,250,.15);color:#60a5fa;border:1px solid rgba(96,165,250,.3);}
.cmp-winner-badge.b{background:rgba(244,114,182,.15);color:#f472b6;border:1px solid rgba(244,114,182,.3);}
.cmp-winner-badge.tie{background:rgba(201,168,76,.15);color:#c9a84c;border:1px solid rgba(201,168,76,.3);}
#cmp-radar{display:block;}
.cmp-radar-legend{font-size:10px;color:#6b6b7a;display:flex;gap:10px;align-items:center;}
.cmp-leg-a{color:#60a5fa;font-size:13px;}
.cmp-leg-b{color:#f472b6;font-size:13px;}

/* bars */
.cmp-bars-section,.cmp-table-section{display:flex;flex-direction:column;gap:8px;}
.cmp-section-label{font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:#6b6b7a;margin-bottom:2px;}
.cmp-bar-row{display:grid;grid-template-columns:120px 1fr 1fr;gap:8px;align-items:center;font-size:11px;}
.cmp-bar-label{color:#6b6b7a;text-align:right;padding-right:6px;}
.cmp-bar-outer{height:14px;background:#16161f;border-radius:7px;overflow:hidden;position:relative;}
.cmp-bar-inner{height:100%;border-radius:7px;transition:width .6s ease;display:flex;align-items:center;justify-content:flex-end;padding-right:6px;font-size:9px;font-weight:700;color:rgba(0,0,0,.7);white-space:nowrap;}

/* table */
.cmp-tbl{width:100%;border-collapse:collapse;font-size:11px;}
.cmp-tbl th{color:#6b6b7a;font-weight:500;padding:6px 10px;text-align:left;border-bottom:1px solid #2a2a3a;}
.cmp-tbl td{padding:6px 10px;border-bottom:1px solid rgba(42,42,58,.4);}
.cmp-tbl tr:last-child td{border:none;}
.cmp-tbl .winner-cell{font-weight:700;}

.cmp-footer{padding:12px 22px;border-top:1px solid #2a2a3a;font-size:10px;color:#6b6b7a;flex-shrink:0;}

/* â•â• DETAIL PANEL CSS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dp-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0);z-index:4800;display:none;transition:background .25s;}
.dp-backdrop.show{display:block;background:rgba(0,0,0,.45);}
.dp-panel{position:fixed;top:0;right:0;bottom:0;width:380px;background:#0e0e16;border-left:1px solid #2a2a3a;z-index:4900;transform:translateX(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);overflow-y:auto;overflow-x:hidden;scrollbar-width:thin;scrollbar-color:#2a2a3a transparent;display:flex;flex-direction:column;}
.dp-panel.open{transform:translateX(0);}

/* Head */
.dp-head{padding:16px 16px 12px;border-bottom:1px solid #2a2a3a;display:flex;justify-content:space-between;align-items:flex-start;flex-shrink:0;background:linear-gradient(135deg,#101018,#14141e);}
.dp-head-left{flex:1;min-width:0;padding-right:8px;}
.dp-name{font-family:'Playfair Display',serif;font-size:17px;font-weight:700;color:#e8e4d8;line-height:1.2;word-break:break-word;}
.dp-name-ar{font-family:'Noto Naskh Arabic',serif;font-size:15px;color:#c9a84c;margin-top:3px;direction:rtl;text-align:right;}
.dp-place{font-size:10px;color:#9ca3af;margin-top:4px;letter-spacing:.02em;}
.dp-coords{font-size:9px;color:#6b6b7a;margin-top:4px;letter-spacing:.05em;}
.dp-close{background:none;border:none;color:#6b6b7a;cursor:pointer;font-size:16px;padding:2px 5px;border-radius:4px;flex-shrink:0;}
.dp-close:hover{color:#e8e4d8;background:#2a2a3a;}

/* Ribbon */
.dp-ribbon{display:flex;border-bottom:1px solid #2a2a3a;flex-shrink:0;}
.dp-ribbon-item{flex:1;padding:9px 10px;border-right:1px solid #2a2a3a;display:flex;flex-direction:column;gap:3px;}
.dp-ribbon-item:last-child{border-right:none;}
.dp-ribbon-lbl{font-size:8px;color:#6b6b7a;letter-spacing:.1em;text-transform:uppercase;}
.dp-ribbon-val{font-size:12px;font-weight:700;color:#e8e4d8;}
.dp-status-badge{display:inline-flex;align-items:center;gap:5px;font-size:11px;font-weight:700;padding:2px 8px;border-radius:10px;}
.dp-status-badge.correct{background:rgba(74,222,128,.12);color:#4ade80;border:1px solid rgba(74,222,128,.3);}
.dp-status-badge.wrong{background:rgba(248,113,113,.12);color:#f87171;border:1px solid rgba(248,113,113,.3);}
.dp-status-badge.unknown{background:rgba(251,191,36,.10);color:#fbbf24;border:1px solid rgba(251,191,36,.25);}

/* Photo */
.dp-photo-wrap{position:relative;flex-shrink:0;}
.dp-photo{width:100%;max-height:200px;object-fit:cover;display:block;}
.dp-photo-credit{position:absolute;bottom:4px;right:6px;font-size:8px;color:rgba(255,255,255,.5);background:rgba(0,0,0,.5);padding:1px 5px;border-radius:3px;}

/* Sections */
.dp-section{padding:14px 16px;border-bottom:1px solid rgba(42,42,58,.5);}
.dp-section-title{font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:#6b6b7a;margin-bottom:10px;}

/* Interior evidence */
.dp-int-gallery{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:8px;}
.dp-int-thumb{position:relative;border:1px solid #2a2a3a;border-radius:6px;overflow:hidden;cursor:pointer;background:#111118;height:70px;}
.dp-int-thumb img{width:100%;height:100%;object-fit:cover;display:block;}
.dp-int-thumb span{position:absolute;left:4px;bottom:4px;font-size:8px;color:#d1d5db;background:rgba(0,0,0,.55);padding:1px 4px;border-radius:3px;}
.dp-int-meta{font-size:10px;color:#6b6b7a;line-height:1.45;margin-bottom:8px;}
.dp-int-form{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px;}
.dp-int-form label{grid-column:1/-1;font-size:10px;color:#6b6b7a;}
.dp-int-form input,.dp-int-form select{background:#111118;border:1px solid #2a2a3a;color:#e8e4d8;font-family:'DM Mono',monospace;font-size:10px;padding:7px 9px;border-radius:6px;outline:none;}
.dp-int-form input[type=range]{grid-column:1/-1;padding:0;height:4px;accent-color:#c9a84c;}
.dp-int-axis-val{font-size:10px;color:#c9a84c;align-self:center;}
.dp-int-form button{grid-column:1/-1;justify-content:center;}
.dp-int-ev-list{display:flex;flex-direction:column;gap:5px;}
.dp-int-ev-row{display:flex;align-items:center;gap:8px;background:#111118;border:1px solid #2a2a3a;border-radius:6px;padding:6px 8px;font-size:10px;}
.dp-int-ev-main{flex:1;color:#e8e4d8;}
.dp-int-ev-sub{font-size:9px;color:#6b6b7a;}
.dp-int-ev-del{background:none;border:1px solid rgba(248,113,113,.35);color:#f87171;border-radius:5px;font-size:9px;padding:3px 6px;cursor:pointer;}

/* Compass */
.dp-qibla-row{display:flex;gap:14px;align-items:flex-start;}
#dp-compass{flex-shrink:0;border-radius:50%;background:#111118;border:1px solid #2a2a3a;}
.dp-qibla-stats{flex:1;display:flex;flex-direction:column;gap:7px;}
.dp-qs-row{display:flex;justify-content:space-between;font-size:11px;}
.dp-qs-k{color:#6b6b7a;}
.dp-qs-v{color:#e8e4d8;font-weight:600;}

/* Wikipedia */
.dp-wiki-body{font-size:11px;color:#b0b0be;line-height:1.65;margin-bottom:8px;max-height:140px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#2a2a3a transparent;}
.dp-wiki-link{font-size:10px;color:#c9a84c;text-decoration:none;letter-spacing:.04em;}
.dp-wiki-link:hover{text-decoration:underline;}

/* Tags */
.dp-tags{display:flex;flex-direction:column;gap:3px;}
.dp-tag-row{display:grid;grid-template-columns:140px 1fr;gap:6px;font-size:10px;padding:3px 0;border-bottom:1px solid rgba(42,42,58,.3);}
.dp-tag-row:last-child{border-bottom:none;}
.dp-tag-k{color:#6b6b7a;word-break:break-all;}
.dp-tag-v{color:#c9a84c;word-break:break-all;}
.dp-tag-v a{color:#60a5fa;text-decoration:none;}
.dp-tag-v a:hover{text-decoration:underline;}

/* Actions */
.dp-actions{display:flex;flex-wrap:wrap;gap:8px;padding:14px 16px 20px;flex-shrink:0;}
.dp-action-btn{display:flex;align-items:center;gap:6px;background:#111118;border:1px solid #2a2a3a;color:#e8e4d8;font-family:'DM Mono',monospace;font-size:10px;padding:7px 12px;border-radius:6px;cursor:pointer;text-decoration:none;transition:all .13s;}
.dp-action-btn:hover{border-color:#c9a84c;color:#c9a84c;background:rgba(201,168,76,.06);}
.dp-action-btn.anim{background:rgba(201,168,76,.1);border-color:rgba(201,168,76,.35);color:#c9a84c;}
.dp-action-btn.anim:hover{background:rgba(201,168,76,.2);}

/* â•â• EXPORT MODAL CSS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.exp-overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:5200;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.exp-overlay.show{display:flex;}
.exp-modal{background:#0e0e16;border:1px solid #2a2a3a;border-radius:14px;width:min(540px,95vw);max-height:88vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,.9);display:flex;flex-direction:column;scrollbar-width:thin;scrollbar-color:#2a2a3a transparent;}
.exp-header{display:flex;align-items:center;justify-content:space-between;padding:18px 22px 14px;border-bottom:1px solid #2a2a3a;}
.exp-title{font-size:15px;font-weight:700;color:#e8e4d8;}
.exp-close{background:none;border:none;color:#6b6b7a;cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;}
.exp-close:hover{color:#e8e4d8;background:#2a2a3a;}

.exp-section{padding:16px 22px;border-bottom:1px solid rgba(42,42,58,.5);}
.exp-section:last-of-type{border-bottom:none;}
.exp-section-title{font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:#6b6b7a;margin-bottom:12px;}

/* Share URL */
.exp-url-row{display:flex;gap:8px;margin-bottom:8px;}
.exp-url-input{flex:1;background:#111118;border:1px solid #2a2a3a;color:#c9a84c;font-family:'DM Mono',monospace;font-size:11px;padding:8px 12px;border-radius:6px;outline:none;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.exp-copy-btn{background:#c9a84c;color:#0a0a0f;border:none;font-family:'DM Mono',monospace;font-size:11px;font-weight:700;padding:8px 16px;border-radius:6px;cursor:pointer;white-space:nowrap;transition:background .15s;}
.exp-copy-btn:hover{background:#e8c97a;}
.exp-copy-btn.copied{background:#4ade80;color:#0a0a0f;}
.exp-url-hint{font-size:10px;color:#4a4a5a;line-height:1.5;}

/* Summary */
.exp-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.exp-sum-card{background:#111118;border:1px solid #1e1e2e;border-radius:8px;padding:10px;text-align:center;}
.exp-sum-val{font-size:20px;font-weight:700;color:#c9a84c;}
.exp-sum-lbl{font-size:9px;color:#6b6b7a;text-transform:uppercase;letter-spacing:.08em;margin-top:3px;}

/* Download grid */
.exp-dl-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;}
.exp-dl-btn{background:#111118;border:1px solid #2a2a3a;border-radius:8px;padding:14px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px;transition:all .15s;text-align:center;}
.exp-dl-btn:hover{border-color:#c9a84c;background:rgba(201,168,76,.06);}
.exp-dl-icon{font-size:22px;line-height:1;}
.exp-dl-label{font-size:13px;font-weight:700;color:#e8e4d8;font-family:'DM Mono',monospace;}
.exp-dl-desc{font-size:10px;color:#6b6b7a;}

.exp-footer{padding:12px 22px;font-size:10px;color:#4a4a5a;}

/* â•â• BUSINESS / MONETIZATION MODAL CSS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.biz-overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:5250;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.biz-overlay.show{display:flex;}
.biz-modal{background:#0e0e16;border:1px solid #2a2a3a;border-radius:14px;width:min(700px,96vw);max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,.9);display:flex;flex-direction:column;scrollbar-width:thin;scrollbar-color:#2a2a3a transparent;}
.biz-header{display:flex;align-items:center;justify-content:space-between;padding:18px 22px 14px;border-bottom:1px solid #2a2a3a;}
.biz-title{font-size:15px;font-weight:700;color:#e8e4d8;}
.biz-close{background:none;border:none;color:#6b6b7a;cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;}
.biz-close:hover{color:#e8e4d8;background:#2a2a3a;}
.biz-section{padding:16px 22px;border-bottom:1px solid rgba(42,42,58,.5);}
.biz-section:last-child{border-bottom:none;}
.biz-section-title{font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:#6b6b7a;margin-bottom:12px;}
.biz-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;}
.biz-card{background:#111118;border:1px solid #2a2a3a;border-radius:8px;padding:10px;}
.biz-card-name{font-size:11px;font-weight:700;color:#e8e4d8;}
.biz-card-price{font-size:16px;font-weight:700;color:#c9a84c;margin-top:5px;}
.biz-card-desc{font-size:10px;color:#6b6b7a;margin-top:6px;line-height:1.4;}
.biz-inline{display:flex;justify-content:space-between;gap:8px;font-size:11px;padding:8px 10px;border:1px solid #2a2a3a;border-radius:7px;background:#111118;color:#e8e4d8;margin-bottom:7px;}
.biz-inline strong{color:#c9a84c;}
.biz-cta-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
.biz-cta{background:transparent;border:1px solid #2a2a3a;color:#9ca3af;font-family:'DM Mono',monospace;font-size:11px;padding:8px 12px;border-radius:7px;cursor:pointer;text-decoration:none;display:inline-flex;align-items:center;justify-content:center;}
.biz-cta:hover{color:#e8e4d8;border-color:#3a3a4a;background:#111118;}
.biz-cta.primary{background:#c9a84c;color:#0a0a0f;border-color:transparent;font-weight:700;}
.biz-cta.primary:hover{background:#e8c97a;color:#0a0a0f;}
.biz-form{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.biz-form input,.biz-form textarea{background:#111118;border:1px solid #2a2a3a;color:#e8e4d8;font-family:'DM Mono',monospace;font-size:11px;padding:8px 10px;border-radius:7px;outline:none;}
.biz-form textarea{grid-column:1 / -1;min-height:74px;resize:vertical;}
.biz-form button{grid-column:1 / -1;}
.biz-hint{font-size:10px;color:#4a4a5a;margin-top:8px;}

/* â•â• LAB MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lab-overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:5260;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.lab-overlay.show{display:flex;}
.lab-modal{background:#0e0e16;border:1px solid #2a2a3a;border-radius:14px;width:min(900px,97vw);max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,.9);display:flex;flex-direction:column;}
.lab-header{display:flex;align-items:center;justify-content:space-between;padding:16px 20px;border-bottom:1px solid #2a2a3a;}
.lab-title{font-size:15px;font-weight:700;color:#e8e4d8;}
.lab-close{background:none;border:none;color:#6b6b7a;cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;}
.lab-close:hover{color:#e8e4d8;background:#2a2a3a;}
.lab-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;padding:12px;}
.lab-card{background:#111118;border:1px solid #2a2a3a;border-radius:10px;padding:10px;min-height:180px;}
.lab-card-title{font-size:10px;color:#6b6b7a;letter-spacing:.1em;text-transform:uppercase;margin-bottom:8px;}
.lab-row{display:flex;justify-content:space-between;gap:8px;font-size:10px;padding:6px 0;border-bottom:1px solid rgba(42,42,58,.35);}
.lab-row:last-child{border-bottom:none;}
.lab-k{color:#6b6b7a;}
.lab-v{color:#e8e4d8;text-align:right;}
.badge{display:inline-block;font-size:9px;padding:2px 6px;border-radius:9px;border:1px solid #2a2a3a;color:#c9a84c;}

/* â•â• COMPASS MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cmps-overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:5265;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.cmps-overlay.show{display:flex;}
.cmps-modal{background:#0e0e16;border:1px solid #2a2a3a;border-radius:14px;width:min(420px,95vw);max-height:90vh;overflow-y:auto;}
.cmps-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #2a2a3a;}
.cmps-title{font-size:14px;font-weight:700;color:#e8e4d8;}
.cmps-close{background:none;border:none;color:#6b6b7a;cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;}
.cmps-close:hover{color:#e8e4d8;background:#2a2a3a;}
.cmps-body{padding:12px 16px;}
#cmps-canvas{display:block;margin:0 auto 10px;border:1px solid #2a2a3a;border-radius:50%;background:#111118;}
.cmps-rows{display:flex;flex-direction:column;gap:5px;margin-bottom:10px;}
.cmps-actions{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}

/* â•â• 3D MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.m3d-overlay{position:fixed;inset:0;background:rgba(0,0,0,.82);z-index:5266;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.m3d-overlay.show{display:flex;}
.m3d-modal{background:#0e0e16;border:1px solid #2a2a3a;border-radius:14px;width:min(980px,97vw);max-height:90vh;overflow:hidden;display:flex;flex-direction:column;}
.m3d-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid #2a2a3a;}
.m3d-title{font-size:14px;font-weight:700;color:#e8e4d8;}
.m3d-close{background:none;border:none;color:#6b6b7a;cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;}
.m3d-close:hover{color:#e8e4d8;background:#2a2a3a;}
.m3d-wrap{display:grid;grid-template-columns:1fr 260px;min-height:420px;}
#m3d-canvas{width:100%;height:100%;display:block;background:#090910;}
.m3d-side{border-left:1px solid #2a2a3a;padding:10px;overflow-y:auto;font-size:11px;color:#9ca3af;}

.manual-axis-point{background:#c9a84c;border:1px solid #fff;border-radius:50%;width:10px;height:10px;box-shadow:0 0 10px rgba(201,168,76,.8);}

/* â•â• LEADERBOARD CSS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.lb-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:5100;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.lb-overlay.show{display:flex;}
.lb-modal{background:#0a0a12;border:1px solid #2a2a3a;border-radius:14px;width:min(1020px,97vw);max-height:92vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 32px 100px rgba(0,0,0,.9);}

/* Header */
.lb-header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px 12px;border-bottom:1px solid #2a2a3a;flex-shrink:0;background:linear-gradient(135deg,#0e0e1a,#12121e);}
.lb-title{font-size:16px;font-weight:700;color:#e8e4d8;letter-spacing:.02em;}
.lb-header-right{display:flex;align-items:center;gap:12px;}
.lb-updated{font-size:10px;color:#6b6b7a;}
.lb-close{background:none;border:none;color:#6b6b7a;cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;}
.lb-close:hover{color:#e8e4d8;background:#2a2a3a;}

/* Controls */
.lb-controls{padding:12px 20px;border-bottom:1px solid #2a2a3a;flex-shrink:0;display:flex;flex-direction:column;gap:10px;background:#0d0d18;}
.lb-add-wrap{display:flex;gap:8px;align-items:center;}
.lb-add-wrap input{flex:1;max-width:340px;background:#16161f;border:1px solid #2a2a3a;color:#e8e4d8;font-family:'DM Mono',monospace;font-size:12px;padding:7px 13px;border-radius:6px;outline:none;transition:border-color .2s;}
.lb-add-wrap input:focus{border-color:#c9a84c;}
.lb-add-wrap input::placeholder{color:#6b6b7a;}
#lb-add-btn{background:#c9a84c;color:#0a0a0f;border:none;font-family:'DM Mono',monospace;font-size:11px;font-weight:700;padding:7px 16px;border-radius:6px;cursor:pointer;letter-spacing:.04em;white-space:nowrap;transition:background .15s;}
#lb-add-btn:hover{background:#e8c97a;}
#lb-add-btn:disabled{background:#3a3a4a;color:#6b6b7a;cursor:not-allowed;}

/* Progress */
.lb-progress-wrap{display:flex;align-items:center;gap:10px;height:18px;}
.lb-progress-bar{height:4px;background:#c9a84c;border-radius:2px;transition:width .4s ease;width:0%;}
.lb-progress-label{font-size:10px;color:#c9a84c;letter-spacing:.05em;white-space:nowrap;}

/* Region filters */
.lb-filters{display:flex;gap:6px;flex-wrap:wrap;}
.lb-filter{background:transparent;border:1px solid #2a2a3a;color:#6b6b7a;font-family:'DM Mono',monospace;font-size:10px;padding:4px 10px;border-radius:14px;cursor:pointer;transition:all .13s;}
.lb-filter:hover{color:#e8e4d8;border-color:#6b6b7a;}
.lb-filter.active{background:rgba(201,168,76,.15);color:#c9a84c;border-color:rgba(201,168,76,.45);font-weight:700;}

/* Sort buttons */
.lb-sort-row{display:flex;align-items:center;gap:6px;}
.lb-sort-label{font-size:10px;color:#6b6b7a;margin-right:2px;}
.lb-sort{background:transparent;border:1px solid #1e1e2e;color:#6b6b7a;font-family:'DM Mono',monospace;font-size:10px;padding:3px 9px;border-radius:4px;cursor:pointer;transition:all .13s;}
.lb-sort:hover{color:#e8e4d8;}
.lb-sort.active{background:#1e1e2e;color:#e8e4d8;border-color:#3a3a4a;}
.lb-mode-row{display:flex;align-items:center;gap:6px;}
.lb-mode{background:transparent;border:1px solid #1e1e2e;color:#6b6b7a;font-family:'DM Mono',monospace;font-size:10px;padding:3px 9px;border-radius:4px;cursor:pointer;transition:all .13s;}
.lb-mode:hover{color:#e8e4d8;}
.lb-mode.active{background:#1e1e2e;color:#e8e4d8;border-color:#3a3a4a;}

/* Summary strip */
.lb-summary{display:flex;gap:0;border-bottom:1px solid #2a2a3a;flex-shrink:0;}
.lb-sum-item{flex:1;padding:10px 16px;text-align:center;border-right:1px solid #2a2a3a;}
.lb-sum-item:last-child{border-right:none;}
.lb-sum-val{font-size:20px;font-weight:700;color:#c9a84c;}
.lb-sum-lbl{font-size:9px;color:#6b6b7a;text-transform:uppercase;letter-spacing:.1em;margin-top:2px;}

/* Table */
.lb-table-wrap{flex:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#2a2a3a transparent;}
.lb-table-head{display:grid;grid-template-columns:36px 1fr 140px 42px 28px 52px 58px 72px 60px;align-items:center;padding:8px 16px;border-bottom:1px solid #2a2a3a;font-size:9px;color:#6b6b7a;letter-spacing:.1em;text-transform:uppercase;position:sticky;top:0;background:#0d0d18;z-index:2;}
.lb-row{display:grid;grid-template-columns:36px 1fr 140px 42px 28px 52px 58px 72px 60px;align-items:center;padding:9px 16px;border-bottom:1px solid rgba(42,42,58,.35);transition:background .12s;cursor:pointer;}
.lb-row:hover{background:rgba(201,168,76,.04);}
.lb-row.current-city{background:rgba(201,168,76,.07);border-left:2px solid #c9a84c;}
.lb-row.analyzing{opacity:.5;pointer-events:none;}

/* Row cells */
.lbt-rank{font-size:13px;font-weight:700;text-align:center;}
.lb-rank-1{color:#fbbf24;}
.lb-rank-2{color:#9ca3af;}
.lb-rank-3{color:#c9784c;}
.lb-rank-n{color:#6b6b7a;}

.lbt-city{display:flex;flex-direction:column;gap:2px;min-width:0;padding-right:8px;}
.lb-city-name{font-size:12px;color:#e8e4d8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.lb-city-country{font-size:9px;color:#6b6b7a;}

.lbt-bar{padding-right:8px;}
.lb-bar-track{height:6px;background:#1a1a26;border-radius:3px;overflow:hidden;}
.lb-bar-fill{height:100%;border-radius:3px;transition:width .8s cubic-bezier(.4,0,.2,1);}

.lbt-pct{font-size:13px;font-weight:700;text-align:right;}
.lbt-not{text-align:center;font-size:13px;}
.lbt-count,.lbt-avg{font-size:11px;color:#6b6b7a;text-align:right;}
.lbt-date{font-size:9px;color:#4a4a5a;text-align:right;}
.lbt-act{display:flex;gap:4px;justify-content:flex-end;}
.lb-act-btn{background:#16161f;border:1px solid #2a2a3a;color:#6b6b7a;font-size:9px;padding:3px 7px;border-radius:4px;cursor:pointer;font-family:'DM Mono',monospace;transition:all .12s;white-space:nowrap;}
.lb-act-btn:hover{color:#c9a84c;border-color:rgba(201,168,76,.4);}
.lb-act-btn.danger:hover{color:#f87171;border-color:rgba(248,113,113,.4);}

.lb-empty{padding:48px;text-align:center;color:#6b6b7a;font-size:13px;}
.lb-empty-icon{font-size:40px;margin-bottom:12px;opacity:.4;}

/* Footer */
.lb-footer{padding:10px 20px;border-top:1px solid #2a2a3a;font-size:10px;color:#6b6b7a;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.lb-clear-btn{background:transparent;border:1px solid rgba(248,113,113,.25);color:rgba(248,113,113,.6);font-family:'DM Mono',monospace;font-size:10px;padding:3px 10px;border-radius:4px;cursor:pointer;transition:all .12s;}
.lb-clear-btn:hover{background:rgba(248,113,113,.08);color:#f87171;border-color:#f87171;}

/* â•â• HISTORY MODAL CSS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.hist-overlay{position:fixed;inset:0;background:rgba(0,0,0,.78);z-index:5000;display:none;align-items:center;justify-content:center;backdrop-filter:blur(6px);}
.hist-overlay.show{display:flex;}
.hist-modal{background:#0e0e16;border:1px solid #2a2a3a;border-radius:14px;width:min(860px,96vw);max-height:90vh;overflow-y:auto;box-shadow:0 24px 80px rgba(0,0,0,.85);display:flex;flex-direction:column;scrollbar-width:thin;scrollbar-color:#2a2a3a transparent;}
.hist-header{display:flex;align-items:center;justify-content:space-between;padding:18px 22px 14px;border-bottom:1px solid #2a2a3a;flex-shrink:0;}
.hist-title{font-size:15px;font-weight:700;color:#e8e4d8;letter-spacing:.02em;}
.hist-close{background:none;border:none;color:#6b6b7a;cursor:pointer;font-size:16px;padding:2px 6px;border-radius:4px;}
.hist-close:hover{color:#e8e4d8;background:#2a2a3a;}

/* Period chips */
.hist-chips{display:flex;flex-wrap:wrap;gap:8px;padding:14px 22px;border-bottom:1px solid #2a2a3a;}
.hist-chip{background:transparent;border:1px solid #2a2a3a;color:#6b6b7a;font-family:'DM Mono',monospace;font-size:11px;padding:5px 13px;border-radius:20px;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:5px;}
.hist-chip:hover{color:#e8e4d8;border-color:#6b6b7a;}
.hist-chip.active{font-weight:700;}
.hist-chip-sub{font-size:9px;opacity:.6;}
.hist-chip.all.active{background:rgba(201,168,76,.15);color:#c9a84c;border-color:rgba(201,168,76,.4);}
.hist-chip.ottoman.active{background:rgba(167,139,250,.15);color:#a78bfa;border-color:rgba(167,139,250,.4);}
.hist-chip.early.active{background:rgba(251,191,36,.15);color:#fbbf24;border-color:rgba(251,191,36,.4);}
.hist-chip.mid.active{background:rgba(96,165,250,.15);color:#60a5fa;border-color:rgba(96,165,250,.4);}
.hist-chip.modern.active{background:rgba(74,222,128,.15);color:#4ade80;border-color:rgba(74,222,128,.4);}
.hist-chip.unknown.active{background:rgba(107,114,128,.15);color:#9ca3af;border-color:rgba(107,114,128,.4);}

/* Summary cards */
.hist-cards{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;padding:14px 22px;border-bottom:1px solid #2a2a3a;}
.hist-card{border-radius:8px;padding:12px 10px;display:flex;flex-direction:column;gap:4px;border:1px solid #2a2a3a;}
.hist-card.ottoman{border-color:rgba(167,139,250,.25);background:rgba(167,139,250,.05);}
.hist-card.early{border-color:rgba(251,191,36,.25);background:rgba(251,191,36,.05);}
.hist-card.mid{border-color:rgba(96,165,250,.25);background:rgba(96,165,250,.05);}
.hist-card.modern{border-color:rgba(74,222,128,.25);background:rgba(74,222,128,.05);}
.hist-card.unknown{border-color:rgba(107,114,128,.2);background:rgba(107,114,128,.04);}
.hist-card-period{font-size:9px;letter-spacing:.1em;text-transform:uppercase;font-weight:700;}
.hist-card.ottoman .hist-card-period{color:#a78bfa;}
.hist-card.early .hist-card-period{color:#fbbf24;}
.hist-card.mid .hist-card-period{color:#60a5fa;}
.hist-card.modern .hist-card-period{color:#4ade80;}
.hist-card.unknown .hist-card-period{color:#9ca3af;}
.hist-card-count{font-size:22px;font-weight:700;color:#e8e4d8;line-height:1;}
.hist-card-pct{font-size:11px;font-weight:700;}
.hist-card.ottoman .hist-card-pct{color:#a78bfa;}
.hist-card.early .hist-card-pct{color:#fbbf24;}
.hist-card.mid .hist-card-pct{color:#60a5fa;}
.hist-card.modern .hist-card-pct{color:#4ade80;}
.hist-card.unknown .hist-card-pct{color:#9ca3af;}
.hist-card-avg{font-size:10px;color:#6b6b7a;}

/* Chart and scatter */
.hist-chart-wrap,.hist-scatter-wrap{padding:16px 22px;border-bottom:1px solid #2a2a3a;}
.hist-section-label{font-size:9px;letter-spacing:.14em;text-transform:uppercase;color:#6b6b7a;margin-bottom:10px;}
#hist-chart,#hist-scatter{display:block;width:100%;border-radius:6px;}
.hist-scatter-legend{display:flex;gap:14px;font-size:10px;color:#6b6b7a;margin-top:8px;flex-wrap:wrap;}
.hsl-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:3px;vertical-align:middle;}
.hsl-dot.ottoman{background:#a78bfa;}
.hsl-dot.early{background:#fbbf24;}
.hsl-dot.mid{background:#60a5fa;}
.hsl-dot.modern{background:#4ade80;}

/* Table */
.hist-table-wrap{padding:16px 22px;border-bottom:1px solid #2a2a3a;}
.hist-tbl{width:100%;border-collapse:collapse;font-size:11px;}
.hist-tbl th{color:#6b6b7a;font-weight:500;padding:6px 10px;text-align:left;border-bottom:1px solid #2a2a3a;}
.hist-tbl td{padding:6px 10px;border-bottom:1px solid rgba(42,42,58,.4);color:#e8e4d8;}
.hist-tbl tr:last-child td{border:none;}
.hist-period-badge{display:inline-block;padding:1px 7px;border-radius:10px;font-size:9px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;}
.hist-period-badge.ottoman{background:rgba(167,139,250,.15);color:#a78bfa;}
.hist-period-badge.early{background:rgba(251,191,36,.15);color:#fbbf24;}
.hist-period-badge.mid{background:rgba(96,165,250,.15);color:#60a5fa;}
.hist-period-badge.modern{background:rgba(74,222,128,.15);color:#4ade80;}
.hist-period-badge.unknown{background:rgba(107,114,128,.12);color:#9ca3af;}

/* Filtered list */
.hist-list-wrap{padding:16px 22px;}
.hist-list{display:flex;flex-direction:column;gap:4px;max-height:220px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:#2a2a3a transparent;}
.hist-list-item{display:flex;align-items:center;gap:8px;padding:6px 10px;background:#111118;border-radius:6px;cursor:pointer;font-size:11px;border:1px solid transparent;transition:border-color .12s;}
.hist-list-item:hover{border-color:#2a2a3a;}
.hist-list-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.hist-list-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:#e8e4d8;}
.hist-list-year{font-size:9px;color:#6b6b7a;flex-shrink:0;min-width:36px;}
.hist-list-diff{font-size:10px;font-weight:700;flex-shrink:0;min-width:34px;text-align:right;}

.hist-footer{padding:12px 22px;border-top:1px solid #2a2a3a;font-size:10px;color:#6b6b7a;flex-shrink:0;}
.hist-footer code{background:#1a1a26;padding:1px 5px;border-radius:3px;font-family:'DM Mono',monospace;}
</style>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPARISON MODE (AdÄ±m 3)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const compareDBA = new Map();
const compareDBB = new Map();
const compareAreaTotals = { a:null, b:null };
const comparePlaceMeta = { a:null, b:null };
const compareLoaded = { a:false, b:false };

function openCompare() {
  document.getElementById('cmp-overlay').classList.add('show');
  document.getElementById('btn-compare').classList.add('active');
  document.getElementById('cmp-a-name').textContent = comparePlaceMeta.a?.label || 'â€”';
  document.getElementById('cmp-b-name').textContent = comparePlaceMeta.b?.label || 'â€”';
  document.getElementById('cmp-tol').textContent = tol + 'Â°';
  const aInput = document.getElementById('cmp-a-input');
  if (aInput && !aInput.value && currentCity) aInput.value = currentCity;
  if (compareLoaded.a || compareLoaded.b) renderCompare();
}

function closeCompare() {
  document.getElementById('cmp-overlay').classList.remove('show');
  document.getElementById('btn-compare').classList.remove('active');
}

function cmpOverlayClick(e) {
  if (e.target === document.getElementById('cmp-overlay')) closeCompare();
}

function compareLevelLabel(level) {
  return level === 'district' ? 'Ä°lÃ§e' : 'Åehir';
}

function scoreCompareGeocode(item, query, level = 'city') {
  const q = trLower(query || '');
  const disp = trLower(item.display_name || '');
  const type = trLower(item.type || '');
  const cls = trLower(item.class || '');
  const addr = item.address || {};
  let s = Number(item.importance || 0) * 100;
  if (disp.includes(q)) s += 20;
  if (disp.startsWith(q + ',')) s += 35;
  if (cls === 'boundary' || cls === 'place') s += 18;
  const cityTypes = new Set(['city','town','village','municipality','county','state','province']);
  const districtTypes = new Set(['district','city_district','borough','suburb','quarter','neighbourhood']);
  if (level === 'district') {
    if (districtTypes.has(type)) s += 65;
    if (addr.city_district || addr.district || addr.suburb || addr.neighbourhood || addr.quarter) s += 24;
  } else {
    if (cityTypes.has(type)) s += 65;
    if (addr.city || addr.town || addr.county || addr.state || addr.province) s += 24;
  }
  return s;
}

function normalizeComparePlace(item, level) {
  const address = item?.address || {};
  const city = address.city || address.town || address.county || address.state || address.province || '';
  const district = address.city_district || address.district || address.suburb || address.neighbourhood || address.quarter || '';
  const levelVal = level || 'city';
  const label = levelVal === 'district'
    ? [district, city].filter(Boolean).join(', ') || (item.display_name || '').split(',').slice(0,2).join(',').trim()
    : city || (item.display_name || '').split(',')[0].trim();
  return {
    query: item.display_name || '',
    level: levelVal,
    label: label || 'â€”',
    city,
    district,
    country: address.country || '',
    lat: +item.lat,
    lng: +item.lon,
    bbox: Array.isArray(item.boundingbox) ? item.boundingbox.map(Number) : null,
    osmType: String(item.osm_type || '').toLowerCase(),
    osmClass: String(item.class || '').toLowerCase(),
    osmId: Number(item.osm_id),
    rawType: String(item.type || '').toLowerCase()
  };
}

async function geocodeComparePlace(name, level = 'city') {
  const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(name)}&format=jsonv2&limit=12&addressdetails=1`;
  const data = await nominatimFetchJson(url, {'Accept-Language':'tr,en'});
  if (!Array.isArray(data) || !data.length) throw new Error('Yer bulunamadÄ±');
  const ranked = data.map(it => ({ it, s: scoreCompareGeocode(it, name, level) })).sort((a,b) => b.s - a.s);
  return normalizeComparePlace(ranked[0].it, level);
}

function overpassAreaIdFromPlace(place) {
  if (!place || !Number.isFinite(place.osmId)) return null;
  if (place.osmType === 'relation') return 3600000000 + place.osmId;
  if (place.osmType === 'way') return 2400000000 + place.osmId;
  return null;
}

function parseOverpassCountTotal(elements = []) {
  const countEl = (elements || []).find(x => x?.type === 'count') || (elements || [])[0];
  const tags = countEl?.tags || {};
  const direct = Number(tags.total);
  if (Number.isFinite(direct)) return direct;
  const sum = Number(tags.nodes || 0) + Number(tags.ways || 0) + Number(tags.relations || 0);
  return Number.isFinite(sum) ? sum : null;
}

function buildMosqueCountAreaQuery(areaId) {
  return `[out:json][timeout:75];
area(${areaId})->.a;
(
  nwr["amenity"="place_of_worship"]["religion"~"muslim|islam",i](area.a);
  nwr["amenity"="mosque"](area.a);
  nwr["building"="mosque"](area.a);
  nwr["place_of_worship"="mosque"](area.a);
  nwr["mosque"](area.a);
);
out count;`;
}

function buildMosqueCountBboxQuery(s,w,n,e) {
  return `[out:json][timeout:60];
(
  nwr["amenity"="place_of_worship"]["religion"~"muslim|islam",i](${s},${w},${n},${e});
  nwr["amenity"="mosque"](${s},${w},${n},${e});
  nwr["building"="mosque"](${s},${w},${n},${e});
  nwr["place_of_worship"="mosque"](${s},${w},${n},${e});
  nwr["mosque"](${s},${w},${n},${e});
);
out count;`;
}

async function fetchAreaMosqueTotal(place) {
  const areaId = overpassAreaIdFromPlace(place);
  if (areaId) {
    const els = await fetchOverpassQuery(buildMosqueCountAreaQuery(areaId), { retries:1, timeoutMs:30000, minInterval:320, backoffMs:700 });
    const total = parseOverpassCountTotal(els);
    if (Number.isFinite(total)) return total;
  }
  if (Array.isArray(place.bbox) && place.bbox.length === 4) {
    const [s,n,w,e] = place.bbox;
    const els = await fetchOverpassQuery(buildMosqueCountBboxQuery(s,w,n,e), { retries:1, timeoutMs:26000, minInterval:320, backoffMs:700 });
    const total = parseOverpassCountTotal(els);
    if (Number.isFinite(total)) return total;
  }
  return null;
}

// Compute score stats from a Map of mosques
function computeStats(db) {
  const all = [...db.values()];
  const withData = all.filter(m => m.diff !== null);
  const correct  = withData.filter(m => m.diff <= tol);
  const wrong    = withData.filter(m => m.diff > tol);
  const unknown  = all.filter(m => m.diff === null);
  const pct = withData.length ? Math.round(correct.length / withData.length * 100) : null;
  const diffs = withData.map(m => m.diff);
  const avg = diffs.length ? diffs.reduce((a,b)=>a+b,0)/diffs.length : null;
  const max = diffs.length ? Math.max(...diffs) : null;
  const min = diffs.length ? Math.min(...diffs) : null;
  const sorted = [...diffs].sort((a,b)=>a-b);
  const median = sorted.length ? sorted[Math.floor(sorted.length/2)] : null;
  const perfect = withData.filter(m => m.diff < 5).length;
  const grade = pct===null?'â€”':pct>=85?'A':pct>=65?'B':pct>=45?'C':'D';
  return { all:all.length, withData:withData.length, correct:correct.length, wrong:wrong.length,
           unknown:unknown.length, pct, avg, max, min, median, perfect, grade };
}

function processElementsToCompareMap(elements, outMap) {
  outMap.clear();
  for (const el of elements || []) {
    let lat0 = null, lng0 = null, polyCoords = null;
    if (el.type === 'node') {
      lat0 = el.lat; lng0 = el.lon;
    } else if ((el.type === 'way' || el.type === 'relation') && Array.isArray(el.geometry) && el.geometry.length >= 2) {
      const pts = el.geometry;
      lat0 = pts.reduce((s,p)=>s+p.lat,0)/pts.length;
      lng0 = pts.reduce((s,p)=>s+p.lon,0)/pts.length;
      polyCoords = pts.map(p => [p.lat, p.lon]);
    } else if ((el.type === 'way' || el.type === 'relation') && el.center) {
      lat0 = el.center.lat; lng0 = el.center.lon;
    }
    if (!Number.isFinite(lat0) || !Number.isFinite(lng0)) continue;
    const qibla = qiblaAngle(lat0, lng0);
    let axis = null, diff = null, method = 'none';
    const tags = el.tags || {};
    const dt = tags.direction || tags['building:direction'];
    if (dt && !isNaN(+dt)) {
      axis = (+dt % 180 + 180) % 180;
      diff = angDiff180(qibla % 180, axis);
      method = 'osm-tag';
    } else if (polyCoords && polyCoords.length >= 4) {
      const res = buildingQiblaEdge(polyCoords, qibla);
      if (res) { axis = res.angle; diff = res.diff; method = 'edge-analysis'; }
    }
    outMap.set(`${el.type}:${el.id}`, {
      id: el.id,
      osmType: el.type,
      name: pickNameFromTags(tags) || buildTagsAddressFallbackName(tags, el.id),
      lat: lat0,
      lng: lng0,
      qibla, axis, diff, method,
      status: diff!==null ? (diff<=tol ? 'correct' : 'wrong') : 'unknown'
    });
  }
}

async function fetchCompareSide(side) {
  const input = document.getElementById(`cmp-${side}-input`);
  const levelEl = document.getElementById(`cmp-${side}-level`);
  const statusEl = document.getElementById(`cmp-${side}-status`);
  const nameEl = document.getElementById(`cmp-${side}-name`);
  const btn = document.getElementById(`cmp-${side}-fetch-btn`);
  const v = input?.value?.trim() || '';
  const level = levelEl?.value === 'district' ? 'district' : 'city';
  if (!v || !btn || !statusEl || !nameEl) return;

  const mapRef = side === 'a' ? compareDBA : compareDBB;
  btn.disabled = true;
  statusEl.textContent = 'Koordinatlar alÄ±nÄ±yor...';
  document.getElementById('cmp-progress-wrap').style.display = 'block';
  document.getElementById('cmp-progress-bar').style.width = '10%';
  document.getElementById('cmp-progress-label').textContent = `${side.toUpperCase()} Â· "${v}" aranÄ±yor...`;
  document.getElementById('cmp-results').style.display = 'none';

  try {
    const place = await geocodeComparePlace(v, level);
    comparePlaceMeta[side] = place;
    nameEl.textContent = place.label;

    document.getElementById('cmp-progress-bar').style.width = '35%';
    document.getElementById('cmp-progress-label').textContent = `${side.toUpperCase()} Â· Toplam cami sayÄ±sÄ± hesaplanÄ±yor...`;

    const totalPromise = fetchAreaMosqueTotal(place).catch(() => null);
    const r = level === 'district' ? 0.022 : 0.036;
    const elements = await fetchBbox(place.lat-r, place.lng-r, place.lat+r, place.lng+r, { retries:1, timeoutMs:22000, backoffMs:650, minInterval:320 });
    document.getElementById('cmp-progress-bar').style.width = '75%';
    document.getElementById('cmp-progress-label').textContent = `${side.toUpperCase()} Â· ${elements.length} kayÄ±t iÅŸleniyor...`;

    processElementsToCompareMap(elements, mapRef);
    compareAreaTotals[side] = await totalPromise;
    compareLoaded[side] = true;
    statusEl.textContent = `âœ“ ${compareLevelLabel(level)} yÃ¼klendi Â· analiz:${mapRef.size} Â· toplam:${compareAreaTotals[side] ?? 'â€”'}`;

    document.getElementById('cmp-progress-bar').style.width = '100%';
    await new Promise(r => setTimeout(r, 280));
    document.getElementById('cmp-progress-wrap').style.display = 'none';
    renderCompare();
  } catch (err) {
    document.getElementById('cmp-progress-wrap').style.display = 'none';
    statusEl.textContent = 'âŒ Hata: ' + err.message;
    toast('KarÅŸÄ±laÅŸtÄ±rma yÃ¼klenirken hata: ' + err.message, 5000);
  }
  btn.disabled = false;
}

function clearCompareSide(side) {
  const mapRef = side === 'a' ? compareDBA : compareDBB;
  mapRef.clear();
  compareAreaTotals[side] = null;
  comparePlaceMeta[side] = null;
  compareLoaded[side] = false;
  const nameEl = document.getElementById(`cmp-${side}-name`);
  const statusEl = document.getElementById(`cmp-${side}-status`);
  const input = document.getElementById(`cmp-${side}-input`);
  if (nameEl) nameEl.textContent = 'â€”';
  if (statusEl) statusEl.textContent = '';
  if (input) input.value = '';
  renderCompare();
}

function fillScoreBlock(ab, city, st) {
  document.getElementById(`cmp-${ab}-pct`).textContent  = st.pct!==null ? st.pct+'%' : 'â€”';
  document.getElementById(`cmp-${ab}-label`).textContent = city;
  const g = document.getElementById(`cmp-${ab}-grade`);
  g.textContent = st.grade==='â€”'?'':
    st.grade==='A'?'A â€” MÃ¼kemmel':st.grade==='B'?'B â€” Ä°yi':st.grade==='C'?'C â€” Orta':'D â€” ZayÄ±f';
  g.className = 'cmp-score-grade'+(st.grade!=='â€”'?' '+st.grade:'');
  drawSmallDonut(`cmp-${ab}-donut`, st, ab==='a'?'#60a5fa':'#f472b6');
}

function buildBarRow(m) {
  const div = document.createElement('div');
  div.className = 'cmp-bar-row';
  const aVal = m.a ?? 0, bVal = m.b ?? 0;
  const maxVal = Math.max(aVal, bVal, 1);
  const aPct = Math.round(aVal/maxVal*100), bPct = Math.round(bVal/maxVal*100);
  const aWin = m.higherBetter===null ? null : (m.higherBetter ? aVal>=bVal : aVal<=bVal);
  const aC = aWin===null?'#6b6b7a':aWin?'#60a5fa':'#60a5fa66';
  const bC = aWin===null?'#6b6b7a':!aWin?'#f472b6':'#f472b666';
  div.innerHTML = `
    <div class="cmp-bar-label">${m.label}</div>
    <div>
      <div style="font-size:9px;color:#6b6b7a;margin-bottom:3px">A: ${m.a!==null&&m.a!==undefined?m.a+(m.unit):'â€”'}</div>
      <div class="cmp-bar-outer"><div class="cmp-bar-inner" style="width:${aPct}%;background:${aC}">${aPct>20?m.a+(m.unit):''}</div></div>
    </div>
    <div>
      <div style="font-size:9px;color:#6b6b7a;margin-bottom:3px">B: ${m.b!==null&&m.b!==undefined?m.b+(m.unit):'â€”'}</div>
      <div class="cmp-bar-outer"><div class="cmp-bar-inner" style="width:${bPct}%;background:${bC}">${bPct>20?m.b+(m.unit):''}</div></div>
    </div>`;
  return div;
}

function drawSmallDonut(canvasId, st, color) {
  const canvas = document.getElementById(canvasId);
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,80,80);
  const cx=40, cy=40, r=34;
  if (!st.withData) {
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.strokeStyle='#2a2a3a'; ctx.lineWidth=10; ctx.stroke(); return;
  }
  const slices = [
    {val:st.correct, color:color},
    {val:st.wrong,   color:color+'44'},
    {val:st.unknown, color:'#2a2a3a'}
  ].filter(s=>s.val>0);
  let angle = -Math.PI/2;
  const total = st.all;
  for (const s of slices) {
    const sw = (s.val/total)*Math.PI*2;
    ctx.beginPath(); ctx.arc(cx,cy,r,angle,angle+sw);
    ctx.strokeStyle=s.color; ctx.lineWidth=10; ctx.lineCap='butt'; ctx.stroke();
    angle+=sw;
  }
}

function drawRadar(stA, stB) {
  const canvas = document.getElementById('cmp-radar');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,200,200);
  const cx=100, cy=100, r=72;
  // 5 axes: DoÄŸruluk, MÃ¼kemmel<5Â°, DÃ¼ÅŸÃ¼k Sapma, Veri KapsamÄ±, DÃ¼ÅŸÃ¼k Maks
  const axes = ['DoÄŸruluk','MÃ¼kemmel','DÃ¼ÅŸÃ¼k Ort.','Kapsam','DÃ¼ÅŸÃ¼k Maks'];
  const n = axes.length;

  function normalize(val, min, max) {
    if (val===null||val===undefined) return 0;
    return Math.max(0, Math.min(1, (val-min)/(max-min)));
  }

  const aScores = [
    normalize(stA.pct,0,100),
    normalize(stA.perfect,0,Math.max(stA.perfect,stB?.perfect??0,1)),
    normalize(stA.avg!==null?90-stA.avg:0,0,90),
    normalize(stA.withData,0,Math.max(stA.withData,stB?.withData??0,1)),
    normalize(stA.max!==null?90-stA.max:0,0,90),
  ];
  const bScores = stB ? [
    normalize(stB.pct,0,100),
    normalize(stB.perfect,0,Math.max(stA.perfect,stB.perfect,1)),
    normalize(stB.avg!==null?90-stB.avg:0,0,90),
    normalize(stB.withData,0,Math.max(stA.withData,stB.withData,1)),
    normalize(stB.max!==null?90-stB.max:0,0,90),
  ] : null;

  // Draw grid rings
  for (let ring=1; ring<=4; ring++) {
    ctx.beginPath();
    for (let i=0; i<n; i++) {
      const angle = (i/n)*Math.PI*2 - Math.PI/2;
      const x = cx + Math.cos(angle)*r*(ring/4);
      const y = cy + Math.sin(angle)*r*(ring/4);
      i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.strokeStyle = '#2a2a3a'; ctx.lineWidth=1; ctx.stroke();
  }

  // Draw axes
  for (let i=0; i<n; i++) {
    const angle = (i/n)*Math.PI*2 - Math.PI/2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.lineTo(cx+Math.cos(angle)*r, cy+Math.sin(angle)*r);
    ctx.strokeStyle='#2a2a3a'; ctx.lineWidth=1; ctx.stroke();
    // Labels
    const lx = cx+Math.cos(angle)*(r+14), ly = cy+Math.sin(angle)*(r+14);
    ctx.fillStyle='#6b6b7a'; ctx.font='9px DM Mono,monospace';
    ctx.textAlign='center'; ctx.textBaseline='middle';
    ctx.fillText(axes[i], lx, ly);
  }

  // Draw city B polygon first (under A)
  if (bScores) {
    ctx.beginPath();
    for (let i=0; i<n; i++) {
      const angle = (i/n)*Math.PI*2 - Math.PI/2;
      const x = cx + Math.cos(angle)*r*bScores[i];
      const y = cy + Math.sin(angle)*r*bScores[i];
      i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    ctx.closePath();
    ctx.fillStyle='rgba(244,114,182,.12)'; ctx.fill();
    ctx.strokeStyle='#f472b6'; ctx.lineWidth=2; ctx.stroke();
  }

  // Draw city A polygon
  ctx.beginPath();
  for (let i=0; i<n; i++) {
    const angle = (i/n)*Math.PI*2 - Math.PI/2;
    const x = cx + Math.cos(angle)*r*aScores[i];
    const y = cy + Math.sin(angle)*r*aScores[i];
    i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  }
  ctx.closePath();
  ctx.fillStyle='rgba(96,165,250,.12)'; ctx.fill();
  ctx.strokeStyle='#60a5fa'; ctx.lineWidth=2; ctx.stroke();

  // Dots
  [aScores, bScores].forEach((scores, si) => {
    if (!scores) return;
    const col = si===0?'#60a5fa':'#f472b6';
    scores.forEach((v,i) => {
      const angle = (i/n)*Math.PI*2 - Math.PI/2;
      ctx.beginPath();
      ctx.arc(cx+Math.cos(angle)*r*v, cy+Math.sin(angle)*r*v, 3, 0, Math.PI*2);
      ctx.fillStyle=col; ctx.fill();
    });
  });
}

// Re-render comparison when tolerance changes or new data comes
// (called from recompute when modal is open)

function renderCompare() {
  if (!compareLoaded.a && !compareLoaded.b) {
    document.getElementById('cmp-results').style.display = 'none';
    return;
  }
  const stA = compareLoaded.a ? computeStats(compareDBA) : computeStats(new Map());
  const stB = compareLoaded.b ? computeStats(compareDBB) : null;
  const nameA = comparePlaceMeta.a?.label || 'A';
  const nameB = comparePlaceMeta.b?.label || 'B';

  document.getElementById('cmp-results').style.display = 'flex';
  document.getElementById('cmp-tol').textContent = tol + 'Â°';
  document.getElementById('cmp-a-name').textContent = compareLoaded.a ? nameA : 'â€”';
  document.getElementById('cmp-b-name').textContent = compareLoaded.b ? nameB : 'â€”';

  // â”€â”€ Score blocks
  fillScoreBlock('a', compareLoaded.a ? nameA : 'â€”', stA);
  fillScoreBlock('b', compareLoaded.b ? nameB : 'â€”', stB || computeStats(new Map()));

  // â”€â”€ Winner badge
  const badge = document.getElementById('cmp-winner-badge');
  if (stB && stA.pct !== null && stB.pct !== null) {
    const diff = stA.pct - stB.pct;
    if (Math.abs(diff) <= 2)     { badge.textContent = 'ğŸ¤ Beraberlik';    badge.className = 'cmp-winner-badge tie'; }
    else if (diff > 0)           { badge.textContent = `ğŸ† ${nameA} Ã¶nde`; badge.className = 'cmp-winner-badge a'; }
    else                         { badge.textContent = `ğŸ† ${nameB} Ã¶nde`; badge.className = 'cmp-winner-badge b'; }
  } else {
    badge.textContent = compareLoaded.a && !compareLoaded.b ? 'B bekleniyor â†’' : (!compareLoaded.a && compareLoaded.b ? 'A bekleniyor â†’' : '');
    badge.className = 'cmp-winner-badge tie';
  }

  // â”€â”€ Radar chart
  drawRadar(stA, stB);

  // â”€â”€ Bar metrics
  const barsEl = document.getElementById('cmp-bars');
  barsEl.innerHTML = '';
  const metrics = [
    { label:'DoÄŸruluk %',   a:stA.pct,     b:stB?.pct,     unit:'%', higherBetter:true  },
    { label:'Ort. Sapma',   a:stA.avg!==null?+stA.avg.toFixed(1):null, b:stB?.avg!==null?+stB.avg.toFixed(1):null, unit:'Â°', higherBetter:false },
    { label:'Maks. Sapma',  a:stA.max!==null?+stA.max.toFixed(1):null, b:stB?.max!==null?+stB.max.toFixed(1):null, unit:'Â°', higherBetter:false },
    { label:'MÃ¼kemmel <5Â°', a:stA.perfect,  b:stB?.perfect, unit:'', higherBetter:true  },
    { label:'Analiz Cami',  a:stA.all,      b:stB?.all,     unit:'', higherBetter:null  },
    { label:'Toplam Cami (OSM Alan)', a:compareAreaTotals.a, b:compareAreaTotals.b, unit:'', higherBetter:null  },
  ];
  metrics.forEach(m => barsEl.appendChild(buildBarRow(m)));

  // â”€â”€ Detail table
  const tbl = document.getElementById('cmp-table');
  const fmtPct = v => v!==null&&v!==undefined ? v+'%' : 'â€”';
  const fmtDeg = v => v!==null&&v!==undefined ? v.toFixed(1)+'Â°' : 'â€”';
  const rows = [
    ['BÃ¶lge',          compareLoaded.a ? nameA : 'â€”',              compareLoaded.b ? nameB : 'â€”'],
    ['BÃ¶lge Tipi',     comparePlaceMeta.a?.level === 'district' ? 'Ä°lÃ§e' : (compareLoaded.a ? 'Åehir' : 'â€”'), comparePlaceMeta.b?.level === 'district' ? 'Ä°lÃ§e' : (compareLoaded.b ? 'Åehir' : 'â€”')],
    ['Toplam Cami (OSM Alan)', compareAreaTotals.a ?? 'â€”', compareAreaTotals.b ?? 'â€”'],
    ['Analiz Cami',    stA.all,                  stB?.all    ?? 'â€”'],
    ['Veri Olan',      stA.withData,             stB?.withData ?? 'â€”'],
    ['DoÄŸru YÃ¶n',      stA.correct,              stB?.correct  ?? 'â€”'],
    ['Sapma Var',      stA.wrong,                stB?.wrong    ?? 'â€”'],
    ['Veri Yok',       stA.unknown,              stB?.unknown  ?? 'â€”'],
    ['DoÄŸruluk',       fmtPct(stA.pct),          fmtPct(stB?.pct)],
    ['Not',            stA.grade,                stB?.grade    ?? 'â€”'],
    ['Ort. Sapma',     fmtDeg(stA.avg),          fmtDeg(stB?.avg)],
    ['Medyan Sapma',   fmtDeg(stA.median),       fmtDeg(stB?.median)],
    ['Min. Sapma',     fmtDeg(stA.min),          fmtDeg(stB?.min)],
    ['Maks. Sapma',    fmtDeg(stA.max),          fmtDeg(stB?.max)],
    ['MÃ¼kemmel (<5Â°)', stA.perfect,              stB?.perfect  ?? 'â€”'],
  ];

  // Highlight winner in each numeric row
  const numericRows = new Set(['Toplam Cami','Veri Olan','DoÄŸru YÃ¶n','MÃ¼kemmel (<5Â°)']);
  const lowerBetterRows = new Set(['Ort. Sapma','Medyan Sapma','Min. Sapma','Maks. Sapma','Sapma Var']);

  tbl.innerHTML = `<table class="cmp-tbl">
    <thead>
      <tr>
        <th>Metrik</th>
        <th style="color:#60a5fa">A: ${escHtml(compareLoaded.a ? nameA : 'â€”')}</th>
        <th style="color:#f472b6">B: ${escHtml(compareLoaded.b ? nameB : 'â€”')}</th>
      </tr>
    </thead>
    <tbody>
      ${rows.map(([label, va, vb]) => {
        let aStyle = 'color:#e8e4d8', bStyle = 'color:#e8e4d8';
        if (stB) {
          const aNum = parseFloat(va), bNum = parseFloat(vb);
          if (!isNaN(aNum) && !isNaN(bNum) && aNum !== bNum) {
            const aWins = lowerBetterRows.has(label) ? aNum < bNum : aNum > bNum;
            if (aWins) { aStyle='color:#60a5fa;font-weight:700'; bStyle='color:#6b6b7a'; }
            else       { bStyle='color:#f472b6;font-weight:700'; aStyle='color:#6b6b7a'; }
          }
        }
        return `<tr>
          <td style="color:#6b6b7a">${escHtml(label)}</td>
          <td style="${aStyle}">${escHtml(va)}</td>
          <td style="${bStyle}">${escHtml(vb)}</td>
        </tr>`;
      }).join('')}
    </tbody>
  </table>`;
}
</script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HISTORICAL ANALYSIS (AdÄ±m 4)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Period definitions
const PERIODS = {
  ottoman: { label:'OsmanlÄ±',      range:[0,    1922], color:'#a78bfa', cls:'ottoman' },
  early:   { label:'Erken Cum.',   range:[1923, 1950], color:'#fbbf24', cls:'early'   },
  mid:     { label:'Orta DÃ¶nem',   range:[1951, 2000], color:'#60a5fa', cls:'mid'     },
  modern:  { label:'Modern',       range:[2001, 9999], color:'#4ade80', cls:'modern'  },
  unknown: { label:'Bilinmiyor',   range:null,         color:'#9ca3af', cls:'unknown' },
};

let historyModeActive = false;
let histPeriodFilter = 'all';

// Parse OSM date tags to year (handles "1453", "1453-04", "1890s", "ca.1800" etc.)
function parseYear(tag) {
  if (!tag) return null;
  const clean = String(tag).replace(/[caCa. ]/g,'');
  // try full match
  const m = clean.match(/(\d{4})/);
  if (m) {
    const y = parseInt(m[1]);
    return (y > 600 && y <= 2030) ? y : null;
  }
  return null;
}

function classifyPeriod(year) {
  if (year === null) return 'unknown';
  if (year <= 1922) return 'ottoman';
  if (year <= 1950) return 'early';
  if (year <= 2000) return 'mid';
  return 'modern';
}

function getPeriodColor(period) {
  return PERIODS[period]?.color ?? '#6b6b7a';
}

// Enrich each mosque in DB with period info
function enrichWithPeriod() {
  mosqueDB.forEach(m => {
    if (m.period !== undefined) return; // already done
    const year = parseYear(m.startDate);
    m.year = year;
    m.period = classifyPeriod(year);
  });
}

function toggleHistoryMode() {
  historyModeActive = !historyModeActive;
  const btn = document.getElementById('btn-history');
  btn.classList.toggle('active', historyModeActive);

  if (historyModeActive) {
    document.getElementById('hist-overlay').classList.add('show');
    enrichWithPeriod();
    renderHistoryModal();
    // Switch map colors to period mode
    applyPeriodColors();
  } else {
    closeHistoryMode();
  }
}

function closeHistoryMode() {
  historyModeActive = false;
  document.getElementById('hist-overlay').classList.remove('show');
  document.getElementById('btn-history').classList.remove('active');
  histPeriodFilter = 'all';
  // Restore normal colors
  renderAll();
}

function histOverlayClick(e) {
  if (e.target === document.getElementById('hist-overlay')) closeHistoryMode();
}

// Re-color map markers by period instead of correct/wrong
function applyPeriodColors() {
  enrichWithPeriod();
  // Re-render with period colors override
  renderLayers.forEach(l => { try{map.removeLayer(l);}catch{} });
  renderLayers = [];

  const bounds = map.getBounds().pad(0.1);
  const visible = [...mosqueDB.values()].filter(m => bounds.contains([m.lat, m.lng]));

  for (const m of visible) {
    const col = getPeriodColor(m.period);
    const dimmed = histPeriodFilter !== 'all' && m.period !== histPeriodFilter;
    const opacity = dimmed ? 0.12 : 0.95;

    if (m.polyCoords) {
      const poly = L.polygon(m.polyCoords, {
        color:col, weight:1.5, fillColor:col, fillOpacity:dimmed?0.02:0.08, opacity:dimmed?0.15:0.45
      }).addTo(map);
      poly.on('click', () => handleMosqueClick(m));
      renderLayers.push(poly);
    }

    const qEnd = destination(m.lat, m.lng, m.qibla, 200);
    renderLayers.push(L.polyline([[m.lat,m.lng],[qEnd.lat,qEnd.lng]], {
      color:'#c9a84c', weight:1.5, opacity:dimmed?0.08:0.5, dashArray:'6 5'
    }).addTo(map));

    if (m.axis !== null && !dimmed) {
      const fd = closestDirection(m.axis, m.qibla);
      const e1 = destination(m.lat, m.lng, fd, 90);
      const e2 = destination(m.lat, m.lng, (fd+180)%360, 90);
      renderLayers.push(L.polyline([[e2.lat,e2.lng],[e1.lat,e1.lng]], {
        color:col, weight:2.5, opacity:0.9
      }).addTo(map));
    }

    const mk = L.circleMarker([m.lat,m.lng], {
      radius:5, fillColor:col, color:'#0a0a0f', weight:1.5, fillOpacity:opacity
    }).addTo(map);
    mk.mosque = m;
    mk.bindPopup(makeHistoryPopup(m));
    mk.on('click', () => handleMosqueClick(m));
    renderLayers.push(mk);
  }
}

function makeHistoryPopup(m) {
  const col = getPeriodColor(m.period);
  const period = PERIODS[m.period];
  const yearStr = m.year ? m.year + ' yÄ±lÄ±' : 'Tarih bilinmiyor';
  const statusStr = m.status==='correct'?'âœ… DoÄŸru':m.status==='wrong'?'âŒ Sapma':'âš ï¸ Veri yok';
  return `<div class="p-name">${escHtml(m.name)}</div>
    <div class="p-row"><span class="p-k">DÃ¶nem</span><span style="color:${col};font-weight:700">${period.label}</span></div>
    <div class="p-row"><span class="p-k">Ä°nÅŸaat</span><span class="p-v">${yearStr}</span></div>
    <div class="p-row"><span class="p-k">Durum</span><span class="p-v">${statusStr}</span></div>
    <div class="p-row"><span class="p-k">KÄ±ble</span><span class="p-v">${m.qibla.toFixed(1)}Â°</span></div>
    ${m.diff!==null?`<div class="p-row"><span class="p-k">Sapma</span><span class="p-v">${m.diff.toFixed(1)}Â°</span></div>`:''}
    <button class="p-anim-btn" onclick="animateFromPopup(${m.id})">ğŸŒ BÃ¼yÃ¼k Daire Animasyonu</button>`;
}

// Compute per-period stats
function computePeriodStats() {
  const stats = {};
  for (const key of Object.keys(PERIODS)) {
    stats[key] = { count:0, withData:0, correct:0, wrong:0, diffs:[], years:[] };
  }
  mosqueDB.forEach(m => {
    const s = stats[m.period];
    s.count++;
    if (m.diff !== null) {
      s.withData++;
      if (m.status === 'correct') s.correct++;
      else s.wrong++;
      s.diffs.push(m.diff);
    }
    if (m.year) s.years.push(m.year);
  });
  // Compute derived
  for (const key of Object.keys(stats)) {
    const s = stats[key];
    s.pct = s.withData ? Math.round(s.correct / s.withData * 100) : null;
    s.avg = s.diffs.length ? s.diffs.reduce((a,b)=>a+b,0)/s.diffs.length : null;
    s.max = s.diffs.length ? Math.max(...s.diffs) : null;
    const sorted = [...s.diffs].sort((a,b)=>a-b);
    s.median = sorted.length ? sorted[Math.floor(sorted.length/2)] : null;
    s.yearMin = s.years.length ? Math.min(...s.years) : null;
    s.yearMax = s.years.length ? Math.max(...s.years) : null;
  }
  return stats;
}

function renderHistoryModal() {
  enrichWithPeriod();
  const stats = computePeriodStats();
  histPeriodFilter = histPeriodFilter || 'all';
  updateHistChips();
  renderHistCards(stats);
  drawHistBarChart(stats);
  drawHistScatter();
  renderHistTable(stats);
  renderHistList();
}

function updateHistChips() {
  document.querySelectorAll('.hist-chip').forEach(c => {
    c.classList.toggle('active', c.dataset.period === histPeriodFilter);
  });
}

function filterPeriod(period) {
  histPeriodFilter = period;
  updateHistChips();
  renderHistList();
  if (historyModeActive) applyPeriodColors();
  // Highlight selected card
  document.querySelectorAll('.hist-card').forEach(c => {
    c.style.transform = c.dataset.period === period || period === 'all' ? '' : 'scale(.97)';
    c.style.opacity = c.dataset.period === period || period === 'all' ? '1' : '.45';
  });
}

function renderHistCards(stats) {
  const el = document.getElementById('hist-cards');
  const order = ['ottoman','early','mid','modern','unknown'];
  el.innerHTML = order.map(key => {
    const s = stats[key];
    const p = PERIODS[key];
    const pctStr = s.pct !== null ? s.pct + '%' : 'â€”';
    const avgStr = s.avg !== null ? s.avg.toFixed(1) + 'Â° ort.' : 'veri yok';
    return `<div class="hist-card ${key}" data-period="${key}" onclick="filterPeriod('${key}')" style="cursor:pointer">
      <div class="hist-card-period">${p.label}</div>
      <div class="hist-card-count">${s.count}</div>
      <div class="hist-card-pct">${pctStr} doÄŸru</div>
      <div class="hist-card-avg">${avgStr}</div>
    </div>`;
  }).join('');
}

function drawHistBarChart(stats) {
  const canvas = document.getElementById('hist-chart');
  canvas.width = canvas.offsetWidth || 800;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const order = ['ottoman','early','mid','modern'];
  const W = canvas.width, H = canvas.height;
  const pad = {l:50, r:20, t:16, b:36};
  const chartW = W - pad.l - pad.r;
  const chartH = H - pad.t - pad.b;
  const barW = Math.floor(chartW / order.length * 0.55);
  const gap = Math.floor(chartW / order.length);

  // Grid lines
  for (let pct = 0; pct <= 100; pct += 25) {
    const y = pad.t + chartH - (pct/100)*chartH;
    ctx.strokeStyle = '#1e1e2e'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(pad.l, y); ctx.lineTo(W-pad.r, y); ctx.stroke();
    ctx.fillStyle = '#6b6b7a'; ctx.font = '9px DM Mono,monospace';
    ctx.textAlign = 'right';
    ctx.fillText(pct+'%', pad.l-6, y+3);
  }

  order.forEach((key, i) => {
    const s = stats[key];
    const p = PERIODS[key];
    const x = pad.l + i*gap + (gap - barW)/2;
    const pct = s.pct ?? 0;
    const barH = (pct/100) * chartH;
    const y = pad.t + chartH - barH;

    // Bar background
    ctx.fillStyle = '#1a1a26';
    ctx.fillRect(x, pad.t, barW, chartH);

    // Bar fill with gradient
    const grad = ctx.createLinearGradient(x, y, x, pad.t+chartH);
    grad.addColorStop(0, p.color);
    grad.addColorStop(1, p.color+'55');
    ctx.fillStyle = grad;
    ctx.fillRect(x, y, barW, barH);

    // Average deviation overlay (secondary bar, red scale)
    if (s.avg !== null) {
      const avgNorm = Math.min(s.avg / 45, 1);
      const avgBarH = avgNorm * chartH;
      ctx.fillStyle = 'rgba(248,113,113,0.25)';
      ctx.fillRect(x + barW + 3, pad.t + chartH - avgBarH, 5, avgBarH);
    }

    // Label
    ctx.fillStyle = '#e8e4d8'; ctx.font = 'bold 11px DM Mono,monospace';
    ctx.textAlign = 'center';
    if (pct > 0) ctx.fillText(pct+'%', x + barW/2, y - 5);

    // Period name
    ctx.fillStyle = p.color; ctx.font = '9px DM Mono,monospace';
    ctx.fillText(p.label, x + barW/2, H - 6);

    // Count
    ctx.fillStyle = '#6b6b7a'; ctx.font = '8px DM Mono,monospace';
    ctx.fillText('n='+s.count, x + barW/2, H - 18);
  });

  // Legend: red bar = avg deviation
  ctx.fillStyle = 'rgba(248,113,113,0.5)';
  ctx.fillRect(pad.l, pad.t + 2, 8, 8);
  ctx.fillStyle = '#6b6b7a'; ctx.font = '8px DM Mono,monospace'; ctx.textAlign = 'left';
  ctx.fillText('â–  ort. sapma (yardÄ±mcÄ±)', pad.l + 12, pad.t + 10);
}

function drawHistScatter() {
  const canvas = document.getElementById('hist-scatter');
  canvas.width = canvas.offsetWidth || 800;
  const ctx = canvas.getContext('2d');
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Collect points: {year, diff, period}
  const points = [];
  mosqueDB.forEach(m => {
    if (m.year && m.diff !== null) points.push({year:m.year, diff:m.diff, period:m.period});
  });
  if (!points.length) {
    ctx.fillStyle = '#6b6b7a'; ctx.font = '11px DM Mono,monospace'; ctx.textAlign = 'center';
    ctx.fillText('Tarih + sapma verisi olan cami bulunamadÄ±', canvas.width/2, canvas.height/2);
    return;
  }

  const W = canvas.width, H = canvas.height;
  const pad = {l:44, r:16, t:12, b:30};
  const chartW = W-pad.l-pad.r, chartH = H-pad.t-pad.b;

  const years = points.map(p=>p.year);
  const minY = Math.min(...years), maxY = Math.max(...years, minY+1);
  const maxDiff = Math.max(...points.map(p=>p.diff), 1);

  // Grid
  for (let d=0; d<=45; d+=15) {
    const y = pad.t + chartH - (d/maxDiff)*chartH;
    ctx.strokeStyle='#1e1e2e'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(W-pad.r,y); ctx.stroke();
    ctx.fillStyle='#6b6b7a'; ctx.font='8px DM Mono,monospace'; ctx.textAlign='right';
    ctx.fillText(d+'Â°', pad.l-4, y+3);
  }

  // Tolerance line
  const tolY = pad.t + chartH - (tol/maxDiff)*chartH;
  ctx.strokeStyle='rgba(201,168,76,.35)'; ctx.lineWidth=1; ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.moveTo(pad.l,tolY); ctx.lineTo(W-pad.r,tolY); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle='rgba(201,168,76,.5)'; ctx.font='8px DM Mono,monospace'; ctx.textAlign='left';
  ctx.fillText('tolerans '+tol+'Â°', pad.l+4, tolY-3);

  // X axis years
  const yearStep = Math.ceil((maxY-minY)/5 / 50)*50 || 50;
  for (let y=Math.ceil(minY/yearStep)*yearStep; y<=maxY; y+=yearStep) {
    const x = pad.l + ((y-minY)/(maxY-minY))*chartW;
    ctx.fillStyle='#6b6b7a'; ctx.font='8px DM Mono,monospace'; ctx.textAlign='center';
    ctx.fillText(y, x, H-6);
  }

  // Points
  for (const pt of points) {
    const x = pad.l + ((pt.year-minY)/Math.max(maxY-minY,1))*chartW;
    const y = pad.t + chartH - (pt.diff/maxDiff)*chartH;
    const col = getPeriodColor(pt.period);
    ctx.beginPath(); ctx.arc(x, y, 3.5, 0, Math.PI*2);
    ctx.fillStyle = col+'cc'; ctx.fill();
    ctx.strokeStyle = col; ctx.lineWidth = 0.8; ctx.stroke();
  }

  // Trend line (linear regression)
  if (points.length > 3) {
    const n = points.length;
    const sx = points.reduce((a,p)=>a+p.year,0);
    const sy = points.reduce((a,p)=>a+p.diff,0);
    const sxy = points.reduce((a,p)=>a+p.year*p.diff,0);
    const sxx = points.reduce((a,p)=>a+p.year*p.year,0);
    const slope = (n*sxy - sx*sy) / (n*sxx - sx*sx);
    const intercept = (sy - slope*sx) / n;
    const x1=pad.l, y1=pad.t+chartH-(((slope*minY+intercept)/maxDiff)*chartH);
    const x2=W-pad.r, y2=pad.t+chartH-(((slope*maxY+intercept)/maxDiff)*chartH);
    ctx.strokeStyle='rgba(255,255,255,.2)'; ctx.lineWidth=1.5; ctx.setLineDash([3,5]);
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    ctx.setLineDash([]);
    // Trend direction label
    const trendDir = slope > 0.01 ? 'â†‘ Sapma artÄ±yor' : slope < -0.01 ? 'â†“ Sapma azalÄ±yor' : 'â†’ Sabit';
    ctx.fillStyle='rgba(255,255,255,.3)'; ctx.font='9px DM Mono,monospace'; ctx.textAlign='right';
    ctx.fillText(trendDir, W-pad.r-4, pad.t+10);
  }
}

function renderHistTable(stats) {
  const el = document.getElementById('hist-table');
  const order = ['ottoman','early','mid','modern','unknown'];
  el.innerHTML = `<table class="hist-tbl">
    <thead><tr>
      <th>DÃ¶nem</th><th>Tarih AralÄ±ÄŸÄ±</th><th>Cami</th>
      <th>DoÄŸruluk</th><th>Ort. Sapma</th><th>Med. Sapma</th><th>Maks.</th>
    </tr></thead>
    <tbody>${order.map(key => {
      const s = stats[key]; const p = PERIODS[key];
      const range = key==='unknown' ? 'â€”' :
        (s.yearMin && s.yearMax ? s.yearMin+(s.yearMin!==s.yearMax?'â€“'+s.yearMax:'') : p.range?p.range[0]+'â€“'+(p.range[1]===9999?'bugÃ¼n':p.range[1]):'â€”');
      return `<tr>
        <td><span class="hist-period-badge ${key}">${p.label}</span></td>
        <td style="color:#6b6b7a">${range}</td>
        <td>${s.count}</td>
        <td style="color:${p.color};font-weight:700">${s.pct!==null?s.pct+'%':'â€”'}</td>
        <td>${s.avg!==null?s.avg.toFixed(1)+'Â°':'â€”'}</td>
        <td>${s.median!==null?s.median.toFixed(1)+'Â°':'â€”'}</td>
        <td style="color:#f87171">${s.max!==null?s.max.toFixed(1)+'Â°':'â€”'}</td>
      </tr>`;
    }).join('')}</tbody>
  </table>`;
}

function renderHistList() {
  const el = document.getElementById('hist-list');
  const label = document.getElementById('hist-list-label');
  const period = histPeriodFilter;

  let items = [...mosqueDB.values()];
  if (period !== 'all') items = items.filter(m => m.period === period);

  // Sort by diff descending (worst first), then unknown, then no year
  items.sort((a,b) => {
    if (a.diff===null && b.diff!==null) return 1;
    if (a.diff!==null && b.diff===null) return -1;
    if (a.diff===null && b.diff===null) return 0;
    return b.diff - a.diff;
  });

  const periodLabel = period === 'all' ? 'tÃ¼m dÃ¶nemler' : PERIODS[period].label;
  label.textContent = `${periodLabel} â€” ${items.length} cami (en kÃ¶tÃ¼den iyiye)`;

  if (!items.length) {
    el.innerHTML = '<div style="color:#6b6b7a;font-size:11px;padding:12px">Bu dÃ¶nemde cami bulunamadÄ±</div>';
    return;
  }

  el.innerHTML = items.slice(0, 80).map(m => {
    const col = m.status==='correct'?'#4ade80':m.status==='wrong'?'#f87171':'#fbbf24';
    const pCol = getPeriodColor(m.period);
    const yearStr = m.year ? m.year : '?';
    return `<div class="hist-list-item" onclick="focusAndAnimate(${m.lat},${m.lng},'${m.id}')">
      <div class="hist-list-dot" style="background:${pCol}"></div>
      <div class="hist-list-name">${escHtml(m.name)}</div>
      <div class="hist-list-year" style="color:${pCol}">${yearStr}</div>
      <div class="hist-list-diff" style="color:${col}">${m.diff!==null?m.diff.toFixed(1)+'Â°':'â€”'}</div>
    </div>`;
  }).join('');
}

function focusAndAnimate(lat, lng, id) {
  const m = mosqueDB.get(id) || [...mosqueDB.values()].find(x=>String(x.id)===String(id));
  if (!m) return;
  map.setView([lat, lng], 17, {animate:true});
  handleMosqueClick(m);
}

// History mode is integrated directly into renderAll() and recompute()
// via typeof historyModeActive checks above.

// Canvas resize: redraw charts when modal becomes visible
document.getElementById('hist-modal').addEventListener('click', () => {
  // noop â€” charts draw on open
});
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT & HASH ROUTING (AdÄ±m 8)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Hash routing: #cityname/lat/lng/zoom
// Format: #istanbul/41.015/28.979/14  (URL-encoded city name)

let _hashUpdating = false; // prevent feedback loop

function buildShareUrl() {
  if (!map) return location.href;
  const c = map.getCenter();
  const z = map.getZoom();
  const city = encodeURIComponent(currentCity || '');
  const hash = `${city}/${c.lat.toFixed(4)}/${c.lng.toFixed(4)}/${z}`;
  return `${location.origin}${location.pathname}#${hash}`;
}

function updateHashFromMap() {
  if (!map || _hashUpdating) return;
  const c = map.getCenter();
  const z = map.getZoom();
  const city = encodeURIComponent(currentCity || '');
  const hash = `${city}/${c.lat.toFixed(4)}/${c.lng.toFixed(4)}/${z}`;
  history.replaceState(null, '', `#${hash}`);
}

function parseHash() {
  const hash = location.hash.slice(1);
  if (!hash) return null;
  const parts = hash.split('/');
  if (parts.length < 4) return null;
  try {
    return {
      city: decodeURIComponent(parts[0]),
      lat:  parseFloat(parts[1]),
      lng:  parseFloat(parts[2]),
      zoom: parseInt(parts[3])
    };
  } catch { return null; }
}

// â”€â”€ Export modal
function openExport() {
  document.getElementById('exp-overlay').classList.add('show');
  document.getElementById('btn-export').classList.add('active');
  // Fill share URL
  document.getElementById('exp-url-input').value = buildShareUrl();
  // Fill summary
  renderExportSummary();
}

function closeExport() {
  document.getElementById('exp-overlay').classList.remove('show');
  document.getElementById('btn-export').classList.remove('active');
}

function expOverlayClick(e) {
  if (e.target === document.getElementById('exp-overlay')) closeExport();
}

// â”€â”€ Business / monetization modal (no-auth flows)
function openBiz() {
  document.getElementById('biz-overlay').classList.add('show');
  document.getElementById('btn-biz').classList.add('active');
}

function closeBiz() {
  document.getElementById('biz-overlay').classList.remove('show');
  document.getElementById('btn-biz').classList.remove('active');
}

function bizOverlayClick(e) {
  if (e.target === document.getElementById('biz-overlay')) closeBiz();
}

function openLab() {
  document.getElementById('lab-overlay').classList.add('show');
  document.getElementById('btn-lab').classList.add('active');
  renderLab();
}
function closeLab() {
  document.getElementById('lab-overlay').classList.remove('show');
  document.getElementById('btn-lab').classList.remove('active');
}
function labOverlayClick(e) {
  if (e.target === document.getElementById('lab-overlay')) closeLab();
}

function generateInsights() {
  const all = [...mosqueDB.values()];
  if (!all.length) return [];
  const withData = all.filter(m => m.diff != null);
  const avg = withData.length ? (withData.reduce((s,m)=>s+m.diff,0)/withData.length) : null;
  const low = all.filter(m => (m.confidence || 0) < 55).length;
  const converted = all.filter(m => m.convertedFrom?.converted).length;
  const unnamed = all.filter(m => isPlaceholderMosqueName(m.name)).length;
  const manualPending = all.filter(m => getManualAxisRecord(m)?.moderation?.status === 'pending').length;
  return [
    ['Toplam cami', all.length],
    ['Veri kapsama', withData.length ? `${Math.round(withData.length/all.length*100)}%` : '0%'],
    ['Ort. sapma', avg != null ? `${avg.toFixed(1)}Â°` : 'â€”'],
    ['DÃ¼ÅŸÃ¼k gÃ¼ven', low],
    ['DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ olasÄ±', converted],
    ['Ä°simsiz', unnamed],
    ['Manuel beklemede', manualPending]
  ];
}

function renderLab() {
  const insights = generateInsights();
  const iEl = document.getElementById('lab-insights');
  iEl.innerHTML = insights.map(([k,v]) => `<div class="lab-row"><span class="lab-k">${escHtml(k)}</span><span class="lab-v">${escHtml(v)}</span></div>`).join('');

  const queue = [...mosqueDB.values()]
    .filter(m => (m.confidence || 0) < 55 || isPlaceholderMosqueName(m.name) || m.convertedFrom?.converted || getManualAxisRecord(m)?.moderation?.status === 'pending')
    .sort((a,b) => (a.confidence || 0) - (b.confidence || 0))
    .slice(0, 20);
  const qEl = document.getElementById('lab-queue');
  if (!queue.length) qEl.innerHTML = '<div class="lab-row"><span class="lab-k">Kuyruk boÅŸ</span><span class="lab-v">âœ“</span></div>';
  else qEl.innerHTML = queue.map(m => `<div class="lab-row"><span class="lab-k">${escHtml(m.name)}</span><span class="lab-v">${m.confidence || 0}/100</span></div>`).join('');

  const sEl = document.getElementById('lab-snapshots');
  const recent = snapshots.slice().reverse().slice(0, 12);
  if (!recent.length) sEl.innerHTML = '<div class="lab-row"><span class="lab-k">GeÃ§miÅŸ yok</span><span class="lab-v">â€”</span></div>';
  else sEl.innerHTML = recent.map(s => `<div class="lab-row"><span class="lab-k">${escHtml(s.city)} Â· ${new Date(s.ts).toLocaleDateString('tr-TR')}</span><span class="lab-v">${s.pct ?? 'â€”'}%</span></div>`).join('');
}

function bizSendLead() {
  const name = document.getElementById('biz-name').value.trim();
  const company = document.getElementById('biz-company').value.trim();
  const email = document.getElementById('biz-email').value.trim();
  const msg = document.getElementById('biz-msg').value.trim();
  const subject = encodeURIComponent('KÄ±ble DedektÃ¶rÃ¼ B2B / White-Label Talebi');
  const body = encodeURIComponent(
    `Ad Soyad: ${name || '-'}\n` +
    `Kurum: ${company || '-'}\n` +
    `E-posta: ${email || '-'}\n` +
    `\nÄ°htiyaÃ§:\n${msg || '-'}\n` +
    `\nNot: Talep web formundan oluÅŸturuldu.`
  );
  location.href = `mailto:sales@qibla-checker.app?subject=${subject}&body=${body}`;
}

function renderExportSummary() {
  const all = [...mosqueDB.values()];
  const withData = all.filter(m => m.diff !== null);
  const correct  = withData.filter(m => m.diff <= tol);
  const pct = withData.length ? Math.round(correct.length/withData.length*100) : null;

  document.getElementById('exp-summary').innerHTML = `
    <div class="exp-sum-card">
      <div class="exp-sum-val">${all.length}</div>
      <div class="exp-sum-lbl">Toplam Cami</div>
    </div>
    <div class="exp-sum-card">
      <div class="exp-sum-val" style="color:${pct!==null?(pct>=70?'#4ade80':pct>=40?'#fbbf24':'#f87171'):'#6b6b7a'}">${pct!==null?pct+'%':'â€”'}</div>
      <div class="exp-sum-lbl">DoÄŸruluk</div>
    </div>
    <div class="exp-sum-card">
      <div class="exp-sum-val">${currentCity||'â€”'}</div>
      <div class="exp-sum-lbl">Åehir</div>
    </div>
  `;
}

function copyShareUrl() {
  const url = buildShareUrl();
  navigator.clipboard?.writeText(url).then(() => {
    const btn = document.getElementById('exp-copy-url');
    btn.textContent = 'âœ“ KopyalandÄ±';
    btn.classList.add('copied');
    setTimeout(() => { btn.textContent = 'Kopyala'; btn.classList.remove('copied'); }, 2200);
  }).catch(() => {
    // Fallback: select the input
    document.getElementById('exp-url-input').select();
    document.execCommand('copy');
  });
}

// â”€â”€ JSON export
function exportJSON() {
  const data = {
    meta: {
      city: currentCity,
      exportDate: new Date().toISOString(),
      tolerance: tol,
      source: 'OpenStreetMap',
      total: mosqueDB.size
    },
    mosques: [...mosqueDB.values()].map(m => ({
      id: m.id,
      osmType: m.osmType||'way',
      name: m.name,
      lat: m.lat,
      lng: m.lng,
      qiblaAngle: m.qibla,
      buildingAxis: m.axis,
      deviation: m.diff,
      status: m.status,
      method: m.method,
      constructionYear: m.year||null,
      period: m.period||null,
      tags: m.tags||{}
    }))
  };

  download(
    JSON.stringify(data, null, 2),
    `qibla-${slugify(currentCity)}-${dateStr()}.json`,
    'application/json'
  );
  toast('âœ“ JSON indirildi', 3000);
}

// â”€â”€ CSV export
function exportCSV() {
  const headers = ['id','name','lat','lng','qibla_angle','building_axis','deviation_deg',
                   'status','method','construction_year','period'];
  const rows = [...mosqueDB.values()].map(m => [
    m.id,
    csvEsc(m.name),
    m.lat.toFixed(6),
    m.lng.toFixed(6),
    m.qibla.toFixed(2),
    m.axis!==null?m.axis.toFixed(2):'',
    m.diff!==null?m.diff.toFixed(2):'',
    m.status,
    m.method,
    m.year||'',
    m.period||''
  ]);

  const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
  download(
    '\uFEFF' + csv, // BOM for Excel UTF-8
    `qibla-${slugify(currentCity)}-${dateStr()}.csv`,
    'text/csv;charset=utf-8'
  );
  toast('âœ“ CSV indirildi â€” Excel\'de aÃ§abilirsiniz', 3000);
}

// â”€â”€ GeoJSON export
function exportGeoJSON() {
  const geojson = {
    type: 'FeatureCollection',
    metadata: {
      city: currentCity,
      exportDate: new Date().toISOString(),
      tolerance: tol
    },
    features: [...mosqueDB.values()].map(m => ({
      type: 'Feature',
      geometry: { type: 'Point', coordinates: [m.lng, m.lat] },
      properties: {
        id: m.id,
        name: m.name,
        qibla_angle: m.qibla,
        building_axis: m.axis,
        deviation_deg: m.diff,
        status: m.status,
        method: m.method,
        year: m.year||null,
        period: m.period||null,
        // Colour for QGIS styling
        fill_color: m.status==='correct'?'#4ade80':m.status==='wrong'?'#f87171':'#fbbf24'
      }
    }))
  };

  download(
    JSON.stringify(geojson, null, 2),
    `qibla-${slugify(currentCity)}-${dateStr()}.geojson`,
    'application/geo+json'
  );
  toast('âœ“ GeoJSON indirildi', 3000);
}

// â”€â”€ HTML Report (opens in new tab)
function exportReport() {
  const all = [...mosqueDB.values()];
  const withData = all.filter(m => m.diff !== null);
  const correct  = withData.filter(m => m.diff <= tol);
  const wrong    = withData.filter(m => m.diff > tol);
  const pct = withData.length ? Math.round(correct.length/withData.length*100) : null;
  const avg = withData.length ? withData.reduce((s,m)=>s+m.diff,0)/withData.length : null;
  const grade = pct===null?'â€”':pct>=85?'A':pct>=65?'B':pct>=45?'C':'D';
  const gradeCol = {A:'#4ade80',B:'#a3e635',C:'#fbbf24',D:'#f87171','â€”':'#6b6b7a'}[grade];

  // Worst 15
  const worst = [...withData].sort((a,b)=>b.diff-a.diff).slice(0,15);
  // Best 10
  const best  = [...withData].sort((a,b)=>a.diff-b.diff).slice(0,10);

  const html = `<!DOCTYPE html>
<html lang="tr"><head><meta charset="UTF-8">
<title>KÄ±ble Analiz Raporu â€” ${currentCity}</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Segoe UI',sans-serif;background:#0a0a0f;color:#e8e4d8;padding:32px;max-width:900px;margin:0 auto;}
h1{font-size:24px;color:#c9a84c;margin-bottom:4px;}
.subtitle{color:#6b6b7a;font-size:13px;margin-bottom:28px;}
.cards{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:28px;}
.card{background:#111118;border:1px solid #2a2a3a;border-radius:10px;padding:16px;text-align:center;}
.card-val{font-size:28px;font-weight:700;color:#c9a84c;}
.card-lbl{font-size:10px;color:#6b6b7a;text-transform:uppercase;letter-spacing:.1em;margin-top:4px;}
h2{font-size:14px;color:#c9a84c;margin:22px 0 10px;letter-spacing:.08em;text-transform:uppercase;}
table{width:100%;border-collapse:collapse;font-size:12px;}
th{text-align:left;padding:8px 10px;background:#111118;color:#6b6b7a;font-weight:500;border-bottom:1px solid #2a2a3a;}
td{padding:7px 10px;border-bottom:1px solid rgba(42,42,58,.4);color:#e8e4d8;}
.ok{color:#4ade80;font-weight:700;} .bad{color:#f87171;font-weight:700;} .unk{color:#fbbf24;}
.grade{display:inline-block;padding:2px 10px;border-radius:10px;font-weight:700;background:rgba(255,255,255,.07);}
footer{margin-top:32px;padding-top:12px;border-top:1px solid #2a2a3a;font-size:10px;color:#4a4a5a;}
</style></head><body>
<h1>ğŸ•Œ KÄ±ble Analiz Raporu</h1>
<div class="subtitle">${currentCity} Â· ${new Date().toLocaleDateString('tr-TR',{day:'numeric',month:'long',year:'numeric'})} Â· Tolerans: ${tol}Â°</div>

<div class="cards">
  <div class="card"><div class="card-val">${all.length}</div><div class="card-lbl">Toplam Cami</div></div>
  <div class="card"><div class="card-val" style="color:${pct!==null?(pct>=70?'#4ade80':pct>=40?'#fbbf24':'#f87171'):'#6b6b7a'}">${pct!==null?pct+'%':'â€”'}</div><div class="card-lbl">DoÄŸruluk</div></div>
  <div class="card"><div class="card-val" style="color:${gradeCol}">${grade}</div><div class="card-lbl">Not</div></div>
  <div class="card"><div class="card-val">${avg!==null?avg.toFixed(1)+'Â°':'â€”'}</div><div class="card-lbl">Ort. Sapma</div></div>
</div>

<h2>En Fazla Sapma GÃ¶steren 15 Cami</h2>
<table>
  <thead><tr><th>#</th><th>Cami AdÄ±</th><th>KÄ±ble</th><th>Bina YÃ¶nÃ¼</th><th>Sapma</th><th>Durum</th></tr></thead>
  <tbody>${worst.map((m,i)=>`<tr>
    <td>${i+1}</td>
    <td>${escHtml(m.name)}</td>
    <td>${m.qibla.toFixed(1)}Â°</td>
    <td>${m.axis!==null?m.axis.toFixed(1)+'Â°':'â€”'}</td>
    <td class="bad">${m.diff.toFixed(1)}Â°</td>
    <td class="bad">âŒ Sapma</td>
  </tr>`).join('')}</tbody>
</table>

<h2>En Ä°yi 10 Cami (KÄ±bleye En YakÄ±n)</h2>
<table>
  <thead><tr><th>#</th><th>Cami AdÄ±</th><th>KÄ±ble</th><th>Bina YÃ¶nÃ¼</th><th>Sapma</th><th>Durum</th></tr></thead>
  <tbody>${best.map((m,i)=>`<tr>
    <td>${i+1}</td>
    <td>${escHtml(m.name)}</td>
    <td>${m.qibla.toFixed(1)}Â°</td>
    <td>${m.axis!==null?m.axis.toFixed(1)+'Â°':'â€”'}</td>
    <td class="ok">${m.diff.toFixed(1)}Â°</td>
    <td class="ok">âœ… DoÄŸru</td>
  </tr>`).join('')}</tbody>
</table>

<footer>Veri: OpenStreetMap katkÄ±cÄ±larÄ± Â· ODbL Â· KÄ±ble DedektÃ¶rÃ¼ ile Ã¼retildi Â· ${new Date().toISOString()}</footer>
</body></html>`;

  const blob = new Blob([html], {type:'text/html;charset=utf-8'});
  const url  = URL.createObjectURL(blob);
  window.open(url, '_blank');
  setTimeout(()=>URL.revokeObjectURL(url), 60000);
  toast('âœ“ Rapor yeni sekmede aÃ§Ä±ldÄ±', 3000);
}

function buildScoreCardCanvas() {
  const all = [...mosqueDB.values()];
  const withData = all.filter(m => m.diff !== null);
  const ok = withData.filter(m => m.diff <= tol).length;
  const pct = withData.length ? Math.round(ok / withData.length * 100) : 0;
  const avg = withData.length ? (withData.reduce((s,m)=>s+m.diff,0)/withData.length) : null;
  const cv = document.createElement('canvas');
  cv.width = 1080; cv.height = 1080;
  const ctx = cv.getContext('2d');
  const bg = ctx.createLinearGradient(0,0,1080,1080);
  bg.addColorStop(0, '#0f1018');
  bg.addColorStop(1, '#1a1b29');
  ctx.fillStyle = bg;
  ctx.fillRect(0,0,1080,1080);
  ctx.fillStyle = '#c9a84c';
  ctx.font = '700 64px "DM Mono", monospace';
  ctx.fillText('Qibla Checker Score', 80, 120);
  ctx.fillStyle = '#e8e4d8';
  ctx.font = '700 120px "DM Mono", monospace';
  ctx.fillText(`${pct}%`, 80, 300);
  ctx.font = '500 44px "DM Mono", monospace';
  ctx.fillStyle = '#9ca3af';
  ctx.fillText(currentCity || 'City', 80, 365);
  ctx.fillStyle = '#d1d5db';
  ctx.font = '500 34px "DM Mono", monospace';
  ctx.fillText(`Total mosques: ${all.length}`, 80, 460);
  ctx.fillText(`With axis data: ${withData.length}`, 80, 518);
  ctx.fillText(`Tolerance: ${tol}Â°`, 80, 576);
  ctx.fillText(`Average deviation: ${avg != null ? avg.toFixed(1)+'Â°' : 'â€”'}`, 80, 634);
  ctx.fillStyle = '#6b7280';
  ctx.font = '400 26px "DM Mono", monospace';
  ctx.fillText(new Date().toLocaleString('tr-TR'), 80, 990);
  return cv;
}

async function shareScoreCard() {
  if (!mosqueDB.size) { toast('PaylaÅŸÄ±m iÃ§in Ã¶nce veri yÃ¼kleyin', 2200); return; }
  const cv = buildScoreCardCanvas();
  const blob = await new Promise(res => cv.toBlob(res, 'image/png'));
  if (!blob) { toast('Skor kartÄ± Ã¼retilemedi', 2200); return; }
  const file = new File([blob], `qibla-score-${slugify(currentCity)}-${dateStr()}.png`, {type:'image/png'});
  if (navigator.share && navigator.canShare && navigator.canShare({ files:[file] })) {
    try {
      await navigator.share({ title:`Qibla Score - ${currentCity}`, text:`${currentCity} kÄ±ble skoru`, files:[file] });
      toast('Skor kartÄ± paylaÅŸÄ±ldÄ±', 1800);
      return;
    } catch {}
  }
  download(blob, file.name, 'image/png');
  toast('Skor kartÄ± indirildi (paylaÅŸÄ±m fallback)', 2300);
}

// â”€â”€ Helpers
function download(content, filename, type) {
  const blob = content instanceof Blob ? content : new Blob([content], {type});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = filename;
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url), 10000);
}

function slugify(s) {
  return (s||'sehir').toLowerCase()
    .replace(/Ä±/g,'i').replace(/ÄŸ/g,'g').replace(/Ã¼/g,'u')
    .replace(/ÅŸ/g,'s').replace(/Ã¶/g,'o').replace(/Ã§/g,'c')
    .replace(/Ä°/g,'i').replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
}

function dateStr() {
  return new Date().toISOString().slice(0,10);
}

function csvEsc(s) {
  if (s==null) return '';
  s = String(s);
  if (s.includes(',') || s.includes('"') || s.includes('\n'))
    return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

// Add 'E' shortcut for export
// (handled in UX script via keydown)
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UX & KEYBOARD SHORTCUTS (AdÄ±m 7)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Keyboard shortcut helpers
function isInputFocused() {
  const tag = document.activeElement?.tagName;
  return tag === 'INPUT' || tag === 'TEXTAREA' || document.activeElement?.isContentEditable;
}

function anyModalOpen() {
  return document.getElementById('hist-overlay')?.classList.contains('show') ||
         document.getElementById('cmp-overlay')?.classList.contains('show') ||
         document.getElementById('lb-overlay')?.classList.contains('show')  ||
         document.getElementById('lab-overlay')?.classList.contains('show') ||
         document.getElementById('cmps-overlay')?.classList.contains('show') ||
         document.getElementById('m3d-overlay')?.classList.contains('show') ||
         document.getElementById('biz-overlay')?.classList.contains('show') ||
         document.getElementById('ks-overlay')?.classList.contains('show');
}

// Navigate cami list with arrow keys
let mosqueNavIdx = -1;

function mosqueNavStep(dir) {
  const items = [...document.querySelectorAll('.m-item')];
  if (!items.length) return;
  mosqueNavIdx = Math.max(0, Math.min(items.length-1, mosqueNavIdx + dir));
  items.forEach((el,i) => el.classList.toggle('active', i === mosqueNavIdx));
  const active = items[mosqueNavIdx];
  if (active) {
    active.scrollIntoView({block:'nearest', behavior:'smooth'});
    // Find mosque by id
    const id = active.id.replace('mi-','');
    const numId = parseInt(id);
    const m = mosqueDB.get(numId) || mosqueDB.get(id);
    if (m) handleMosqueClick(m);
  }
}

// Global keydown handler
document.addEventListener('keydown', e => {
  // Always: Esc closes everything
  if (e.key === 'Escape') {
    if (document.getElementById('ks-overlay').classList.contains('show')) { closeShortcuts(); return; }
    if (document.getElementById('lab-overlay').classList.contains('show')) { closeLab(); return; }
    if (document.getElementById('cmps-overlay').classList.contains('show')) { closeCompass(); return; }
    if (document.getElementById('m3d-overlay').classList.contains('show')) { close3D(); return; }
    if (document.getElementById('biz-overlay').classList.contains('show')) { closeBiz(); return; }
    if (anyModalOpen()) return; // let each modal handle its own Esc
    if (dpOpen) { closeDetailPanel(); return; }
    if (document.getElementById('ms-dropdown').classList.contains('show')) {
      document.getElementById('ms-dropdown').classList.remove('show'); return;
    }
    return;
  }

  // Skip if input is focused or a modal is open (except help)
  // Respect native OS/browser shortcuts (copy/paste/cut etc.)
  if (e.metaKey || e.ctrlKey || e.altKey) return;
  if (isInputFocused()) return;

  switch(e.key) {
    case '?':
      e.preventDefault();
      openShortcuts(); break;

    case '/':
      e.preventDefault();
      document.getElementById('city-input').focus();
      document.getElementById('city-input').select(); break;

    case 'h': case 'H':
      if (!anyModalOpen()) { e.preventDefault(); toggleHeatmap(); } break;

    case 's': case 'S':
      if (!anyModalOpen()) { e.preventDefault(); toggleScoreCard(); } break;

    case 't': case 'T':
      if (!anyModalOpen()) { e.preventDefault(); toggleHistoryMode(); } break;

    case 'l': case 'L':
      if (!anyModalOpen()) { e.preventDefault(); openLeaderboard(); } break;

    case 'p': case 'P':
      if (!anyModalOpen()) { e.preventDefault(); openBiz(); } break;

    case 'q': case 'Q':
      if (!anyModalOpen()) { e.preventDefault(); openLab(); } break;

    case 'o': case 'O':
      if (!anyModalOpen()) { e.preventDefault(); openCompass(); } break;

    case 'e': case 'E':
      if (!anyModalOpen()) { e.preventDefault(); openExport(); } break;

    case 'g': case 'G':
      if (!anyModalOpen()) { e.preventDefault(); useMyLocation(); } break;

    case 'd': case 'D':
      if (dpOpen) { e.preventDefault(); closeDetailPanel(); } break;

    case 'ArrowRight':
      if (!anyModalOpen() && !dpOpen) { e.preventDefault(); mosqueNavStep(1); }
      else if (dpOpen) { e.preventDefault(); mosqueNavStep(1); } break;

    case 'ArrowLeft':
      if (!anyModalOpen() && !dpOpen) { e.preventDefault(); mosqueNavStep(-1); }
      else if (dpOpen) { e.preventDefault(); mosqueNavStep(-1); } break;

    case '+': case '=':
      if (!anyModalOpen()) {
        e.preventDefault();
        const tolInput = document.getElementById('tol');
        tolInput.value = Math.min(45, parseInt(tolInput.value)+5);
        tolInput.dispatchEvent(new Event('input'));
      } break;

    case '-':
      if (!anyModalOpen()) {
        e.preventDefault();
        const tolInput = document.getElementById('tol');
        tolInput.value = Math.max(5, parseInt(tolInput.value)-5);
        tolInput.dispatchEvent(new Event('input'));
      } break;
  }
});

// â”€â”€ Shortcuts modal
function openShortcuts() {
  document.getElementById('ks-overlay').classList.add('show');
}
function closeShortcuts() {
  document.getElementById('ks-overlay').classList.remove('show');
}
function ksOverlayClick(e) {
  if (e.target === document.getElementById('ks-overlay')) closeShortcuts();
}

// â”€â”€ Mobile drawer
function openMobDrawer() {
  document.getElementById('mob-drawer').classList.add('open');
  document.getElementById('mob-backdrop').classList.add('show');
}
function closeMobDrawer() {
  document.getElementById('mob-drawer').classList.remove('open');
  document.getElementById('mob-backdrop').classList.remove('show');
}
function syncMobileQuickBarVisibility() {
  const bar = document.getElementById('mob-bottom-bar');
  if (!bar) return;
  const mobileLike = (window.innerWidth <= 900) && (window.matchMedia('(pointer: coarse)').matches || window.innerWidth <= 768);
  bar.style.display = mobileLike ? 'flex' : 'none';
}
function mobSearch() {
  const v = document.getElementById('mob-city-input').value.trim();
  if (!v) return;
  document.getElementById('city-input').value = v;
  closeMobDrawer();
  doSearch();
}
function mobQuickSearch() {
  const v = document.getElementById('mob-quick-city')?.value.trim();
  if (!v) return;
  document.getElementById('city-input').value = v;
  doSearch();
}
document.getElementById('mob-city-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') mobSearch();
});
document.getElementById('mob-quick-city')?.addEventListener('keydown', e => {
  if (e.key === 'Enter') mobQuickSearch();
});
window.addEventListener('resize', syncMobileQuickBarVisibility);
window.addEventListener('orientationchange', syncMobileQuickBarVisibility);
setTimeout(syncMobileQuickBarVisibility, 0);

// Sync mobile layer buttons with desktop
const _origSwitchLayer = switchLayer;
window.switchLayer = function(type) {
  _origSwitchLayer(type);
  setLayerButtonActive(type);
};

// â”€â”€ Touch swipe to close detail panel on mobile
(function() {
  let startY = 0, startX = 0;
  const panel = document.getElementById('dp-panel');

  panel.addEventListener('touchstart', e => {
    startY = e.touches[0].clientY;
    startX = e.touches[0].clientX;
  }, {passive:true});

  panel.addEventListener('touchend', e => {
    if (window.innerWidth > 768) return;
    const dy = e.changedTouches[0].clientY - startY;
    const dx = e.changedTouches[0].clientX - startX;
    // Swipe down on mobile (full-width panel)
    if (dy > 80 && Math.abs(dx) < Math.abs(dy)) closeDetailPanel();
  }, {passive:true});
})();

// â”€â”€ Mark newly loaded mosque markers with a brief pulse
// (applied via CSS class added in renderAll override)
const _uxRenderAll = renderAll;
window.renderAll = function() {
  _uxRenderAll();
};

// â”€â”€ Show shortcut hint toast on first load
(function(){
  const KEY='qibla-ks-hint-shown';
  if(!safeStorageGet(KEY, null)){
    setTimeout(()=>toast('ğŸ’¡ Klavye kÄ±sayollarÄ± iÃ§in ? tuÅŸuna basÄ±n',5000),3000);
    safeStorageSet(KEY,'1');
  }
})();
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DETAIL PANEL (AdÄ±m 6)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let dpOpen = false;
let dpPopulateToken = 0;
const mosquePlaceCache = new Map();

function extractPlaceFromAddress(addr = {}) {
  if (!addr || typeof addr !== 'object') return { city:'', district:'' };
  const city = String(
    addr.city || addr.town || addr.county || addr.province || addr.state || addr.municipality || ''
  ).trim();
  const district = String(
    addr.city_district || addr.district || addr.suburb || addr.neighbourhood || addr.quarter || addr.borough || ''
  ).trim();
  return { city, district };
}

function extractPlaceFromTags(tags = {}) {
  const city = String(
    tags['addr:city'] || tags['addr:town'] || tags['addr:county'] || tags['addr:province'] || tags['addr:state'] || ''
  ).trim();
  const district = String(
    tags['addr:district'] || tags['addr:city_district'] || tags['addr:suburb'] || tags['addr:neighbourhood'] || tags['addr:quarter'] || ''
  ).trim();
  return { city, district };
}

function formatPlaceLine(city, district) {
  if (city && district) return `${district} / ${city}`;
  if (city) return city;
  if (district) return district;
  return currentLang === 'en' ? 'District/city unavailable' : 'Ä°lÃ§e/ÅŸehir bilgisi bulunamadÄ±';
}

async function resolveMosquePlace(m, tags = {}) {
  const fromTags = extractPlaceFromTags(tags);
  if (fromTags.city || fromTags.district) return fromTags;
  const key = `${(m.osmType || 'way')}:${m.id}`;
  if (mosquePlaceCache.has(key)) return mosquePlaceCache.get(key);
  try {
    const langHdr = currentLang === 'en' ? 'en,tr,ar' : 'tr,en,ar';
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${m.lat}&lon=${m.lng}&format=jsonv2&zoom=14&addressdetails=1`;
    const data = await nominatimFetchJson(url, {'Accept-Language': langHdr});
    const place = extractPlaceFromAddress(data?.address || {});
    mosquePlaceCache.set(key, place);
    return place;
  } catch {
    const none = { city:'', district:'' };
    mosquePlaceCache.set(key, none);
    return none;
  }
}

function openDetailPanel(m) {
  dpOpen = true;
  document.getElementById('dp-panel').classList.add('open');
  document.getElementById('dp-backdrop').classList.add('show');
  populateDetailPanel(m);
}

function closeDetailPanel() {
  dpOpen = false;
  document.getElementById('dp-panel').classList.remove('open');
  document.getElementById('dp-backdrop').classList.remove('show');
}

// ESC closes panel
document.addEventListener('keydown', e => {
  if (e.key === 'Escape' && dpOpen) closeDetailPanel();
});

function populateDetailPanel(m) {
  const tags = m.tags || {};
  const token = ++dpPopulateToken;
  const names = pickLocalizedMosqueNames(m, tags);

  // â”€â”€ Name & coords
  document.getElementById('dp-name').textContent = names.primary;
  const ar = names.arName;
  const arEl = document.getElementById('dp-name-ar');
  arEl.textContent = ar;
  arEl.style.display = ar ? '' : 'none';
  const placeEl = document.getElementById('dp-place');
  const placeFromTags = extractPlaceFromTags(tags);
  placeEl.textContent = formatPlaceLine(placeFromTags.city, placeFromTags.district);
  document.getElementById('dp-coords').textContent =
    `${m.lat.toFixed(5)}Â°N  ${m.lng.toFixed(5)}Â°E  Â·  OSM ${m.osmType||'way'} #${m.id}`;

  // â”€â”€ Status ribbon
  const col = m.status==='correct'?'#4ade80':m.status==='wrong'?'#f87171':'#fbbf24';
  const statusLabel = m.status==='correct'?'âœ… DoÄŸru YÃ¶n':m.status==='wrong'?'âŒ Sapma Var':'âš ï¸ Veri Yok';
  document.getElementById('dp-status-badge').innerHTML =
    `<span class="dp-status-badge ${m.status}">${statusLabel}</span>`;
  document.getElementById('dp-qibla-val').textContent = m.qibla.toFixed(1)+'Â°';
  document.getElementById('dp-axis-val').textContent  = m.axis!==null ? m.axis.toFixed(1)+'Â°' : 'â€”';
  const diffEl = document.getElementById('dp-diff-val');
  diffEl.textContent = m.diff!==null ? m.diff.toFixed(1)+'Â°' : 'â€”';
  diffEl.style.color = m.diff!==null ? col : '#6b6b7a';
  document.getElementById('dp-dist-val').textContent =
    Math.round(greatCircleKm(m.lat, m.lng, 21.4225, 39.8262)) + ' km';

  if (!(placeFromTags.city || placeFromTags.district)) {
    resolveMosquePlace(m, tags).then(resolved => {
      if (token === dpPopulateToken && window._lastClickedMosque?.id == m.id) {
        placeEl.textContent = formatPlaceLine(resolved.city, resolved.district);
      }
    });
  }

  // â”€â”€ Photo
  loadPhoto(m, tags);

  // â”€â”€ Compass
  drawDetailCompass(m);
  renderInteriorSection(m, tags);
  renderExplainability(m);

  // â”€â”€ Qibla stats
  const methLabel = {
    'edge-analysis':'Kenar Analizi (PCA)',
    'osm-tag':'OSM direction tag',
    'hybrid-interior':'Hibrit (Bina + Ä°Ã§ Mekan)',
    'interior-only':'Ä°Ã§ Mekan KanÄ±tÄ±',
    'fused':'BirleÅŸik',
    'none':'â€”'
  }[m.method] || m.method;
  const buildDate = tags.start_date || tags['building:start_date'];
  const fusionRel = m.fusion?.reliability!=null ? Math.round(m.fusion.reliability*100)+'%' : 'â€”';
  const interiorCount = m.fusion?.interiorCount || getInteriorEvidenceList(m).length;
  const conv = m.convertedFrom?.converted ? 'Evet (olasÄ±)' : 'HayÄ±r';
  document.getElementById('dp-qibla-stats').innerHTML = `
    <div class="dp-qs-row"><span class="dp-qs-k">Hesaplama yÃ¶ntemi</span><span class="dp-qs-v">${escHtml(methLabel)}</span></div>
    <div class="dp-qs-row"><span class="dp-qs-k">Kabe yÃ¶nÃ¼ (bÃ¼yÃ¼k daire)</span><span class="dp-qs-v">${m.qibla.toFixed(2)}Â°</span></div>
    ${m.baseAxis!==null&&m.baseAxis!==undefined?`<div class="dp-qs-row"><span class="dp-qs-k">Bina ekseni (ham)</span><span class="dp-qs-v">${m.baseAxis.toFixed(2)}Â°</span></div>`:''}
    ${m.axis!==null?`<div class="dp-qs-row"><span class="dp-qs-k">Nihai eksen</span><span class="dp-qs-v">${m.axis.toFixed(2)}Â°</span></div>`:''}
    ${m.diff!==null?`<div class="dp-qs-row"><span class="dp-qs-k">KÄ±ble sapmasÄ±</span><span class="dp-qs-v" style="color:${col}">${m.diff.toFixed(2)}Â°</span></div>`:''}
    <div class="dp-qs-row"><span class="dp-qs-k">FÃ¼zyon gÃ¼veni</span><span class="dp-qs-v">${fusionRel}</span></div>
    <div class="dp-qs-row"><span class="dp-qs-k">Model gÃ¼ven puanÄ±</span><span class="dp-qs-v">${m.confidence ?? 'â€”'}/100</span></div>
    <div class="dp-qs-row"><span class="dp-qs-k">Ä°Ã§ kanÄ±t adedi</span><span class="dp-qs-v">${interiorCount}</span></div>
    <div class="dp-qs-row"><span class="dp-qs-k">DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ yapÄ±</span><span class="dp-qs-v">${conv}</span></div>
    ${m.diff!==null?`<div class="dp-qs-row"><span class="dp-qs-k">DeÄŸerlendirme</span><span class="dp-qs-v" style="color:${col}">${m.diff<=5?'MÃ¼kemmel (<5Â°)':m.diff<=tol?'Kabul edilebilir':'DÃ¼zeltilmeli'}</span></div>`:''}
    ${buildDate?`<div class="dp-qs-row"><span class="dp-qs-k">Ä°nÅŸaat tarihi</span><span class="dp-qs-v">${escHtml(buildDate)}</span></div>`:''}
  `;

  // â”€â”€ Wikipedia
  loadWikipedia(m, tags);

  // â”€â”€ OSM Tags table
  renderTagsTable(tags);

  // â”€â”€ Action buttons
  renderActions(m, tags);

  // Ä°sim OSM'de eksikse Wikidata'dan etiketi Ã§ekmeyi dene
  if (isPlaceholderMosqueName(m.name) && typeof tags.wikidata === 'string') {
    fetchWikidataLabel(tags.wikidata).then(lbl => {
      if (!lbl || !m || !m.tags || m.tags.wikidata !== tags.wikidata) return;
      m.name = lbl;
      document.getElementById('dp-name').textContent = lbl;
      // Sidebar/gÃ¶rÃ¼nÃ¼m gÃ¼ncelle
      const bounds = map?.getBounds?.().pad(0.1);
      if (bounds) {
        const visible = [...mosqueDB.values()].filter(x => bounds.contains([x.lat, x.lng]));
        updateList(visible);
      }
    }).catch(()=>{});
  }
}

// â”€â”€ Photo loader
async function loadPhoto(m, tags) {
  const wrap = document.getElementById('dp-photo-wrap');
  const img  = document.getElementById('dp-photo');
  const cred = document.getElementById('dp-photo-credit');

  wrap.style.display = 'none';

  // 1. wikimedia_commons tag
  const wmc = tags.wikimedia_commons || tags.image;
  if (wmc) {
    const url = await resolveWikimediaUrl(wmc);
    if (url) { img.src = url; wrap.style.display = ''; cred.textContent = 'Â© Wikimedia Commons'; return; }
  }

  // 2. wikipedia tag â†’ try Wikimedia page image
  const wiki = tags.wikipedia;
  if (wiki) {
    const url = await fetchWikiPageImage(wiki);
    if (url) { img.src = url; wrap.style.display = ''; cred.textContent = 'Â© Wikipedia'; return; }
  }
}

async function resolveWikimediaUrl(val) {
  try {
    // If it's already a URL
    if (val.startsWith('http')) return val;
    // Extract filename from "File:Xxxx.jpg" or plain filename
    const file = val.replace(/^(File:|Dosya:)/i,'').replace(/^Category:.*/,'').trim();
    if (!file || /^Category/i.test(val)) return null;
    const api = `https://commons.wikimedia.org/w/api.php?action=query&titles=File:${encodeURIComponent(file)}&prop=imageinfo&iiprop=url&format=json&origin=*`;
    const r = await fetch(api);
    const d = await r.json();
    const pages = d.query?.pages;
    if (!pages) return null;
    const page = Object.values(pages)[0];
    return page?.imageinfo?.[0]?.url || null;
  } catch { return null; }
}

async function fetchWikiPageImage(wikiTag) {
  try {
    // Format: "tr:Cami adÄ±" or "en:Mosque name"
    const [lang, ...titleParts] = wikiTag.includes(':') ? wikiTag.split(':') : ['tr', wikiTag];
    const title = titleParts.join(':');
    const api = `https://${lang}.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&prop=pageimages&pithumbsize=600&format=json&origin=*`;
    const r = await fetch(api);
    const d = await r.json();
    const pages = d.query?.pages;
    if (!pages) return null;
    const page = Object.values(pages)[0];
    return page?.thumbnail?.source || null;
  } catch { return null; }
}

// â”€â”€ Wikipedia summary
async function loadWikipedia(m, tags) {
  const sec = document.getElementById('dp-wiki-section');
  const body = document.getElementById('dp-wiki-body');
  const link = document.getElementById('dp-wiki-link');
  sec.style.display = 'none';

  const wiki = tags.wikipedia;
  if (!wiki) return;

  try {
    const [lang, ...titleParts] = wiki.includes(':') ? wiki.split(':') : ['tr', wiki];
    const title = titleParts.join(':');
    const api = `https://${lang}.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(title)}&prop=extracts&exintro=true&exchars=600&format=json&origin=*`;
    const r = await fetch(api);
    const d = await r.json();
    const pages = d.query?.pages;
    if (!pages) return;
    const page = Object.values(pages)[0];
    if (!page?.extract) return;

    // Strip HTML tags for clean text
    const clean = page.extract.replace(/<[^>]+>/g,'').replace(/\n+/g,' ').trim();
    if (!clean) return;

    body.textContent = clean;
    link.href = `https://${lang}.wikipedia.org/wiki/${encodeURIComponent(title)}`;
    link.textContent = `Wikipedia'da oku (${lang}) â†’`;
    sec.style.display = '';
  } catch { sec.style.display = 'none'; }
}

// â”€â”€ Compass canvas
function drawDetailCompass(m) {
  const canvas = document.getElementById('dp-compass');
  const ctx = canvas.getContext('2d');
  const cx = 60, cy = 60, r = 52;
  ctx.clearRect(0, 0, 120, 120);

  // Outer ring
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.strokeStyle = '#2a2a3a'; ctx.lineWidth = 1.5; ctx.stroke();

  // Cardinal labels
  const cardinals = [['K',0],['D',90],['G',180],['B',270]];
  ctx.font = '8px DM Mono,monospace'; ctx.fillStyle = '#4a4a5a'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  cardinals.forEach(([lbl, deg]) => {
    const rad = (deg - 90) * Math.PI / 180;
    ctx.fillText(lbl, cx + (r-8)*Math.cos(rad), cy + (r-8)*Math.sin(rad));
  });

  // Tick marks
  for (let d=0; d<360; d+=30) {
    const rad = (d-90)*Math.PI/180;
    const len = d%90===0 ? 7 : 4;
    ctx.beginPath();
    ctx.moveTo(cx+(r-2)*Math.cos(rad), cy+(r-2)*Math.sin(rad));
    ctx.lineTo(cx+(r-2-len)*Math.cos(rad), cy+(r-2-len)*Math.sin(rad));
    ctx.strokeStyle = '#3a3a4a'; ctx.lineWidth = 1; ctx.stroke();
  }

  // Qibla direction (gold dashed)
  const qRad = (m.qibla - 90) * Math.PI / 180;
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(cx + (r-12)*Math.cos(qRad), cy + (r-12)*Math.sin(qRad));
  ctx.strokeStyle = '#c9a84c'; ctx.lineWidth = 2; ctx.setLineDash([4,3]); ctx.stroke();
  ctx.setLineDash([]);
  // Qibla arrowhead
  drawArrow(ctx, cx, cy, qRad, r-12, '#c9a84c', 2);

  // Building axis (colored by status)
  if (m.axis !== null) {
    const col = m.status==='correct'?'#4ade80':m.status==='wrong'?'#f87171':'#fbbf24';
    const fd = closestDirection(m.axis, m.qibla);
    const bRad = (fd - 90) * Math.PI / 180;
    // Draw full axis (both directions)
    const bRad2 = bRad + Math.PI;
    ctx.beginPath();
    ctx.moveTo(cx + (r-18)*Math.cos(bRad2), cy + (r-18)*Math.sin(bRad2));
    ctx.lineTo(cx + (r-18)*Math.cos(bRad),  cy + (r-18)*Math.sin(bRad));
    ctx.strokeStyle = col; ctx.lineWidth = 2.5; ctx.stroke();
    drawArrow(ctx, cx, cy, bRad, r-18, col, 2.5);
  }

  // Center dot
  ctx.beginPath(); ctx.arc(cx,cy,3,0,Math.PI*2);
  ctx.fillStyle = '#e8e4d8'; ctx.fill();

  // Legend
  ctx.font = '7px DM Mono,monospace'; ctx.textAlign = 'left'; ctx.textBaseline = 'middle';
  ctx.fillStyle = '#c9a84c'; ctx.fillRect(4,108,12,2);
  ctx.fillStyle = '#c9a84c'; ctx.fillText('KÄ±ble', 19, 109);
  if (m.axis !== null) {
    const col = m.status==='correct'?'#4ade80':m.status==='wrong'?'#f87171':'#fbbf24';
    ctx.fillStyle = col; ctx.fillRect(60,108,12,2);
    ctx.fillStyle = col; ctx.fillText('Bina', 75, 109);
  }
}

function drawArrow(ctx, cx, cy, angleRad, dist, color, lw) {
  const tipX = cx + dist*Math.cos(angleRad);
  const tipY = cy + dist*Math.sin(angleRad);
  const headLen = 7;
  const headAngle = 0.45;
  ctx.beginPath();
  ctx.moveTo(tipX - headLen*Math.cos(angleRad-headAngle), tipY - headLen*Math.sin(angleRad-headAngle));
  ctx.lineTo(tipX, tipY);
  ctx.lineTo(tipX - headLen*Math.cos(angleRad+headAngle), tipY - headLen*Math.sin(angleRad+headAngle));
  ctx.strokeStyle = color; ctx.lineWidth = lw; ctx.stroke();
}

// â”€â”€ Tags table
const DP_TAG_PRIORITY = ['name','name:tr','name:ar','name:en','amenity','religion','denomination',
  'start_date','building:start_date','architect','heritage','wikipedia','wikidata',
  'wikimedia_commons','image','website','phone','addr:street','addr:city','operator',
  'building','building:levels','capacity','access','opening_hours'];

function renderTagsTable(tags) {
  const el = document.getElementById('dp-tags');
  const title = document.getElementById('dp-tags-title');
  const allKeys = Object.keys(tags);
  if (!allKeys.length) { el.innerHTML='<div style="color:#6b6b7a;font-size:11px">Etiket bulunamadÄ±</div>'; return; }

  // Sort: priority first, then alphabetical
  const sorted = [...allKeys].sort((a,b) => {
    const ai = DP_TAG_PRIORITY.indexOf(a), bi = DP_TAG_PRIORITY.indexOf(b);
    if (ai>=0 && bi>=0) return ai-bi;
    if (ai>=0) return -1;
    if (bi>=0) return 1;
    return a.localeCompare(b);
  });

  title.textContent = `OSM Etiketleri (${allKeys.length})`;

  el.innerHTML = sorted.map(k => {
    let v = escHtml(tags[k]);
    // Linkify URLs
    if (typeof tags[k] === 'string' && /^https?:\/\//i.test(tags[k])) {
      const url = tags[k];
      const short = url.length>40 ? url.slice(0,40)+'â€¦' : url;
      v = `<a href="${escHtml(url)}" target="_blank" rel="noopener">${escHtml(short)}</a>`;
    }
    // Wikipedia: linkify
    if (k === 'wikipedia' && typeof tags[k] === 'string') {
      const [rawLang,...tp] = tags[k].split(':');
      const lang = /^[a-z-]{2,12}$/i.test(rawLang) ? rawLang.toLowerCase() : 'tr';
      const title2 = tp.join(':');
      v = `<a href="https://${lang}.wikipedia.org/wiki/${encodeURIComponent(title2)}" target="_blank" rel="noopener">${escHtml(tags[k])}</a>`;
    }
    if (k === 'wikidata' && typeof tags[k] === 'string') {
      v = `<a href="https://www.wikidata.org/wiki/${encodeURIComponent(tags[k])}" target="_blank" rel="noopener">${escHtml(tags[k])}</a>`;
    }
    return `<div class="dp-tag-row"><span class="dp-tag-k">${escHtml(k)}</span><span class="dp-tag-v">${v}</span></div>`;
  }).join('');
}

async function renderInteriorSection(m, tags) {
  const gallery = document.getElementById('dp-int-gallery');
  const meta = document.getElementById('dp-int-meta');
  const evList = document.getElementById('dp-int-ev-list');
  const axisInput = document.getElementById('dp-int-axis');
  const axisVal = document.getElementById('dp-int-axis-val');
  const urlInput = document.getElementById('dp-int-url');
  const noteInput = document.getElementById('dp-int-note');

  axisInput.value = Math.round((m.axis ?? m.qibla) % 180);
  axisVal.textContent = axisInput.value + 'Â°';
  urlInput.value = '';
  noteInput.value = '';

  gallery.innerHTML = '<div class="dp-int-meta">Ä°Ã§ mekan gÃ¶rselleri aranÄ±yor...</div>';
  meta.textContent = '';
  const photos = await resolveInteriorPhotos(m);
  if (!photos.length) {
    gallery.innerHTML = '<div class="dp-int-meta">Otomatik iÃ§ mekan gÃ¶rseli bulunamadÄ±. URL ile manuel kanÄ±t ekleyebilirsiniz.</div>';
  } else {
    gallery.innerHTML = photos.map((p,i) => `
      <div class="dp-int-thumb" onclick="window.open('${escHtml(p.url)}','_blank')">
        <img src="${escHtml(p.url)}" alt="Interior ${i+1}"/>
        <span>${p.source==='commons-category'?'Commons':'Arama'}</span>
      </div>
    `).join('');
  }

  const list = getInteriorEvidenceList(m);
  const manualRec = getManualAxisRecord(m);
  meta.textContent = list.length
    ? `KaydedilmiÅŸ iÃ§ mekan kanÄ±tÄ±: ${list.length} Â· Son gÃ¼ncelleme: ${new Date(list[list.length-1].ts).toLocaleString('tr-TR')}`
    : 'HenÃ¼z iÃ§ mekan yÃ¶n kanÄ±tÄ± kaydedilmedi.';

  evList.innerHTML = list.length
    ? list.map((ev, idx) => `
      <div class="dp-int-ev-row">
        <div class="dp-int-ev-main">
          ${Number(ev.axis).toFixed(1)}Â° Â· GÃ¼ven ${(Number(ev.confidence||0)*100|0)}%
          <div class="dp-int-ev-sub">${escHtml(ev.note || ev.sourceUrl || 'manuel giriÅŸ')}</div>
        </div>
        <button class="dp-int-ev-del" onclick="removeInteriorEvidence(${idx})">Sil</button>
      </div>
    `).join('')
    : '<div class="dp-int-meta">KanÄ±t listesi boÅŸ.</div>';

  if (manualRec?.axis != null) {
    const mod = manualRec.moderation || {};
    const row = document.createElement('div');
    row.className = 'dp-int-ev-row';
    row.innerHTML = `
      <div class="dp-int-ev-main">
        Manuel aks: ${Number(manualRec.axis).toFixed(1)}Â° Â· AI: ${(mod.status || 'none').toUpperCase()}
        <div class="dp-int-ev-sub">Skor: ${mod.score!=null ? (mod.score*100|0)+'%' : 'â€”'} Â· ${new Date(manualRec.ts || Date.now()).toLocaleString('tr-TR')}</div>
      </div>
      <button class="dp-int-ev-del" onclick="deleteManualAxis()">Sil</button>
    `;
    evList.appendChild(row);
  }
  if (manualRec?.axis != null) {
    const mod = manualRec.moderation || {};
    setManualStatus(`KayÄ±tlÄ±: ${Number(manualRec.axis).toFixed(1)}Â° Â· AI ${String(mod.status || 'none').toUpperCase()}`);
  } else {
    setManualStatus('HazÄ±r');
  }
}

function saveInteriorEvidence() {
  const m = window._lastClickedMosque;
  if (!m) return;
  const axis = toAxis180(document.getElementById('dp-int-axis').value);
  const confidence = Math.min(1, Math.max(0.2, Number(document.getElementById('dp-int-conf').value) || 0.75));
  const sourceUrl = document.getElementById('dp-int-url').value.trim();
  const note = document.getElementById('dp-int-note').value.trim();
  const key = getMosqueKey(m);
  const list = getInteriorEvidenceList(m);
  list.push({
    axis,
    confidence,
    sourceUrl,
    note,
    ts: Date.now(),
    source: 'manual'
  });
  interiorDB[key] = list.slice(-12);
  saveInteriorDB();
  applyAxisFusion(m);
  renderAll();
  populateDetailPanel(m);
  toast('Ä°Ã§ mekan kanÄ±tÄ± kaydedildi, analiz gÃ¼ncellendi', 2600);
}

function removeInteriorEvidence(idx) {
  const m = window._lastClickedMosque;
  if (!m) return;
  const key = getMosqueKey(m);
  const list = getInteriorEvidenceList(m);
  if (idx < 0 || idx >= list.length) return;
  list.splice(idx, 1);
  interiorDB[key] = list;
  saveInteriorDB();
  applyAxisFusion(m);
  renderAll();
  populateDetailPanel(m);
  toast('Ä°Ã§ mekan kanÄ±tÄ± kaldÄ±rÄ±ldÄ±', 2200);
}

function deleteManualAxis() {
  const m = window._lastClickedMosque;
  if (!m) return;
  delete manualAxisDB[getMosqueKey(m)];
  saveManualAxisDB();
  applyAxisFusion(m);
  renderAll();
  populateDetailPanel(m);
  toast('Manuel aks kaydÄ± silindi', 2000);
}

function renderExplainability(m) {
  const el = document.getElementById('dp-explain');
  if (!el) return;
  const badges = (m.qualityBadges || []).map(b => `<span class="badge">${escHtml(b)}</span>`).join(' ');
  const interiorAxis = getInteriorAxis(m);
  const manualRec = getManualAxisRecord(m);
  const items = [
    ['Nihai yÃ¶ntem', m.method || 'â€”'],
    ['FÃ¼zyon gÃ¼veni', m.fusion?.reliability!=null ? `${Math.round(m.fusion.reliability*100)}%` : 'â€”'],
    ['Geometri karmaÅŸÄ±klÄ±ÄŸÄ±', m.geomComplexity!=null ? `${Math.round(m.geomComplexity*100)}%` : 'â€”'],
    ['KanÄ±t sayÄ±sÄ±', String(m.fusion?.candidates ?? 0)],
    ['Ham eksen', m.baseAxis!=null ? `${m.baseAxis.toFixed(2)}Â°` : 'â€”'],
    ['Ä°Ã§ eksen', interiorAxis!=null ? `${interiorAxis.toFixed(2)}Â°` : 'â€”'],
    ['DÃ¶nÃ¼ÅŸÃ¼m ipucu', m.convertedFrom?.converted ? (m.convertedFrom.previous || 'var') : 'yok'],
    ['AI manuel moderasyon', manualRec?.moderation?.status || 'none']
  ];
  el.innerHTML = `
    <div class="lab-row"><span class="lab-k">Kalite Rozetleri</span><span class="lab-v">${badges || 'â€”'}</span></div>
    ${items.map(([k,v]) => `<div class="lab-row"><span class="lab-k">${escHtml(k)}</span><span class="lab-v">${escHtml(v)}</span></div>`).join('')}
    ${m.convertedFrom?.evidence ? `<div class="lab-row"><span class="lab-k">DÃ¶nÃ¼ÅŸÃ¼m kanÄ±tÄ±</span><span class="lab-v">${escHtml(m.convertedFrom.evidence)}</span></div>` : ''}
    ${manualRec?.moderation?.reasons?.length ? `<div class="lab-row"><span class="lab-k">AI notlarÄ±</span><span class="lab-v">${escHtml(manualRec.moderation.reasons.join(', '))}</span></div>` : ''}
  `;
}

// â”€â”€ Action buttons
function renderActions(m, tags) {
  const el = document.getElementById('dp-actions');
  const osmUrl = `https://www.openstreetmap.org/${m.osmType||'way'}/${m.id}`;
  const editUrl = `https://www.openstreetmap.org/edit?${m.osmType||'way'}=${m.id}`;
  const gmUrl   = `https://www.google.com/maps?q=${m.lat},${m.lng}`;
  const coordStr= `${m.lat.toFixed(6)}, ${m.lng.toFixed(6)}`;

  let wikiAction = '';
  if (typeof tags.wikipedia === 'string' && tags.wikipedia.includes(':')) {
    const [rawLang, ...rest] = tags.wikipedia.split(':');
    const lang = /^[a-z-]{2,12}$/i.test(rawLang) ? rawLang.toLowerCase() : 'tr';
    const title = rest.join(':').trim();
    if (title) {
      wikiAction = `<a class="dp-action-btn" href="https://${lang}.wikipedia.org/wiki/${encodeURIComponent(title)}" target="_blank" rel="noopener">ğŸ“– Wikipedia</a>`;
    }
  }

  el.innerHTML = `
    <button class="dp-action-btn" onclick="focusMosqueOnMap()">ğŸ§­ Haritada GÃ¶ster</button>
    <button class="dp-action-btn anim" onclick="closeDetailPanel();if(window._lastClickedMosque)animateQibla(window._lastClickedMosque)">ğŸŒ BÃ¼yÃ¼k Daire</button>
    <button class="dp-action-btn" onclick="enrichSelectedMosqueName(true)">ğŸ§  Ä°smi Bul</button>
    <button class="dp-action-btn" onclick="open3D()">ğŸ— 3D Analiz</button>
    <a class="dp-action-btn" href="${osmUrl}" target="_blank" rel="noopener">ğŸ—º OSM'de GÃ¶r</a>
    <a class="dp-action-btn" href="${editUrl}" target="_blank" rel="noopener">âœï¸ OSM'de DÃ¼zenle</a>
    <a class="dp-action-btn" href="${gmUrl}" target="_blank" rel="noopener">ğŸ“ Google Maps</a>
    <button class="dp-action-btn" onclick="navigator.clipboard?.writeText('${coordStr}').then(()=>toast('Koordinat kopyalandÄ±'))">ğŸ“‹ Koordinat Kopyala</button>
    ${wikiAction}
  `;
}

function focusMosqueOnMap() {
  const m = window._lastClickedMosque;
  if (!m || !map) return;
  closeDetailPanel();
  map.flyTo([m.lat, m.lng], Math.max(map.getZoom() || 15, 16), { duration: 0.7 });
  setTimeout(() => {
    const marker = renderLayers.find(layer => layer?.mosque?.id == m.id);
    if (marker?.openPopup) marker.openPopup();
  }, 450);
}

async function enrichSelectedMosqueName(force = false) {
  const m = window._lastClickedMosque;
  if (!m) return;
  const old = m.name;
  toast('Ä°sim kaynaklarÄ± karÅŸÄ±laÅŸtÄ±rÄ±lÄ±yor...', 1800);
  try {
    const resolved = await enrichMosqueName(m, { force });
    if (resolved && resolved !== old) {
      populateDetailPanel(m);
      const bounds = map?.getBounds?.().pad(0.1);
      if (bounds) {
        const visible = [...mosqueDB.values()].filter(x => bounds.contains([x.lat, x.lng]));
        updateList(visible);
      }
      toast(`Ä°sim gÃ¼ncellendi: ${resolved}`, 2800);
    } else if (resolved) {
      toast(`Ä°sim doÄŸrulandÄ±: ${resolved}`, 2400);
    } else {
      toast('Ek kaynaklarda kesin isim bulunamadÄ±', 2600);
    }
  } catch (e) {
    toast('Ä°sim Ã§Ã¶zÃ¼mleme baÅŸarÄ±sÄ±z: ' + (e?.message || 'bilinmeyen hata'), 3200);
  }
}

function setManualStatus(msg) {
  const el = document.getElementById('dp-manual-status');
  if (el) el.textContent = msg;
}

function clearManualCaptureVisuals() {
  manualCapture.markers.forEach(mk => { try { map.removeLayer(mk); } catch {} });
  manualCapture.markers = [];
  if (manualCapture.line) { try { map.removeLayer(manualCapture.line); } catch {} }
  manualCapture.line = null;
  manualCapture.points = [];
}

function cancelManualAxisCapture() {
  if (!map) return;
  manualCapture.active = false;
  map.off('click', onManualMapClick);
  clearManualCaptureVisuals();
  setManualStatus('Ä°ptal edildi');
}

function startManualAxisCapture() {
  const m = window._lastClickedMosque;
  if (!m || !map) { toast('Ã–nce bir cami seÃ§in', 2000); return; }
  cancelManualAxisCapture();
  manualCapture.active = true;
  setManualStatus('Haritada 1. noktayÄ± seÃ§in');
  map.on('click', onManualMapClick);
}

function onManualMapClick(e) {
  if (!manualCapture.active) return;
  const p = [e.latlng.lat, e.latlng.lng];
  manualCapture.points.push(p);
  const mk = L.circleMarker(p, { radius:6, color:'#fff', weight:1.5, fillColor:'#c9a84c', fillOpacity:1 }).addTo(map);
  manualCapture.markers.push(mk);
  if (manualCapture.points.length === 1) {
    setManualStatus('2. noktayÄ± seÃ§in');
    return;
  }
  const [a,b] = manualCapture.points;
  manualCapture.line = L.polyline([a,b], { color:'#c9a84c', weight:3, dashArray:'6 4' }).addTo(map);
  const brg = bearing(a[0], a[1], b[0], b[1]);
  const axis = toAxis180(brg);
  const m = window._lastClickedMosque;
  const mod = applyManualAxisSubmission(m, axis, 'map-2point');
  setManualStatus(`AI: ${mod.status.toUpperCase()} Â· skor ${(mod.score*100|0)}% Â· aks ${axis.toFixed(1)}Â°`);
  manualCapture.active = false;
  map.off('click', onManualMapClick);
  renderAll();
  populateDetailPanel(m);
  toast(`Manuel aks ${mod.status === 'accepted' ? 'kabul edildi' : mod.status === 'pending' ? 'incelemeye alÄ±ndÄ±' : 'reddedildi'}`, 2800);
}

function compassOverlayClick(e) {
  if (e.target === document.getElementById('cmps-overlay')) closeCompass();
}

function openCompass() {
  document.getElementById('cmps-overlay').classList.add('show');
  document.getElementById('btn-compass')?.classList.add('active');
  document.getElementById('btn-map-sync')?.classList.toggle('active', uiState.mapSyncWithCompass);
  startCompass();
}
function closeCompass() {
  document.getElementById('cmps-overlay').classList.remove('show');
  document.getElementById('btn-compass')?.classList.remove('active');
  if (!uiState.liveMapCompass) stopCompass();
  if (uiState.mapSyncWithCompass && !uiState.liveMapCompass) {
    uiState.mapSyncWithCompass = false;
    document.getElementById('btn-map-sync')?.classList.remove('active');
    applyMapHeadingRotation(null);
  }
  updateCompassFabUi();
}

async function requestCompassPermission() {
  try {
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
      const p = await DeviceOrientationEvent.requestPermission();
      if (p !== 'granted') { toast('SensÃ¶r izni verilmedi', 2200); return false; }
    }
    startCompass();
    return true;
  } catch {
    toast('SensÃ¶r izni alÄ±namadÄ±', 2200);
    return false;
  }
}

function refreshCompassLocation() {
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(pos => {
    setUserGeoState(pos.coords.latitude, pos.coords.longitude, true);
    compassState.loc = { lat: pos.coords.latitude, lng: pos.coords.longitude };
    compassState.qibla = qiblaAngle(compassState.loc.lat, compassState.loc.lng);
    drawCompass();
  }, () => {
    const c = map?.getCenter?.();
    if (c) {
      compassState.loc = { lat:c.lat, lng:c.lng };
      compassState.qibla = qiblaAngle(c.lat, c.lng);
      drawCompass();
    }
  }, { enableHighAccuracy:true, timeout:8000 });
}

function onDeviceOrientation(ev) {
  const raw = ev.webkitCompassHeading != null ? ev.webkitCompassHeading : (ev.absolute ? ev.alpha : null);
  if (raw == null) return;
  compassState.heading = (360 - raw + 360) % 360;
  applyMapHeadingRotation(compassState.heading);
  drawCompass();
}

function startCompass() {
  if (compassState.running) return;
  compassState.running = true;
  refreshCompassLocation();
  window.addEventListener('deviceorientation', onDeviceOrientation, true);
  drawCompass();
}

function stopCompass() {
  compassState.running = false;
  window.removeEventListener('deviceorientation', onDeviceOrientation, true);
}

function drawCompass() {
  const cv = document.getElementById('cmps-canvas');
  const rows = document.getElementById('cmps-rows');
  if (!cv || !rows) return;
  const ctx = cv.getContext('2d');
  const W = cv.width, H = cv.height, cx=W/2, cy=H/2, r=110;
  ctx.clearRect(0,0,W,H);
  ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fillStyle='#111118'; ctx.fill();
  ctx.strokeStyle='#2a2a3a'; ctx.lineWidth=2; ctx.stroke();
  for (let d=0; d<360; d+=15) {
    const rr = toRad(d-90);
    const len = d%90===0?14:d%45===0?10:6;
    ctx.beginPath();
    ctx.moveTo(cx+Math.cos(rr)*(r-2), cy+Math.sin(rr)*(r-2));
    ctx.lineTo(cx+Math.cos(rr)*(r-len), cy+Math.sin(rr)*(r-len));
    ctx.strokeStyle = '#3a3a4a'; ctx.lineWidth=1; ctx.stroke();
  }
  const heading = compassState.heading;
  const qibla = compassState.qibla;
  if (heading != null) {
    const h = toRad(heading-90);
    ctx.beginPath(); ctx.moveTo(cx,cy);
    ctx.lineTo(cx+Math.cos(h)*(r-28), cy+Math.sin(h)*(r-28));
    ctx.strokeStyle='#60a5fa'; ctx.lineWidth=3; ctx.stroke();
  }
  if (qibla != null) {
    const q = toRad(qibla-90);
    ctx.beginPath(); ctx.moveTo(cx,cy);
    ctx.lineTo(cx+Math.cos(q)*(r-20), cy+Math.sin(q)*(r-20));
    ctx.strokeStyle='#c9a84c'; ctx.lineWidth=3; ctx.setLineDash([6,4]); ctx.stroke(); ctx.setLineDash([]);
  }
  ctx.beginPath(); ctx.arc(cx,cy,4,0,Math.PI*2); ctx.fillStyle='#e8e4d8'; ctx.fill();

  const diff = (heading != null && qibla != null)
    ? Math.min(Math.abs(((qibla-heading)+360)%360), Math.abs(((heading-qibla)+360)%360)).toFixed(1)+'Â°'
    : 'â€”';
  rows.innerHTML = `
    <div class="lab-row"><span class="lab-k">Cihaz yÃ¶nÃ¼</span><span class="lab-v">${heading!=null?heading.toFixed(1)+'Â°':'â€”'}</span></div>
    <div class="lab-row"><span class="lab-k">KÄ±ble yÃ¶nÃ¼</span><span class="lab-v">${qibla!=null?qibla.toFixed(1)+'Â°':'â€”'}</span></div>
    <div class="lab-row"><span class="lab-k">AnlÄ±k fark</span><span class="lab-v">${diff}</span></div>
    <div class="lab-row"><span class="lab-k">Harita senkronu</span><span class="lab-v">${uiState.mapSyncWithCompass ? 'AÃ§Ä±k' : 'KapalÄ±'}</span></div>
    <div class="lab-row"><span class="lab-k">Konum</span><span class="lab-v">${compassState.loc ? `${compassState.loc.lat.toFixed(4)}, ${compassState.loc.lng.toFixed(4)}` : 'â€”'}</span></div>
  `;
}

function m3dOverlayClick(e) {
  if (e.target === document.getElementById('m3d-overlay')) close3D();
}

async function loadThree() {
  if (window.THREE) return;
  await loadScript('https://unpkg.com/three@0.160.0/build/three.min.js');
}

function dispose3D() {
  if (m3dState.raf) cancelAnimationFrame(m3dState.raf);
  m3dState.raf = 0;
  if (m3dState.renderer) {
    try { m3dState.renderer.dispose(); } catch {}
  }
  m3dState = { renderer:null, scene:null, camera:null, raf:0, obj:null };
}

async function open3D() {
  const m = window._lastClickedMosque;
  if (!m) { toast('Ã–nce bir cami seÃ§in', 2200); return; }
  document.getElementById('m3d-overlay').classList.add('show');
  await loadThree();
  render3DScene(m);
}

function close3D() {
  document.getElementById('m3d-overlay').classList.remove('show');
  dispose3D();
}

function render3DScene(m) {
  const canvas = document.getElementById('m3d-canvas');
  const side = document.getElementById('m3d-side');
  if (!canvas || !window.THREE) return;
  dispose3D();
  const THREE = window.THREE;
  const w = canvas.clientWidth || 700;
  const h = canvas.clientHeight || 420;
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true });
  renderer.setSize(w, h, false);
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x090910);
  const camera = new THREE.PerspectiveCamera(45, w/h, 1, 5000);
  camera.position.set(0, 180, 300);
  camera.lookAt(0, 0, 0);
  const amb = new THREE.AmbientLight(0xffffff, 0.7);
  scene.add(amb);
  const dir = new THREE.DirectionalLight(0xffffff, 0.8);
  dir.position.set(120, 220, 80);
  scene.add(dir);

  const grid = new THREE.GridHelper(360, 18, 0x333344, 0x1d1d2a);
  scene.add(grid);

  let obj = null;
  if (m.polyCoords && m.polyCoords.length >= 4) {
    const lat0 = m.lat, lng0 = m.lng;
    const pts = m.polyCoords.map(([la,ln]) => ({
      x:(ln-lng0) * Math.cos(toRad(lat0)) * 111320,
      z:(la-lat0) * 111320
    }));
    const shape = new THREE.Shape();
    shape.moveTo(pts[0].x, pts[0].z);
    for (let i=1; i<pts.length; i++) shape.lineTo(pts[i].x, pts[i].z);
    const geo = new THREE.ExtrudeGeometry(shape, { depth:22, bevelEnabled:false });
    geo.rotateX(-Math.PI/2);
    geo.translate(0, 0, 0);
    const mat = new THREE.MeshStandardMaterial({ color:0x4b5563, metalness:0.1, roughness:0.85 });
    obj = new THREE.Mesh(geo, mat);
    scene.add(obj);
  } else {
    const geo = new THREE.BoxGeometry(70, 22, 45);
    const mat = new THREE.MeshStandardMaterial({ color:0x4b5563 });
    obj = new THREE.Mesh(geo, mat);
    scene.add(obj);
  }

  const qDir = m.qibla;
  const aDir = m.axis ?? m.baseAxis;
  const mkLine = (deg, color, len, y=12) => {
    if (deg == null) return null;
    const r = toRad(deg);
    const p2 = new THREE.Vector3(Math.sin(r)*len, y, Math.cos(r)*len);
    const g = new THREE.BufferGeometry().setFromPoints([new THREE.Vector3(0,y,0), p2]);
    const mat = new THREE.LineBasicMaterial({ color });
    const line = new THREE.Line(g, mat);
    scene.add(line);
    return line;
  };
  mkLine(qDir, 0xc9a84c, 140, 15);
  mkLine(aDir, 0x7c6ad8, 120, 13);
  const iAxis = getInteriorAxis(m);
  mkLine(iAxis, 0x4ade80, 100, 11);

  side.innerHTML = `
    <div class="lab-row"><span class="lab-k">Cami</span><span class="lab-v">${escHtml(m.name)}</span></div>
    <div class="lab-row"><span class="lab-k">KÄ±ble</span><span class="lab-v">${m.qibla.toFixed(2)}Â°</span></div>
    <div class="lab-row"><span class="lab-k">Nihai aks</span><span class="lab-v">${m.axis!=null?m.axis.toFixed(2)+'Â°':'â€”'}</span></div>
    <div class="lab-row"><span class="lab-k">Ä°Ã§ aks</span><span class="lab-v">${iAxis!=null?iAxis.toFixed(2)+'Â°':'â€”'}</span></div>
    <div class="lab-row"><span class="lab-k">Sapma</span><span class="lab-v">${m.diff!=null?m.diff.toFixed(2)+'Â°':'â€”'}</span></div>
    <div class="lab-row"><span class="lab-k">GÃ¼ven</span><span class="lab-v">${m.confidence ?? 'â€”'}/100</span></div>
  `;

  const tick = () => {
    if (obj) obj.rotation.y += 0.004;
    renderer.render(scene, camera);
    m3dState.raf = requestAnimationFrame(tick);
  };
  m3dState = { renderer, scene, camera, raf:0, obj };
  tick();
}
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  LEADERBOARD (AdÄ±m 5)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const LB_KEY = 'qibla-leaderboard-v2';
const LB_MODE_KEY = 'qibla-leaderboard-mode-v1';

// Pre-seeded cities with approximate data (will be replaced when user analyses them)
const LB_SEEDS = [
  { city:'Ä°stanbul',  country:'TÃ¼rkiye',  region:'turkey'  },
  { city:'Ankara',    country:'TÃ¼rkiye',  region:'turkey'  },
  { city:'Ä°zmir',     country:'TÃ¼rkiye',  region:'turkey'  },
  { city:'Konya',     country:'TÃ¼rkiye',  region:'turkey'  },
  { city:'Bursa',     country:'TÃ¼rkiye',  region:'turkey'  },
  { city:'Cairo',     country:'MÄ±sÄ±r',    region:'mideast' },
  { city:'Istanbul',  country:'TÃ¼rkiye',  region:'turkey'  },
  { city:'Tehran',    country:'Ä°ran',     region:'mideast' },
  { city:'Baghdad',   country:'Irak',     region:'mideast' },
  { city:'Riyadh',    country:'S.Arabistan', region:'mideast' },
  { city:'Dubai',     country:'BAE',      region:'mideast' },
  { city:'Karachi',   country:'Pakistan', region:'asia'    },
  { city:'Lahore',    country:'Pakistan', region:'asia'    },
  { city:'Dhaka',     country:'BangladeÅŸ',region:'asia'    },
  { city:'Jakarta',   country:'Endonezya',region:'asia'    },
  { city:'Casablanca',country:'Fas',      region:'africa'  },
  { city:'Lagos',     country:'Nijerya',  region:'africa'  },
  { city:'London',    country:'Ä°ngiltere',region:'europe'  },
  { city:'Berlin',    country:'Almanya',  region:'europe'  },
  { city:'Paris',     country:'Fransa',   region:'europe'  },
];

let lbData = [];       // array of entry objects
let lbRegion = 'all';
let lbSort = 'pct';
let lbDataset = safeStorageGet(LB_MODE_KEY, 'qibla') === 'admin' ? 'admin' : 'qibla';

// Entry schema:
// { city, country, region, pct, grade, count, withData, avg, min, max, median, perfect, lat, lng, analysedAt, tol }

function lbLoad() {
  try { lbData = JSON.parse(safeStorageGet(LB_KEY, '[]')) || []; } catch { lbData = []; }
}

function lbSave() {
  try { safeStorageSet(LB_KEY, JSON.stringify(lbData)); } catch {}
}

function lbFindEntry(city) {
  return lbData.find(e => trLower(e.city) === trLower(city));
}

function lbUpsert(entry) {
  const idx = lbData.findIndex(e => trLower(e.city) === trLower(entry.city));
  if (idx >= 0) lbData[idx] = entry;
  else lbData.push(entry);
  lbSave();
}

function lbDelete(city) {
  lbData = lbData.filter(e => trLower(e.city) !== trLower(city));
  lbSave();
}

function lbClearAll() {
  if (!confirm('TÃ¼m sÄ±ralama verileri silinecek. Emin misiniz?')) return;
  lbData = [];
  lbSave();
  renderLeaderboard();
}

// Detect region from country/city name heuristic
function detectRegion(city, country) {
  const c = trLower(country || '');
  const ci = trLower(city || '');
  if (/turkiye|turkey|tÃ¼rkiye/.test(c+ci)) return 'turkey';
  if (/misir|egypt|irak|iraq|iran|suriye|syria|suudi|saudi|kuveyt|kuwait|katar|qatar|bae|uae|Ã¼rdÃ¼n|jordan|lÃ¼bnan|lebanon|yemen|oman/.test(c)) return 'mideast';
  if (/pakistan|hindistan|india|banglades|endonezya|indonesia|malezya|malaysia|afganistan|afghanistan/.test(c)) return 'asia';
  if (/fas|morocco|nijerya|nigeria|tanzanya|tanzania|kenya|senegal|tunus|tunisia|libya|cezayir|algeria|etiyopya|ethiopia/.test(c)) return 'africa';
  if (/ingiltere|england|uk|almanya|germany|fransa|france|hollanda|netherlands|ispanya|spain|italya|italy|belcika|belgium/.test(c)) return 'europe';
  return 'other';
}

function gradeColor(grade) {
  return grade==='A'?'#4ade80':grade==='B'?'#a3e635':grade==='C'?'#fbbf24':grade==='D'?'#f87171':'#6b6b7a';
}

function pctColor(pct) {
  if (pct === null) return '#6b6b7a';
  if (pct >= 80) return '#4ade80';
  if (pct >= 60) return '#a3e635';
  if (pct >= 40) return '#fbbf24';
  return '#f87171';
}

// â”€â”€ Open / close
function openLeaderboard() {
  lbLoad();
  document.getElementById('lb-overlay').classList.add('show');
  document.getElementById('btn-lb').classList.add('active');
  lbSetDataset(lbDataset, true);
  renderLeaderboard();
}

function closeLeaderboard() {
  document.getElementById('lb-overlay').classList.remove('show');
  document.getElementById('btn-lb').classList.remove('active');
}

function lbOverlayClick(e) {
  if (e.target === document.getElementById('lb-overlay')) closeLeaderboard();
}

// â”€â”€ Filters & sort
function lbSetRegion(r) {
  lbRegion = r;
  document.querySelectorAll('.lb-filter').forEach(b => b.classList.toggle('active', b.dataset.region === r));
  renderLeaderboard();
}

function lbSetSort(s) {
  lbSort = s;
  document.querySelectorAll('.lb-sort').forEach(b => b.classList.toggle('active', b.dataset.sort === s));
  renderLeaderboard();
}

function lbSetDataset(mode, silent = false) {
  lbDataset = mode === 'admin' ? 'admin' : 'qibla';
  safeStorageSet(LB_MODE_KEY, lbDataset);
  if (lbDataset === 'admin' && (lbSort === 'pct' || lbSort === 'avg')) lbSort = 'count';
  if (lbDataset === 'qibla' && lbSort === 'count') lbSort = 'pct';
  document.querySelectorAll('.lb-mode').forEach(b => b.classList.toggle('active', b.dataset.mode === lbDataset));
  document.querySelectorAll('.lb-sort').forEach(b => b.classList.toggle('active', b.dataset.sort === lbSort));
  const input = document.getElementById('lb-city-input');
  const addBtn = document.getElementById('lb-add-btn');
  if (input) {
    input.placeholder = lbDataset === 'admin'
      ? 'Ä°l/Eyalet yaz... (Ã¶rn: Konya Province, TÃ¼rkiye)'
      : 'Åehir ekle... (Ã¶rn: Konya, Cairo, Lahore)';
  }
  if (addBtn) addBtn.textContent = lbDataset === 'admin' ? '+ SayÄ±mÄ± Ã‡ek' : '+ Analiz Et';
  if (!silent) renderLeaderboard();
}

function lbSelectAdminResult(items = []) {
  if (!items.length) return null;
  const prefType = new Set(['administrative','state','province','region','county','municipality']);
  const ranked = items.map(it => {
    let s = 0;
    const cls = trLower(it.class || '');
    const type = trLower(it.type || '');
    const osmType = trLower(it.osm_type || '');
    if (cls === 'boundary') s += 65;
    if (prefType.has(type)) s += 55;
    if (osmType === 'relation') s += 48;
    else if (osmType === 'way') s += 28;
    s += Number(it.importance || 0) * 30;
    return { it, s };
  }).sort((a,b) => b.s - a.s);
  return ranked[0]?.it || items[0];
}

function parseOverpassCount(elements = []) {
  const c = elements.find(x => x.type === 'count');
  const total = Number(c?.tags?.total ?? 0);
  return Number.isFinite(total) ? total : 0;
}

async function fetchMosqueCountByAreaId(areaId) {
  const q = `[out:json][timeout:90];
area(${areaId})->.a;
(
  nwr["amenity"="place_of_worship"]["religion"~"muslim|islam",i](area.a);
  nwr["amenity"="mosque"](area.a);
  nwr["building"="mosque"](area.a);
  nwr["place_of_worship"="mosque"](area.a);
  nwr["mosque"](area.a);
);
out count;`;
  const els = await fetchOverpassQuery(q);
  return parseOverpassCount(els);
}

async function fetchMosqueCountByBbox(s, w, n, e) {
  const q = `[out:json][timeout:90];
(
  nwr["amenity"="place_of_worship"]["religion"~"muslim|islam",i](${s},${w},${n},${e});
  nwr["amenity"="mosque"](${s},${w},${n},${e});
  nwr["building"="mosque"](${s},${w},${n},${e});
  nwr["place_of_worship"="mosque"](${s},${w},${n},${e});
  nwr["mosque"](${s},${w},${n},${e});
);
out count;`;
  const els = await fetchOverpassQuery(q);
  return parseOverpassCount(els);
}

async function lbCountAdminArea(queryText) {
  const btn = document.getElementById('lb-add-btn');
  btn.disabled = true;
  const pw = document.getElementById('lb-progress-wrap');
  const pb = document.getElementById('lb-progress-bar');
  const pl = document.getElementById('lb-progress-label');
  pw.style.display = 'flex';
  pb.style.width = '8%';
  pl.textContent = `"${queryText}" sÄ±nÄ±rÄ± aranÄ±yor...`;
  try {
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(queryText)}&format=jsonv2&limit=8&addressdetails=1`;
    const hits = await nominatimFetchJson(url, {'Accept-Language':'tr,en'});
    const best = lbSelectAdminResult(hits || []);
    if (!best) throw new Error('Ä°l/eyalet bulunamadÄ±');
    pb.style.width = '40%';
    pl.textContent = 'SÄ±nÄ±r bulundu, sayÄ± Ã§ekiliyor...';

    const osmType = trLower(best.osm_type || '');
    const osmId = Number(best.osm_id);
    let total = 0;
    if (Number.isFinite(osmId) && (osmType === 'relation' || osmType === 'way')) {
      const areaId = (osmType === 'relation' ? 3600000000 : 2400000000) + osmId;
      total = await fetchMosqueCountByAreaId(areaId);
    } else if (Array.isArray(best.boundingbox) && best.boundingbox.length === 4) {
      const s = Number(best.boundingbox[0]), n = Number(best.boundingbox[1]);
      const w = Number(best.boundingbox[2]), e = Number(best.boundingbox[3]);
      total = await fetchMosqueCountByBbox(s, w, n, e);
    } else {
      throw new Error('Alan sÄ±nÄ±rÄ± okunamadÄ±');
    }

    pb.style.width = '90%';
    const addr = best.address || {};
    const cityLike = addr.state || addr.county || addr.province || String(best.display_name || '').split(',')[0].trim() || queryText;
    const country = addr.country || '';
    const name = country ? `${cityLike} (${country})` : cityLike;
    const entry = {
      city: name,
      country,
      region: detectRegion(cityLike, country),
      pct: null,
      grade: 'â€”',
      count: total,
      withData: null,
      avg: null, min: null, max: null, median: null, perfect: null,
      lat: Number(best.lat), lng: Number(best.lon),
      analysedAt: new Date().toISOString(),
      tol,
      mode: 'admin-count',
      source: 'overpass-area'
    };
    lbUpsert(entry);
    pb.style.width = '100%';
    pl.textContent = `âœ“ ${name}: ${total.toLocaleString()} kayÄ±t`;
    await new Promise(res => setTimeout(res, 550));
    pw.style.display = 'none';
    renderLeaderboard();
    toast(`âœ“ ${name} sayÄ±mÄ± tamamlandÄ±: ${total.toLocaleString()}`, 3600);
  } catch (err) {
    pw.style.display = 'none';
    toast('âŒ Ä°l sayÄ±mÄ± hatasÄ±: ' + (err?.message || 'bilinmeyen hata'), 5200);
  }
  btn.disabled = false;
}

// â”€â”€ Filtered + sorted data
function lbFiltered() {
  let d = lbData.filter(e => (lbDataset === 'admin' ? e.mode === 'admin-count' : e.mode !== 'admin-count'));
  if (lbRegion !== 'all') d = d.filter(e => e.region === lbRegion);
  return d.slice().sort((a, b) => {
    if (lbDataset === 'admin') {
      if (lbSort === 'name') return trLower(a.city).localeCompare(trLower(b.city));
      return (b.count||0) - (a.count||0);
    }
    if (lbSort === 'pct') {
      if (a.pct === null && b.pct === null) return 0;
      if (a.pct === null) return 1;
      if (b.pct === null) return -1;
      return b.pct - a.pct;
    }
    if (lbSort === 'count') return (b.count||0) - (a.count||0);
    if (lbSort === 'avg') {
      if (a.avg === null && b.avg === null) return 0;
      if (a.avg === null) return 1;
      if (b.avg === null) return -1;
      return a.avg - b.avg; // lower avg = better
    }
    if (lbSort === 'name') return trLower(a.city).localeCompare(trLower(b.city));
    return 0;
  });
}

// â”€â”€ Render
function renderLeaderboard() {
  const filtered = lbFiltered();
  lbSetDataset(lbDataset, true);

  const hCity = document.getElementById('lb-h-city');
  const hBar = document.getElementById('lb-h-bar');
  const hPct = document.getElementById('lb-h-pct');
  const hNote = document.getElementById('lb-h-note');
  const hCount = document.getElementById('lb-h-count');
  const hAvg = document.getElementById('lb-h-avg');
  if (lbDataset === 'admin') {
    if (hCity) hCity.textContent = 'Ä°l/BÃ¶lge';
    if (hBar) hBar.textContent = 'YoÄŸunluk';
    if (hPct) hPct.textContent = 'â€”';
    if (hNote) hNote.textContent = 'TÃ¼r';
    if (hCount) hCount.textContent = 'Cami+Mescit';
    if (hAvg) hAvg.textContent = 'Kaynak';
  } else {
    if (hCity) hCity.textContent = 'Åehir';
    if (hBar) hBar.textContent = 'DoÄŸruluk';
    if (hPct) hPct.textContent = '%';
    if (hNote) hNote.textContent = 'Not';
    if (hCount) hCount.textContent = 'Cami';
    if (hAvg) hAvg.textContent = 'Ort.Sap.';
  }

  // Summary strip
  const summary = document.getElementById('lb-summary');
  if (lbDataset === 'admin') {
    const adminRows = lbData.filter(e => e.mode === 'admin-count');
    const total = adminRows.length;
    const totalMosques = adminRows.reduce((s, e) => s + (e.count||0), 0);
    const top = adminRows.slice().sort((a,b)=>(b.count||0)-(a.count||0))[0];
    const avgCount = total ? Math.round(totalMosques / total) : null;
    summary.innerHTML = `
      <div class="lb-sum-item"><div class="lb-sum-val">${total}</div><div class="lb-sum-lbl">Ä°l/BÃ¶lge</div></div>
      <div class="lb-sum-item"><div class="lb-sum-val">${totalMosques.toLocaleString()}</div><div class="lb-sum-lbl">Toplam Cami+Mescit</div></div>
      <div class="lb-sum-item"><div class="lb-sum-val">${top ? escHtml(top.city) : 'â€”'}</div><div class="lb-sum-lbl">En YÃ¼ksek BÃ¶lge</div></div>
      <div class="lb-sum-item"><div class="lb-sum-val">${avgCount!==null?avgCount.toLocaleString():'â€”'}</div><div class="lb-sum-lbl">Ort. BÃ¶lge SayÄ±sÄ±</div></div>
    `;
  } else {
    const qRows = lbData.filter(e => e.mode !== 'admin-count');
    const total = qRows.length;
    const analysed = qRows.filter(e => e.pct !== null).length;
    const totalMosques = qRows.reduce((s, e) => s + (e.count||0), 0);
    const avgPct = analysed ? Math.round(qRows.filter(e=>e.pct!==null).reduce((s,e)=>s+e.pct,0)/analysed) : null;
    summary.innerHTML = `
      <div class="lb-sum-item"><div class="lb-sum-val">${total}</div><div class="lb-sum-lbl">Åehir</div></div>
      <div class="lb-sum-item"><div class="lb-sum-val">${analysed}</div><div class="lb-sum-lbl">Analiz Edildi</div></div>
      <div class="lb-sum-item"><div class="lb-sum-val">${totalMosques.toLocaleString()}</div><div class="lb-sum-lbl">Toplam Cami</div></div>
      <div class="lb-sum-item"><div class="lb-sum-val" style="color:${pctColor(avgPct)}">${avgPct!==null?avgPct+'%':'â€”'}</div><div class="lb-sum-lbl">Ort. DoÄŸruluk</div></div>
    `;
  }

  // Updated timestamp
  const latestDate = lbData.map(e=>e.analysedAt).filter(Boolean).sort().reverse()[0];
  document.getElementById('lb-updated').textContent = latestDate
    ? 'Son gÃ¼ncelleme: ' + new Date(latestDate).toLocaleDateString('tr-TR')
    : '';

  // Rows
  const container = document.getElementById('lb-rows');
  if (!filtered.length) {
    container.innerHTML = `<div class="lb-empty">
      <div class="lb-empty-icon">ğŸ•Œ</div>
      <div>${lbData.length===0
        ? 'HenÃ¼z ÅŸehir yok â€” yukarÄ±dan bir ÅŸehir ekleyin!'
        : 'Bu bÃ¶lgede ÅŸehir bulunamadÄ±'}</div>
      ${lbData.length===0?`<div style="color:#4a4a5a;font-size:11px;margin-top:8px">Ã–rnek: Ä°stanbul, Cairo, Karachi, Jakarta</div>`:''}
    </div>`;
    return;
  }

  const bestVal = lbDataset === 'admin'
    ? Math.max(...filtered.map(e=>e.count||0), 1)
    : Math.max(...filtered.map(e=>e.pct??0), 1);

  container.innerHTML = filtered.map((e, i) => {
    const rank = i + 1;
    const rankClass = rank===1?'lb-rank-1':rank===2?'lb-rank-2':rank===3?'lb-rank-3':'lb-rank-n';
    const rankIcon = rank===1?'ğŸ¥‡':rank===2?'ğŸ¥ˆ':rank===3?'ğŸ¥‰':rank;
    const col = lbDataset === 'admin' ? '#60a5fa' : pctColor(e.pct);
    const barW = lbDataset === 'admin'
      ? Math.round(((e.count||0) / bestVal) * 100)
      : (e.pct !== null ? Math.round((e.pct/100)*100) : 0);
    const isCurrentCity = trLower(e.city) === trLower(currentCity);
    const needsAnalysis = e.pct === null;
    const dateStr = e.analysedAt ? new Date(e.analysedAt).toLocaleDateString('tr-TR',{day:'2-digit',month:'2-digit',year:'2-digit'}) : 'â€”';
    const citySafe = escHtml(e.city);
    const countrySafe = escHtml(e.country || '');
    const cityEnc = encodeURIComponent(e.city);

    return `<div class="lb-row${isCurrentCity?' current-city':''}${needsAnalysis?' needs-analysis':''}"
         onclick="lbGoCity('${cityEnc}','${e.lat||''}','${e.lng||''}')">
      <span class="lbt-rank ${rankClass}">${rankIcon}</span>
      <span class="lbt-city">
        <span class="lb-city-name">${citySafe}${isCurrentCity?' <span style="font-size:9px;color:#c9a84c">â—</span>':''}</span>
        <span class="lb-city-country">${countrySafe} ${e.region?'Â· '+regionLabel(e.region):''}</span>
      </span>
      <span class="lbt-bar">
        ${e.pct!==null
          ? `<div class="lb-bar-track"><div class="lb-bar-fill" style="width:${barW}%;background:${col}"></div></div>`
          : `<span style="font-size:9px;color:#4a4a5a">analiz bekleniyor</span>`}
      </span>
      <span class="lbt-pct" style="color:${col}">${lbDataset==='admin'?'â€”':(e.pct!==null?e.pct+'%':'â€”')}</span>
      <span class="lbt-not">${lbDataset==='admin'?'Ä°l/State':(e.grade&&e.grade!=='â€”'?`<span style="color:${gradeColor(e.grade)};font-weight:700">${e.grade}</span>`:'â€”')}</span>
      <span class="lbt-count">${(e.count||0).toLocaleString()}</span>
      <span class="lbt-avg">${lbDataset==='admin'?(e.source || 'overpass'):(e.avg!==null?e.avg.toFixed(1)+'Â°':'â€”')}</span>
      <span class="lbt-date">${dateStr}</span>
      <span class="lbt-act">
        ${needsAnalysis
          ? `<button class="lb-act-btn" onclick="event.stopPropagation();${lbDataset==='admin'?'lbCountAdminArea':'lbAnalyseCity'}(decodeURIComponent('${cityEnc}'))">â–¶ Analiz</button>`
          : `<button class="lb-act-btn" onclick="event.stopPropagation();${lbDataset==='admin'?'lbCountAdminArea':'lbAnalyseCity'}(decodeURIComponent('${cityEnc}'))">â†º</button>`}
        <button class="lb-act-btn danger" onclick="event.stopPropagation();lbRemove(decodeURIComponent('${cityEnc}'))">âœ•</button>
      </span>
    </div>`;
  }).join('');
}

function regionLabel(r) {
  return {turkey:'TÃ¼rkiye',mideast:'Orta DoÄŸu',asia:'GÃ¼ney Asya',africa:'Afrika',europe:'Avrupa',other:'DiÄŸer'}[r]||r;
}

// â”€â”€ Navigate to city on map
function lbGoCity(cityEnc, lat, lng) {
  const city = decodeURIComponent(cityEnc);
  if (lat && lng) {
    map.setView([+lat, +lng], 13, {animate:true});
  }
  closeLeaderboard();
  document.getElementById('city-input').value = city;
  doSearch();
}

// â”€â”€ Remove entry
function lbRemove(city) {
  lbDelete(city);
  renderLeaderboard();
}

// â”€â”€ Add city via input
async function lbAddCity() {
  const input = document.getElementById('lb-city-input');
  const city = input.value.trim();
  if (!city) return;
  input.value = '';
  if (lbDataset === 'admin') await lbCountAdminArea(city);
  else await lbAnalyseCity(city);
}

// â”€â”€ Core: analyse a city and store result
async function lbAnalyseCity(city) {
  const btn = document.getElementById('lb-add-btn');
  btn.disabled = true;

  // Show progress
  const pw = document.getElementById('lb-progress-wrap');
  const pb = document.getElementById('lb-progress-bar');
  const pl = document.getElementById('lb-progress-label');
  pw.style.display = 'flex';
  pb.style.width = '5%';
  pl.textContent = `"${city}" analiz ediliyor...`;

  try {
    pb.style.width = '15%'; pl.textContent = 'Koordinatlar alÄ±nÄ±yor...';
    const loc = await geocode(city);

    pb.style.width = '35%'; pl.textContent = 'Camiler yÃ¼kleniyor...';
    const r = 0.072; // ~8km radius
    const elements = await fetchBbox(loc.lat-r, loc.lng-r, loc.lat+r, loc.lng+r);

    pb.style.width = '75%'; pl.textContent = `${elements.length} cami iÅŸleniyor...`;
    await new Promise(res => setTimeout(res, 20));

    // Analyse into temp map
    const tempDB = new Map();
    for (const el of elements) {
      let lat0, lng0, polyCoords = null;
      if (el.type==='node') { lat0=el.lat; lng0=el.lon; }
      else if (el.type==='way'&&el.geometry) {
        const pts=el.geometry;
        lat0=pts.reduce((s,p)=>s+p.lat,0)/pts.length;
        lng0=pts.reduce((s,p)=>s+p.lon,0)/pts.length;
        polyCoords=pts.map(p=>[p.lat,p.lon]);
      } else continue;

      const qibla = qiblaAngle(lat0, lng0);
      let axis=null, diff=null;
      const dt = el.tags?.direction||el.tags?.['building:direction'];
      if (dt&&!isNaN(+dt)) { axis=+dt%180; diff=angDiff180(qibla%180,axis); }
      else if (polyCoords&&polyCoords.length>=4) {
        const res = buildingQiblaEdge(polyCoords, qibla);
        if (res) { axis=res.angle; diff=res.diff; }
      }
      tempDB.set(el.id, {
        diff, status: diff!==null?(diff<=tol?'correct':'wrong'):'unknown'
      });
    }

    pb.style.width = '90%'; pl.textContent = 'Skor hesaplanÄ±yor...';
    const st = computeStats(tempDB);

    // Detect country & region from nominatim display_name
    let country = '', region = 'other';
    try {
      const geoData = await nominatimFetchJson(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(city)}&format=json&limit=1&addressdetails=1`, {'Accept-Language':'tr'});
      if (geoData[0]?.address) {
        country = geoData[0].address.country || '';
        region = detectRegion(city, country);
      }
    } catch {}

    const entry = {
      city, country, region,
      pct: st.pct, grade: st.grade,
      count: st.all, withData: st.withData,
      avg: st.avg, min: st.min, max: st.max, median: st.median, perfect: st.perfect,
      lat: loc.lat, lng: loc.lng,
      analysedAt: new Date().toISOString(),
      tol
    };

    lbUpsert(entry);
    pb.style.width = '100%'; pl.textContent = `âœ“ ${city} eklendi`;
    await new Promise(res => setTimeout(res, 600));
    pw.style.display = 'none';
    renderLeaderboard();
    toast(`âœ“ ${city} sÄ±ralamaya eklendi â€” ${st.pct!==null?st.pct+'% doÄŸru':'veri yetersiz'}`, 4000);

  } catch(err) {
    pw.style.display = 'none';
    toast('âŒ ' + err.message, 6000);
    console.error(err);
  }

  btn.disabled = false;
}
</script>
</body>
</html>
